{"file_contents":{"client/src/components/DocumentCard.tsx":{"content":"import { Card } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Heart, FileText, Database, Coins } from \"lucide-react\";\nimport type { DocumentWithFavorite } from \"@shared/schema\";\nimport { Link } from \"wouter\";\nimport { useState } from \"react\";\nimport { InsufficientPointsDialog } from \"@/components/InsufficientPointsDialog\";\nimport { useAuth } from \"@/hooks/useAuth\";\n\ninterface DocumentCardProps {\n  document: DocumentWithFavorite;\n  onFavoriteToggle: (documentId: string, isFavorited: boolean) => void;\n  isTogglingFavorite?: boolean;\n  categoryLogoUrl?: string;\n}\n\nexport function DocumentCard({ document, onFavoriteToggle, isTogglingFavorite, categoryLogoUrl }: DocumentCardProps) {\n  const [isHovered, setIsHovered] = useState(false);\n  const [showPointsDialog, setShowPointsDialog] = useState(false);\n  const { user } = useAuth();\n  const dataCount = document.pageCount * 10;\n  const requiredPoints = document.pointsCost || document.pageCount || 0;\n  const userPoints = user?.points || 0;\n\n  const handleExchangeClick = (e: React.MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    if (userPoints < requiredPoints) {\n      setShowPointsDialog(true);\n    }\n  };\n\n  return (\n    <Card\n      className=\"overflow-hidden hover-elevate transition-all duration-200\"\n      onMouseEnter={() => setIsHovered(true)}\n      onMouseLeave={() => setIsHovered(false)}\n    >\n      <Link href={`/document/${document.id}`} data-testid={`link-document-${document.id}`}>\n        <div className=\"cursor-pointer\">\n          <div className=\"relative aspect-video overflow-hidden bg-muted\">\n            <img\n              src={document.coverImageUrl}\n              alt={document.title}\n              className={`w-full h-full object-cover transition-transform duration-300 ${\n                isHovered ? \"scale-105\" : \"scale-100\"\n              }`}\n              data-testid={`img-cover-${document.id}`}\n            />\n            <div className=\"absolute top-3 left-3 right-3\">\n              <Badge\n                className=\"backdrop-blur-sm border-border text-[16px] bg-[#000000] text-[#ffffff] inline-flex items-start gap-1.5 whitespace-normal max-w-full\"\n                data-testid={`badge-category-${document.id}`}\n              >\n                {categoryLogoUrl && (\n                  <img \n                    src={categoryLogoUrl} \n                    alt={document.category}\n                    className=\"w-5 h-5 object-contain flex-shrink-0 mt-0.5\"\n                    data-testid={`img-category-logo-${document.id}`}\n                  />\n                )}\n                <span className=\"break-words\">\n                  {document.subcategory \n                    ? <>{document.category} <span className=\"opacity-60\">‚Ä∫</span> {document.subcategory}</>\n                    : document.category}\n                </span>\n              </Badge>\n            </div>\n          </div>\n        </div>\n      </Link>\n\n      <div className=\"p-4 space-y-3\">\n        <Link href={`/document/${document.id}`}>\n          <h3\n            className=\"text-xl font-semibold line-clamp-2 hover:text-primary transition-colors cursor-pointer\"\n            data-testid={`text-title-${document.id}`}\n          >\n            {document.title}\n          </h3>\n        </Link>\n\n        <p\n          className=\"text-sm text-muted-foreground line-clamp-3 leading-relaxed\"\n          data-testid={`text-description-${document.id}`}\n        >\n          {document.description}\n        </p>\n\n        <div className=\"flex flex-col gap-2 pt-2\">\n          <div className=\"flex items-center gap-4 text-sm text-muted-foreground\">\n            <div className=\"flex items-center gap-1.5\">\n              <span className=\"font-semibold text-foreground\">ID</span>\n              <span data-testid={`text-postid-${document.id}`}>\n                {document.postId || 'N/A'}\n              </span>\n            </div>\n            <div className=\"flex items-center gap-1.5\">\n              <Database className=\"w-4 h-4\" />\n              <span data-testid={`text-datacount-${document.id}`}>\n                {dataCount.toLocaleString()} Data\n              </span>\n            </div>\n          </div>\n          \n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-4 text-sm text-muted-foreground\">\n              <div className=\"flex items-center gap-1.5\">\n                <FileText className=\"w-4 h-4\" />\n                <span data-testid={`text-pages-${document.id}`}>\n                  {document.pageCount} trang\n                </span>\n              </div>\n              <div className=\"flex items-center gap-1.5\">\n                <Coins className=\"w-4 h-4 text-amber-500\" />\n                <span className=\"font-semibold text-amber-600 dark:text-amber-400\" data-testid={`text-points-${document.id}`}>\n                  {document.pointsCost || document.pageCount || 0} ƒëi·ªÉm\n                </span>\n              </div>\n            </div>\n\n            <Button\n              size=\"icon\"\n              variant=\"ghost\"\n              onClick={(e) => {\n                e.preventDefault();\n                onFavoriteToggle(document.id, document.isFavorited);\n              }}\n              disabled={isTogglingFavorite}\n              className=\"toggle-elevate\"\n              data-testid={`button-favorite-${document.id}`}\n            >\n              <Heart\n                className={`w-5 h-5 transition-all duration-200 ${\n                  document.isFavorited\n                    ? \"fill-destructive text-destructive\"\n                    : \"text-muted-foreground\"\n                }`}\n              />\n            </Button>\n          </div>\n          \n          <Button\n            variant=\"default\"\n            size=\"sm\"\n            className=\"w-full mt-1 bg-amber-500 hover:bg-amber-600 text-white\"\n            onClick={handleExchangeClick}\n            data-testid={`button-exchange-${document.id}`}\n          >\n            <Coins className=\"w-4 h-4 mr-2\" />\n            ƒê·ªïi ƒëi·ªÉm\n          </Button>\n        </div>\n      </div>\n\n      <InsufficientPointsDialog\n        open={showPointsDialog}\n        onOpenChange={setShowPointsDialog}\n        requiredPoints={requiredPoints}\n        currentPoints={userPoints}\n      />\n    </Card>\n  );\n}\n","path":null,"size_bytes":6352,"size_tokens":null},"server/replitAuth.ts":{"content":"// Reference: javascript_log_in_with_replit blueprint\nimport * as client from \"openid-client\";\nimport { Strategy, type VerifyFunction } from \"openid-client/passport\";\n\nimport passport from \"passport\";\nimport session from \"express-session\";\nimport type { Express, RequestHandler } from \"express\";\nimport memoize from \"memoizee\";\nimport { createSessionStore } from \"./mongodb\";\n\nlet storage: any;\n\nif (!process.env.REPLIT_DOMAINS) {\n  throw new Error(\"Environment variable REPLIT_DOMAINS not provided\");\n}\n\nconst getOidcConfig = memoize(\n  async () => {\n    return await client.discovery(\n      new URL(process.env.ISSUER_URL ?? \"https://replit.com/oidc\"),\n      process.env.REPL_ID!\n    );\n  },\n  { maxAge: 3600 * 1000 }\n);\n\nexport function getSession(mongoConnected: boolean) {\n  const sessionTtl = 7 * 24 * 60 * 60 * 1000; // 1 week\n  const sessionStore = createSessionStore(mongoConnected);\n  \n  return session({\n    secret: process.env.SESSION_SECRET!,\n    store: sessionStore,\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      httpOnly: true,\n      secure: true,\n      maxAge: sessionTtl,\n    },\n  });\n}\n\nfunction updateUserSession(\n  user: any,\n  tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers\n) {\n  user.claims = tokens.claims();\n  user.access_token = tokens.access_token;\n  user.refresh_token = tokens.refresh_token;\n  user.expires_at = user.claims?.exp;\n}\n\nasync function upsertUser(\n  claims: any,\n) {\n  console.log(\"[Auth] OIDC Claims received:\", JSON.stringify(claims, null, 2));\n  console.log(\"[Auth] Role claim value:\", claims[\"role\"]);\n  \n  await storage.upsertUser({\n    id: claims[\"sub\"],\n    email: claims[\"email\"],\n    firstName: claims[\"first_name\"],\n    lastName: claims[\"last_name\"],\n    profileImageUrl: claims[\"profile_image_url\"],\n    role: claims[\"role\"],\n  });\n}\n\nexport function setStorage(s: any) {\n  storage = s;\n}\n\nexport async function setupAuth(app: Express, mongoConnected: boolean) {\n  app.set(\"trust proxy\", 1);\n  app.use(getSession(mongoConnected));\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  const config = await getOidcConfig();\n\n  const verify: VerifyFunction = async (\n    tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers,\n    verified: passport.AuthenticateCallback\n  ) => {\n    const user = {};\n    updateUserSession(user, tokens);\n    await upsertUser(tokens.claims());\n    verified(null, user);\n  };\n\n  for (const domain of process.env\n    .REPLIT_DOMAINS!.split(\",\")) {\n    const strategy = new Strategy(\n      {\n        name: `replitauth:${domain}`,\n        config,\n        scope: \"openid email profile offline_access\",\n        callbackURL: `https://${domain}/api/callback`,\n      },\n      verify,\n    );\n    passport.use(strategy);\n  }\n\n  passport.serializeUser((user: Express.User, cb) => cb(null, user));\n  passport.deserializeUser((user: Express.User, cb) => cb(null, user));\n\n  app.get(\"/api/login\", (req, res, next) => {\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      prompt: \"login consent\",\n      scope: [\"openid\", \"email\", \"profile\", \"offline_access\"],\n    })(req, res, next);\n  });\n\n  app.get(\"/api/callback\", (req, res, next) => {\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      successReturnToOrRedirect: \"/\",\n      failureRedirect: \"/api/login\",\n    })(req, res, next);\n  });\n\n  app.get(\"/api/logout\", (req, res) => {\n    req.logout(() => {\n      res.redirect(\n        client.buildEndSessionUrl(config, {\n          client_id: process.env.REPL_ID!,\n          post_logout_redirect_uri: `${req.protocol}://${req.hostname}`,\n        }).href\n      );\n    });\n  });\n}\n\nexport const isAuthenticated: RequestHandler = async (req, res, next) => {\n  const user = req.user as any;\n\n  if (!req.isAuthenticated() || !user.expires_at) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  if (now <= user.expires_at) {\n    return next();\n  }\n\n  const refreshToken = user.refresh_token;\n  if (!refreshToken) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n\n  try {\n    const config = await getOidcConfig();\n    const tokenResponse = await client.refreshTokenGrant(config, refreshToken);\n    updateUserSession(user, tokenResponse);\n    return next();\n  } catch (error) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n};\n","path":null,"size_bytes":4406,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7428,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    // h-9 to match icon buttons and default buttons.\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":844,"size_tokens":null},"client/src/lib/authUtils.ts":{"content":"// Reference: javascript_log_in_with_replit blueprint\nexport function isUnauthorizedError(error: Error): boolean {\n  return /^401: .*Unauthorized/.test(error.message);\n}\n","path":null,"size_bytes":170,"size_tokens":null},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport type { IStorage } from \"./storage\";\nimport { MongoDBStorage } from \"./mongo-storage\";\nimport { MemStorage } from \"./mem-storage\";\nimport { connectMongoDB } from \"./mongodb\";\nimport { setupGoogleAuth, isAuthenticated, setStorage } from \"./googleAuth\";\nimport crypto from \"crypto\";\n\nlet storage: IStorage;\nimport { insertDocumentSchema, insertFavoriteSchema, insertTagSchema, insertUserUploadSchema } from \"@shared/schema\";\nimport { z } from \"zod\";\nimport multer from \"multer\";\nimport path from \"path\";\nimport fs from \"fs\";\nimport { processAdminUpload, processUserUploadApproval } from \"./pipeline/runner\";\nimport { processFileWithAI } from \"./services/aiProcessor\";\nimport { PointsAuditLog, RedemptionLog, Subcategory, User } from \"./models\";\nimport { \n  recordLegitimateAward, \n  recordPointsUsage, \n  validateUserLegitimacy, \n  blockUser,\n  unblockUser,\n  getLegitimatePointsRecord,\n  getAllUsersWithLegitimatePoints,\n  SUPER_ADMIN_EMAIL \n} from \"./services/pointsLegitimacy\";\n\n// Calculate MD5 hash of a file for duplicate detection\nfunction calculateFileHash(filePath: string): Promise<string> {\n  return new Promise((resolve, reject) => {\n    const hash = crypto.createHash('md5');\n    const stream = fs.createReadStream(filePath);\n    stream.on('data', (data) => hash.update(data));\n    stream.on('end', () => resolve(hash.digest('hex')));\n    stream.on('error', reject);\n  });\n}\n\n// Admin middleware\nconst isAdmin = async (req: any, res: any, next: any) => {\n  try {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"Unauthorized\" });\n    }\n    const userId = req.user.claims.sub;\n    const user = await storage.getUser(userId);\n    if (!user || user.role !== \"admin\") {\n      return res.status(403).json({ message: \"Forbidden - Admin access required\" });\n    }\n    next();\n  } catch (error) {\n    console.error(\"Error in admin middleware:\", error);\n    res.status(500).json({ message: \"Internal server error\" });\n  }\n};\n\n// Helper function to format date as dd-mm-yyyy\nfunction formatDateForFilename(date: Date): string {\n  const day = String(date.getDate()).padStart(2, '0');\n  const month = String(date.getMonth() + 1).padStart(2, '0');\n  const year = date.getFullYear();\n  return `${day}-${month}-${year}`;\n}\n\n// Configure multer for user file uploads (10MB max)\nconst USER_UPLOAD_DIR = path.join(process.cwd(), \"User-Upload\");\nconst userStorageMulter = multer.diskStorage({\n  destination: (_req, _file, cb) => {\n    if (!fs.existsSync(USER_UPLOAD_DIR)) {\n      fs.mkdirSync(USER_UPLOAD_DIR, { recursive: true, mode: 0o700 });\n    }\n    cb(null, USER_UPLOAD_DIR);\n  },\n  filename: (req: any, file, cb) => {\n    const now = new Date();\n    const dateStr = formatDateForFilename(now);\n    const ext = path.extname(file.originalname);\n    const nameWithoutExt = path.basename(file.originalname, ext);\n    // Format: \"original-filename-dd-mm-yyyy.ext\"\n    cb(null, `${nameWithoutExt}-${dateStr}${ext}`);\n  }\n});\n\nconst upload = multer({\n  storage: userStorageMulter,\n  limits: {\n    fileSize: 10 * 1024 * 1024, // 10MB max\n  },\n  fileFilter: (_req, file, cb) => {\n    const allowedTypes = [\n      \"application/pdf\",\n      \"text/csv\",\n      \"application/vnd.ms-excel\",\n      \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\"\n    ];\n    if (allowedTypes.includes(file.mimetype)) {\n      cb(null, true);\n    } else {\n      cb(new Error(\"Invalid file type. Only PDF, CSV, and Excel files are allowed.\"));\n    }\n  }\n});\n\n// Configure multer for admin bulk uploads (500MB max)\nconst ADMIN_UPLOAD_DIR = path.join(process.cwd(), \"Admin-Upload\");\nconst adminStorageMulter = multer.diskStorage({\n  destination: (_req, _file, cb) => {\n    if (!fs.existsSync(ADMIN_UPLOAD_DIR)) {\n      fs.mkdirSync(ADMIN_UPLOAD_DIR, { recursive: true, mode: 0o700 });\n    }\n    cb(null, ADMIN_UPLOAD_DIR);\n  },\n  filename: (req: any, file, cb) => {\n    const now = new Date();\n    const dateStr = formatDateForFilename(now);\n    const ext = path.extname(file.originalname);\n    const nameWithoutExt = path.basename(file.originalname, ext);\n    // Format: \"original-filename-dd-mm-yyyy.ext\"\n    cb(null, `${nameWithoutExt}-${dateStr}${ext}`);\n  }\n});\n\nconst adminUpload = multer({\n  storage: adminStorageMulter,\n  limits: {\n    fileSize: 500 * 1024 * 1024, // 500MB max\n  },\n  fileFilter: (_req, file, cb) => {\n    const allowedTypes = [\n      \"application/pdf\",\n      \"text/csv\",\n      \"application/vnd.ms-excel\",\n      \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\"\n    ];\n    if (allowedTypes.includes(file.mimetype)) {\n      cb(null, true);\n    } else {\n      cb(new Error(\"Invalid file type. Only PDF, CSV, and Excel files are allowed.\"));\n    }\n  }\n});\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  // Try to connect to MongoDB, fall back to in-memory storage if it fails\n  const mongoConnected = await connectMongoDB();\n  \n  if (mongoConnected) {\n    console.log(\"‚úÖ Using MongoDB persistent storage\");\n    storage = new MongoDBStorage();\n  } else {\n    console.log(\"‚ö†Ô∏è  Using IN-MEMORY storage - all data will be lost on restart!\");\n    storage = new MemStorage();\n  }\n  \n  // Pass storage to auth module\n  setStorage(storage);\n  \n  // Seed initial categories if none exist\n  if (mongoConnected) {\n    try {\n      const existingCategories = await storage.getAllCategories();\n      if (existingCategories.length === 0) {\n        console.log(\"üì¶ Seeding initial categories...\");\n        const initialCategories = [\n          { name: \"Data kh√°ch h√†ng Casino\", order: 1 },\n          { name: \"Data Doanh Nghi·ªáp\", order: 2 },\n          { name: \"Data B·∫•t ƒê·ªông S·∫£n\", order: 3 },\n          { name: \"Data Ng√¢n H√†ng\", order: 4 },\n          { name: \"Data B·∫£o Hi·ªÉm\", order: 5 },\n          { name: \"Data Email\", order: 6 },\n          { name: \"Kh√°c\", order: 7 },\n        ];\n        \n        for (const cat of initialCategories) {\n          await storage.createCategory(cat);\n        }\n        \n        console.log(\"‚úÖ Initial categories seeded successfully\");\n      }\n    } catch (error) {\n      console.error(\"Error seeding categories:\", error);\n    }\n  }\n  \n  // Google Auth middleware\n  await setupGoogleAuth(app, mongoConnected);\n\n  // Auth routes\n  app.get('/api/auth/user', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      res.json(user);\n    } catch (error) {\n      console.error(\"Error fetching user:\", error);\n      res.status(500).json({ message: \"Failed to fetch user\" });\n    }\n  });\n\n  // User view stats - get how many posts user has viewed\n  app.get('/api/user/view-stats', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const stats = await storage.getUserViewStats(userId);\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching view stats:\", error);\n      res.status(500).json({ message: \"Failed to fetch view stats\" });\n    }\n  });\n\n  // Document routes\n  app.get(\"/api/documents\", async (req: any, res) => {\n    try {\n      let userId: string | undefined;\n      if (req.isAuthenticated() && req.user?.claims?.sub) {\n        userId = req.user.claims.sub;\n      }\n      const documents = await storage.getAllDocuments(userId);\n      res.json(documents);\n    } catch (error) {\n      console.error(\"Error fetching documents:\", error);\n      res.status(500).json({ message: \"Failed to fetch documents\" });\n    }\n  });\n\n  app.get(\"/api/documents/:id\", async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      let userId: string | undefined;\n      if (req.isAuthenticated() && req.user?.claims?.sub) {\n        userId = req.user.claims.sub;\n      }\n      \n      const document = await storage.getDocumentById(id, userId);\n      if (!document) {\n        return res.status(404).json({ message: \"Document not found\" });\n      }\n\n      // Check if user is blocked\n      if (userId) {\n        const user = await storage.getUser(userId);\n        if (user?.isBlocked) {\n          return res.status(403).json({ \n            message: \"T√†i kho·∫£n c·ªßa b·∫°n ƒë√£ b·ªã kh√≥a. B·∫°n kh√¥ng th·ªÉ xem n·ªôi dung b√†i vi·∫øt. Vui l√≤ng li√™n h·ªá admin ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£.\",\n            code: \"USER_BLOCKED\",\n            blockedReason: user.blockedReason\n          });\n        }\n        \n        // Admin users bypass the view limit\n        if (user?.role !== 'admin') {\n          const canView = await storage.recordUserPostView(userId, id);\n          if (!canView) {\n            return res.status(403).json({ \n              message: \"B·∫°n ƒë√£ ƒë·∫°t gi·ªõi h·∫°n xem 10 b√†i ƒëƒÉng. Vui l√≤ng li√™n h·ªá admin ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£.\",\n              code: \"VIEW_LIMIT_REACHED\"\n            });\n          }\n        }\n      }\n\n      // Increment view count\n      await storage.incrementViewCount(id);\n\n      res.json(document);\n    } catch (error) {\n      console.error(\"Error fetching document:\", error);\n      res.status(500).json({ message: \"Failed to fetch document\" });\n    }\n  });\n\n  app.get(\"/api/documents/:id/related\", async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      let userId: string | undefined;\n      if (req.isAuthenticated() && req.user?.claims?.sub) {\n        userId = req.user.claims.sub;\n      }\n\n      const relatedDocuments = await storage.getRelatedDocuments(id, userId);\n      res.json(relatedDocuments);\n    } catch (error) {\n      console.error(\"Error fetching related documents:\", error);\n      res.status(500).json({ message: \"Failed to fetch related documents\" });\n    }\n  });\n\n  app.post(\"/api/documents\", isAdmin, async (req: any, res) => {\n    try {\n      const validatedData = insertDocumentSchema.parse(req.body);\n      const document = await storage.createDocument(validatedData);\n      res.status(201).json(document);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid document data\", errors: error.errors });\n      }\n      console.error(\"Error creating document:\", error);\n      res.status(500).json({ message: \"Failed to create document\" });\n    }\n  });\n\n  app.patch(\"/api/documents/:id\", isAdmin, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const document = await storage.updateDocument(id, req.body);\n      if (!document) {\n        return res.status(404).json({ message: \"Document not found\" });\n      }\n      res.json(document);\n    } catch (error) {\n      console.error(\"Error updating document:\", error);\n      res.status(500).json({ message: \"Failed to update document\" });\n    }\n  });\n\n  app.delete(\"/api/documents/:id\", isAdmin, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const success = await storage.deleteDocument(id);\n      if (!success) {\n        return res.status(404).json({ message: \"Document not found\" });\n      }\n      res.json({ message: \"Document deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting document:\", error);\n      res.status(500).json({ message: \"Failed to delete document\" });\n    }\n  });\n\n  // Favorite routes\n  app.post(\"/api/favorites\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const { documentId } = req.body;\n\n      if (!documentId) {\n        return res.status(400).json({ message: \"documentId is required\" });\n      }\n\n      const favorite = await storage.addFavorite({ userId, documentId });\n      res.status(201).json(favorite);\n    } catch (error) {\n      console.error(\"Error adding favorite:\", error);\n      res.status(500).json({ message: \"Failed to add favorite\" });\n    }\n  });\n\n  app.delete(\"/api/favorites/:documentId\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const { documentId } = req.params;\n\n      const success = await storage.removeFavorite(userId, documentId);\n      if (!success) {\n        return res.status(404).json({ message: \"Favorite not found\" });\n      }\n      res.json({ message: \"Favorite removed successfully\" });\n    } catch (error) {\n      console.error(\"Error removing favorite:\", error);\n      res.status(500).json({ message: \"Failed to remove favorite\" });\n    }\n  });\n\n  app.get(\"/api/favorites\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const favorites = await storage.getUserFavorites(userId);\n      res.json(favorites);\n    } catch (error) {\n      console.error(\"Error fetching favorites:\", error);\n      res.status(500).json({ message: \"Failed to fetch favorites\" });\n    }\n  });\n\n  // Admin routes\n  app.get(\"/api/admin/stats\", isAdmin, async (req: any, res) => {\n    try {\n      const stats = await storage.getAdminStats();\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching admin stats:\", error);\n      res.status(500).json({ message: \"Failed to fetch stats\" });\n    }\n  });\n\n  // Admin badge counts for sidebar notifications\n  app.get(\"/api/admin/badge-counts\", isAdmin, async (req: any, res) => {\n    try {\n      // Count pending user uploads\n      const allUploads = await storage.getAllUserUploads();\n      const pendingUploadsCount = allUploads.filter(u => u.approvalStatus === 'pending').length;\n\n      // Count total unread support messages\n      const conversations = await (storage as any).getAllConversations();\n      const unreadSupportCount = conversations.reduce((sum: number, conv: any) => sum + (conv.unreadByAdmin || 0), 0);\n\n      // Count new users (registered in last 24 hours)\n      const allUsers = await storage.getAllUsers();\n      const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);\n      const newUsersCount = allUsers.filter(u => u.createdAt && new Date(u.createdAt) > oneDayAgo).length;\n\n      res.json({\n        pendingUploads: pendingUploadsCount,\n        unreadSupport: unreadSupportCount,\n        newUsers: newUsersCount,\n      });\n    } catch (error) {\n      console.error(\"Error fetching admin badge counts:\", error);\n      res.status(500).json({ message: \"Failed to fetch badge counts\" });\n    }\n  });\n\n  app.get(\"/api/admin/documents\", isAdmin, async (req: any, res) => {\n    try {\n      const documents = await storage.getAllDocumentsForAdmin();\n      res.json(documents);\n    } catch (error) {\n      console.error(\"Error fetching documents for admin:\", error);\n      res.status(500).json({ message: \"Failed to fetch documents\" });\n    }\n  });\n\n  app.get(\"/api/admin/documents/:id\", isAdmin, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const document = await storage.getDocumentByIdForAdmin(id);\n      if (!document) {\n        return res.status(404).json({ message: \"Document not found\" });\n      }\n      res.json(document);\n    } catch (error) {\n      console.error(\"Error fetching document for admin:\", error);\n      res.status(500).json({ message: \"Failed to fetch document\" });\n    }\n  });\n\n  app.get(\"/api/admin/documents/recent\", isAdmin, async (req: any, res) => {\n    try {\n      const documents = await storage.getRecentDocuments(5);\n      res.json(documents);\n    } catch (error) {\n      console.error(\"Error fetching recent documents:\", error);\n      res.status(500).json({ message: \"Failed to fetch recent documents\" });\n    }\n  });\n\n  app.delete(\"/api/admin/documents/:id\", isAdmin, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const success = await storage.deleteDocument(id);\n      if (!success) {\n        return res.status(404).json({ message: \"Document not found\" });\n      }\n      res.json({ message: \"Document deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting document:\", error);\n      res.status(500).json({ message: \"Failed to delete document\" });\n    }\n  });\n\n  app.post(\"/api/admin/documents/bulk-delete\", isAdmin, async (req: any, res) => {\n    try {\n      const { ids } = req.body;\n      \n      if (!ids || !Array.isArray(ids) || ids.length === 0) {\n        return res.status(400).json({ message: \"No document IDs provided\" });\n      }\n\n      let deletedCount = 0;\n      let errors: string[] = [];\n\n      for (const id of ids) {\n        try {\n          const success = await storage.deleteDocument(id);\n          if (success) {\n            deletedCount++;\n          } else {\n            errors.push(`Document ${id} not found`);\n          }\n        } catch (err) {\n          errors.push(`Failed to delete document ${id}`);\n        }\n      }\n\n      res.json({ \n        message: `Deleted ${deletedCount} documents successfully`,\n        deletedCount,\n        errors: errors.length > 0 ? errors : undefined\n      });\n    } catch (error) {\n      console.error(\"Error bulk deleting documents:\", error);\n      res.status(500).json({ message: \"Failed to bulk delete documents\" });\n    }\n  });\n\n  app.get(\"/api/admin/users\", isAdmin, async (req: any, res) => {\n    try {\n      const users = await storage.getAllUsers();\n      res.json(users);\n    } catch (error) {\n      console.error(\"Error fetching users:\", error);\n      res.status(500).json({ message: \"Failed to fetch users\" });\n    }\n  });\n\n  app.get(\"/api/admin/users/recent\", isAdmin, async (req: any, res) => {\n    try {\n      const users = await storage.getRecentUsers(5);\n      res.json(users);\n    } catch (error) {\n      console.error(\"Error fetching recent users:\", error);\n      res.status(500).json({ message: \"Failed to fetch recent users\" });\n    }\n  });\n\n  app.patch(\"/api/admin/users/:id/role\", isAdmin, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const { role } = req.body;\n      \n      if (!role || ![\"admin\", \"user\"].includes(role)) {\n        return res.status(400).json({ message: \"Invalid role\" });\n      }\n\n      const user = await storage.updateUserRole(id, role);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      res.json(user);\n    } catch (error) {\n      console.error(\"Error updating user role:\", error);\n      res.status(500).json({ message: \"Failed to update user role\" });\n    }\n  });\n\n  // Update user points (only super admin yifeng260688@gmail.com can manage points)\n  const SUPER_ADMIN_EMAIL = \"yifeng260688@gmail.com\";\n  \n  const updatePointsSchema = z.object({\n    points: z.number().int().min(0, \"Points must be a non-negative integer\"),\n    reason: z.string().min(1, \"Reason is required\").max(500).optional(),\n  });\n  \n  app.patch(\"/api/admin/users/:id/points\", isAdmin, async (req: any, res) => {\n    try {\n      // Check if current user is the super admin\n      const currentUserEmail = req.user?.claims?.email;\n      const currentUserId = req.user?.claims?.sub;\n      \n      if (currentUserEmail !== SUPER_ADMIN_EMAIL) {\n        // Log unauthorized attempt for security monitoring\n        console.warn(`[SECURITY] Unauthorized points modification attempt by ${currentUserEmail} (${currentUserId}) for user ${req.params.id}`);\n        return res.status(403).json({ message: \"Only the super admin can manage user points\" });\n      }\n\n      const { id } = req.params;\n      \n      // Validate request body with Zod\n      const validationResult = updatePointsSchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          message: \"Invalid points value\", \n          errors: validationResult.error.errors \n        });\n      }\n      \n      const { points, reason } = validationResult.data;\n\n      // Get current user to record previous points\n      const targetUser = await storage.getUser(id);\n      if (!targetUser) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      \n      const previousPoints = targetUser.points || 0;\n      const changeAmount = points - previousPoints;\n      \n      // Update points\n      const user = await storage.updateUserPoints(id, points);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      // Also update LegitimatePoints to match (when super admin manually sets points)\n      // This ensures user won't be flagged as suspicious after manual adjustment\n      if (changeAmount > 0) {\n        // Adding points - record as legitimate\n        // recordLegitimateAward(userId, userEmail, amount, reason, adminEmail, relatedUploadId?)\n        await recordLegitimateAward(\n          id,                                                    // userId\n          targetUser.email || '',                                // userEmail\n          changeAmount,                                          // amount\n          reason || `Admin manual adjustment: +${changeAmount}`, // reason\n          currentUserEmail                                       // adminEmail (super admin email)\n        );\n      } else if (points === 0) {\n        // Reset to 0 - clear the legitimate points record too\n        const { LegitimatePoints } = await import(\"./models\");\n        await LegitimatePoints.updateOne(\n          { userId: id },\n          { \n            $set: { \n              totalLegitimatePoints: 0, \n              totalPointsUsed: 0 \n            } \n          }\n        );\n        console.log(`[POINTS] Reset legitimate points for user ${id} to 0`);\n      }\n\n      // Create security audit log\n      const auditLog = new PointsAuditLog({\n        _id: crypto.randomUUID(),\n        userId: id,\n        adminId: currentUserId,\n        adminEmail: currentUserEmail,\n        previousPoints,\n        newPoints: points,\n        changeAmount,\n        reason: reason || `ƒêi·ªÅu ch·ªânh ƒëi·ªÉm t·ª´ ${previousPoints} th√†nh ${points}`,\n        actionType: \"manual\",\n        ipAddress: req.ip || req.connection?.remoteAddress,\n        userAgent: req.get('User-Agent'),\n      });\n      await auditLog.save();\n      \n      console.log(`[AUDIT] Points updated for user ${id}: ${previousPoints} -> ${points} by ${currentUserEmail}`);\n      \n      res.json(user);\n    } catch (error) {\n      console.error(\"Error updating user points:\", error);\n      res.status(500).json({ message: \"Failed to update user points\" });\n    }\n  });\n  \n  // Get points audit log (super admin only)\n  app.get(\"/api/admin/points-audit\", isAdmin, async (req: any, res) => {\n    try {\n      const currentUserEmail = req.user?.claims?.email;\n      if (currentUserEmail !== SUPER_ADMIN_EMAIL) {\n        return res.status(403).json({ message: \"Only the super admin can view points audit log\" });\n      }\n      \n      const { userId, actionType, limit = 100 } = req.query;\n      const query: any = {};\n      if (userId) query.userId = userId;\n      if (actionType) query.actionType = actionType;\n      \n      const logs = await PointsAuditLog.find(query)\n        .sort({ createdAt: -1 })\n        .limit(parseInt(limit as string))\n        .lean();\n      \n      // Get user emails for display\n      const userIds = [...new Set(logs.map(log => log.userId))];\n      const users = await Promise.all(userIds.map(id => storage.getUser(id)));\n      const userMap = new Map(users.filter(Boolean).map(u => [u!.id, u!.email]));\n      \n      const enrichedLogs = logs.map(log => ({\n        ...log,\n        userEmail: userMap.get(log.userId) || \"Unknown\"\n      }));\n      \n      res.json(enrichedLogs);\n    } catch (error) {\n      console.error(\"Error fetching points audit log:\", error);\n      res.status(500).json({ message: \"Failed to fetch points audit log\" });\n    }\n  });\n\n  // Get redemption logs (super admin only)\n  app.get(\"/api/admin/redemption-logs\", isAdmin, async (req: any, res) => {\n    try {\n      const currentUserEmail = req.user?.claims?.email;\n      if (currentUserEmail !== SUPER_ADMIN_EMAIL) {\n        return res.status(403).json({ message: \"Only the super admin can view redemption logs\" });\n      }\n      \n      const { userId, documentId, limit = 100 } = req.query;\n      const query: any = {};\n      if (userId) query.userId = userId;\n      if (documentId) query.documentId = documentId;\n      \n      const logs = await RedemptionLog.find(query)\n        .sort({ createdAt: -1 })\n        .limit(parseInt(limit as string))\n        .lean();\n      \n      res.json(logs);\n    } catch (error) {\n      console.error(\"Error fetching redemption logs:\", error);\n      res.status(500).json({ message: \"Failed to fetch redemption logs\" });\n    }\n  });\n\n  // Admin: Get all users with legitimate points\n  app.get(\"/api/admin/legitimate-points\", isAdmin, async (req: any, res) => {\n    try {\n      const currentUserEmail = req.user?.claims?.email;\n      if (currentUserEmail !== SUPER_ADMIN_EMAIL) {\n        return res.status(403).json({ message: \"Only the super admin can view legitimate points\" });\n      }\n      \n      const records = await getAllUsersWithLegitimatePoints();\n      res.json(records);\n    } catch (error) {\n      console.error(\"Error fetching legitimate points:\", error);\n      res.status(500).json({ message: \"Failed to fetch legitimate points\" });\n    }\n  });\n\n  // Admin: Get users with current points for validation\n  app.get(\"/api/admin/users-points-validation\", isAdmin, async (req: any, res) => {\n    try {\n      const currentUserEmail = req.user?.claims?.email;\n      if (currentUserEmail !== SUPER_ADMIN_EMAIL) {\n        return res.status(403).json({ message: \"Only the super admin can view this data\" });\n      }\n      \n      // Get all users with points > 0, EXCLUDING super admin\n      const allUsers = await User.find({ \n        points: { $gt: 0 },\n        email: { $ne: SUPER_ADMIN_EMAIL }  // Exclude super admin\n      }).lean();\n      const legitRecords = await getAllUsersWithLegitimatePoints();\n      const legitMap = new Map(legitRecords.map(r => [r.userId, r]));\n      \n      const usersWithValidation = allUsers.map(user => {\n        const legit = legitMap.get(user._id);\n        const legitAvailable = legit ? legit.availablePoints : 0;\n        const isValid = user.points <= legitAvailable;\n        \n        return {\n          userId: user._id,\n          email: user.email,\n          firstName: user.firstName,\n          lastName: user.lastName,\n          currentPoints: user.points,\n          legitimatePoints: legit?.totalLegitimatePoints || 0,\n          pointsUsed: legit?.totalPointsUsed || 0,\n          availablePoints: legitAvailable,\n          isValid,\n          isBlocked: user.isBlocked || false,\n          blockedReason: user.blockedReason,\n          blockedAt: user.blockedAt,\n        };\n      });\n      \n      res.json(usersWithValidation);\n    } catch (error) {\n      console.error(\"Error fetching users points validation:\", error);\n      res.status(500).json({ message: \"Failed to fetch data\" });\n    }\n  });\n\n  // Admin: Block a user\n  app.post(\"/api/admin/users/:id/block\", isAdmin, async (req: any, res) => {\n    try {\n      const currentUserEmail = req.user?.claims?.email;\n      if (currentUserEmail !== SUPER_ADMIN_EMAIL) {\n        return res.status(403).json({ message: \"Only the super admin can block users\" });\n      }\n      \n      const { id } = req.params;\n      const { reason } = req.body;\n      \n      const result = await blockUser(id, reason || \"Blocked by admin\");\n      if (result) {\n        res.json({ success: true, message: \"User blocked successfully\" });\n      } else {\n        res.status(404).json({ message: \"User not found\" });\n      }\n    } catch (error) {\n      console.error(\"Error blocking user:\", error);\n      res.status(500).json({ message: \"Failed to block user\" });\n    }\n  });\n\n  // Admin: Unblock a user\n  app.post(\"/api/admin/users/:id/unblock\", isAdmin, async (req: any, res) => {\n    try {\n      const currentUserEmail = req.user?.claims?.email;\n      if (currentUserEmail !== SUPER_ADMIN_EMAIL) {\n        return res.status(403).json({ message: \"Only the super admin can unblock users\" });\n      }\n      \n      const { id } = req.params;\n      \n      const result = await unblockUser(id);\n      if (result) {\n        res.json({ success: true, message: \"User unblocked successfully\" });\n      } else {\n        res.status(404).json({ message: \"User not found\" });\n      }\n    } catch (error) {\n      console.error(\"Error unblocking user:\", error);\n      res.status(500).json({ message: \"Failed to unblock user\" });\n    }\n  });\n\n  // TEST ONLY: Set user points directly (bypasses legitimate tracking) - For testing auto-block feature\n  app.post(\"/api/admin/users/:id/set-points-test\", isAdmin, async (req: any, res) => {\n    try {\n      const currentUserEmail = req.user?.claims?.email;\n      if (currentUserEmail !== SUPER_ADMIN_EMAIL) {\n        return res.status(403).json({ message: \"Only the super admin can use this test endpoint\" });\n      }\n      \n      const { id } = req.params;\n      const { accountPoints, legitimatePoints } = req.body;\n      \n      if (typeof accountPoints !== 'number' || typeof legitimatePoints !== 'number') {\n        return res.status(400).json({ message: \"Both accountPoints and legitimatePoints are required as numbers\" });\n      }\n      \n      // Get user\n      const user = await storage.getUser(id);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      \n      // Set account points directly\n      const { User, LegitimatePoints } = await import(\"./models\");\n      await User.updateOne({ id }, { $set: { points: accountPoints } });\n      \n      // Set legitimate points directly\n      await LegitimatePoints.updateOne(\n        { userId: id },\n        { \n          $set: { \n            totalLegitimatePoints: legitimatePoints,\n            totalPointsUsed: 0,\n          }\n        },\n        { upsert: true }\n      );\n      \n      // Check validity\n      const isValid = accountPoints <= legitimatePoints;\n      \n      console.log(`[TEST] Set user ${id} - Account: ${accountPoints}, Legitimate: ${legitimatePoints}, Valid: ${isValid}`);\n      \n      res.json({ \n        success: true, \n        message: `User points set for testing`,\n        accountPoints,\n        legitimatePoints,\n        isValid,\n        warning: isValid ? null : \"User will be AUTO-BLOCKED when trying to redeem!\"\n      });\n    } catch (error) {\n      console.error(\"Error setting test points:\", error);\n      res.status(500).json({ message: \"Failed to set test points\" });\n    }\n  });\n\n  // Tag routes (admin-only for CRUD, public for reading)\n  app.get(\"/api/tags\", async (req: any, res) => {\n    try {\n      const tags = await storage.getAllTags();\n      res.json(tags);\n    } catch (error) {\n      console.error(\"Error fetching tags:\", error);\n      res.status(500).json({ message: \"Failed to fetch tags\" });\n    }\n  });\n\n  app.post(\"/api/admin/tags\", isAdmin, async (req: any, res) => {\n    try {\n      const tagData = insertTagSchema.parse(req.body);\n      const tag = await storage.createTag(tagData);\n      res.status(201).json(tag);\n    } catch (error: any) {\n      if (error.name === \"ZodError\") {\n        return res.status(400).json({ message: \"Invalid tag data\", errors: error.errors });\n      }\n      console.error(\"Error creating tag:\", error);\n      res.status(500).json({ message: \"Failed to create tag\" });\n    }\n  });\n\n  app.delete(\"/api/admin/tags/:id\", isAdmin, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const success = await storage.deleteTag(id);\n      if (!success) {\n        return res.status(404).json({ message: \"Tag not found\" });\n      }\n      res.json({ message: \"Tag deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting tag:\", error);\n      res.status(500).json({ message: \"Failed to delete tag\" });\n    }\n  });\n\n  app.get(\"/api/documents/:id/tags\", async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const tags = await storage.getDocumentTags(id);\n      res.json(tags);\n    } catch (error) {\n      console.error(\"Error fetching document tags:\", error);\n      res.status(500).json({ message: \"Failed to fetch document tags\" });\n    }\n  });\n\n  app.put(\"/api/admin/documents/:id/tags\", isAdmin, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const { tagIds } = req.body;\n      \n      if (!Array.isArray(tagIds)) {\n        return res.status(400).json({ message: \"tagIds must be an array\" });\n      }\n\n      await storage.setDocumentTags(id, tagIds);\n      const tags = await storage.getDocumentTags(id);\n      res.json(tags);\n    } catch (error) {\n      console.error(\"Error setting document tags:\", error);\n      res.status(500).json({ message: \"Failed to set document tags\" });\n    }\n  });\n\n  // User upload routes\n  app.get(\"/api/user-uploads\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const uploads = await storage.getUserUploads(userId);\n      res.json(uploads);\n    } catch (error) {\n      console.error(\"Error fetching user uploads:\", error);\n      res.status(500).json({ message: \"Failed to fetch uploads\" });\n    }\n  });\n\n  app.post(\"/api/user-uploads\", isAuthenticated, upload.single(\"file\"), async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const file = req.file;\n\n      // Check if user is blocked\n      const user = await storage.getUser(userId);\n      if (user?.isBlocked) {\n        // Delete uploaded file if exists\n        if (file && fs.existsSync(file.path)) {\n          fs.unlinkSync(file.path);\n        }\n        return res.status(403).json({ \n          message: \"T√†i kho·∫£n c·ªßa b·∫°n ƒë√£ b·ªã kh√≥a. B·∫°n kh√¥ng th·ªÉ upload file. Vui l√≤ng li√™n h·ªá admin ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£.\",\n          code: \"USER_BLOCKED\",\n          blockedReason: user.blockedReason\n        });\n      }\n\n      if (!file) {\n        return res.status(400).json({ message: \"No file uploaded\" });\n      }\n\n      // Calculate file hash for duplicate detection\n      const fileHash = await calculateFileHash(file.path);\n      \n      // Check for duplicate\n      const duplicateCheck = await storage.checkDuplicateFileHash(fileHash);\n      if (duplicateCheck.isDuplicate) {\n        console.log(`[Duplicate] File \"${file.originalname}\" is duplicate of \"${duplicateCheck.existingFileName}\"`);\n        // Delete the duplicate file\n        if (fs.existsSync(file.path)) {\n          fs.unlinkSync(file.path);\n        }\n        return res.status(400).json({ \n          message: `File tr√πng l·∫∑p! File \"${file.originalname}\" ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng v·ªõi t√™n \"${duplicateCheck.existingFileName}\".`\n        });\n      }\n\n      // Check available slot\n      const availableSlot = await storage.findAvailableSlot(userId);\n      if (availableSlot === null) {\n        // Delete uploaded file since we can't store it\n        fs.unlinkSync(file.path);\n        return res.status(400).json({ \n          message: \"Upload limit reached. You can only upload 2 files. Please delete an existing file first.\" \n        });\n      }\n\n      // Validate upload data matches schema requirements\n      const uploadData = {\n        userId,\n        slot: availableSlot,\n        fileName: file.originalname,\n        fileType: file.mimetype,\n        filePath: file.path,\n        fileSize: file.size,\n        fileHash: fileHash,\n      };\n\n      // Validate using Zod schema (will throw if invalid)\n      const validatedData = insertUserUploadSchema.parse(uploadData);\n\n      // Create upload record (database unique constraint prevents race conditions)\n      const upload = await storage.createUserUpload(validatedData);\n\n      // Trigger AI metadata generation asynchronously (non-blocking)\n      console.log(`[AI] User upload created: ${upload.id}, triggering AI processing...`);\n      processFileWithAI(file.path, file.mimetype, upload.id, 'user', storage).catch((error) => {\n        console.error(`[AI] Error processing user upload ${upload.id}:`, error);\n      });\n\n      res.json(upload);\n    } catch (error: any) {\n      console.error(\"Error uploading file:\", error);\n      // Clean up file if database operation failed\n      if (req.file?.path && fs.existsSync(req.file.path)) {\n        fs.unlinkSync(req.file.path);\n      }\n      \n      // Handle database constraint violations\n      if (error.code === '23505') { // PostgreSQL unique constraint violation\n        return res.status(400).json({ \n          message: \"Upload limit reached due to concurrent request. Please try again.\" \n        });\n      }\n      \n      // Handle Zod validation errors\n      if (error.name === 'ZodError') {\n        return res.status(400).json({ message: \"Invalid upload data\", errors: error.errors });\n      }\n      \n      res.status(500).json({ message: error.message || \"Failed to upload file\" });\n    }\n  });\n\n\n  // Admin upload routes (bulk uploads up to 500MB)\n  app.get(\"/api/admin/uploads\", isAdmin, async (req: any, res) => {\n    try {\n      const uploads = await storage.getAdminUploads();\n      res.json(uploads);\n    } catch (error) {\n      console.error(\"Error fetching admin uploads:\", error);\n      res.status(500).json({ message: \"Failed to fetch uploads\" });\n    }\n  });\n\n  app.post(\"/api/admin/uploads\", isAdmin, adminUpload.array(\"files\", 10), async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const files = req.files as Express.Multer.File[];\n      const category = req.body.category || null;\n      const subcategory = req.body.subcategory || null;\n\n      if (!files || files.length === 0) {\n        return res.status(400).json({ message: \"No files uploaded\" });\n      }\n\n      const uploads = [];\n      const duplicates: { fileName: string; existingFileName: string }[] = [];\n      \n      // Process each file\n      for (const file of files) {\n        try {\n          // Calculate file hash for duplicate detection\n          const fileHash = await calculateFileHash(file.path);\n          \n          // Check for duplicate\n          const duplicateCheck = await storage.checkDuplicateFileHash(fileHash);\n          if (duplicateCheck.isDuplicate) {\n            console.log(`[Duplicate] File \"${file.originalname}\" is duplicate of \"${duplicateCheck.existingFileName}\"`);\n            duplicates.push({\n              fileName: file.originalname,\n              existingFileName: duplicateCheck.existingFileName || 'unknown'\n            });\n            // Delete the duplicate file\n            if (fs.existsSync(file.path)) {\n              fs.unlinkSync(file.path);\n            }\n            continue; // Skip this file\n          }\n          \n          // Create upload record with category, subcategory and hash\n          const upload = await storage.createAdminUpload({\n            uploadedBy: userId,\n            fileName: file.originalname,\n            fileType: file.mimetype,\n            filePath: file.path,\n            fileSize: file.size,\n            fileHash: fileHash,\n            category: category,\n            subcategory: subcategory,\n          });\n\n          uploads.push(upload);\n\n          // Trigger pipeline processing asynchronously (only for Excel files)\n          // AI processing runs FIRST, then pipeline starts after AI completes\n          const isExcelFile = file.mimetype === \"application/vnd.ms-excel\" || \n                              file.mimetype === \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\";\n          \n          if (isExcelFile) {\n            // Run AI processing first, then pipeline - so AI metadata is available when document is created\n            console.log(`[AI+Pipeline] Admin upload created: ${upload.id}, starting AI processing first with category: ${category || 'none'}...`);\n            (async () => {\n              try {\n                // Wait for AI processing to complete\n                const aiResult = await processFileWithAI(file.path, file.mimetype, upload.id, 'admin', storage, category);\n                console.log(`[AI+Pipeline] AI processing completed for ${upload.id}: ${aiResult.success ? 'success' : 'failed'}`);\n                \n                // Now start pipeline processing (AI metadata will be available)\n                console.log(`[AI+Pipeline] Starting pipeline for ${upload.id}...`);\n                await processAdminUpload(upload.id, file.path, storage);\n              } catch (error) {\n                console.error(`[AI+Pipeline] Error processing admin upload ${upload.id}:`, error);\n              }\n            })();\n          } else {\n            // Update status to \"skipped\" for non-Excel files to avoid dangling \"pending\" records\n            console.log(`[Pipeline] Skipping pipeline for non-Excel file: ${file.mimetype}`);\n            await storage.updatePipelineStatus(upload.id, \"skipped\");\n          }\n        } catch (fileError: any) {\n          console.error(`Error processing file ${file.originalname}:`, fileError);\n          // Clean up this specific file if database operation failed\n          if (fs.existsSync(file.path)) {\n            fs.unlinkSync(file.path);\n          }\n          // Continue processing other files\n        }\n      }\n\n      // Return response with both successful uploads and duplicate info\n      if (uploads.length === 0 && duplicates.length > 0) {\n        return res.status(400).json({ \n          message: \"T·∫•t c·∫£ file ƒë·ªÅu b·ªã tr√πng l·∫∑p\",\n          duplicates \n        });\n      }\n\n      if (uploads.length === 0) {\n        return res.status(500).json({ message: \"Failed to process any files\" });\n      }\n\n      res.json({ \n        uploads, \n        duplicates: duplicates.length > 0 ? duplicates : undefined,\n        message: duplicates.length > 0 \n          ? `ƒê√£ upload ${uploads.length} file. ${duplicates.length} file b·ªã tr√πng l·∫∑p ƒë√£ b·ªã b·ªè qua.`\n          : undefined\n      });\n    } catch (error: any) {\n      console.error(\"Error uploading admin files:\", error);\n      // Clean up all files if request failed\n      if (req.files && Array.isArray(req.files)) {\n        for (const file of req.files) {\n          if (file.path && fs.existsSync(file.path)) {\n            fs.unlinkSync(file.path);\n          }\n        }\n      }\n      res.status(500).json({ message: error.message || \"Failed to upload files\" });\n    }\n  });\n\n  app.delete(\"/api/admin/uploads/:id\", isAdmin, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n\n      // Get upload to find file path\n      const uploads = await storage.getAdminUploads();\n      const upload = uploads.find(u => u.id === id);\n\n      if (!upload) {\n        return res.status(404).json({ message: \"Upload not found\" });\n      }\n\n      // Delete from database\n      const deleted = await storage.deleteAdminUpload(id);\n      if (!deleted) {\n        return res.status(404).json({ message: \"Upload not found\" });\n      }\n\n      // Delete file from filesystem\n      if (fs.existsSync(upload.filePath)) {\n        fs.unlinkSync(upload.filePath);\n      }\n\n      res.json({ message: \"Upload deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting admin upload:\", error);\n      res.status(500).json({ message: \"Failed to delete upload\" });\n    }\n  });\n\n  // Reprocess failed admin upload\n  app.post(\"/api/admin/uploads/:id/reprocess\", isAdmin, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      \n      const upload = await storage.getAdminUploadById(id);\n      if (!upload) {\n        return res.status(404).json({ message: \"Upload not found\" });\n      }\n      \n      if (upload.pipelineStatus !== \"failed\") {\n        return res.status(400).json({ message: \"Only failed uploads can be reprocessed\" });\n      }\n      \n      // Check if file exists\n      if (!fs.existsSync(upload.filePath)) {\n        return res.status(400).json({ message: \"File no longer exists on the server\" });\n      }\n      \n      // Reset status to pending and clear error\n      await storage.updatePipelineStatus(id, \"pending\");\n      \n      // Start pipeline processing asynchronously\n      processAdminUpload(id, upload.filePath, storage)\n        .catch((err: any) => console.error(`[Reprocess] Pipeline failed for ${id}:`, err));\n      \n      res.json({ message: \"Reprocessing started\" });\n    } catch (error: any) {\n      console.error(\"Error reprocessing admin upload:\", error);\n      res.status(500).json({ message: error.message || \"Failed to reprocess upload\" });\n    }\n  });\n\n  // User upload approval routes (admin only)\n  app.get(\"/api/admin/user-uploads\", isAdmin, async (req: any, res) => {\n    try {\n      const uploads = await storage.getAllUserUploads();\n      res.json(uploads);\n    } catch (error) {\n      console.error(\"Error fetching user uploads for review:\", error);\n      res.status(500).json({ message: \"Failed to fetch uploads\" });\n    }\n  });\n\n  app.patch(\"/api/admin/user-uploads/:id/approve\", isAdmin, async (req: any, res) => {\n    try {\n      const adminId = req.user.claims.sub;\n      const { id } = req.params;\n      const { category: selectedCategory, points } = req.body;\n\n      // Validate category is provided and exists\n      if (!selectedCategory || typeof selectedCategory !== 'string') {\n        return res.status(400).json({ message: \"Category is required\" });\n      }\n\n      // Verify category exists in the system\n      const allCategories = await storage.getAllCategories();\n      const validCategory = allCategories.find(cat => cat.name === selectedCategory);\n      if (!validCategory) {\n        return res.status(400).json({ message: \"Invalid category. Please select a valid category.\" });\n      }\n\n      const upload = await storage.approveUserUpload(id, adminId, selectedCategory);\n      \n      if (!upload) {\n        return res.status(404).json({ message: \"Upload not found\" });\n      }\n\n      // Award points to user if specified\n      const pointsToAward = parseInt(points) || 0;\n      if (pointsToAward > 0 && upload.userId) {\n        // Get current user points and add the new points\n        const user = await storage.getUser(upload.userId);\n        const currentPoints = user?.points || 0;\n        const newTotal = currentPoints + pointsToAward;\n        await storage.updateUserPoints(upload.userId, newTotal);\n        \n        // Log points award\n        const adminEmail = req.user?.claims?.email || \"unknown\";\n        const pointsLog = new PointsAuditLog({\n          _id: crypto.randomUUID(),\n          userId: upload.userId,\n          adminId: adminId,\n          adminEmail: adminEmail,\n          previousPoints: currentPoints,\n          newPoints: newTotal,\n          changeAmount: pointsToAward,\n          reason: `Th∆∞·ªüng ƒëi·ªÉm cho file \"${upload.fileName}\" ƒë∆∞·ª£c ph√™ duy·ªát`,\n          actionType: \"upload_reward\",\n          relatedUploadId: upload.id,\n        });\n        await pointsLog.save();\n        \n        // Record legitimate points if awarded by super admin\n        if (adminEmail === SUPER_ADMIN_EMAIL) {\n          await recordLegitimateAward(\n            upload.userId,\n            user?.email || \"unknown\",\n            pointsToAward,\n            `Th∆∞·ªüng ƒëi·ªÉm cho file \"${upload.fileName}\" ƒë∆∞·ª£c ph√™ duy·ªát`,\n            adminEmail,\n            upload.id\n          );\n        }\n        \n        console.log(`[Points] Awarded ${pointsToAward} points to user ${upload.userId} for approved upload ${upload.id} (total: ${newTotal})`);\n      }\n\n      // Create approval notification for user\n      if (upload.userId) {\n        const pointsMessage = pointsToAward > 0 ? ` B·∫°n ƒë∆∞·ª£c th∆∞·ªüng ${pointsToAward} ƒëi·ªÉm.` : '';\n        await (storage as any).createNotification({\n          type: 'single',\n          targetUserId: upload.userId,\n          senderId: adminId,\n          title: 'File ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát',\n          content: `File \"${upload.fileName}\" c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát v√† ƒëƒÉng th√†nh c√¥ng.${pointsMessage}`,\n        });\n        console.log(`[Notification] Sent approval notification to user ${upload.userId}`);\n      }\n\n      // Trigger pipeline processing asynchronously for approved upload\n      // AI processing runs FIRST, then pipeline starts after AI completes\n      const isExcelFile = upload.fileType === \"application/vnd.ms-excel\" || \n                          upload.fileType === \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\";\n      \n      if (isExcelFile) {\n        // Run AI processing first, then pipeline - so AI metadata is available when document is created\n        console.log(`[AI+Pipeline] User upload approved: ${upload.id}, starting AI processing first with category: ${selectedCategory}...`);\n        (async () => {\n          try {\n            // Wait for AI processing to complete\n            const aiResult = await processFileWithAI(upload.filePath, upload.fileType, upload.id, 'user', storage, selectedCategory);\n            console.log(`[AI+Pipeline] AI processing completed for user upload ${upload.id}: ${aiResult.success ? 'success' : 'failed'}`);\n            \n            // Now start pipeline processing (AI metadata will be available)\n            console.log(`[AI+Pipeline] Starting pipeline for user upload ${upload.id}...`);\n            await processUserUploadApproval(upload.id, upload.filePath, storage);\n          } catch (error) {\n            console.error(`[AI+Pipeline] Error processing approved user upload ${upload.id}:`, error);\n          }\n        })();\n      } else {\n        // For non-Excel files, create document immediately with AI-generated or default metadata\n        console.log(`[Document] Creating document from non-Excel approved upload: ${upload.id} with category: ${selectedCategory}`);\n        \n        // Trigger AI processing and create document after\n        (async () => {\n          try {\n            const aiResult = await processFileWithAI(upload.filePath, upload.fileType, upload.id, 'user', storage, selectedCategory);\n            console.log(`[AI] AI processing completed for non-Excel user upload ${upload.id}: ${aiResult.success ? 'success' : 'failed'}`);\n            \n            // Get updated upload with AI metadata\n            const updatedUpload = await storage.getUserUploadById(upload.id);\n            const fileName = path.basename(upload.filePath);\n            const fileUrl = `/User-Upload/${fileName}`;\n            \n            const title = updatedUpload?.aiGeneratedTitle || upload.fileName.replace(/\\.[^/.]+$/, \"\");\n            const description = updatedUpload?.aiGeneratedDescription || `T√†i li·ªáu ƒë∆∞·ª£c t·∫£i l√™n b·ªüi ng∆∞·ªùi d√πng: ${upload.fileName}`;\n            \n            const document = await storage.createDocument({\n              title,\n              description,\n              category: selectedCategory,\n              pageCount: 1,\n              coverImageUrl: fileUrl,\n              imageUrls: \"[]\",\n            });\n            console.log(`[Document] Created document ${document.id} from non-Excel upload ${upload.id}`);\n          } catch (error) {\n            console.error(`[AI+Document] Error processing non-Excel user upload ${upload.id}:`, error);\n          }\n        })();\n        \n        // Update status to \"skipped\" for non-Excel files\n        console.log(`[Pipeline] Skipping pipeline for non-Excel file: ${upload.fileType}`);\n        await storage.updateUserUploadPipelineStatus(upload.id, \"skipped\", undefined, new Date());\n      }\n\n      res.json(upload);\n    } catch (error) {\n      console.error(\"Error approving user upload:\", error);\n      res.status(500).json({ message: \"Failed to approve upload\" });\n    }\n  });\n\n  app.patch(\"/api/admin/user-uploads/:id/reject\", isAdmin, async (req: any, res) => {\n    try {\n      const adminId = req.user.claims.sub;\n      const { id } = req.params;\n      const { reason } = req.body;\n\n      // Validate reason is provided\n      if (!reason || typeof reason !== 'string' || !reason.trim()) {\n        return res.status(400).json({ message: \"Rejection reason is required\" });\n      }\n\n      const upload = await storage.rejectUserUpload(id, adminId);\n      \n      if (!upload) {\n        return res.status(404).json({ message: \"Upload not found\" });\n      }\n\n      // Create rejection notification for user with reason\n      if (upload.userId) {\n        await (storage as any).createNotification({\n          type: 'single',\n          targetUserId: upload.userId,\n          senderId: adminId,\n          title: 'File b·ªã t·ª´ ch·ªëi',\n          content: `File \"${upload.fileName}\" c·ªßa b·∫°n ƒë√£ b·ªã t·ª´ ch·ªëi. L√Ω do: ${reason.trim()}`,\n        });\n        console.log(`[Notification] Sent rejection notification to user ${upload.userId} with reason: ${reason.trim()}`);\n      }\n\n      res.json(upload);\n    } catch (error) {\n      console.error(\"Error rejecting user upload:\", error);\n      res.status(500).json({ message: \"Failed to reject upload\" });\n    }\n  });\n\n  // View user upload as HTML (for Excel files)\n  // Custom auth check that returns HTML error instead of JSON\n  app.get(\"/api/admin/user-uploads/:id/view-html\", async (req: any, res) => {\n    // Check authentication with HTML response\n    if (!req.isAuthenticated || !req.isAuthenticated()) {\n      const loginHtml = `\n<!DOCTYPE html>\n<html lang=\"vi\">\n<head>\n  <meta charset=\"UTF-8\">\n  <title>Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n</title>\n  <style>\n    body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; text-align: center; }\n    .container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; }\n    h1 { color: #f57c00; font-size: 18px; }\n    p { color: #666; font-size: 14px; }\n    a { color: #1976d2; text-decoration: none; font-weight: bold; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <h1>Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n</h1>\n    <p>Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i ƒë·ªÉ xem file.</p>\n    <p><a href=\"/\">ƒêƒÉng nh·∫≠p l·∫°i</a></p>\n  </div>\n</body>\n</html>`;\n      res.setHeader('Content-Type', 'text/html; charset=utf-8');\n      return res.status(401).send(loginHtml);\n    }\n    \n    // Check admin role\n    const userId = req.user?.claims?.sub;\n    if (!userId) {\n      return res.status(401).send('<html><body><h1>Unauthorized</h1></body></html>');\n    }\n    const user = await storage.getUser(userId);\n    if (!user || user.role !== \"admin\") {\n      return res.status(403).send('<html><body><h1>Forbidden - Admin access required</h1></body></html>');\n    }\n    try {\n      const { id } = req.params;\n      const upload = await storage.getUserUploadById(id);\n      \n      if (!upload) {\n        return res.status(404).json({ message: \"Upload not found\" });\n      }\n\n      let filePath = upload.filePath;\n      console.log(`[Admin View] Upload ID: ${id}, original filePath: ${filePath}`);\n      \n      // Try different path variations\n      if (!fs.existsSync(filePath)) {\n        // Try with current working directory\n        const cwdPath = path.join(process.cwd(), filePath);\n        console.log(`[Admin View] Trying cwd path: ${cwdPath}`);\n        if (fs.existsSync(cwdPath)) {\n          filePath = cwdPath;\n        } else {\n          // Try just the filename in User-Upload folder\n          const fileName = path.basename(filePath);\n          const userUploadPath = path.join(process.cwd(), 'User-Upload', fileName);\n          console.log(`[Admin View] Trying User-Upload path: ${userUploadPath}`);\n          if (fs.existsSync(userUploadPath)) {\n            filePath = userUploadPath;\n          } else {\n            console.log(`[Admin View] File not found at any path`);\n            // Return a user-friendly HTML page instead of JSON error\n            const errorHtml = `\n<!DOCTYPE html>\n<html lang=\"vi\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>File kh√¥ng t·ªìn t·∫°i</title>\n  <style>\n    body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; text-align: center; }\n    .container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto; }\n    h1 { color: #e53935; font-size: 20px; margin-bottom: 20px; }\n    p { color: #666; font-size: 14px; margin: 10px 0; }\n    .icon { font-size: 48px; margin-bottom: 20px; }\n    .filename { background: #f5f5f5; padding: 10px; border-radius: 4px; word-break: break-all; font-family: monospace; font-size: 12px; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"icon\">‚ö†Ô∏è</div>\n    <h1>File kh√¥ng t·ªìn t·∫°i tr√™n server</h1>\n    <p>File n√†y c√≥ th·ªÉ ƒë√£ b·ªã x√≥a ho·∫∑c upload b·ªã l·ªói.</p>\n    <div class=\"filename\">${upload.fileName}</div>\n    <p style=\"margin-top: 20px; color: #999; font-size: 12px;\">B·∫°n c√≥ th·ªÉ t·ª´ ch·ªëi upload n√†y v√† y√™u c·∫ßu user upload l·∫°i.</p>\n  </div>\n</body>\n</html>`;\n            res.setHeader('Content-Type', 'text/html; charset=utf-8');\n            return res.send(errorHtml);\n          }\n        }\n      }\n\n      // Check if file is Excel\n      const ext = path.extname(upload.fileName).toLowerCase();\n      if (ext !== '.xlsx' && ext !== '.xls') {\n        // Return a simple HTML page for non-Excel files\n        const htmlContent = `\n<!DOCTYPE html>\n<html lang=\"vi\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${upload.fileName}</title>\n  <style>\n    body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; text-align: center; }\n    .container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto; }\n    h1 { color: #333; font-size: 18px; margin-bottom: 20px; }\n    p { color: #666; font-size: 14px; }\n    .file-icon { font-size: 48px; margin-bottom: 20px; }\n    a { color: #4CAF50; text-decoration: none; font-weight: bold; }\n    a:hover { text-decoration: underline; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"file-icon\">${ext === '.pdf' ? 'üìÑ' : 'üìä'}</div>\n    <h1>${upload.fileName}</h1>\n    <p>Lo·∫°i file: ${upload.fileType}</p>\n    <p>K√≠ch th∆∞·ªõc: ${(upload.fileSize / 1024).toFixed(1)} KB</p>\n    <p style=\"margin-top: 20px;\">File n√†y kh√¥ng ph·∫£i Excel n√™n kh√¥ng th·ªÉ xem tr∆∞·ªõc d·∫°ng b·∫£ng.</p>\n    <p><a href=\"/api/admin/user-uploads/${id}/download\">T·∫£i v·ªÅ ƒë·ªÉ xem</a></p>\n  </div>\n</body>\n</html>`;\n        res.setHeader('Content-Type', 'text/html; charset=utf-8');\n        return res.send(htmlContent);\n      }\n\n      const xlsxModule = await import(\"xlsx\");\n      const xlsx = xlsxModule.default || xlsxModule;\n      const workbook = xlsx.readFile(filePath);\n      \n      let htmlContent = `\n<!DOCTYPE html>\n<html lang=\"vi\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${upload.fileName}</title>\n  <style>\n    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }\n    h1 { color: #333; font-size: 18px; margin-bottom: 20px; }\n    h2 { color: #555; font-size: 14px; margin: 20px 0 10px; background: #e0e0e0; padding: 8px; border-radius: 4px; }\n    table { border-collapse: collapse; width: 100%; background: white; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }\n    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }\n    th { background-color: #4CAF50; color: white; font-weight: bold; }\n    tr:nth-child(even) { background-color: #f9f9f9; }\n    tr:hover { background-color: #f1f1f1; }\n    .info { color: #666; margin-bottom: 10px; font-size: 12px; }\n  </style>\n</head>\n<body>\n  <h1>File: ${upload.fileName}</h1>\n  <p class=\"info\">Uploaded by: ${(upload as any).userEmail || 'Unknown'} | Size: ${(upload.fileSize / 1024).toFixed(1)} KB</p>\n`;\n\n      for (const sheetName of workbook.SheetNames) {\n        const sheet = workbook.Sheets[sheetName];\n        const jsonData = xlsx.utils.sheet_to_json(sheet, { header: 1 }) as any[][];\n        \n        htmlContent += `<h2>Sheet: ${sheetName} (${jsonData.length} rows)</h2>`;\n        htmlContent += '<table>';\n        \n        // Show ALL rows - no limit\n        for (let i = 0; i < jsonData.length; i++) {\n          const row = jsonData[i];\n          if (Array.isArray(row) && row.length > 0) {\n            htmlContent += '<tr>';\n            const tag = i === 0 ? 'th' : 'td';\n            for (const cell of row) {\n              const cellValue = cell !== null && cell !== undefined ? String(cell).substring(0, 100) : '';\n              htmlContent += `<${tag}>${cellValue}</${tag}>`;\n            }\n            htmlContent += '</tr>';\n          }\n        }\n        \n        htmlContent += '</table>';\n      }\n\n      htmlContent += '</body></html>';\n      \n      res.setHeader('Content-Type', 'text/html; charset=utf-8');\n      res.send(htmlContent);\n    } catch (error: any) {\n      console.error(\"Error viewing user upload as HTML:\", error);\n      res.status(500).json({ message: error.message || \"Failed to view file\" });\n    }\n  });\n\n  // Download user upload file\n  app.get(\"/api/admin/user-uploads/:id/download\", isAdmin, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const upload = await storage.getUserUploadById(id);\n      \n      if (!upload) {\n        return res.status(404).json({ message: \"Upload not found\" });\n      }\n\n      let filePath = upload.filePath;\n      \n      // Try different path variations\n      if (!fs.existsSync(filePath)) {\n        const cwdPath = path.join(process.cwd(), filePath);\n        if (fs.existsSync(cwdPath)) {\n          filePath = cwdPath;\n        } else {\n          const fileName = path.basename(filePath);\n          const userUploadPath = path.join(process.cwd(), 'User-Upload', fileName);\n          if (fs.existsSync(userUploadPath)) {\n            filePath = userUploadPath;\n          } else {\n            return res.status(404).json({ \n              message: \"File kh√¥ng t·ªìn t·∫°i tr√™n server. File c√≥ th·ªÉ ƒë√£ b·ªã x√≥a ho·∫∑c upload b·ªã l·ªói.\",\n              fileName: upload.fileName\n            });\n          }\n        }\n      }\n\n      res.download(filePath, upload.fileName);\n    } catch (error: any) {\n      console.error(\"Error downloading user upload:\", error);\n      res.status(500).json({ message: error.message || \"Failed to download file\" });\n    }\n  });\n\n  // Category routes\n  app.get(\"/api/categories\", async (_req, res) => {\n    try {\n      const categories = await storage.getAllCategories();\n      res.json(categories);\n    } catch (error) {\n      console.error(\"Error fetching categories:\", error);\n      res.status(500).json({ message: \"Failed to fetch categories\" });\n    }\n  });\n\n  // Configure multer for category logo uploads\n  const CATEGORY_LOGO_DIR = path.join(process.cwd(), \"Category-Logos\");\n  const categoryLogoStorage = multer.diskStorage({\n    destination: (_req, _file, cb) => {\n      if (!fs.existsSync(CATEGORY_LOGO_DIR)) {\n        fs.mkdirSync(CATEGORY_LOGO_DIR, { recursive: true, mode: 0o700 });\n      }\n      cb(null, CATEGORY_LOGO_DIR);\n    },\n    filename: (req: any, file, cb) => {\n      const now = new Date();\n      const timestamp = now.getTime();\n      const ext = path.extname(file.originalname);\n      const nameWithoutExt = path.basename(file.originalname, ext);\n      cb(null, `${nameWithoutExt}-${timestamp}${ext}`);\n    }\n  });\n\n  const categoryLogoUpload = multer({\n    storage: categoryLogoStorage,\n    limits: {\n      fileSize: 2 * 1024 * 1024, // 2MB max for logos\n    },\n    fileFilter: (_req, file, cb) => {\n      const allowedTypes = [\"image/jpeg\", \"image/png\", \"image/gif\", \"image/webp\", \"image/svg+xml\"];\n      if (allowedTypes.includes(file.mimetype)) {\n        cb(null, true);\n      } else {\n        cb(new Error(\"Invalid file type. Only images are allowed.\"));\n      }\n    }\n  });\n\n  app.post(\"/api/categories\", isAdmin, categoryLogoUpload.single('logo'), async (req: any, res) => {\n    try {\n      const { name, order } = req.body;\n      \n      if (!name) {\n        return res.status(400).json({ message: \"Category name is required\" });\n      }\n\n      const logoUrl = req.file ? `/Category-Logos/${req.file.filename}` : undefined;\n      \n      const category = await storage.createCategory({\n        name,\n        logoUrl,\n        order: order ? parseInt(order) : 0,\n      });\n\n      res.json(category);\n    } catch (error: any) {\n      console.error(\"Error creating category:\", error);\n      res.status(500).json({ message: \"Failed to create category\", error: error.message });\n    }\n  });\n\n  app.patch(\"/api/categories/:id\", isAdmin, categoryLogoUpload.single('logo'), async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const { name, order } = req.body;\n\n      const updateData: any = {};\n      if (name) updateData.name = name;\n      if (order !== undefined) updateData.order = parseInt(order);\n      if (req.file) updateData.logoUrl = `/Category-Logos/${req.file.filename}`;\n\n      const category = await storage.updateCategory(id, updateData);\n\n      if (!category) {\n        return res.status(404).json({ message: \"Category not found\" });\n      }\n\n      res.json(category);\n    } catch (error: any) {\n      console.error(\"Error updating category:\", error);\n      res.status(500).json({ message: \"Failed to update category\", error: error.message });\n    }\n  });\n\n  app.delete(\"/api/categories/:id\", isAdmin, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      \n      // Get category name first\n      const category = await storage.getCategoryById(id);\n      if (!category) {\n        return res.status(404).json({ message: \"Category not found\" });\n      }\n\n      // Check if any documents use this category\n      const allDocuments = await storage.getAllDocumentsForAdmin();\n      const documentsUsingCategory = allDocuments.filter(doc => doc.category === category.name);\n      \n      if (documentsUsingCategory.length > 0) {\n        return res.status(400).json({ \n          message: `Kh√¥ng th·ªÉ x√≥a danh m·ª•c v√¨ c√≥ ${documentsUsingCategory.length} t√†i li·ªáu ƒëang s·ª≠ d·ª•ng danh m·ª•c n√†y. Vui l√≤ng c·∫≠p nh·∫≠t ho·∫∑c x√≥a c√°c t√†i li·ªáu tr∆∞·ªõc.`\n        });\n      }\n\n      const deleted = await storage.deleteCategory(id);\n\n      if (!deleted) {\n        return res.status(404).json({ message: \"Category not found\" });\n      }\n\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting category:\", error);\n      res.status(500).json({ message: \"Failed to delete category\" });\n    }\n  });\n\n  // Subcategory routes\n  app.get(\"/api/subcategories\", async (req: any, res) => {\n    try {\n      const { categoryId } = req.query;\n      const query = categoryId ? { categoryId } : {};\n      const subcategories = await Subcategory.find(query).sort({ order: 1, name: 1 }).lean();\n      res.json(subcategories.map((s: any) => ({ ...s, id: s._id })));\n    } catch (error) {\n      console.error(\"Error fetching subcategories:\", error);\n      res.status(500).json({ message: \"Failed to fetch subcategories\" });\n    }\n  });\n\n  app.post(\"/api/subcategories\", isAdmin, async (req: any, res) => {\n    try {\n      const { name, categoryId, parentSubcategoryId, order } = req.body;\n      \n      if (!name || !categoryId) {\n        return res.status(400).json({ message: \"Name and categoryId are required\" });\n      }\n\n      // Check category exists\n      const category = await storage.getCategoryById(categoryId);\n      if (!category) {\n        return res.status(404).json({ message: \"Category not found\" });\n      }\n\n      // Validate parent subcategory if provided\n      if (parentSubcategoryId) {\n        const parentSub = await Subcategory.findById(parentSubcategoryId);\n        if (!parentSub) {\n          return res.status(404).json({ message: \"Parent subcategory not found\" });\n        }\n      }\n\n      const subcategory = new Subcategory({\n        _id: crypto.randomUUID(),\n        name: name.trim(),\n        categoryId,\n        parentSubcategoryId: parentSubcategoryId || null,\n        order: order !== undefined ? parseInt(order) : 0,\n      });\n\n      await subcategory.save();\n      res.status(201).json({ ...subcategory.toObject(), id: subcategory._id });\n    } catch (error: any) {\n      if (error.code === 11000) {\n        return res.status(400).json({ message: \"Subcategory with this name already exists in this category\" });\n      }\n      console.error(\"Error creating subcategory:\", error);\n      res.status(500).json({ message: \"Failed to create subcategory\" });\n    }\n  });\n\n  app.patch(\"/api/subcategories/:id\", isAdmin, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const { name, order } = req.body;\n\n      const updateData: any = { updatedAt: new Date() };\n      if (name) updateData.name = name.trim();\n      if (order !== undefined) updateData.order = parseInt(order);\n\n      const subcategory = await Subcategory.findByIdAndUpdate(id, updateData, { new: true }).lean();\n\n      if (!subcategory) {\n        return res.status(404).json({ message: \"Subcategory not found\" });\n      }\n\n      res.json({ ...subcategory, id: subcategory._id });\n    } catch (error: any) {\n      if (error.code === 11000) {\n        return res.status(400).json({ message: \"Subcategory with this name already exists in this category\" });\n      }\n      console.error(\"Error updating subcategory:\", error);\n      res.status(500).json({ message: \"Failed to update subcategory\" });\n    }\n  });\n\n  app.delete(\"/api/subcategories/:id\", isAdmin, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const result = await Subcategory.findByIdAndDelete(id);\n\n      if (!result) {\n        return res.status(404).json({ message: \"Subcategory not found\" });\n      }\n\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting subcategory:\", error);\n      res.status(500).json({ message: \"Failed to delete subcategory\" });\n    }\n  });\n\n  // ============ CHAT SUPPORT API ROUTES ============\n\n  // Helper to verify conversation ownership\n  const verifyConversationAccess = async (conversationId: string, userId?: string, guestId?: string) => {\n    const conversation = await storage.getConversationById(conversationId);\n    if (!conversation) return null;\n    \n    if (userId && conversation.userId === userId) return conversation;\n    if (guestId && conversation.guestId === guestId) return conversation;\n    \n    return null;\n  };\n\n  // Get or create conversation for current user\n  app.get(\"/api/support/conversation\", async (req: any, res) => {\n    try {\n      const userId = req.user?.claims?.sub;\n      const guestId = req.cookies?.guestId;\n\n      if (!userId && !guestId) {\n        return res.status(400).json({ message: \"User ID or Guest ID required\" });\n      }\n\n      const conversation = await storage.getOrCreateConversation(userId, guestId);\n      res.json(conversation);\n    } catch (error: any) {\n      console.error(\"Error getting conversation:\", error);\n      res.status(500).json({ message: \"Failed to get conversation\", error: error.message });\n    }\n  });\n\n  // Start a new conversation (generates server-side guestId for guests)\n  app.post(\"/api/support/conversation\", async (req: any, res) => {\n    try {\n      const userId = req.user?.claims?.sub;\n      const existingGuestId = req.cookies?.guestId;\n      const { guestName, guestEmail } = req.body;\n\n      let guestId = existingGuestId;\n      \n      if (!userId && !guestId) {\n        const crypto = await import(\"crypto\");\n        guestId = `guest-${Date.now()}-${crypto.randomBytes(12).toString(\"hex\")}`;\n      }\n\n      const conversation = await storage.getOrCreateConversation(userId, guestId, guestName, guestEmail);\n      \n      if (guestId && !userId) {\n        res.cookie(\"guestId\", guestId, {\n          httpOnly: true,\n          secure: process.env.NODE_ENV === \"production\",\n          sameSite: \"lax\",\n          maxAge: 30 * 24 * 60 * 60 * 1000,\n        });\n      }\n\n      res.json(conversation);\n    } catch (error: any) {\n      console.error(\"Error creating conversation:\", error);\n      res.status(500).json({ message: \"Failed to create conversation\", error: error.message });\n    }\n  });\n\n  // Get messages for a conversation (with ownership verification)\n  app.get(\"/api/support/conversation/:id/messages\", async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const userId = req.user?.claims?.sub;\n      const guestId = req.cookies?.guestId;\n\n      const conversation = await verifyConversationAccess(id, userId, guestId);\n      if (!conversation) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const messages = await storage.getMessagesByConversationId(id);\n      res.json(messages);\n    } catch (error: any) {\n      console.error(\"Error getting messages:\", error);\n      res.status(500).json({ message: \"Failed to get messages\", error: error.message });\n    }\n  });\n\n  // Send a message (user side with ownership verification)\n  app.post(\"/api/support/conversation/:id/messages\", async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const { content } = req.body;\n      const userId = req.user?.claims?.sub;\n      const guestId = req.cookies?.guestId;\n\n      if (!content || typeof content !== \"string\" || !content.trim() || content.length > 5000) {\n        return res.status(400).json({ message: \"Invalid message content\" });\n      }\n\n      const conversation = await verifyConversationAccess(id, userId, guestId);\n      if (!conversation) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const user = userId ? await storage.getUser(userId) : null;\n      const senderName = user \n        ? `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email \n        : \"Kh√°ch\";\n\n      const message = await storage.createMessage({\n        conversationId: id,\n        senderType: \"user\",\n        senderId: userId,\n        senderName,\n        content: content.trim(),\n      });\n\n      const { emitNewMessage } = await import(\"./socket\");\n      emitNewMessage(id, message);\n\n      res.json(message);\n    } catch (error: any) {\n      console.error(\"Error sending message:\", error);\n      res.status(500).json({ message: \"Failed to send message\", error: error.message });\n    }\n  });\n\n  // Mark messages as read (user side with ownership verification)\n  app.post(\"/api/support/conversation/:id/read\", async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const userId = req.user?.claims?.sub;\n      const guestId = req.cookies?.guestId;\n\n      const conversation = await verifyConversationAccess(id, userId, guestId);\n      if (!conversation) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      await storage.markMessagesAsRead(id, \"user\");\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error marking messages as read:\", error);\n      res.status(500).json({ message: \"Failed to mark messages as read\", error: error.message });\n    }\n  });\n\n  // ============ ADMIN CHAT SUPPORT API ROUTES ============\n\n  // Get all conversations (admin only)\n  app.get(\"/api/admin/support/conversations\", isAdmin, async (req: any, res) => {\n    try {\n      const conversations = await storage.getAllConversations();\n      \n      const conversationsWithUserInfo = await Promise.all(\n        conversations.map(async (conv: any) => {\n          let userName = conv.guestName || \"Kh√°ch\";\n          let userEmail = conv.guestEmail;\n          \n          if (conv.userId) {\n            const user = await storage.getUser(conv.userId);\n            if (user) {\n              userName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email || \"User\";\n              userEmail = user.email;\n            }\n          }\n          \n          return {\n            ...conv,\n            userName,\n            userEmail,\n          };\n        })\n      );\n\n      res.json(conversationsWithUserInfo);\n    } catch (error: any) {\n      console.error(\"Error getting conversations:\", error);\n      res.status(500).json({ message: \"Failed to get conversations\", error: error.message });\n    }\n  });\n\n  // Get single conversation (admin only)\n  app.get(\"/api/admin/support/conversations/:id\", isAdmin, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const conversation = await storage.getConversationById(id);\n      \n      if (!conversation) {\n        return res.status(404).json({ message: \"Conversation not found\" });\n      }\n\n      res.json(conversation);\n    } catch (error: any) {\n      console.error(\"Error getting conversation:\", error);\n      res.status(500).json({ message: \"Failed to get conversation\", error: error.message });\n    }\n  });\n\n  // Get messages for a conversation (admin only)\n  app.get(\"/api/admin/support/conversations/:id/messages\", isAdmin, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const messages = await storage.getMessagesByConversationId(id);\n      res.json(messages);\n    } catch (error: any) {\n      console.error(\"Error getting messages:\", error);\n      res.status(500).json({ message: \"Failed to get messages\", error: error.message });\n    }\n  });\n\n  // Send a message as admin\n  app.post(\"/api/admin/support/conversations/:id/messages\", isAdmin, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const { content } = req.body;\n      const adminId = req.user?.claims?.sub;\n\n      if (!content || !content.trim()) {\n        return res.status(400).json({ message: \"Message content required\" });\n      }\n\n      const admin = await storage.getUser(adminId);\n      const senderName = admin \n        ? `${admin.firstName || ''} ${admin.lastName || ''}`.trim() || \"Support\" \n        : \"Support\";\n\n      const message = await storage.createMessage({\n        conversationId: id,\n        senderType: \"admin\",\n        senderId: adminId,\n        senderName,\n        content: content.trim(),\n      });\n\n      const { emitNewMessage } = await import(\"./socket\");\n      emitNewMessage(id, message);\n\n      res.json(message);\n    } catch (error: any) {\n      console.error(\"Error sending admin message:\", error);\n      res.status(500).json({ message: \"Failed to send message\", error: error.message });\n    }\n  });\n\n  // Mark messages as read (admin side)\n  app.post(\"/api/admin/support/conversations/:id/read\", isAdmin, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      await storage.markMessagesAsRead(id, \"admin\");\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error marking messages as read:\", error);\n      res.status(500).json({ message: \"Failed to mark messages as read\", error: error.message });\n    }\n  });\n\n  // Update conversation status (admin only)\n  app.patch(\"/api/admin/support/conversations/:id\", isAdmin, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const { status } = req.body;\n\n      if (![\"active\", \"closed\"].includes(status)) {\n        return res.status(400).json({ message: \"Invalid status\" });\n      }\n\n      const conversation = await storage.updateConversationStatus(id, status);\n      \n      if (!conversation) {\n        return res.status(404).json({ message: \"Conversation not found\" });\n      }\n\n      const { emitConversationUpdate } = await import(\"./socket\");\n      emitConversationUpdate(conversation);\n\n      res.json(conversation);\n    } catch (error: any) {\n      console.error(\"Error updating conversation:\", error);\n      res.status(500).json({ message: \"Failed to update conversation\", error: error.message });\n    }\n  });\n\n  // ============ NOTIFICATION ROUTES ============\n\n  // Get notifications for current user\n  app.get(\"/api/notifications\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const notifications = await storage.getNotificationsForUser(userId);\n      res.json(notifications);\n    } catch (error: any) {\n      console.error(\"Error fetching notifications:\", error);\n      res.status(500).json({ message: \"Failed to fetch notifications\", error: error.message });\n    }\n  });\n\n  // Get unread notification count for current user\n  app.get(\"/api/notifications/unread-count\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const count = await storage.getUnreadNotificationCount(userId);\n      res.json({ count });\n    } catch (error: any) {\n      console.error(\"Error fetching unread count:\", error);\n      res.status(500).json({ message: \"Failed to fetch unread count\", error: error.message });\n    }\n  });\n\n  // Mark notification as read\n  app.post(\"/api/notifications/:id/read\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const { id } = req.params;\n      await storage.markNotificationAsRead(id, userId);\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error marking notification as read:\", error);\n      res.status(500).json({ message: \"Failed to mark notification as read\", error: error.message });\n    }\n  });\n\n  // Mark all notifications as read\n  app.post(\"/api/notifications/read-all\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      await storage.markAllNotificationsAsRead(userId);\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error marking all notifications as read:\", error);\n      res.status(500).json({ message: \"Failed to mark all notifications as read\", error: error.message });\n    }\n  });\n\n  // Admin: Get all users for sending notifications\n  app.get(\"/api/admin/users\", isAdmin, async (req: any, res) => {\n    try {\n      const users = await storage.getAllUsers();\n      res.json(users);\n    } catch (error: any) {\n      console.error(\"Error fetching users:\", error);\n      res.status(500).json({ message: \"Failed to fetch users\", error: error.message });\n    }\n  });\n\n  // Admin: Get all notifications\n  app.get(\"/api/admin/notifications\", isAdmin, async (req: any, res) => {\n    try {\n      const notifications = await storage.getAllNotifications();\n      res.json(notifications);\n    } catch (error: any) {\n      console.error(\"Error fetching all notifications:\", error);\n      res.status(500).json({ message: \"Failed to fetch notifications\", error: error.message });\n    }\n  });\n\n  // Admin: Create notification (send to all or single user)\n  app.post(\"/api/admin/notifications\", isAdmin, async (req: any, res) => {\n    try {\n      const senderId = req.user.claims.sub;\n      const { title, content, type, targetUserId } = req.body;\n\n      if (!title || !title.trim()) {\n        return res.status(400).json({ message: \"Title is required\" });\n      }\n      if (!content || !content.trim()) {\n        return res.status(400).json({ message: \"Content is required\" });\n      }\n      if (!type || ![\"all\", \"single\"].includes(type)) {\n        return res.status(400).json({ message: \"Type must be 'all' or 'single'\" });\n      }\n      if (type === \"single\" && !targetUserId) {\n        return res.status(400).json({ message: \"Target user ID is required for single notifications\" });\n      }\n\n      const sender = await storage.getUser(senderId);\n      const senderName = sender \n        ? `${sender.firstName || ''} ${sender.lastName || ''}`.trim() || \"Admin\" \n        : \"Admin\";\n\n      const notification = await storage.createNotification({\n        title: title.trim(),\n        content: content.trim(),\n        type,\n        targetUserId: type === \"single\" ? targetUserId : undefined,\n        senderId,\n        senderName,\n      });\n\n      res.json(notification);\n    } catch (error: any) {\n      console.error(\"Error creating notification:\", error);\n      res.status(500).json({ message: \"Failed to create notification\", error: error.message });\n    }\n  });\n\n  // Admin: Delete notification\n  app.delete(\"/api/admin/notifications/:id\", isAdmin, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const deleted = await storage.deleteNotification(id);\n      if (!deleted) {\n        return res.status(404).json({ message: \"Notification not found\" });\n      }\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error deleting notification:\", error);\n      res.status(500).json({ message: \"Failed to delete notification\", error: error.message });\n    }\n  });\n\n  // ============================================\n  // Points Redemption & Redeemed Files\n  // ============================================\n  \n  // Get user's redeemed files\n  app.get(\"/api/user/redeemed-files\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const mongoStorage = storage as MongoDBStorage;\n      const files = await mongoStorage.getUserRedeemedFiles(userId);\n      res.json(files);\n    } catch (error: any) {\n      console.error(\"Error fetching redeemed files:\", error);\n      res.status(500).json({ message: \"Failed to fetch redeemed files\", error: error.message });\n    }\n  });\n\n  // Redeem points for a document\n  app.post(\"/api/redeem/:documentId\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const { documentId } = req.params;\n      const mongoStorage = storage as MongoDBStorage;\n\n      // Get the document\n      const document = await mongoStorage.getDocumentById(documentId);\n      if (!document) {\n        return res.status(404).json({ message: \"Document not found\" });\n      }\n\n      // Check if already redeemed\n      const alreadyRedeemed = await mongoStorage.hasUserRedeemedDocument(userId, documentId);\n      if (alreadyRedeemed) {\n        return res.status(400).json({ message: \"B·∫°n ƒë√£ quy ƒë·ªïi t√†i li·ªáu n√†y r·ªìi\" });\n      }\n\n      // Get user and check points\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      // Check if user is blocked\n      if (user.isBlocked) {\n        return res.status(403).json({ \n          message: \"T√†i kho·∫£n c·ªßa b·∫°n ƒë√£ b·ªã kh√≥a do ph√°t hi·ªán ƒëi·ªÉm kh√¥ng h·ª£p l·ªá. Vui l√≤ng li√™n h·ªá admin.\",\n          blocked: true\n        });\n      }\n\n      const pointsCost = document.pointsCost || document.pageCount || 0;\n      if (user.points < pointsCost) {\n        return res.status(400).json({ \n          message: \"B·∫°n kh√¥ng ƒë·ªß ƒëi·ªÉm ƒë·ªÉ quy ƒë·ªïi t√†i li·ªáu n√†y\",\n          required: pointsCost,\n          current: user.points\n        });\n      }\n\n      // Validate points legitimacy before allowing redemption\n      const legitimacyCheck = await validateUserLegitimacy(userId);\n      if (!legitimacyCheck.isValid) {\n        // Block the user immediately\n        await blockUser(userId, legitimacyCheck.reason || \"ƒêi·ªÉm kh√¥ng h·ª£p l·ªá\");\n        console.error(`[Security] BLOCKED user ${userId} for illegitimate points: ${legitimacyCheck.reason}`);\n        return res.status(403).json({ \n          message: \"T√†i kho·∫£n c·ªßa b·∫°n ƒë√£ b·ªã kh√≥a do ph√°t hi·ªán ƒëi·ªÉm kh√¥ng h·ª£p l·ªá. Vui l√≤ng li√™n h·ªá admin.\",\n          blocked: true,\n          reason: legitimacyCheck.reason\n        });\n      }\n\n      // Import download function\n      const { downloadFromArchive, uploadToSpaces } = await import(\"./services/doSpaces\");\n      \n      // Download file from archive storage (secure - internal only)\n      const archiveKey = `Original-Files/${document.postId}.xlsx`;\n      const downloadResult = await downloadFromArchive(archiveKey);\n      \n      if (!downloadResult.success || !downloadResult.buffer) {\n        console.error(`[Redeem] Failed to download file for postId: ${document.postId}`);\n        return res.status(500).json({ message: \"Kh√¥ng th·ªÉ t·∫£i file t·ª´ kho l∆∞u tr·ªØ\" });\n      }\n\n      // Save file to a temporary location\n      const tempDir = path.join(process.cwd(), \"temp-redeem\");\n      if (!fs.existsSync(tempDir)) {\n        fs.mkdirSync(tempDir, { recursive: true });\n      }\n      \n      const tempFileName = `${userId}-${document.postId}.xlsx`;\n      const tempFilePath = path.join(tempDir, tempFileName);\n      fs.writeFileSync(tempFilePath, downloadResult.buffer);\n\n      // Upload to user's redeemed folder in public bucket\n      const userRedeemedKey = `Redeemed-Files/${userId}/${document.postId}.xlsx`;\n      const uploadResult = await uploadToSpaces({\n        localFilePath: tempFilePath,\n        remoteKey: userRedeemedKey,\n        isPublic: false, // Private - only accessible via signed URLs or direct download\n      });\n\n      // Clean up temp file\n      try {\n        fs.unlinkSync(tempFilePath);\n      } catch (e) {\n        console.warn(\"Failed to delete temp file:\", e);\n      }\n\n      if (!uploadResult.success) {\n        console.error(`[Redeem] Failed to upload to user's folder:`, uploadResult.error);\n        return res.status(500).json({ message: \"Kh√¥ng th·ªÉ l∆∞u file\" });\n      }\n\n      // Deduct points\n      const deducted = await mongoStorage.deductUserPoints(userId, pointsCost);\n      if (!deducted) {\n        return res.status(400).json({ message: \"Kh√¥ng th·ªÉ tr·ª´ ƒëi·ªÉm\" });\n      }\n\n      // Record points usage in legitimate points tracker\n      await recordPointsUsage(userId, pointsCost);\n\n      // Create redeemed file record\n      const redeemedFile = await mongoStorage.createUserRedeemedFile({\n        userId,\n        documentId,\n        postId: document.postId,\n        documentTitle: document.title,\n        fileName: `${document.postId}.xlsx`,\n        fileSize: downloadResult.fileSize || 0,\n        filePath: userRedeemedKey,\n        pointsCost,\n      });\n\n      // Create redemption log for admin dashboard\n      const previousPoints = user.points;\n      const newPoints = previousPoints - pointsCost;\n      const redemptionLog = new RedemptionLog({\n        _id: crypto.randomUUID(),\n        userId,\n        userEmail: req.user?.claims?.email || \"unknown\",\n        documentId,\n        documentTitle: document.title,\n        postId: document.postId,\n        pointsDeducted: pointsCost,\n        previousPoints,\n        newPoints,\n      });\n      await redemptionLog.save();\n\n      console.log(`[Redeem] User ${userId} redeemed document ${document.postId} for ${pointsCost} points`);\n\n      res.json({\n        success: true,\n        redeemedFile,\n        newPoints: user.points - pointsCost,\n      });\n    } catch (error: any) {\n      console.error(\"Error redeeming document:\", error);\n      res.status(500).json({ message: \"Failed to redeem document\", error: error.message });\n    }\n  });\n\n  // Download a redeemed file\n  app.get(\"/api/user/redeemed-files/:id/download\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const { id } = req.params;\n      const mongoStorage = storage as MongoDBStorage;\n\n      // Get the redeemed file record\n      const redeemedFile = await mongoStorage.getRedeemedFile(userId, id);\n      if (!redeemedFile) {\n        return res.status(404).json({ message: \"File not found\" });\n      }\n\n      // Download from public bucket (user's redeemed folder)\n      const { downloadFromArchive } = await import(\"./services/doSpaces\");\n      \n      // Use the regular spaces bucket for redeemed files\n      const { S3Client, GetObjectCommand } = await import(\"@aws-sdk/client-s3\");\n      \n      const DO_ENDPOINT = process.env.DO_ENDPOINT || \"https://sgp1.digitaloceanspaces.com\";\n      const DO_ACCESS_KEY = process.env.DO_ACCESS_KEY;\n      const DO_SECRET_KEY = process.env.DO_SECRET_KEY;\n      const bucketName = process.env.DO_BUCKET_NAME || \"data-ld1\";\n      \n      if (!DO_ACCESS_KEY || !DO_SECRET_KEY) {\n        return res.status(500).json({ message: \"Storage not configured\" });\n      }\n\n      const client = new S3Client({\n        endpoint: DO_ENDPOINT,\n        region: \"sgp1\",\n        credentials: {\n          accessKeyId: DO_ACCESS_KEY,\n          secretAccessKey: DO_SECRET_KEY,\n        },\n        forcePathStyle: false,\n      });\n\n      const getCommand = new GetObjectCommand({\n        Bucket: bucketName,\n        Key: redeemedFile.filePath,\n      });\n\n      const response = await client.send(getCommand);\n\n      if (!response.Body) {\n        return res.status(500).json({ message: \"Failed to download file\" });\n      }\n\n      // Set headers for file download\n      res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n      res.setHeader('Content-Disposition', `attachment; filename=\"${redeemedFile.fileName}\"`);\n      \n      // Stream the file to response\n      const stream = response.Body as any;\n      stream.pipe(res);\n    } catch (error: any) {\n      console.error(\"Error downloading redeemed file:\", error);\n      res.status(500).json({ message: \"Failed to download file\", error: error.message });\n    }\n  });\n\n  // Check if user has redeemed a document\n  app.get(\"/api/user/redeemed-check/:documentId\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const { documentId } = req.params;\n      const mongoStorage = storage as MongoDBStorage;\n      \n      const hasRedeemed = await mongoStorage.hasUserRedeemedDocument(userId, documentId);\n      res.json({ hasRedeemed });\n    } catch (error: any) {\n      console.error(\"Error checking redemption status:\", error);\n      res.status(500).json({ message: \"Failed to check redemption status\", error: error.message });\n    }\n  });\n\n  const httpServer = createServer(app);\n\n  // Setup Socket.IO\n  const { setupSocket } = await import(\"./socket\");\n  setupSocket(httpServer, storage);\n\n  return httpServer;\n}\n","path":null,"size_bytes":93519,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1056,"size_tokens":null},"client/src/hooks/useAuth.ts":{"content":"// Reference: javascript_log_in_with_replit blueprint\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { User } from \"@shared/schema\";\n\nexport function useAuth() {\n  const { data: user, isLoading } = useQuery<User>({\n    queryKey: [\"/api/auth/user\"],\n    retry: false,\n    refetchOnMount: true,\n    refetchOnWindowFocus: true,\n    staleTime: 0,\n  });\n\n  return {\n    user,\n    isLoading,\n    isAuthenticated: !!user,\n  };\n}\n","path":null,"size_bytes":437,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport cookieParser from \"cookie-parser\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\n\nconst app = express();\n\ndeclare module 'http' {\n  interface IncomingMessage {\n    rawBody: unknown\n  }\n}\napp.use(express.json({\n  verify: (req, _res, buf) => {\n    req.rawBody = buf;\n  }\n}));\napp.use(express.urlencoded({ extended: false }));\napp.use(cookieParser());\n\n// Serve uploaded files and pipeline outputs\napp.use('/uploads', express.static('uploads'));\napp.use('/User-Upload', express.static('User-Upload'));\napp.use('/Admin-Upload', express.static('Admin-Upload'));\napp.use('/Category-Logos', express.static('Category-Logos'));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"‚Ä¶\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n  });\n})();\n","path":null,"size_bytes":2547,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"client/src/pages/Home.tsx":{"content":"import { useState, useMemo, useCallback } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Header } from \"@/components/Header\";\nimport { SearchBar } from \"@/components/SearchBar\";\nimport { DocumentCard } from \"@/components/DocumentCard\";\nimport { SEOHead } from \"@/components/SEOHead\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Button } from \"@/components/ui/button\";\nimport { AlertCircle, Heart } from \"lucide-react\";\nimport type { DocumentWithFavorite } from \"@shared/schema\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\n\ninterface Category {\n  id: string;\n  name: string;\n  logoUrl?: string;\n  order: number;\n}\n\nexport default function Home() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [selectedCategory, setSelectedCategory] = useState<string>(\"all\");\n  const { toast } = useToast();\n\n  const { data: documents = [], isLoading, error } = useQuery<DocumentWithFavorite[]>({\n    queryKey: [\"/api/documents\"],\n  });\n\n  const { data: categories = [] } = useQuery<Category[]>({\n    queryKey: [\"/api/categories\"],\n  });\n\n  const toggleFavoriteMutation = useMutation({\n    mutationFn: async ({ documentId, isFavorited }: { documentId: string; isFavorited: boolean }) => {\n      if (isFavorited) {\n        await apiRequest(\"DELETE\", `/api/favorites/${documentId}`);\n      } else {\n        await apiRequest(\"POST\", \"/api/favorites\", { documentId });\n      }\n    },\n    onMutate: async ({ documentId, isFavorited }) => {\n      await queryClient.cancelQueries({ queryKey: [\"/api/documents\"] });\n      const previousDocuments = queryClient.getQueryData<DocumentWithFavorite[]>([\"/api/documents\"]);\n      queryClient.setQueryData<DocumentWithFavorite[]>([\"/api/documents\"], (old) => \n        old?.map((doc) => \n          doc.id === documentId \n            ? { ...doc, isFavorited: !isFavorited, favoriteCount: doc.favoriteCount + (isFavorited ? -1 : 1) }\n            : doc\n        )\n      );\n      return { previousDocuments };\n    },\n    onError: (error, variables, context) => {\n      if (context?.previousDocuments) {\n        queryClient.setQueryData([\"/api/documents\"], context.previousDocuments);\n      }\n      if (isUnauthorizedError(error as Error)) {\n        toast({\n          title: \"Ch∆∞a ƒëƒÉng nh·∫≠p\",\n          description: \"ƒêang chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang ƒëƒÉng nh·∫≠p...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"L·ªói\",\n        description: \"Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t y√™u th√≠ch. Vui l√≤ng th·ª≠ l·∫°i.\",\n        variant: \"destructive\",\n      });\n    },\n    onSettled: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/documents\"] });\n    },\n  });\n\n  const filteredDocuments = useMemo(() => {\n    let filtered = documents;\n\n    // Filter by search query\n    if (searchQuery.trim()) {\n      const query = searchQuery.toLowerCase();\n      filtered = filtered.filter(\n        (doc) =>\n          doc.title.toLowerCase().includes(query) ||\n          doc.description.toLowerCase().includes(query) ||\n          doc.category.toLowerCase().includes(query)\n      );\n    }\n\n    // Filter by category\n    if (selectedCategory === \"favorites\") {\n      filtered = filtered.filter((doc) => doc.isFavorited);\n    } else if (selectedCategory !== \"all\") {\n      filtered = filtered.filter((doc) => doc.category === selectedCategory);\n    }\n\n    return filtered;\n  }, [documents, searchQuery, selectedCategory]);\n\n  const seoDescription = `Th∆∞ vi·ªán ${documents.length} file data kh√°ch h√†ng, th√¥ng tin kh√°ch h√†ng, data doanh nghi·ªáp. Danh s√°ch kh√°ch h√†ng ch·∫•t l∆∞·ª£ng cao cho kinh doanh online hi·ªáu qu·∫£.`;\n  const seoKeywords = useMemo(() => {\n    const categoryNames = categories.map(c => c.name).join(\", \");\n    return `data kh√°ch h√†ng, th√¥ng tin kh√°ch h√†ng, data doanh nghi·ªáp, data kinh doanh, kinh doanh online, danh s√°ch kh√°ch h√†ng, ${categoryNames}`;\n  }, [categories]);\n\n  const categoryLogoMap = useMemo(() => {\n    const map: Record<string, string> = {};\n    categories.forEach(cat => {\n      if (cat.logoUrl) {\n        map[cat.name] = cat.logoUrl;\n      }\n    });\n    return map;\n  }, [categories]);\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* SEO Meta Tags */}\n      <SEOHead\n        title=\"Data Kh√°ch H√†ng - Th√¥ng Tin Kh√°ch H√†ng - Data Doanh Nghi·ªáp\"\n        description={seoDescription}\n        keywords={seoKeywords}\n        type=\"website\"\n        url={window.location.href}\n      />\n\n      <Header />\n\n      <main className=\"container max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\n        {/* Hero Section with H1 */}\n        <section className=\"mb-12\">\n          <div className=\"text-center mb-8\">\n            <h1 className=\"text-3xl sm:text-4xl font-bold mb-3\" data-testid=\"heading-main\">\n              Data Kh√°ch H√†ng - Th√¥ng Tin Kh√°ch H√†ng - Data Doanh Nghi·ªáp\n            </h1>\n            <p className=\"text-lg text-muted-foreground max-w-2xl mx-auto\">\n              Th∆∞ vi·ªán data kh√°ch h√†ng ch·∫•t l∆∞·ª£ng cao cho kinh doanh online. Danh s√°ch kh√°ch h√†ng, data kinh doanh c·∫≠p nh·∫≠t li√™n t·ª•c\n            </p>\n          </div>\n          <SearchBar value={searchQuery} onChange={setSearchQuery} />\n        </section>\n\n        {/* Category Filter */}\n        <div className=\"mb-8\">\n          <div className=\"flex flex-wrap gap-3\" data-testid=\"category-filter\">\n            {/* All categories button */}\n            <Button\n              variant={selectedCategory === \"all\" ? \"default\" : \"outline\"}\n              onClick={() => setSelectedCategory(\"all\")}\n              data-testid=\"category-all\"\n            >\n              T·∫•t c·∫£\n            </Button>\n            \n            {/* Favorites button */}\n            <Button\n              variant={selectedCategory === \"favorites\" ? \"default\" : \"outline\"}\n              onClick={() => setSelectedCategory(\"favorites\")}\n              data-testid=\"category-favorites\"\n            >\n              <Heart className=\"w-4 h-4 mr-2\" />\n              Y√™u th√≠ch\n            </Button>\n\n            {/* Dynamic categories from API */}\n            {categories.map((category) => (\n              <Button\n                key={category.id}\n                variant={selectedCategory === category.name ? \"default\" : \"outline\"}\n                onClick={() => setSelectedCategory(category.name)}\n                data-testid={`category-${category.id}`}\n              >\n                {category.logoUrl && (\n                  <img \n                    src={category.logoUrl} \n                    alt={category.name}\n                    className=\"w-12 h-12 mr-2 object-contain\"\n                  />\n                )}\n                {category.name}\n              </Button>\n            ))}\n          </div>\n        </div>\n\n        {/* Document Library Section */}\n        <section>\n          {/* Section Header with H2 */}\n          {!isLoading && (\n            <div className=\"mb-6\">\n              <h2 className=\"text-2xl font-bold mb-2\" data-testid=\"heading-library\">\n                {selectedCategory === \"favorites\" \n                  ? \"Data Y√™u Th√≠ch\" \n                  : selectedCategory === \"all\" \n                    ? \"Danh S√°ch Data Kh√°ch H√†ng\"\n                    : selectedCategory}\n              </h2>\n              <p className=\"text-sm text-muted-foreground\" data-testid=\"text-results-count\">\n                {filteredDocuments.length === 0\n                  ? \"Kh√¥ng t√¨m th·∫•y data n√†o\"\n                  : `T√¨m th·∫•y ${filteredDocuments.length} file data`}\n                {searchQuery && ` cho t·ª´ kh√≥a \"${searchQuery}\"`}\n              </p>\n            </div>\n          )}\n\n          {/* Error State */}\n          {error && (\n            <Alert variant=\"destructive\" className=\"mb-8\">\n              <AlertCircle className=\"h-4 w-4\" />\n              <AlertDescription>\n                Kh√¥ng th·ªÉ t·∫£i danh s√°ch t√†i li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.\n              </AlertDescription>\n            </Alert>\n          )}\n\n          {/* Loading State */}\n          {isLoading && (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6\">\n              {Array.from({ length: 8 }).map((_, i) => (\n                <div key={i} className=\"space-y-3\">\n                  <Skeleton className=\"aspect-video w-full rounded-lg\" />\n                  <Skeleton className=\"h-6 w-3/4\" />\n                  <Skeleton className=\"h-4 w-full\" />\n                  <Skeleton className=\"h-4 w-full\" />\n                  <div className=\"flex justify-between items-center pt-2\">\n                    <Skeleton className=\"h-4 w-20\" />\n                    <Skeleton className=\"h-8 w-8 rounded-full\" />\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n\n          {/* Documents Grid */}\n          {!isLoading && !error && filteredDocuments.length > 0 && (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6\">\n              {filteredDocuments.map((document) => (\n                <DocumentCard\n                  key={document.id}\n                  document={document}\n                  onFavoriteToggle={(documentId, isFavorited) =>\n                    toggleFavoriteMutation.mutate({ documentId, isFavorited })\n                  }\n                  isTogglingFavorite={toggleFavoriteMutation.isPending}\n                  categoryLogoUrl={categoryLogoMap[document.category]}\n                />\n              ))}\n            </div>\n          )}\n        </section>\n\n        {/* Empty State */}\n        {!isLoading && !error && filteredDocuments.length === 0 && (\n          <div className=\"text-center py-16\">\n            <div className=\"inline-flex items-center justify-center w-16 h-16 rounded-full bg-muted mb-4\">\n              <AlertCircle className=\"w-8 h-8 text-muted-foreground\" />\n            </div>\n            <h3 className=\"text-xl font-semibold mb-2\">Kh√¥ng t√¨m th·∫•y data</h3>\n            <p className=\"text-muted-foreground\">\n              {selectedCategory === \"favorites\"\n                ? \"B·∫°n ch∆∞a c√≥ data y√™u th√≠ch n√†o. H√£y th√™m v√†o t·ª´ danh s√°ch t·∫•t c·∫£!\"\n                : searchQuery\n                ? \"Th·ª≠ t√¨m ki·∫øm v·ªõi t·ª´ kh√≥a kh√°c ho·∫∑c x√≥a b·ªô l·ªçc.\"\n                : \"Ch∆∞a c√≥ data n√†o trong th∆∞ vi·ªán.\"}\n            </p>\n          </div>\n        )}\n      </main>\n    </div>\n  );\n}\n","path":null,"size_bytes":10734,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":710,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":1348,"size_tokens":null},"replit.md":{"content":"# Customer Data Document Library Platform\n\n## Overview\nThis platform is a Vietnamese-language document library specializing in customer data (\"Data kh√°ch h√†ng\"). It allows users to browse, search, favorite, and view documents with associated image galleries generated from Excel files. The project features automated Excel-to-PNG conversion with watermarks and data masking, dynamic category management, and real-time chat support.\n\n## User Preferences\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\n### Frontend Architecture\n- **Framework & Build System**: React 18 with TypeScript, Vite, Wouter for routing, TanStack Query for server state.\n- **UI Component System**: Shadcn/ui (Radix UI), Tailwind CSS (New York style, neutral palette), Inter font.\n- **State Management**: React Query for server state (aggressive caching), React hooks for local UI state.\n- **Image Gallery**: Custom ImageGallery component with navigation, thumbnails, and lightbox zoom functionality.\n\n### Backend Architecture\n- **Server Framework**: Express.js with TypeScript and Node.js (ESM).\n- **API Design**: RESTful endpoints, middleware for logging and error handling, JSON format.\n- **Data Access Layer**: `IStorage` interface abstraction, implemented with MongoDB Atlas and Mongoose ODM.\n- **Image Pipeline**: Excel ‚Üí PNG (Python with watermarks/masking) ‚Üí Document with image URLs array.\n\n### Database Architecture\n- **Database**: MongoDB Atlas Cluster (datald.h332t8m.mongodb.net).\n- **Collections**: `users`, `documents`, `favorites`, `tags`, `documenttags`, `useruploads`, `adminuploads`, `sessions`, `categories`.\n- **Document Schema**: Documents use `imageUrls` array (stored as JSON string) instead of video URLs.\n- **AI Metadata Fields**: `aiStatus`, `aiGeneratedTitle`, `aiGeneratedDescription`, `aiGeneratedAt`, `aiError` for uploads.\n- **Category System**: Documents store category names (strings) validated against centralized category list. 7 default categories auto-seeded: Casino, Doanh Nghi·ªáp, B·∫•t ƒê·ªông S·∫£n, Ng√¢n H√†ng, B·∫£o Hi·ªÉm, Email, Kh√°c.\n- **Query Patterns**: Mongoose populate, atomic updates (`$inc`), compound indexes, category-based filtering, delete protection.\n\n### Authentication & Authorization\n- **Authentication**: Replit Auth via OIDC (Passport.js), session-based state management (connect-mongo).\n- **Security**: HTTP-only secure cookies, session secret, CSRF protection, 401 error handling.\n\n### Admin Panel Features\n- **Bulk Upload System**: Admin-only, up to 10 files, 500MB limit per file, supports PDF, CSV, XLSX, real-time progress, pipeline status tracking, manual category selection.\n- **User Upload Approval Workflow**: Review and approve/reject user submissions (max 10 per user, 10MB limit), three-state approval, mandatory category selection during approval.\n- **Excel-to-PNG Pipeline**: Automated conversion using Python (Pandas, Jinja2, Playwright, Pillow) with:\n  - Watermark grid (5x3 pattern)\n  - Data masking for sensitive information\n  - Data leakage detection with auto-retry\n  - Cover photo generation\n- **Category Management System**: Admin can create/delete categories with logo upload capability (2MB limit). Delete protection prevents removal if documents reference it. Supports subcategories with expandable category rows.\n- **Subcategory System**: Each category can have multiple subcategories. Admin can create/edit/delete subcategories via the Categories management page. Subcategories stored in separate collection with compound unique index on (categoryId, name).\n- **User Points Check Page**: Admin page to view all users with points >= 1, with filtering and search capabilities.\n- **Document Gallery Controls**: Zoom in/out buttons in DocumentDetail page for image viewing.\n- **Notification System**: Admin can send notifications to all users or individual users. Users see notification bell icon with unread count in header. Notifications tracked per-user with read status.\n\n### Image Pipeline Details\n- **Script Location**: `server/pipeline/excel_to_png.py`\n- **Output Format**: PNG images with watermarks uploaded to Digital Ocean Spaces\n- **Cover Image**: First page/sheet used as `coverImageUrl`\n- **Image Structure**: Each image has `{sheet, page, url, isBlurred}` properties\n- **Blur Protection**: Images after first 10 are blurred (COVER_BLUR_RADIUS = 8, FREE_PREVIEW_IMAGES = 10)\n- **Original Files**: Saved to `Original-Files/` folder with PostID prefix (e.g., `1234567890-filename.xlsx`)\n- **Large File Splitting**: Files with >5000 data rows automatically split into multiple posts (max 500 pages/5000 rows per post) with P1-, P2-, P3- prefixes added to titles\n\n### Digital Ocean Spaces Integration\n- **Bucket**: data-ld1\n- **Region**: sgp1 (Singapore)\n- **CDN URL**: https://data-ld1.sgp1.cdn.digitaloceanspaces.com\n- **Folder Naming**: `PostID-OriginalFileName/` (e.g., `1234567890-CustomerData/`)\n- **Image Naming**: `001_SheetName_page1.png`, `002_SheetName_page2.png`, etc.\n- **Service Location**: `server/services/doSpaces.ts`\n- **Environment Variables**: `DO_ACCESS_KEY`, `DO_SECRET_KEY`\n\n## External Dependencies\n\n### Third-Party Services\n- **Replit Auth**: OIDC identity provider.\n- **MongoDB Atlas**: Cloud-hosted MongoDB database cluster.\n- **Google Gemini AI**: `gemini-flash-lite-latest` model for automatic metadata generation with category-aware SEO optimization.\n\n### AI Metadata Generation\n- **Model**: Google Gemini Flash Lite\n- **Category-Aware Prompts**: AI receives category context (Casino, Doanh Nghi·ªáp, B·∫•t ƒê·ªông S·∫£n, Ng√¢n H√†ng, B·∫£o Hi·ªÉm, Email, Kh√°c) to generate more relevant SEO titles and descriptions\n- **SEO Keywords**: Category-specific keyword suggestions (e.g., \"data casino\", \"kh√°ch VIP\", \"d·ªØ li·ªáu doanh nghi·ªáp\") help AI create optimized content\n- **Output**: Vietnamese SEO-optimized title (max 100 chars) and description (200-300 chars)\n- **Service Location**: `server/services/gemini.ts`, `server/services/aiProcessor.ts`\n\n### Media & Content\n- PNG images with watermarks (generated from Excel files).\n- Cover images (first page of document or static assets).\n\n### Build & Development Tools\n- **Mongoose**: MongoDB object modeling.\n- **pdf-parse**: PDF text extraction.\n- **xlsx**: Excel file parsing.\n- **csv-parse**: CSV file parsing.\n- **ESBuild**: Server-side bundling (production).\n- **TSX**: TypeScript execution (development).\n- **PostCSS with Autoprefixer**: CSS processing.\n- **Python Libraries**: Pandas, Jinja2, Playwright, Pillow for Excel-to-PNG pipeline.\n\n## Key File Locations\n- **Image Pipeline**: `server/pipeline/runner.ts`, `server/pipeline/excel_to_png.py`\n- **Document Model**: `server/models/index.ts` (DocumentModel with imageUrls array)\n- **Storage Layer**: `server/mongo-storage.ts` (handles imageUrls serialization)\n- **Frontend Gallery**: `client/src/pages/DocumentDetail.tsx` (ImageGallery component)\n- **Schema**: `shared/schema.ts` (documents table with imageUrls text field)\n","path":null,"size_bytes":6981,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4885,"size_tokens":null},"design_guidelines.md":{"content":"# Design Guidelines: DRM Video Document Library Platform\n\n## Design Approach\n\n**Selected Approach:** Design System (Material Design inspired) + Platform References (YouTube, Udemy, Notion)\n\n**Justification:** This is a utility-focused document library requiring efficient browsing, search, and video consumption. The interface prioritizes discoverability, quick scanning of content, and seamless video playback. Drawing from Material Design's structured approach while referencing successful content platforms ensures familiarity and optimal user experience.\n\n**Core Principles:**\n- Content-First: Cards and video player take visual priority\n- Efficient Navigation: Clear search and filtering mechanisms\n- Trust & Credibility: Professional presentation builds confidence in content\n- Scannable Hierarchy: Users can quickly assess document relevance\n\n---\n\n## Typography\n\n**Font Families:**\n- Primary: Inter (clean, excellent Vietnamese diacritics support)\n- Secondary: System UI fallback for performance\n\n**Hierarchy:**\n- Hero/Page Titles: text-4xl to text-5xl, font-bold\n- Card Titles: text-xl, font-semibold\n- Video Title (Detail Page): text-3xl, font-bold\n- Body/Descriptions: text-base, font-normal, line-height relaxed\n- Metadata (category, pages): text-sm, font-medium\n- Search Input: text-base\n\n---\n\n## Layout System\n\n**Spacing Primitives:** Use Tailwind units of 2, 4, 6, 8, 12, 16, 20 consistently\n- Component padding: p-4 to p-6\n- Section spacing: py-12 to py-20\n- Card gaps: gap-6 to gap-8\n- Video player margins: mx-auto with max-width constraints\n\n**Grid System:**\n- Homepage Cards: grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4\n- Container: max-w-7xl mx-auto px-4 to px-8\n- Detail Page: max-w-6xl mx-auto for video + info\n- Related Documents: grid-cols-1 md:grid-cols-2 lg:grid-cols-3\n\n---\n\n## Component Library\n\n### Navigation Header\n- Fixed top navigation with backdrop blur\n- Logo/brand on left\n- Centered search bar (expandable on mobile)\n- Right side: User avatar/login button, favorites count badge\n- Height: h-16, shadow-sm\n- Sticky positioning for persistent access\n\n### Homepage Components\n\n**Search Section:**\n- Prominent search bar: w-full md:max-w-2xl, h-12 to h-14\n- Search icon inside input (left side)\n- Real-time filtering indicators\n- Spacing: py-8 from navigation\n\n**Document Cards:**\n- Card structure: rounded-lg, shadow-md, hover:shadow-xl transition\n- Cover image: aspect-video, object-cover, rounded-t-lg\n- Image placeholder gradient if no cover\n- Card padding: p-4\n- Content layout (vertical stack with gap-3):\n  - Category badge (top): rounded-full pill, text-xs, px-3, py-1\n  - Title: text-xl, font-semibold, line-clamp-2\n  - Description: text-sm, line-clamp-3\n  - Footer row (flex justify-between):\n    - Page count icon + number\n    - Favorite button (heart icon, toggle state)\n- Hover state: scale-102, smooth transition\n- Clickable: entire card is interactive area\n\n### Document Detail Page Components\n\n**Top Information Section:**\n- Full-width container: py-8\n- Breadcrumb navigation: text-sm with category > document trail\n- Document metadata grid: 2-column on desktop, stack on mobile\n  - Left: Title (text-3xl), Description (text-base, max-w-3xl)\n  - Right: Stats card with rounded-lg border - Category, Page count, Views (future), Favorite button (prominent, larger size)\n- Spacing between metadata and video: py-6\n\n**Video Player Section:**\n- Centered container: max-w-5xl mx-auto\n- Aspect ratio: aspect-video\n- HTML5 video element with custom controls\n- Player wrapper: rounded-lg, shadow-2xl for elevation\n- DRM initialization indicators (loading states)\n- Responsive: w-full with appropriate max-width\n\n**Related Documents Section:**\n- Section header: \"T√†i li·ªáu li√™n quan\" - text-2xl, font-bold, py-12\n- Reuse homepage card design\n- Grid: 3 columns desktop, 2 tablet, 1 mobile\n- Limit to 6-9 related items\n- Section background: subtle contrast from main content\n\n### Authentication Components\n\n**Login Modal/Page:**\n- Centered card: max-w-md, rounded-xl, shadow-2xl\n- Replit Auth integration buttons: full-width, h-12\n- Social login icons (Google, GitHub) with provider branding\n- Divider: \"ho·∫∑c\" text with horizontal lines\n- Email/password inputs: h-11, rounded-lg, border focus states\n- Submit button: w-full, h-12, font-semibold\n- Links: \"ƒêƒÉng k√Ω\" / \"Qu√™n m·∫≠t kh·∫©u\" - text-sm\n\n**User Menu Dropdown:**\n- Trigger: Avatar circle - w-10, h-10, rounded-full\n- Dropdown: rounded-lg, shadow-xl, min-w-48\n- Menu items: py-2, px-4, hover background\n- Options: Profile, Favorites, Settings, Logout\n- Dividers between sections\n\n### Interactive Elements\n\n**Favorite Button:**\n- Icon-based: Heart outline (unfavorited), filled heart (favorited)\n- Size: w-8 h-8 minimum for touch targets\n- Animated transition on toggle\n- Tooltip: \"Th√™m v√†o y√™u th√≠ch\" / \"ƒê√£ l∆∞u\"\n- Counter display when applicable\n\n**Category Badges:**\n- Pill shape: rounded-full\n- Padding: px-3 py-1\n- Text: text-xs to text-sm, font-medium\n- Subtle background, slightly darker text\n- Clickable: filters by category\n\n**Search Input:**\n- Left icon: Magnifying glass\n- Placeholder: \"T√¨m ki·∫øm t√†i li·ªáu...\"\n- Clear button (X) when text entered\n- Dropdown suggestions (future enhancement area)\n- Border radius: rounded-lg\n- Focus state: ring treatment\n\n---\n\n## Images\n\n**Cover Images:**\n- Each document card requires a cover image\n- Dimensions: 16:9 aspect ratio (standard video thumbnail)\n- Fallback: Gradient background with document icon if no cover provided\n- Quality: Optimized for web, lazy loading\n\n**User Avatars:**\n- Circular crop: aspect-square\n- Sizes: 40px (navigation), 80px (profile)\n- Fallback: User initials on colored background\n\n**Hero Section:** None required - content discovery is immediate priority\n\n---\n\n## Animations\n\n**Minimal, purposeful motion:**\n- Card hover: scale-102, duration-200, ease-out\n- Favorite toggle: Heart scale pulse animation, duration-300\n- Page transitions: Fade-in for new content, duration-150\n- Video loading: Subtle spinner, positioned center\n- No auto-playing effects or distracting movements\n\n---\n\n## Responsive Behavior\n\n**Breakpoints:**\n- Mobile: Stack all grids to single column, larger touch targets\n- Tablet: 2-column card grid, search bar full width\n- Desktop: 3-4 column grid, navigation items visible\n- Large: 4-column grid maximum for optimal card size\n\n**Mobile Optimizations:**\n- Collapsible search (icon ‚Üí full bar)\n- Hamburger menu if needed for secondary navigation\n- Video player: full width with safe area considerations\n- Card images: slightly larger hit areas\n\n---\n\n## Accessibility\n\n- WCAG AA contrast ratios throughout\n- Focus indicators on all interactive elements (ring-2 on focus)\n- Semantic HTML: article for cards, main/section structure\n- Alt text for all images\n- ARIA labels for icon-only buttons\n- Keyboard navigation: Tab order logical, Enter activates\n- Video player: Native controls accessible, captions support ready\n\n---\n\n## Vietnamese Language Considerations\n\n- Inter font family fully supports Vietnamese diacritics\n- Line-height: relaxed (1.6-1.75) for readability with diacritics\n- Text rendering: antialiased for clarity\n- Proper text truncation that respects Vietnamese word boundaries (line-clamp utilities)","path":null,"size_bytes":7240,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":689,"size_tokens":null},"client/src/App.tsx":{"content":"// Reference: javascript_log_in_with_replit blueprint\nimport { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useDevToolsDetection } from \"@/hooks/useDevToolsDetection\";\nimport NotFound from \"@/pages/not-found\";\nimport Landing from \"@/pages/Landing\";\nimport Home from \"@/pages/Home\";\nimport DocumentDetail from \"@/pages/DocumentDetail\";\nimport AdminLayout from \"@/pages/admin/Layout\";\nimport AdminDashboard from \"@/pages/admin/Dashboard\";\nimport AdminDocuments from \"@/pages/admin/Documents\";\nimport AdminCategories from \"@/pages/admin/Categories\";\nimport AdminTags from \"@/pages/admin/Tags\";\nimport AdminUsers from \"@/pages/admin/Users\";\nimport AdminBulkUpload from \"@/pages/admin/BulkUpload\";\nimport AdminUserUploads from \"@/pages/admin/UserUploads\";\nimport AdminSupport from \"@/pages/admin/Support\";\nimport AdminNotifications from \"@/pages/admin/Notifications\";\nimport AdminUserPoints from \"@/pages/admin/UserPoints\";\nimport DocumentForm from \"@/pages/admin/DocumentForm\";\nimport { AdminRoute } from \"@/components/AdminRoute\";\nimport { ChatLauncher } from \"@/components/ChatWidget\";\n\nfunction Router() {\n  return (\n    <Switch>\n      {/* Public routes */}\n      <Route path=\"/\" component={Home} />\n      <Route path=\"/document/:id\" component={DocumentDetail} />\n      \n      {/* Admin routes - protected */}\n      <Route path=\"/admin\">\n        <AdminRoute>\n          <AdminLayout>\n            <AdminDashboard />\n          </AdminLayout>\n        </AdminRoute>\n      </Route>\n      <Route path=\"/admin/documents\">\n        <AdminRoute>\n          <AdminLayout>\n            <AdminDocuments />\n          </AdminLayout>\n        </AdminRoute>\n      </Route>\n      <Route path=\"/admin/categories\">\n        <AdminRoute>\n          <AdminLayout>\n            <AdminCategories />\n          </AdminLayout>\n        </AdminRoute>\n      </Route>\n      <Route path=\"/admin/tags\">\n        <AdminRoute>\n          <AdminLayout>\n            <AdminTags />\n          </AdminLayout>\n        </AdminRoute>\n      </Route>\n      <Route path=\"/admin/users\">\n        <AdminRoute>\n          <AdminLayout>\n            <AdminUsers />\n          </AdminLayout>\n        </AdminRoute>\n      </Route>\n      <Route path=\"/admin/bulk-upload\">\n        <AdminRoute>\n          <AdminLayout>\n            <AdminBulkUpload />\n          </AdminLayout>\n        </AdminRoute>\n      </Route>\n      <Route path=\"/admin/user-uploads\">\n        <AdminRoute>\n          <AdminLayout>\n            <AdminUserUploads />\n          </AdminLayout>\n        </AdminRoute>\n      </Route>\n      <Route path=\"/admin/support\">\n        <AdminRoute>\n          <AdminLayout>\n            <AdminSupport />\n          </AdminLayout>\n        </AdminRoute>\n      </Route>\n      <Route path=\"/admin/notifications\">\n        <AdminRoute>\n          <AdminNotifications />\n        </AdminRoute>\n      </Route>\n      <Route path=\"/admin/user-points\">\n        <AdminRoute>\n          <AdminUserPoints />\n        </AdminRoute>\n      </Route>\n      <Route path=\"/admin/documents/new\">\n        <AdminRoute>\n          <AdminLayout>\n            <DocumentForm />\n          </AdminLayout>\n        </AdminRoute>\n      </Route>\n      <Route path=\"/admin/documents/edit/:id\">\n        {(params) => (\n          <AdminRoute>\n            <AdminLayout>\n              <DocumentForm documentId={params.id} />\n            </AdminLayout>\n          </AdminRoute>\n        )}\n      </Route>\n      \n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction DevToolsProtection() {\n  useDevToolsDetection();\n  return null;\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <TooltipProvider>\n        <DevToolsProtection />\n        <Toaster />\n        <Router />\n        <ChatLauncher />\n      </TooltipProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":4058,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7609,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4281,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2154,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1527,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5128,"size_tokens":null},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":2263,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"shadcn-card rounded-xl border bg-card border-card-border text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n}\n","path":null,"size_bytes":1904,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":261,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":21846,"size_tokens":null},"client/src/pages/Landing.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport { FileText, Heart, Search, Video } from \"lucide-react\";\nimport { SiGoogle } from \"react-icons/si\";\n\nexport default function Landing() {\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Hero Section */}\n      <section className=\"relative overflow-hidden\">\n        <div className=\"absolute inset-0 bg-gradient-to-br from-primary/5 via-background to-background\" />\n        <div className=\"container relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20 sm:py-32\">\n          <div className=\"text-center space-y-8 max-w-4xl mx-auto\">\n            <div className=\"inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-primary/10 mb-4\">\n              <Video className=\"w-10 h-10 text-primary\" />\n            </div>\n            <h1 className=\"text-4xl sm:text-5xl lg:text-6xl font-bold tracking-tight\">\n              Th∆∞ vi·ªán T√†i li·ªáu\n              <span className=\"block text-primary mt-2\">Chuy√™n nghi·ªáp & B·∫£o m·∫≠t</span>\n            </h1>\n            <p className=\"text-xl text-muted-foreground leading-relaxed max-w-2xl mx-auto\">\n              Kh√°m ph√° h√†ng ngh√¨n t√†i li·ªáu chuy√™n nghi·ªáp ƒë∆∞·ª£c m√£ h√≥a DRM. T√¨m ki·∫øm, l∆∞u y√™u th√≠ch v√†\n              xem video tr·ª±c tuy·∫øn m·ªôt c√°ch an to√†n.\n            </p>\n            <div className=\"flex flex-col sm:flex-row gap-4 justify-center pt-4\">\n              <Button size=\"lg\" asChild className=\"text-lg h-12 px-8\" data-testid=\"button-login-hero\">\n                <a href=\"/api/auth/google\">\n                  <SiGoogle className=\"w-5 h-5 mr-2\" />\n                  ƒêƒÉng nh·∫≠p b·∫±ng Google\n                </a>\n              </Button>\n            </div>\n          </div>\n        </div>\n      </section>\n\n      {/* Features Section */}\n      <section className=\"py-20 sm:py-24 bg-muted/30\">\n        <div className=\"container max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\n          <div className=\"text-center mb-16\">\n            <h2 className=\"text-3xl sm:text-4xl font-bold mb-4\">T√≠nh nƒÉng n·ªïi b·∫≠t</h2>\n            <p className=\"text-lg text-muted-foreground max-w-2xl mx-auto\">\n              Tr·∫£i nghi·ªám xem t√†i li·ªáu chuy√™n nghi·ªáp v·ªõi ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng hi·ªán ƒë·∫°i\n            </p>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8\">\n            <Card className=\"p-6 space-y-4 hover-elevate transition-all duration-200\">\n              <div className=\"flex items-center justify-center w-12 h-12 rounded-lg bg-primary/10\">\n                <Search className=\"w-6 h-6 text-primary\" />\n              </div>\n              <h3 className=\"text-xl font-semibold\">T√¨m ki·∫øm th√¥ng minh</h3>\n              <p className=\"text-muted-foreground leading-relaxed\">\n                T√¨m ki·∫øm t√†i li·ªáu nhanh ch√≥ng theo t·ª´ kh√≥a, category ho·∫∑c n·ªôi dung. K·∫øt qu·∫£ hi·ªÉn th·ªã\n                ngay l·∫≠p t·ª©c.\n              </p>\n            </Card>\n\n            <Card className=\"p-6 space-y-4 hover-elevate transition-all duration-200\">\n              <div className=\"flex items-center justify-center w-12 h-12 rounded-lg bg-primary/10\">\n                <Video className=\"w-6 h-6 text-primary\" />\n              </div>\n              <h3 className=\"text-xl font-semibold\">Video DRM an to√†n</h3>\n              <p className=\"text-muted-foreground leading-relaxed\">\n                T·∫•t c·∫£ t√†i li·ªáu ƒë∆∞·ª£c m√£ h√≥a DRM chuy√™n nghi·ªáp. Xem video tr·ª±c tuy·∫øn v·ªõi HTML5 player\n                hi·ªán ƒë·∫°i.\n              </p>\n            </Card>\n\n            <Card className=\"p-6 space-y-4 hover-elevate transition-all duration-200\">\n              <div className=\"flex items-center justify-center w-12 h-12 rounded-lg bg-primary/10\">\n                <Heart className=\"w-6 h-6 text-primary\" />\n              </div>\n              <h3 className=\"text-xl font-semibold\">L∆∞u y√™u th√≠ch</h3>\n              <p className=\"text-muted-foreground leading-relaxed\">\n                L∆∞u l·∫°i c√°c t√†i li·ªáu quan tr·ªçng v√†o danh s√°ch y√™u th√≠ch c·ªßa b·∫°n. Truy c·∫≠p nhanh ch√≥ng\n                m·ªçi l√∫c m·ªçi n∆°i.\n              </p>\n            </Card>\n\n            <Card className=\"p-6 space-y-4 hover-elevate transition-all duration-200\">\n              <div className=\"flex items-center justify-center w-12 h-12 rounded-lg bg-primary/10\">\n                <FileText className=\"w-6 h-6 text-primary\" />\n              </div>\n              <h3 className=\"text-xl font-semibold\">Th∆∞ vi·ªán phong ph√∫</h3>\n              <p className=\"text-muted-foreground leading-relaxed\">\n                H√†ng ngh√¨n t√†i li·ªáu chuy√™n nghi·ªáp ƒë∆∞·ª£c ph√¢n lo·∫°i r√µ r√†ng theo nhi·ªÅu category kh√°c nhau.\n              </p>\n            </Card>\n\n            <Card className=\"p-6 space-y-4 hover-elevate transition-all duration-200\">\n              <div className=\"flex items-center justify-center w-12 h-12 rounded-lg bg-primary/10\">\n                <Search className=\"w-6 h-6 text-primary\" />\n              </div>\n              <h3 className=\"text-xl font-semibold\">G·ª£i √Ω th√¥ng minh</h3>\n              <p className=\"text-muted-foreground leading-relaxed\">\n                Kh√°m ph√° c√°c t√†i li·ªáu li√™n quan d·ª±a tr√™n n·ªôi dung b·∫°n ƒëang xem. M·ªü r·ªông ki·∫øn th·ª©c m·ªôt\n                c√°ch d·ªÖ d√†ng.\n              </p>\n            </Card>\n\n            <Card className=\"p-6 space-y-4 hover-elevate transition-all duration-200\">\n              <div className=\"flex items-center justify-center w-12 h-12 rounded-lg bg-primary/10\">\n                <Video className=\"w-6 h-6 text-primary\" />\n              </div>\n              <h3 className=\"text-xl font-semibold\">Xem m·ªçi thi·∫øt b·ªã</h3>\n              <p className=\"text-muted-foreground leading-relaxed\">\n                Giao di·ªán responsive ho√†n h·∫£o. Xem t√†i li·ªáu tr√™n m√°y t√≠nh, tablet ho·∫∑c ƒëi·ªán tho·∫°i m·ªôt\n                c√°ch m∆∞·ª£t m√†.\n              </p>\n            </Card>\n          </div>\n        </div>\n      </section>\n\n      {/* CTA Section */}\n      <section className=\"py-20 sm:py-24\">\n        <div className=\"container max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\n          <Card className=\"p-8 sm:p-12 text-center bg-gradient-to-br from-primary/5 to-background border-primary/20\">\n            <div className=\"max-w-2xl mx-auto space-y-6\">\n              <h2 className=\"text-3xl sm:text-4xl font-bold\">\n                S·∫µn s√†ng kh√°m ph√° th∆∞ vi·ªán?\n              </h2>\n              <p className=\"text-lg text-muted-foreground\">\n                ƒêƒÉng nh·∫≠p ngay ƒë·ªÉ truy c·∫≠p h√†ng ngh√¨n t√†i li·ªáu chuy√™n nghi·ªáp ƒë∆∞·ª£c m√£ h√≥a an to√†n.\n              </p>\n              <Button size=\"lg\" asChild className=\"text-lg h-12 px-8\" data-testid=\"button-login-cta\">\n                <a href=\"/api/auth/google\">\n                  <SiGoogle className=\"w-5 h-5 mr-2\" />\n                  ƒêƒÉng nh·∫≠p b·∫±ng Google\n                </a>\n              </Button>\n            </div>\n          </Card>\n        </div>\n      </section>\n    </div>\n  );\n}\n","path":null,"size_bytes":7147,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(`\n      after:content-[''] after:block after:absolute after:inset-0 after:rounded-full after:pointer-events-none after:border after:border-black/10 dark:after:border-white/10\n      relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full`,\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1592,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"shared/schema.ts":{"content":"// Reference: javascript_database blueprint\n// Drizzle ORM schema for PostgreSQL\nimport { pgTable, varchar, integer, timestamp, text } from \"drizzle-orm/pg-core\";\nimport { relations, sql } from \"drizzle-orm\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Users table\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().$defaultFn(() => crypto.randomUUID()),\n  email: varchar(\"email\", { length: 255 }),\n  firstName: varchar(\"first_name\", { length: 100 }),\n  lastName: varchar(\"last_name\", { length: 100 }),\n  profileImageUrl: text(\"profile_image_url\"),\n  role: varchar(\"role\", { length: 20 }).$type<\"admin\" | \"user\">().notNull().default(\"user\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\"),\n});\n\n// Documents table\nexport const documents = pgTable(\"documents\", {\n  id: varchar(\"id\").primaryKey().$defaultFn(() => crypto.randomUUID()),\n  postId: varchar(\"post_id\", { length: 10 }).notNull().unique(),\n  title: varchar(\"title\", { length: 500 }).notNull(),\n  description: text(\"description\").notNull(),\n  category: varchar(\"category\", { length: 100 }).notNull(),\n  pageCount: integer(\"page_count\").notNull().default(0),\n  coverImageUrl: text(\"cover_image_url\").notNull(),\n  imageUrls: text(\"image_urls\"),\n  viewCount: integer(\"view_count\").notNull().default(0),\n  favoriteCount: integer(\"favorite_count\").notNull().default(0),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\"),\n});\n\n// DocumentImage interface for imageUrls array\nexport interface DocumentImage {\n  sheet: string;\n  page: number;\n  url: string;\n  isBlurred?: boolean;\n}\n\n// Favorites table\nexport const favorites = pgTable(\"favorites\", {\n  id: varchar(\"id\").primaryKey().$defaultFn(() => crypto.randomUUID()),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  documentId: varchar(\"document_id\").notNull().references(() => documents.id, { onDelete: \"cascade\" }),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Tags table\nexport const tags = pgTable(\"tags\", {\n  id: varchar(\"id\").primaryKey().$defaultFn(() => crypto.randomUUID()),\n  name: varchar(\"name\", { length: 100 }).notNull().unique(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Document tags junction table\nexport const documentTags = pgTable(\"document_tags\", {\n  id: varchar(\"id\").primaryKey().$defaultFn(() => crypto.randomUUID()),\n  documentId: varchar(\"document_id\").notNull().references(() => documents.id, { onDelete: \"cascade\" }),\n  tagId: varchar(\"tag_id\").notNull().references(() => tags.id, { onDelete: \"cascade\" }),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// User uploads table\nexport const userUploads = pgTable(\"user_uploads\", {\n  id: varchar(\"id\").primaryKey().$defaultFn(() => crypto.randomUUID()),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  slot: integer(\"slot\").notNull(),\n  fileName: varchar(\"file_name\", { length: 500 }).notNull(),\n  fileType: varchar(\"file_type\", { length: 150 }).notNull(),\n  filePath: text(\"file_path\").notNull(),\n  fileSize: integer(\"file_size\").notNull(),\n  approvalStatus: varchar(\"approval_status\", { length: 20 }).$type<\"pending\" | \"approved\" | \"rejected\">().notNull().default(\"pending\"),\n  reviewedBy: varchar(\"reviewed_by\"),\n  reviewedAt: timestamp(\"reviewed_at\"),\n  approvedCategory: varchar(\"approved_category\", { length: 100 }),\n  pipelineStatus: varchar(\"pipeline_status\", { length: 20 }).$type<\"not_started\" | \"processing\" | \"completed\" | \"failed\" | \"skipped\">(),\n  pipelineStartedAt: timestamp(\"pipeline_started_at\"),\n  pipelineCompletedAt: timestamp(\"pipeline_completed_at\"),\n  aiStatus: varchar(\"ai_status\", { length: 20 }).$type<\"pending\" | \"processing\" | \"completed\" | \"failed\">(),\n  aiGeneratedTitle: varchar(\"ai_generated_title\", { length: 500 }),\n  aiGeneratedDescription: text(\"ai_generated_description\"),\n  aiGeneratedCategory: varchar(\"ai_generated_category\", { length: 100 }),\n  aiGeneratedAt: timestamp(\"ai_generated_at\"),\n  aiError: text(\"ai_error\"),\n  uploadedAt: timestamp(\"uploaded_at\").notNull().defaultNow(),\n});\n\n// Admin uploads table\nexport const adminUploads = pgTable(\"admin_uploads\", {\n  id: varchar(\"id\").primaryKey().$defaultFn(() => crypto.randomUUID()),\n  uploadedBy: varchar(\"uploaded_by\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  fileName: varchar(\"file_name\", { length: 500 }).notNull(),\n  fileType: varchar(\"file_type\", { length: 150 }).notNull(),\n  filePath: text(\"file_path\").notNull(),\n  fileSize: integer(\"file_size\").notNull(),\n  category: varchar(\"category\", { length: 100 }),\n  pipelineStatus: varchar(\"pipeline_status\", { length: 20 }).$type<\"not_started\" | \"processing\" | \"completed\" | \"failed\" | \"skipped\">().notNull().default(\"not_started\"),\n  pipelineError: text(\"pipeline_error\"),\n  pipelineStartedAt: timestamp(\"pipeline_started_at\"),\n  pipelineCompletedAt: timestamp(\"pipeline_completed_at\"),\n  aiStatus: varchar(\"ai_status\", { length: 20 }).$type<\"pending\" | \"processing\" | \"completed\" | \"failed\">(),\n  aiGeneratedTitle: varchar(\"ai_generated_title\", { length: 500 }),\n  aiGeneratedDescription: text(\"ai_generated_description\"),\n  aiGeneratedCategory: varchar(\"ai_generated_category\", { length: 100 }),\n  aiGeneratedAt: timestamp(\"ai_generated_at\"),\n  aiError: text(\"ai_error\"),\n  uploadedAt: timestamp(\"uploaded_at\").notNull().defaultNow(),\n});\n\n// Define relations\nexport const usersRelations = relations(users, ({ many }) => ({\n  favorites: many(favorites),\n  userUploads: many(userUploads),\n  adminUploads: many(adminUploads),\n}));\n\nexport const documentsRelations = relations(documents, ({ many }) => ({\n  favorites: many(favorites),\n  documentTags: many(documentTags),\n}));\n\nexport const favoritesRelations = relations(favorites, ({ one }) => ({\n  user: one(users, {\n    fields: [favorites.userId],\n    references: [users.id],\n  }),\n  document: one(documents, {\n    fields: [favorites.documentId],\n    references: [documents.id],\n  }),\n}));\n\nexport const tagsRelations = relations(tags, ({ many }) => ({\n  documentTags: many(documentTags),\n}));\n\nexport const documentTagsRelations = relations(documentTags, ({ one }) => ({\n  document: one(documents, {\n    fields: [documentTags.documentId],\n    references: [documents.id],\n  }),\n  tag: one(tags, {\n    fields: [documentTags.tagId],\n    references: [tags.id],\n  }),\n}));\n\nexport const userUploadsRelations = relations(userUploads, ({ one }) => ({\n  user: one(users, {\n    fields: [userUploads.userId],\n    references: [users.id],\n  }),\n}));\n\nexport const adminUploadsRelations = relations(adminUploads, ({ one }) => ({\n  user: one(users, {\n    fields: [adminUploads.uploadedBy],\n    references: [users.id],\n  }),\n}));\n\n// TypeScript types inferred from Drizzle tables\nexport type User = typeof users.$inferSelect;\nexport type InsertUser = typeof users.$inferInsert;\n\nexport type Document = typeof documents.$inferSelect;\nexport type InsertDocument = typeof documents.$inferInsert;\n\nexport type Favorite = typeof favorites.$inferSelect;\nexport type InsertFavorite = typeof favorites.$inferInsert;\n\nexport type Tag = typeof tags.$inferSelect;\nexport type InsertTag = typeof tags.$inferInsert;\n\nexport type DocumentTag = typeof documentTags.$inferSelect;\nexport type InsertDocumentTag = typeof documentTags.$inferInsert;\n\nexport type UserUpload = typeof userUploads.$inferSelect;\nexport type InsertUserUpload = typeof userUploads.$inferInsert;\n\nexport type AdminUpload = typeof adminUploads.$inferSelect;\nexport type InsertAdminUpload = typeof adminUploads.$inferInsert;\n\n// Extended types for API responses\nexport interface DocumentWithFavorite extends Document {\n  isFavorited: boolean;\n}\n\nexport interface DocumentWithTags extends Document {\n  tags: Tag[];\n}\n\nexport interface UserUploadWithUser extends UserUpload {\n  user?: {\n    id: string;\n    email?: string;\n    firstName?: string;\n    lastName?: string;\n  };\n}\n\n// Zod validation schemas using drizzle-zod\nexport const insertDocumentSchema = createInsertSchema(documents, {\n  title: z.string().min(1, \"Title is required\"),\n  description: z.string().min(1, \"Description is required\"),\n  category: z.string().min(1, \"Category is required\"),\n  pageCount: z.number().int().positive(\"Page count must be positive\"),\n  coverImageUrl: z.string().min(1, \"Cover image is required\"),\n  imageUrls: z.string().optional(),\n}).omit({\n  id: true,\n  viewCount: true,\n  favoriteCount: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertFavoriteSchema = createInsertSchema(favorites).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertTagSchema = createInsertSchema(tags, {\n  name: z.string().min(1, \"Tag name is required\").max(50, \"Tag name too long\"),\n}).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertUserUploadSchema = createInsertSchema(userUploads, {\n  slot: z.number().int().min(1).max(10, \"Slot must be between 1 and 10\"),\n  fileName: z.string().min(1),\n  fileType: z.string().min(1),\n  filePath: z.string().min(1),\n  fileSize: z.number().int().positive(),\n}).omit({\n  id: true,\n  approvalStatus: true,\n  reviewedBy: true,\n  reviewedAt: true,\n  pipelineStatus: true,\n  pipelineStartedAt: true,\n  pipelineCompletedAt: true,\n  aiStatus: true,\n  aiGeneratedTitle: true,\n  aiGeneratedDescription: true,\n  aiGeneratedCategory: true,\n  aiGeneratedAt: true,\n  aiError: true,\n  uploadedAt: true,\n});\n","path":null,"size_bytes":9503,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":157,"size_tokens":null},"server/storage.ts":{"content":"// Storage interface - defines contract for database operations\n// Implementation: server/mongo-storage.ts (MongoDB/Mongoose)\n// Note: This file only contains interface definitions, no implementation\n\nimport type {\n  User,\n  Document,\n  Favorite,\n  Tag,\n  DocumentTag,\n  DocumentWithFavorite,\n  UserUpload,\n  AdminUpload,\n} from \"@shared/schema\";\nimport type { ICategory, IChatConversation, IChatMessage } from \"./models\";\n\nexport interface IStorage {\n  // User operations (REQUIRED for Replit Auth)\n  getUser(id: string): Promise<User | undefined>;\n  upsertUser(user: Partial<User> & { id: string }): Promise<User>;\n\n  // Document operations\n  getAllDocuments(userId?: string): Promise<DocumentWithFavorite[]>;\n  getDocumentById(id: string, userId?: string): Promise<DocumentWithFavorite | undefined>;\n  getRelatedDocuments(documentId: string, userId?: string): Promise<DocumentWithFavorite[]>;\n  createDocument(document: Partial<Document>): Promise<Document>;\n  updateDocument(id: string, document: Partial<Document>): Promise<Document | undefined>;\n  deleteDocument(id: string): Promise<boolean>;\n  incrementViewCount(id: string): Promise<void>;\n\n  // Favorite operations\n  addFavorite(favorite: Partial<Favorite>): Promise<Favorite>;\n  removeFavorite(userId: string, documentId: string): Promise<boolean>;\n  getUserFavorites(userId: string): Promise<string[]>;\n\n  // Tag operations\n  getAllTags(): Promise<Tag[]>;\n  createTag(tag: Partial<Tag>): Promise<Tag>;\n  deleteTag(id: string): Promise<boolean>;\n  getDocumentTags(documentId: string): Promise<Tag[]>;\n  setDocumentTags(documentId: string, tagIds: string[]): Promise<void>;\n\n  // Admin operations\n  getAllUsers(): Promise<User[]>;\n  getRecentUsers(limit: number): Promise<User[]>;\n  updateUserRole(userId: string, role: string): Promise<User | undefined>;\n  getAllDocumentsForAdmin(): Promise<Document[]>;\n  getDocumentByIdForAdmin(id: string): Promise<Document | undefined>;\n  getRecentDocuments(limit: number): Promise<Document[]>;\n  getAdminStats(): Promise<{\n    totalDocuments: number;\n    totalUsers: number;\n    totalFavorites: number;\n    totalViews: number;\n  }>;\n\n  // User upload operations\n  getUserUploads(userId: string): Promise<UserUpload[]>;\n  getUserUploadCount(userId: string): Promise<number>;\n  findAvailableSlot(userId: string): Promise<number | null>;\n  createUserUpload(upload: Partial<UserUpload>): Promise<UserUpload>;\n  deleteUserUpload(id: string, userId: string): Promise<boolean>;\n  \n  // Admin upload operations\n  getAdminUploads(): Promise<AdminUpload[]>;\n  getAdminUploadById(id: string): Promise<AdminUpload | undefined>;\n  createAdminUpload(upload: Partial<AdminUpload>): Promise<AdminUpload>;\n  deleteAdminUpload(id: string): Promise<boolean>;\n  updatePipelineStatus(id: string, status: string, startedAt?: Date, completedAt?: Date): Promise<AdminUpload | undefined>;\n  \n  // Duplicate file detection\n  checkDuplicateFileHash(fileHash: string): Promise<{ isDuplicate: boolean; existingFileName?: string; existingUploadType?: 'admin' | 'user' }>;\n  deleteAllDuplicateRecords(): Promise<{ adminDeleted: number; userDeleted: number; details: string[] }>;\n  clearAllUploads(): Promise<{ adminCleared: number; userCleared: number }>;\n  \n  // User upload approval operations\n  getAllUserUploads(): Promise<(UserUpload & { userName: string; userEmail: string })[]>;\n  getUserUploadById(id: string): Promise<UserUpload | undefined>;\n  approveUserUpload(id: string, adminId: string, category: string): Promise<UserUpload | undefined>;\n  rejectUserUpload(id: string, adminId: string): Promise<UserUpload | undefined>;\n  updateUserUploadPipelineStatus(id: string, status: string, startedAt?: Date, completedAt?: Date): Promise<UserUpload | undefined>;\n  \n  // Category operations\n  getAllCategories(): Promise<ICategory[]>;\n  getCategoryById(id: string): Promise<ICategory | undefined>;\n  createCategory(category: Partial<ICategory>): Promise<ICategory>;\n  updateCategory(id: string, category: Partial<ICategory>): Promise<ICategory | undefined>;\n  deleteCategory(id: string): Promise<boolean>;\n\n  // Chat support operations\n  getOrCreateConversation(userId?: string, guestId?: string, guestName?: string, guestEmail?: string): Promise<IChatConversation>;\n  getConversationById(id: string): Promise<IChatConversation | undefined>;\n  getConversationByUserId(userId: string): Promise<IChatConversation | undefined>;\n  getConversationByGuestId(guestId: string): Promise<IChatConversation | undefined>;\n  getAllConversations(): Promise<IChatConversation[]>;\n  updateConversationStatus(id: string, status: \"active\" | \"closed\"): Promise<IChatConversation | undefined>;\n  \n  // Chat message operations\n  getMessagesByConversationId(conversationId: string): Promise<IChatMessage[]>;\n  createMessage(message: Partial<IChatMessage>): Promise<IChatMessage>;\n  markMessagesAsRead(conversationId: string, senderType: \"user\" | \"admin\"): Promise<void>;\n}\n","path":null,"size_bytes":4925,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4420,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8605,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2765,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4120,"size_tokens":null},"server/seed.ts":{"content":"import { db } from \"./db\";\nimport { documents } from \"@shared/schema\";\n\nconst sampleDocuments = [\n  {\n    title: \"B√°o c√°o T√†i ch√≠nh Doanh nghi·ªáp Q4 2024\",\n    description: \"Ph√¢n t√≠ch chi ti·∫øt v·ªÅ t√¨nh h√¨nh t√†i ch√≠nh doanh nghi·ªáp trong qu√Ω 4 nƒÉm 2024. Bao g·ªìm b√°o c√°o thu chi, l·ª£i nhu·∫≠n, v√† d·ª± b√°o cho nƒÉm ti·∫øp theo.\",\n    category: \"T√†i ch√≠nh\",\n    pageCount: 45,\n    coverImageUrl: \"/attached_assets/generated_images/Financial_document_cover_navy_6a14393a.png\",\n    imageUrls: null,\n  },\n  {\n    title: \"Chi·∫øn l∆∞·ª£c Marketing S·ªë 2025\",\n    description: \"H∆∞·ªõng d·∫´n to√†n di·ªán v·ªÅ c√°c chi·∫øn l∆∞·ª£c marketing s·ªë hi·ªán ƒë·∫°i, bao g·ªìm SEO, social media, content marketing v√† email campaigns.\",\n    category: \"Marketing\",\n    pageCount: 67,\n    coverImageUrl: \"/attached_assets/generated_images/Business_document_cover_blue_a6330d07.png\",\n    imageUrls: null,\n  },\n  {\n    title: \"K·ªπ thu·∫≠t L·∫≠p tr√¨nh Web Hi·ªán ƒë·∫°i\",\n    description: \"Kh√≥a h·ªçc v·ªÅ l·∫≠p tr√¨nh web v·ªõi React, Node.js, v√† TypeScript. T·ª´ c∆° b·∫£n ƒë·∫øn n√¢ng cao v·ªõi c√°c v√≠ d·ª• th·ª±c t·∫ø v√† best practices.\",\n    category: \"C√¥ng ngh·ªá\",\n    pageCount: 120,\n    coverImageUrl: \"/attached_assets/generated_images/Technology_document_cover_green_3f0ac92b.png\",\n    imageUrls: null,\n  },\n  {\n    title: \"Ph∆∞∆°ng ph√°p Gi·∫£ng d·∫°y Hi·ªáu qu·∫£\",\n    description: \"T√†i li·ªáu h∆∞·ªõng d·∫´n c√°c ph∆∞∆°ng ph√°p gi·∫£ng d·∫°y hi·ªáu qu·∫£ cho gi√°o vi√™n, bao g·ªìm k·ªπ thu·∫≠t t∆∞∆°ng t√°c, ƒë√°nh gi√° h·ªçc sinh v√† qu·∫£n l√Ω l·ªõp h·ªçc.\",\n    category: \"Gi√°o d·ª•c\",\n    pageCount: 88,\n    coverImageUrl: \"/attached_assets/generated_images/Education_document_cover_orange_62237e7d.png\",\n    imageUrls: null,\n  },\n  {\n    title: \"Qu·∫£n tr·ªã D·ª± √°n Agile & Scrum\",\n    description: \"H∆∞·ªõng d·∫´n chi ti·∫øt v·ªÅ ph∆∞∆°ng ph√°p qu·∫£n tr·ªã d·ª± √°n Agile v√† Scrum framework. Ph√π h·ª£p cho project managers v√† team leaders.\",\n    category: \"Qu·∫£n l√Ω\",\n    pageCount: 95,\n    coverImageUrl: \"/attached_assets/generated_images/Business_document_cover_blue_a6330d07.png\",\n    imageUrls: null,\n  },\n  {\n    title: \"Ph√¢n t√≠ch D·ªØ li·ªáu v·ªõi Python\",\n    description: \"Kh√≥a h·ªçc to√†n di·ªán v·ªÅ ph√¢n t√≠ch d·ªØ li·ªáu s·ª≠ d·ª•ng Python, Pandas, NumPy v√† Matplotlib. Bao g·ªìm machine learning c∆° b·∫£n.\",\n    category: \"C√¥ng ngh·ªá\",\n    pageCount: 156,\n    coverImageUrl: \"/attached_assets/generated_images/Technology_document_cover_green_3f0ac92b.png\",\n    imageUrls: null,\n  },\n  {\n    title: \"K·∫ø ho·∫°ch Kinh doanh Startup\",\n    description: \"Template v√† h∆∞·ªõng d·∫´n chi ti·∫øt ƒë·ªÉ x√¢y d·ª±ng business plan cho startup. Bao g·ªìm market research, financial projections v√† pitch deck.\",\n    category: \"Kinh doanh\",\n    pageCount: 72,\n    coverImageUrl: \"/attached_assets/generated_images/Financial_document_cover_navy_6a14393a.png\",\n    imageUrls: null,\n  },\n  {\n    title: \"Thi·∫øt k·∫ø UI/UX Chuy√™n nghi·ªáp\",\n    description: \"Nguy√™n t·∫Øc v√† th·ª±c h√†nh thi·∫øt k·∫ø UI/UX hi·ªán ƒë·∫°i. Bao g·ªìm user research, wireframing, prototyping v√† usability testing.\",\n    category: \"Thi·∫øt k·∫ø\",\n    pageCount: 134,\n    coverImageUrl: \"/attached_assets/generated_images/Education_document_cover_orange_62237e7d.png\",\n    imageUrls: null,\n  },\n  {\n    title: \"K·ªπ nƒÉng Giao ti·∫øp Hi·ªáu qu·∫£\",\n    description: \"Ph√°t tri·ªÉn k·ªπ nƒÉng giao ti·∫øp trong c√¥ng vi·ªác v√† cu·ªôc s·ªëng. Bao g·ªìm presentation skills, negotiation v√† conflict resolution.\",\n    category: \"K·ªπ nƒÉng m·ªÅm\",\n    pageCount: 58,\n    coverImageUrl: \"/attached_assets/generated_images/Business_document_cover_blue_a6330d07.png\",\n    imageUrls: null,\n  },\n  {\n    title: \"ƒê·∫ßu t∆∞ Ch·ª©ng kho√°n C∆° b·∫£n\",\n    description: \"H∆∞·ªõng d·∫´n t·ª´ A-Z v·ªÅ ƒë·∫ßu t∆∞ ch·ª©ng kho√°n cho ng∆∞·ªùi m·ªõi b·∫Øt ƒë·∫ßu. Bao g·ªìm ph√¢n t√≠ch c∆° b·∫£n, ph√¢n t√≠ch k·ªπ thu·∫≠t v√† qu·∫£n l√Ω r·ªßi ro.\",\n    category: \"T√†i ch√≠nh\",\n    pageCount: 103,\n    coverImageUrl: \"/attached_assets/generated_images/Financial_document_cover_navy_6a14393a.png\",\n    imageUrls: null,\n  },\n  {\n    title: \"Cloud Computing v·ªõi AWS\",\n    description: \"Kh√≥a h·ªçc v·ªÅ Amazon Web Services, bao g·ªìm EC2, S3, RDS, Lambda v√† c√°c d·ªãch v·ª• cloud computing ph·ªï bi·∫øn kh√°c.\",\n    category: \"C√¥ng ngh·ªá\",\n    pageCount: 178,\n    coverImageUrl: \"/attached_assets/generated_images/Technology_document_cover_green_3f0ac92b.png\",\n    imageUrls: null,\n  },\n  {\n    title: \"T√¢m l√Ω h·ªçc T·ªï ch·ª©c\",\n    description: \"Nghi√™n c·ª©u v·ªÅ h√†nh vi con ng∆∞·ªùi trong m√¥i tr∆∞·ªùng t·ªï ch·ª©c. Bao g·ªìm motivation, leadership v√† organizational culture.\",\n    category: \"Gi√°o d·ª•c\",\n    pageCount: 91,\n    coverImageUrl: \"/attached_assets/generated_images/Education_document_cover_orange_62237e7d.png\",\n    imageUrls: null,\n  },\n];\n\nasync function seed() {\n  try {\n    console.log(\"Starting database seed...\");\n    \n    // Insert sample documents\n    for (const doc of sampleDocuments) {\n      await db.insert(documents).values(doc);\n      console.log(`Inserted: ${doc.title}`);\n    }\n    \n    console.log(\"Database seeding completed successfully!\");\n    process.exit(0);\n  } catch (error) {\n    console.error(\"Error seeding database:\", error);\n    process.exit(1);\n  }\n}\n\nseed();\n","path":null,"size_bytes":5342,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","path":null,"size_bytes":1280,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1077,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1883,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1139,"size_tokens":null},"client/src/components/Header.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { Heart, LogOut, Shield } from \"lucide-react\";\nimport { SiGoogle } from \"react-icons/si\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { Link } from \"wouter\";\nimport { UploadDialog } from \"@/components/UploadDialog\";\nimport { NotificationBell } from \"@/components/NotificationBell\";\nimport logoImage from \"@assets/LOGO DATA T√ÅCH N·ªÄN_1764101818270.png\";\n\nexport function Header() {\n  const { user, isAuthenticated } = useAuth();\n\n  const getInitials = () => {\n    if (!user) return \"U\";\n    const firstName = user.firstName || \"\";\n    const lastName = user.lastName || \"\";\n    if (firstName && lastName) {\n      return `${firstName[0]}${lastName[0]}`.toUpperCase();\n    }\n    if (user.email) {\n      return user.email[0].toUpperCase();\n    }\n    return \"U\";\n  };\n\n  return (\n    <header className=\"sticky top-0 z-50 w-full border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60\">\n      <div className=\"container max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\n        <div className=\"flex h-24 items-center justify-between\">\n          <Link href=\"/\" data-testid=\"link-home\">\n            <div className=\"flex items-center gap-3 cursor-pointer hover-elevate rounded-lg px-3 py-2 -ml-3\">\n              <div className=\"flex items-center justify-center w-48 h-48\">\n                <img \n                  src={logoImage} \n                  alt=\"DATA KH√ÅCH H√ÄNG Logo\" \n                  className=\"w-full h-full object-contain\"\n                />\n              </div>\n              <div>\n                <h1 className=\"font-bold text-[40px]\">DATA KH√ÅCH H√ÄNG</h1>\n              </div>\n            </div>\n          </Link>\n\n          <div className=\"flex items-center gap-4\">\n            {isAuthenticated && <UploadDialog />}\n            {isAuthenticated && <NotificationBell />}\n            {isAuthenticated ? (\n              <DropdownMenu>\n                <DropdownMenuTrigger asChild>\n                  <Button\n                    variant=\"ghost\"\n                    className=\"relative h-10 w-10 rounded-full\"\n                    data-testid=\"button-user-menu\"\n                  >\n                    <Avatar className=\"h-10 w-10\">\n                      <AvatarImage\n                        src={user?.profileImageUrl || \"\"}\n                        alt={user?.firstName || \"User\"}\n                        className=\"object-cover\"\n                      />\n                      <AvatarFallback className=\"bg-primary text-primary-foreground\">\n                        {getInitials()}\n                      </AvatarFallback>\n                    </Avatar>\n                  </Button>\n                </DropdownMenuTrigger>\n                <DropdownMenuContent className=\"w-56\" align=\"end\">\n                  <div className=\"flex items-center justify-start gap-2 p-2\">\n                    <div className=\"flex flex-col space-y-1 leading-none\">\n                      {(user?.firstName || user?.lastName) && (\n                        <p className=\"font-medium\" data-testid=\"text-user-name\">\n                          {[user?.firstName, user?.lastName].filter(Boolean).join(\" \")}\n                        </p>\n                      )}\n                      {user?.email && (\n                        <p className=\"text-sm text-muted-foreground\" data-testid=\"text-user-email\">\n                          {user.email}\n                        </p>\n                      )}\n                    </div>\n                  </div>\n                  <DropdownMenuSeparator />\n                  <DropdownMenuItem asChild>\n                    <Link href=\"/\" data-testid=\"link-favorites\">\n                      <div className=\"flex items-center gap-2 w-full cursor-pointer\">\n                        <Heart className=\"w-4 h-4\" />\n                        <span>Y√™u th√≠ch</span>\n                      </div>\n                    </Link>\n                  </DropdownMenuItem>\n                  {user?.role === \"admin\" && (\n                    <>\n                      <DropdownMenuSeparator />\n                      <DropdownMenuItem asChild>\n                        <Link href=\"/admin\" data-testid=\"link-admin\">\n                          <div className=\"flex items-center gap-2 w-full cursor-pointer\">\n                            <Shield className=\"w-4 h-4\" />\n                            <span>Admin Panel</span>\n                          </div>\n                        </Link>\n                      </DropdownMenuItem>\n                    </>\n                  )}\n                  <DropdownMenuSeparator />\n                  <DropdownMenuItem asChild>\n                    <a href=\"/api/logout\" className=\"cursor-pointer\" data-testid=\"link-logout\">\n                      <div className=\"flex items-center gap-2 w-full\">\n                        <LogOut className=\"w-4 h-4\" />\n                        <span>ƒêƒÉng xu·∫•t</span>\n                      </div>\n                    </a>\n                  </DropdownMenuItem>\n                </DropdownMenuContent>\n              </DropdownMenu>\n            ) : (\n              <Button asChild data-testid=\"button-login\">\n                <a href=\"/api/auth/google\">\n                  <SiGoogle className=\"w-4 h-4 mr-2\" />\n                  ƒêƒÉng nh·∫≠p b·∫±ng Google\n                </a>\n              </Button>\n            )}\n          </div>\n        </div>\n      </div>\n    </header>\n  );\n}\n","path":null,"size_bytes":5629,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3848,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":791,"size_tokens":null},"client/src/pages/DocumentDetail.tsx":{"content":"import { useState } from \"react\";\nimport { useRoute } from \"wouter\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Header } from \"@/components/Header\";\nimport { DocumentCard } from \"@/components/DocumentCard\";\nimport { SEOHead } from \"@/components/SEOHead\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Card } from \"@/components/ui/card\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { \n  Dialog,\n  DialogContent,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { \n  AlertCircle, \n  FileText, \n  Heart, \n  ChevronLeft, \n  ChevronRight,\n  Lock, \n  Share2, \n  Facebook, \n  MessageCircle, \n  Bell,\n  Download,\n  Eye,\n  Database,\n  ZoomIn,\n  ZoomOut,\n  Image as ImageIcon,\n  X,\n  Coins\n} from \"lucide-react\";\nimport type { DocumentWithFavorite, DocumentImage } from \"@shared/schema\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\nimport { Link } from \"wouter\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { InsufficientPointsDialog } from \"@/components/InsufficientPointsDialog\";\n\nfunction createSEODescription(description: string): string {\n  const maxLength = 160;\n  if (description.length <= maxLength) {\n    return description;\n  }\n  \n  const truncated = description.substring(0, maxLength - 3);\n  const lastSpace = truncated.lastIndexOf(' ');\n  return lastSpace > 0 ? truncated.substring(0, lastSpace) + '...' : truncated + '...';\n}\n\nfunction shareOnSocial(platform: 'facebook' | 'twitter' | 'zalo', url: string, title: string) {\n  const encodedUrl = encodeURIComponent(url);\n  const encodedTitle = encodeURIComponent(title);\n  \n  const shareUrls = {\n    facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`,\n    twitter: `https://twitter.com/intent/tweet?url=${encodedUrl}&text=${encodedTitle}`,\n    zalo: `https://zalo.me/share?url=${encodedUrl}`,\n  };\n  \n  window.open(shareUrls[platform], '_blank', 'width=600,height=400');\n}\n\nfunction parseImageUrls(imageUrls: string | null | undefined): DocumentImage[] {\n  if (!imageUrls) return [];\n  try {\n    const parsed = JSON.parse(imageUrls);\n    return Array.isArray(parsed) ? parsed : [];\n  } catch {\n    return [];\n  }\n}\n\ninterface ImageGalleryProps {\n  images: DocumentImage[];\n  coverImageUrl: string;\n  title: string;\n}\n\nconst FREE_PREVIEW_LIMIT = 10;\n\nfunction ImageGallery({ images, coverImageUrl, title }: ImageGalleryProps) {\n  const [currentIndex, setCurrentIndex] = useState(0);\n  const [isLightboxOpen, setIsLightboxOpen] = useState(false);\n  const [zoomLevel, setZoomLevel] = useState(1);\n\n  const handleZoomIn = () => setZoomLevel(prev => Math.min(prev + 0.25, 3));\n  const handleZoomOut = () => setZoomLevel(prev => Math.max(prev - 0.25, 0.5));\n  const resetZoom = () => setZoomLevel(1);\n\n  const rawImages = images.length > 0 \n    ? images \n    : [{ sheet: 'cover', page: 1, url: coverImageUrl }];\n\n  // Only show free preview images + 1 locked representative\n  const freeImages = rawImages.slice(0, FREE_PREVIEW_LIMIT);\n  const lockedCount = Math.max(0, rawImages.length - FREE_PREVIEW_LIMIT);\n  const hasLockedContent = lockedCount > 0;\n  \n  // Display images: free previews + 1 locked indicator (if any locked exist)\n  const displayImages = hasLockedContent \n    ? [...freeImages, { sheet: 'locked', page: 0, url: '' }]\n    : freeImages;\n\n  const currentImage = displayImages[currentIndex] || displayImages[0];\n  const isCurrentLocked = hasLockedContent && currentIndex === displayImages.length - 1;\n  \n  const freePreviewCount = freeImages.length;\n\n  const goToPrevious = () => {\n    setCurrentIndex((prev) => (prev === 0 ? displayImages.length - 1 : prev - 1));\n  };\n\n  const goToNext = () => {\n    setCurrentIndex((prev) => (prev === displayImages.length - 1 ? 0 : prev + 1));\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      {lockedCount > 0 && (\n        <div className=\"flex items-center gap-2 px-3 py-2 bg-amber-500/10 border border-amber-500/20 rounded-lg text-sm\">\n          <Lock className=\"w-4 h-4 text-amber-600\" />\n          <span className=\"text-amber-700 dark:text-amber-400\">\n            Th√¥ng tin quan tr·ªçng ƒë·ªÅu ƒë∆∞·ª£c m√£ h√≥a th√†nh d·∫•u * -&gt; ƒê·ªÉ xem ƒë∆∞·ª£c to√†n b·ªô n·ªôi dung li√™n h·ªá Admin\n          </span>\n        </div>\n      )}\n      \n      <Card className=\"overflow-hidden shadow-2xl\">\n        <div className=\"relative aspect-video bg-muted\">\n          {isCurrentLocked ? (\n            <div className=\"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-gray-200 to-gray-300 dark:from-gray-700 dark:to-gray-800\">\n              <div className=\"flex items-center justify-center w-20 h-20 rounded-full bg-gray-400 dark:bg-gray-600 mb-6\">\n                <Lock className=\"w-10 h-10 text-gray-700 dark:text-gray-300\" />\n              </div>\n              <p className=\"text-gray-900 dark:text-gray-100 font-bold text-xl md:text-2xl text-center px-4 mb-2\">\n                ƒê·ªÇ M·ªû KH√ìA XEM N·ªòI DUNG\n              </p>\n              <p className=\"text-gray-900 dark:text-gray-100 font-bold text-xl md:text-2xl text-center px-4\">\n                LI√äN H·ªÜ ADMIN\n              </p>\n            </div>\n          ) : (\n            <>\n              <img\n                src={currentImage.url}\n                alt={`${title} - Trang ${currentIndex + 1}`}\n                className=\"w-full h-full object-contain cursor-pointer\"\n                onClick={() => setIsLightboxOpen(true)}\n                data-testid=\"img-main-gallery\"\n              />\n              <Button\n                size=\"icon\"\n                variant=\"secondary\"\n                className=\"absolute top-4 right-4 backdrop-blur-sm\"\n                onClick={() => setIsLightboxOpen(true)}\n                data-testid=\"button-zoom-image\"\n              >\n                <ZoomIn className=\"w-5 h-5\" />\n              </Button>\n            </>\n          )}\n\n          {displayImages.length > 1 && (\n            <>\n              <Button\n                size=\"icon\"\n                variant=\"secondary\"\n                className=\"absolute left-4 top-1/2 -translate-y-1/2 backdrop-blur-sm\"\n                onClick={goToPrevious}\n                data-testid=\"button-prev-image\"\n              >\n                <ChevronLeft className=\"w-5 h-5\" />\n              </Button>\n              <Button\n                size=\"icon\"\n                variant=\"secondary\"\n                className=\"absolute right-4 top-1/2 -translate-y-1/2 backdrop-blur-sm\"\n                onClick={goToNext}\n                data-testid=\"button-next-image\"\n              >\n                <ChevronRight className=\"w-5 h-5\" />\n              </Button>\n            </>\n          )}\n\n          <div className=\"absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/60 text-white px-4 py-1.5 rounded-full text-sm backdrop-blur-sm flex items-center gap-2\">\n            {isCurrentLocked && <Lock className=\"w-3 h-3\" />}\n            {isCurrentLocked ? `+${lockedCount} ·∫£nh b·ªã kh√≥a` : `${currentIndex + 1} / ${freePreviewCount}`}\n          </div>\n        </div>\n      </Card>\n\n      {displayImages.length > 1 && (\n        <div className=\"flex gap-2 overflow-x-auto pb-2 scrollbar-thin\">\n          {displayImages.map((img, index) => {\n            const isLockedThumbnail = hasLockedContent && index === displayImages.length - 1;\n            return (\n              <button\n                key={`${img.sheet}-${img.page}-${index}`}\n                onClick={() => setCurrentIndex(index)}\n                className={`relative flex-shrink-0 ${isLockedThumbnail ? 'w-24' : 'w-20'} h-14 rounded-md overflow-hidden border-2 transition-all ${\n                  index === currentIndex \n                    ? 'border-primary ring-2 ring-primary/20' \n                    : 'border-transparent hover:border-muted-foreground/30'\n                }`}\n                data-testid={`button-thumbnail-${index}`}\n              >\n                {isLockedThumbnail ? (\n                  <div className=\"w-full h-full flex items-center justify-center gap-1 bg-gray-300 dark:bg-gray-600\">\n                    <Lock className=\"w-4 h-4 text-gray-600 dark:text-gray-300\" />\n                    <span className=\"text-xs font-medium text-gray-600 dark:text-gray-300\">+{lockedCount}</span>\n                  </div>\n                ) : (\n                  <img\n                    src={img.url}\n                    alt={`Thumbnail ${index + 1}`}\n                    className=\"w-full h-full object-cover\"\n                  />\n                )}\n              </button>\n            );\n          })}\n        </div>\n      )}\n\n      <Dialog open={isLightboxOpen && !isCurrentLocked} onOpenChange={(open) => { setIsLightboxOpen(open); if (!open) resetZoom(); }}>\n        <DialogContent className=\"max-w-[95vw] max-h-[95vh] p-0 bg-black/95 border-none\">\n          <div className=\"relative w-full h-full flex items-center justify-center min-h-[80vh] overflow-auto\">\n            <Button\n              size=\"icon\"\n              variant=\"ghost\"\n              className=\"absolute top-4 right-4 z-50 text-white hover:bg-white/20\"\n              onClick={() => setIsLightboxOpen(false)}\n              data-testid=\"button-close-lightbox\"\n            >\n              <X className=\"w-6 h-6\" />\n            </Button>\n\n            <div className=\"absolute top-4 left-4 z-50 flex items-center gap-2\">\n              <Button\n                size=\"icon\"\n                variant=\"ghost\"\n                className=\"text-white hover:bg-white/20\"\n                onClick={handleZoomOut}\n                disabled={zoomLevel <= 0.5}\n                data-testid=\"button-zoom-out\"\n              >\n                <ZoomOut className=\"w-5 h-5\" />\n              </Button>\n              <span className=\"text-white text-sm min-w-[60px] text-center\">{Math.round(zoomLevel * 100)}%</span>\n              <Button\n                size=\"icon\"\n                variant=\"ghost\"\n                className=\"text-white hover:bg-white/20\"\n                onClick={handleZoomIn}\n                disabled={zoomLevel >= 3}\n                data-testid=\"button-zoom-in\"\n              >\n                <ZoomIn className=\"w-5 h-5\" />\n              </Button>\n            </div>\n\n            <img\n              src={currentImage.url}\n              alt={`${title} - Trang ${currentIndex + 1}`}\n              className=\"max-w-full max-h-[85vh] object-contain transition-transform duration-200\"\n              style={{ transform: `scale(${zoomLevel})` }}\n              data-testid=\"img-lightbox\"\n            />\n\n            {freePreviewCount > 1 && (\n              <>\n                <Button\n                  size=\"icon\"\n                  variant=\"ghost\"\n                  className=\"absolute left-4 top-1/2 -translate-y-1/2 text-white hover:bg-white/20 w-12 h-12\"\n                  onClick={() => { goToPrevious(); resetZoom(); }}\n                  data-testid=\"button-lightbox-prev\"\n                >\n                  <ChevronLeft className=\"w-8 h-8\" />\n                </Button>\n                <Button\n                  size=\"icon\"\n                  variant=\"ghost\"\n                  className=\"absolute right-4 top-1/2 -translate-y-1/2 text-white hover:bg-white/20 w-12 h-12\"\n                  onClick={() => { goToNext(); resetZoom(); }}\n                  data-testid=\"button-lightbox-next\"\n                >\n                  <ChevronRight className=\"w-8 h-8\" />\n                </Button>\n              </>\n            )}\n\n            <div className=\"absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/60 text-white px-4 py-1.5 rounded-full text-sm\">\n              {currentIndex + 1} / {freePreviewCount}\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n\nexport default function DocumentDetail() {\n  const [, params] = useRoute(\"/document/:id\");\n  const documentId = params?.id;\n  const { toast } = useToast();\n  const { user, isAuthenticated, isLoading: isAuthLoading } = useAuth();\n  const [showPointsDialog, setShowPointsDialog] = useState(false);\n\n  const { data: document, isLoading, error } = useQuery<DocumentWithFavorite>({\n    queryKey: [`/api/documents/${documentId}`],\n    enabled: !!documentId,\n  });\n\n  const { data: relatedDocuments = [] } = useQuery<DocumentWithFavorite[]>({\n    queryKey: [`/api/documents/${documentId}/related`],\n    enabled: !!documentId && !!document,\n  });\n\n  interface Category {\n    id: string;\n    name: string;\n    logoUrl?: string;\n    order: number;\n  }\n\n  const { data: categories = [] } = useQuery<Category[]>({\n    queryKey: [\"/api/categories\"],\n  });\n\n  const categoryLogoMap: Record<string, string> = {};\n  categories.forEach(cat => {\n    if (cat.logoUrl) {\n      categoryLogoMap[cat.name] = cat.logoUrl;\n    }\n  });\n\n  const toggleFavoriteMutation = useMutation({\n    mutationFn: async ({ documentId, isFavorited }: { documentId: string; isFavorited: boolean }) => {\n      if (isFavorited) {\n        await apiRequest(\"DELETE\", `/api/favorites/${documentId}`);\n      } else {\n        await apiRequest(\"POST\", \"/api/favorites\", { documentId });\n      }\n    },\n    onMutate: async ({ documentId: docId, isFavorited }) => {\n      await queryClient.cancelQueries({ queryKey: [`/api/documents/${docId}`] });\n      await queryClient.cancelQueries({ queryKey: [\"/api/documents\"] });\n      \n      const previousDocument = queryClient.getQueryData<DocumentWithFavorite>([`/api/documents/${docId}`]);\n      const previousDocuments = queryClient.getQueryData<DocumentWithFavorite[]>([\"/api/documents\"]);\n      \n      if (previousDocument) {\n        queryClient.setQueryData<DocumentWithFavorite>([`/api/documents/${docId}`], {\n          ...previousDocument,\n          isFavorited: !isFavorited,\n          favoriteCount: previousDocument.favoriteCount + (isFavorited ? -1 : 1),\n        });\n      }\n      \n      if (previousDocuments) {\n        queryClient.setQueryData<DocumentWithFavorite[]>([\"/api/documents\"], \n          previousDocuments.map((doc) => \n            doc.id === docId \n              ? { ...doc, isFavorited: !isFavorited, favoriteCount: doc.favoriteCount + (isFavorited ? -1 : 1) }\n              : doc\n          )\n        );\n      }\n      \n      return { previousDocument, previousDocuments };\n    },\n    onError: (error, variables, context) => {\n      if (context?.previousDocument) {\n        queryClient.setQueryData([`/api/documents/${variables.documentId}`], context.previousDocument);\n      }\n      if (context?.previousDocuments) {\n        queryClient.setQueryData([\"/api/documents\"], context.previousDocuments);\n      }\n      if (isUnauthorizedError(error as Error)) {\n        toast({\n          title: \"Ch∆∞a ƒëƒÉng nh·∫≠p\",\n          description: \"ƒêang chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang ƒëƒÉng nh·∫≠p...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"L·ªói\",\n        description: \"Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t y√™u th√≠ch. Vui l√≤ng th·ª≠ l·∫°i.\",\n        variant: \"destructive\",\n      });\n    },\n    onSettled: (_, __, variables) => {\n      queryClient.invalidateQueries({ queryKey: [`/api/documents/${variables.documentId}`] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/documents\"] });\n    },\n  });\n\n  const images = document ? parseImageUrls(document.imageUrls) : [];\n\n  if (!documentId) {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <Header />\n        <div className=\"container max-w-7xl mx-auto px-4 py-16 text-center\">\n          <Alert variant=\"destructive\">\n            <AlertCircle className=\"h-4 w-4\" />\n            <AlertDescription>T√†i li·ªáu kh√¥ng t·ªìn t·∫°i.</AlertDescription>\n          </Alert>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <Header />\n\n      <main className=\"container max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\n        <div className=\"mb-6\">\n          <Button variant=\"ghost\" asChild data-testid=\"button-back\">\n            <Link href=\"/\">\n              <ChevronLeft className=\"w-4 h-4 mr-2\" />\n              Quay l·∫°i\n            </Link>\n          </Button>\n        </div>\n\n        {error && (\n          <Alert variant=\"destructive\">\n            <AlertCircle className=\"h-4 w-4\" />\n            <AlertDescription>\n              Kh√¥ng th·ªÉ t·∫£i th√¥ng tin t√†i li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.\n            </AlertDescription>\n          </Alert>\n        )}\n\n        {isLoading && (\n          <div className=\"space-y-8\">\n            <Skeleton className=\"h-10 w-3/4\" />\n            <Skeleton className=\"aspect-video w-full rounded-lg\" />\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n              <Skeleton className=\"h-32\" />\n              <Skeleton className=\"h-32\" />\n              <Skeleton className=\"h-32\" />\n            </div>\n          </div>\n        )}\n\n        {!isLoading && !error && document && (\n          <>\n            <SEOHead\n              title={`${document.title} - ${document.category}${document.subcategory ? ` ‚Ä∫ ${document.subcategory}` : ''}`}\n              description={createSEODescription(document.description)}\n              keywords={`${document.category}, ${document.subcategory || ''}, t√†i li·ªáu, data kh√°ch h√†ng, ${document.title}`}\n              imageUrl={document.coverImageUrl}\n              url={window.location.href}\n              type=\"article\"\n            />\n\n            <article className=\"space-y-8\">\n              <header className=\"space-y-4\">\n                <div className=\"flex items-start justify-between gap-4 flex-wrap\">\n                  <div className=\"flex-1 min-w-0\">\n                    <h1 className=\"text-3xl sm:text-4xl font-bold mb-3 leading-tight\" data-testid=\"text-document-title\">\n                      {document.title}\n                    </h1>\n                    <div className=\"flex items-center gap-3 flex-wrap\">\n                      <Badge className=\"mb-2\" data-testid=\"badge-document-category\">\n                        {document.subcategory \n                          ? <>{document.category} <span className=\"opacity-60 mx-1\">‚Ä∫</span> {document.subcategory}</>\n                          : document.category}\n                      </Badge>\n                      <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                        <Eye className=\"w-4 h-4\" />\n                        <span>{document.viewCount} l∆∞·ª£t xem</span>\n                      </div>\n                    </div>\n                    \n                    <div className=\"flex items-center gap-6 flex-wrap text-sm text-muted-foreground mt-2\">\n                      <div className=\"flex items-center gap-1.5\">\n                        <span className=\"font-semibold text-foreground\">ID</span>\n                        <span data-testid=\"text-document-postid\">{document.postId || 'N/A'}</span>\n                      </div>\n                      <div className=\"flex items-center gap-1.5\">\n                        <Database className=\"w-4 h-4\" />\n                        <span data-testid=\"text-document-datacount\">{(document.pageCount * 10).toLocaleString()} Data</span>\n                      </div>\n                      <div className=\"flex items-center gap-1.5\">\n                        <FileText className=\"w-4 h-4\" />\n                        <span data-testid=\"text-document-pagecount\">{document.pageCount} trang</span>\n                      </div>\n                      <div className=\"flex items-center gap-1.5\">\n                        <ImageIcon className=\"w-4 h-4\" />\n                        <span data-testid=\"text-document-imagecount\">{images.length || 1} h√¨nh ·∫£nh</span>\n                      </div>\n                      <div className=\"flex items-center gap-1.5\">\n                        <Coins className=\"w-4 h-4 text-amber-500\" />\n                        <span className=\"font-semibold text-amber-600 dark:text-amber-400\" data-testid=\"text-document-points\">\n                          {document.pointsCost || document.pageCount || 0} ƒëi·ªÉm\n                        </span>\n                      </div>\n                    </div>\n                  </div>\n                  <div className=\"flex flex-col gap-2\">\n                    <Button\n                      size=\"lg\"\n                      variant={document.isFavorited ? \"default\" : \"outline\"}\n                      onClick={() =>\n                        toggleFavoriteMutation.mutate({\n                          documentId: document.id,\n                          isFavorited: document.isFavorited,\n                        })\n                      }\n                      disabled={toggleFavoriteMutation.isPending}\n                      className=\"toggle-elevate\"\n                      data-testid=\"button-favorite-detail\"\n                    >\n                      <Heart\n                        className={`w-5 h-5 mr-2 ${\n                          document.isFavorited ? \"fill-current\" : \"\"\n                        }`}\n                      />\n                      {document.isFavorited ? \"ƒê√£ l∆∞u\" : \"Y√™u th√≠ch\"}\n                    </Button>\n                    <Button\n                      size=\"lg\"\n                      className=\"bg-amber-500 hover:bg-amber-600 text-white\"\n                      onClick={() => {\n                        const requiredPoints = document.pointsCost || document.pageCount || 0;\n                        const userPoints = user?.points || 0;\n                        if (userPoints < requiredPoints) {\n                          setShowPointsDialog(true);\n                        }\n                      }}\n                      data-testid=\"button-exchange-detail\"\n                    >\n                      <Coins className=\"w-5 h-5 mr-2\" />\n                      ƒê·ªïi ƒëi·ªÉm ({document.pointsCost || document.pageCount || 0})\n                    </Button>\n                  </div>\n                </div>\n                <p className=\"text-base text-foreground leading-relaxed\" data-testid=\"text-document-description\">\n                  {document.description}\n                </p>\n\n                <div className=\"flex items-center gap-3 pt-2 flex-wrap\">\n                  <span className=\"text-sm font-medium text-muted-foreground\">Chia s·∫ª:</span>\n                  <div className=\"flex gap-2\">\n                    <Button\n                      size=\"sm\"\n                      variant=\"outline\"\n                      onClick={() => shareOnSocial('facebook', window.location.href, document.title)}\n                      data-testid=\"button-share-facebook\"\n                    >\n                      <Facebook className=\"w-4 h-4 mr-2\" />\n                      Facebook\n                    </Button>\n                    <Button\n                      size=\"sm\"\n                      variant=\"outline\"\n                      onClick={() => shareOnSocial('zalo', window.location.href, document.title)}\n                      data-testid=\"button-share-zalo\"\n                    >\n                      <MessageCircle className=\"w-4 h-4 mr-2\" />\n                      Zalo\n                    </Button>\n                    <Button\n                      size=\"sm\"\n                      variant=\"outline\"\n                      onClick={() => {\n                        navigator.clipboard.writeText(window.location.href);\n                        toast({\n                          title: \"ƒê√£ sao ch√©p\",\n                          description: \"Link t√†i li·ªáu ƒë√£ ƒë∆∞·ª£c sao ch√©p v√†o clipboard\",\n                        });\n                      }}\n                      data-testid=\"button-copy-link\"\n                    >\n                      <Share2 className=\"w-4 h-4 mr-2\" />\n                      Sao ch√©p\n                    </Button>\n                  </div>\n                </div>\n              </header>\n\n              {isAuthenticated ? (\n                <ImageGallery \n                  images={images} \n                  coverImageUrl={document.coverImageUrl} \n                  title={document.title} \n                />\n              ) : (\n                <Card className=\"overflow-hidden shadow-2xl\" data-testid=\"card-login-required\">\n                  <div className=\"aspect-video bg-muted flex flex-col items-center justify-center p-8 text-center\">\n                    <div className=\"flex items-center justify-center w-16 h-16 rounded-full bg-primary/10 mb-4\">\n                      <Lock className=\"w-8 h-8 text-primary\" />\n                    </div>\n                    <h3 className=\"text-xl font-semibold mb-2\">N·ªôi dung y√™u c·∫ßu ƒëƒÉng nh·∫≠p</h3>\n                    <p className=\"text-muted-foreground mb-6 max-w-md\">\n                      Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem h√¨nh ·∫£nh v√† truy c·∫≠p ƒë·∫ßy ƒë·ªß n·ªôi dung t√†i li·ªáu\n                    </p>\n                    <Button\n                      size=\"lg\"\n                      onClick={() => window.location.href = \"/api/login\"}\n                      data-testid=\"button-login-to-view\"\n                    >\n                      ƒêƒÉng nh·∫≠p\n                    </Button>\n                  </div>\n                </Card>\n              )}\n\n              <section>\n                <h2 className=\"text-2xl font-bold mb-4\" data-testid=\"heading-table-of-contents\">\n                  Th√¥ng tin t√†i li·ªáu\n                </h2>\n                <Card className=\"p-6\">\n                  <ul className=\"space-y-3\">\n                    <li className=\"flex items-start gap-3\">\n                      <div className=\"flex items-center justify-center w-6 h-6 rounded-full bg-primary/10 text-primary font-semibold text-sm mt-0.5\">\n                        1\n                      </div>\n                      <div>\n                        <h3 className=\"font-semibold mb-1\">Xem h√¨nh ·∫£nh t√†i li·ªáu</h3>\n                        <p className=\"text-sm text-muted-foreground\">\n                          {images.length > 0 \n                            ? `${images.length} h√¨nh ·∫£nh ch·∫•t l∆∞·ª£ng cao t·ª´ file Excel ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω`\n                            : 'N·ªôi dung h√¨nh ·∫£nh v·ªõi ch·∫•t l∆∞·ª£ng HD, c√≥ watermark b·∫£o v·ªá'\n                          }\n                        </p>\n                      </div>\n                    </li>\n                    <li className=\"flex items-start gap-3\">\n                      <div className=\"flex items-center justify-center w-6 h-6 rounded-full bg-primary/10 text-primary font-semibold text-sm mt-0.5\">\n                        2\n                      </div>\n                      <div>\n                        <h3 className=\"font-semibold mb-1\">Data kh√°ch h√†ng</h3>\n                        <p className=\"text-sm text-muted-foreground\">\n                          {(document.pageCount * 10).toLocaleString()} d·ªØ li·ªáu kh√°ch h√†ng chi ti·∫øt\n                        </p>\n                      </div>\n                    </li>\n                    <li className=\"flex items-start gap-3\">\n                      <div className=\"flex items-center justify-center w-6 h-6 rounded-full bg-primary/10 text-primary font-semibold text-sm mt-0.5\">\n                        3\n                      </div>\n                      <div>\n                        <h3 className=\"font-semibold mb-1\">L∆∞u v√† chia s·∫ª</h3>\n                        <p className=\"text-sm text-muted-foreground\">\n                          L∆∞u v√†o y√™u th√≠ch ho·∫∑c chia s·∫ª v·ªõi b·∫°n b√®\n                        </p>\n                      </div>\n                    </li>\n                  </ul>\n                </Card>\n              </section>\n\n              <section>\n                <h2 className=\"text-2xl font-bold mb-4\" data-testid=\"heading-how-to-use\">\n                  H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng\n                </h2>\n                <Card className=\"p-6\">\n                  <div className=\"space-y-4\">\n                    <div>\n                      <h3 className=\"font-semibold mb-2 flex items-center gap-2\">\n                        <Eye className=\"w-5 h-5 text-primary\" />\n                        ƒê·ªÉ xem h√¨nh ·∫£nh\n                      </h3>\n                      <p className=\"text-sm text-muted-foreground ml-7\">\n                        {isAuthenticated \n                          ? \"Click v√†o h√¨nh ·∫£nh ƒë·ªÉ ph√≥ng to. S·ª≠ d·ª•ng c√°c n√∫t m≈©i t√™n ƒë·ªÉ chuy·ªÉn trang. H√¨nh ·∫£nh ƒë∆∞·ª£c b·∫£o v·ªá b·∫±ng watermark.\"\n                          : \"Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem h√¨nh ·∫£nh t√†i li·ªáu. Nh·∫•n n√∫t 'ƒêƒÉng nh·∫≠p' b√™n tr√™n.\"\n                        }\n                      </p>\n                    </div>\n                    \n                    <div>\n                      <h3 className=\"font-semibold mb-2 flex items-center gap-2\">\n                        <Download className=\"w-5 h-5 text-primary\" />\n                        ƒê·ªÉ t·∫£i t√†i li·ªáu\n                      </h3>\n                      <p className=\"text-sm text-muted-foreground ml-7\">\n                        T√†i li·ªáu ƒë∆∞·ª£c b·∫£o v·ªá v√† ch·ªâ xem tr·ª±c tuy·∫øn. B·∫°n c√≥ th·ªÉ l∆∞u v√†o m·ª•c y√™u th√≠ch ƒë·ªÉ d·ªÖ d√†ng truy c·∫≠p l·∫°i.\n                      </p>\n                    </div>\n\n                    <div>\n                      <h3 className=\"font-semibold mb-2 flex items-center gap-2\">\n                        <Share2 className=\"w-5 h-5 text-primary\" />\n                        ƒê·ªÉ chia s·∫ª\n                      </h3>\n                      <p className=\"text-sm text-muted-foreground ml-7\">\n                        S·ª≠ d·ª•ng c√°c n√∫t chia s·∫ª ·ªü ƒë·∫ßu trang ƒë·ªÉ chia s·∫ª t√†i li·ªáu l√™n Facebook, Zalo ho·∫∑c sao ch√©p link.\n                      </p>\n                    </div>\n                  </div>\n                </Card>\n              </section>\n\n              <section>\n                <Card className=\"bg-gradient-to-r from-primary/10 to-primary/5 border-primary/20 p-8\">\n                  <div className=\"flex flex-col md:flex-row items-center justify-between gap-6\">\n                    <div className=\"flex-1 text-center md:text-left\">\n                      <h2 className=\"text-2xl font-bold mb-2\" data-testid=\"heading-subscribe\">\n                        Nh·∫≠n th√¥ng b√°o t√†i li·ªáu m·ªõi\n                      </h2>\n                      <p className=\"text-muted-foreground\">\n                        ƒêƒÉng k√Ω ƒë·ªÉ nh·∫≠n th√¥ng b√°o khi c√≥ t√†i li·ªáu m·ªõi trong danh m·ª•c <strong>{document.subcategory ? `${document.category} ‚Ä∫ ${document.subcategory}` : document.category}</strong>\n                      </p>\n                    </div>\n                    <div className=\"flex gap-3\">\n                      <Button \n                        size=\"lg\" \n                        onClick={() => {\n                          if (!isAuthenticated) {\n                            window.location.href = \"/api/login\";\n                          } else {\n                            toast({\n                              title: \"ƒê√£ ƒëƒÉng k√Ω\",\n                              description: \"B·∫°n s·∫Ω nh·∫≠n th√¥ng b√°o khi c√≥ t√†i li·ªáu m·ªõi\",\n                            });\n                          }\n                        }}\n                        data-testid=\"button-subscribe\"\n                      >\n                        <Bell className=\"w-5 h-5 mr-2\" />\n                        {isAuthenticated ? \"ƒêƒÉng k√Ω ngay\" : \"ƒêƒÉng nh·∫≠p ƒë·ªÉ ƒëƒÉng k√Ω\"}\n                      </Button>\n                    </div>\n                  </div>\n                </Card>\n              </section>\n\n              {relatedDocuments.length > 0 && (\n                <section className=\"pt-4\">\n                  <Separator className=\"mb-8\" />\n                  <h2 className=\"text-2xl font-bold mb-6\" data-testid=\"heading-related\">\n                    T√†i li·ªáu li√™n quan\n                  </h2>\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n                    {relatedDocuments.slice(0, 6).map((relatedDoc) => (\n                      <DocumentCard\n                        key={relatedDoc.id}\n                        document={relatedDoc}\n                        onFavoriteToggle={(documentId, isFavorited) =>\n                          toggleFavoriteMutation.mutate({ documentId, isFavorited })\n                        }\n                        isTogglingFavorite={toggleFavoriteMutation.isPending}\n                        categoryLogoUrl={categoryLogoMap[relatedDoc.category]}\n                      />\n                    ))}\n                  </div>\n                </section>\n              )}\n            </article>\n          </>\n        )}\n      </main>\n\n      {document && (\n        <InsufficientPointsDialog\n          open={showPointsDialog}\n          onOpenChange={setShowPointsDialog}\n          requiredPoints={document.pointsCost || document.pageCount || 0}\n          currentPoints={user?.points || 0}\n        />\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":33149,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \".5625rem\", /* 9px */\n        md: \".375rem\", /* 6px */\n        sm: \".1875rem\", /* 3px */\n      },\n      colors: {\n        // Flat / base colors (regular buttons)\n        background: \"hsl(var(--background) / <alpha-value>)\",\n        foreground: \"hsl(var(--foreground) / <alpha-value>)\",\n        border: \"hsl(var(--border) / <alpha-value>)\",\n        input: \"hsl(var(--input) / <alpha-value>)\",\n        card: {\n          DEFAULT: \"hsl(var(--card) / <alpha-value>)\",\n          foreground: \"hsl(var(--card-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--card-border) / <alpha-value>)\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover) / <alpha-value>)\",\n          foreground: \"hsl(var(--popover-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--popover-border) / <alpha-value>)\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--primary-foreground) / <alpha-value>)\",\n          border: \"var(--primary-border)\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary) / <alpha-value>)\",\n          foreground: \"hsl(var(--secondary-foreground) / <alpha-value>)\",\n          border: \"var(--secondary-border)\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted) / <alpha-value>)\",\n          foreground: \"hsl(var(--muted-foreground) / <alpha-value>)\",\n          border: \"var(--muted-border)\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--accent-foreground) / <alpha-value>)\",\n          border: \"var(--accent-border)\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive) / <alpha-value>)\",\n          foreground: \"hsl(var(--destructive-foreground) / <alpha-value>)\",\n          border: \"var(--destructive-border)\",\n        },\n        ring: \"hsl(var(--ring) / <alpha-value>)\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1) / <alpha-value>)\",\n          \"2\": \"hsl(var(--chart-2) / <alpha-value>)\",\n          \"3\": \"hsl(var(--chart-3) / <alpha-value>)\",\n          \"4\": \"hsl(var(--chart-4) / <alpha-value>)\",\n          \"5\": \"hsl(var(--chart-5) / <alpha-value>)\",\n        },\n        sidebar: {\n          ring: \"hsl(var(--sidebar-ring) / <alpha-value>)\",\n          DEFAULT: \"hsl(var(--sidebar) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--sidebar-border) / <alpha-value>)\",\n        },\n        \"sidebar-primary\": {\n          DEFAULT: \"hsl(var(--sidebar-primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-primary-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-primary-border)\",\n        },\n        \"sidebar-accent\": {\n          DEFAULT: \"hsl(var(--sidebar-accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-accent-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-accent-border)\"\n        },\n        status: {\n          online: \"rgb(34 197 94)\",\n          away: \"rgb(245 158 11)\",\n          busy: \"rgb(239 68 68)\",\n          offline: \"rgb(156 163 175)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":4050,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3021,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n  \" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground border border-destructive-border\",\n        outline:\n          // Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color.\n          \" border [border-color:var(--button-outline)]  shadow-xs active:shadow-none \",\n        secondary: \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // Add a transparent border so that when someone toggles a border on later, it doesn't shift layout/size.\n        ghost: \"border border-transparent\",\n      },\n      // Heights are set as \"min\" heights, because sometimes Ai will place large amount of content\n      // inside buttons. With a min-height they will look appropriate with small amounts of content,\n      // but will expand to fit large amounts of content.\n      size: {\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  },\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2359,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5741,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1209,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1977,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":1080,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1251,"size_tokens":null},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* LIGHT MODE */\n:root {\n  --button-outline: rgba(0,0,0, .10);\n  --badge-outline: rgba(0,0,0, .05);\n\n  /* Automatic computation of border around primary / danger buttons */\n  --opaque-button-border-intensity: -8; /* In terms of percentages */\n\n  /* Backgrounds applied on top of other backgrounds when hovered/active */\n  --elevate-1: rgba(0,0,0, .03);\n  --elevate-2: rgba(0,0,0, .08);\n\n  --background: 0 0% 100%;\n\n  --foreground: 220 13% 13%;\n\n  --border: 220 13% 91%;\n\n  --card: 220 13% 98%;\n\n  --card-foreground: 220 13% 13%;\n\n  --card-border: 220 13% 94%;\n\n  --sidebar: 220 9% 96%;\n\n  --sidebar-foreground: 220 13% 13%;\n\n  --sidebar-border: 220 13% 91%;\n\n  --sidebar-primary: 217 91% 60%;\n\n  --sidebar-primary-foreground: 0 0% 100%;\n\n  --sidebar-accent: 220 13% 90%;\n\n  --sidebar-accent-foreground: 220 13% 13%;\n\n  --sidebar-ring: 217 91% 60%;\n\n  --popover: 220 13% 94%;\n\n  --popover-foreground: 220 13% 13%;\n\n  --popover-border: 220 13% 88%;\n\n  --primary: 217 91% 60%;\n\n  --primary-foreground: 0 0% 100%;\n\n  --secondary: 220 13% 88%;\n\n  --secondary-foreground: 220 13% 13%;\n\n  --muted: 220 13% 92%;\n\n  --muted-foreground: 220 9% 46%;\n\n  --accent: 220 14% 89%;\n\n  --accent-foreground: 220 13% 13%;\n\n  --destructive: 0 84% 60%;\n\n  --destructive-foreground: 0 0% 100%;\n\n  --input: 220 13% 80%;\n  --ring: 217 91% 60%;\n  --chart-1: 217 91% 60%;\n  --chart-2: 271 81% 56%;\n  --chart-3: 142 76% 36%;\n  --chart-4: 28 80% 52%;\n  --chart-5: 340 82% 52%;\n\n  --font-sans: Inter, -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: \"SF Mono\", Monaco, \"Cascadia Code\", \"Roboto Mono\", Consolas, \"Courier New\", monospace;\n  --radius: .5rem; /* 8px */\n  --shadow-2xs: 0px 1px 2px 0px hsl(220 13% 13% / 0.05);\n  --shadow-xs: 0px 1px 2px 0px hsl(220 13% 13% / 0.06);\n  --shadow-sm: 0px 1px 2px 0px hsl(220 13% 13% / 0.06), 0px 1px 3px 0px hsl(220 13% 13% / 0.10);\n  --shadow: 0px 1px 2px 0px hsl(220 13% 13% / 0.06), 0px 2px 4px -1px hsl(220 13% 13% / 0.10);\n  --shadow-md: 0px 2px 4px -1px hsl(220 13% 13% / 0.06), 0px 4px 6px -1px hsl(220 13% 13% / 0.10);\n  --shadow-lg: 0px 4px 6px -2px hsl(220 13% 13% / 0.05), 0px 10px 15px -3px hsl(220 13% 13% / 0.10);\n  --shadow-xl: 0px 10px 10px -5px hsl(220 13% 13% / 0.04), 0px 20px 25px -5px hsl(220 13% 13% / 0.10);\n  --shadow-2xl: 0px 25px 50px -12px hsl(220 13% 13% / 0.25);\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n\n  /* Automatically computed borders - intensity can be controlled by the user by the --opaque-button-border-intensity setting */\n\n  /* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n.dark {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n\n  --opaque-button-border-intensity: 9;  /* In terms of percentages */\n\n  /* Backgrounds applied on top of other backgrounds when hovered/active */\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n\n  --background: 220 13% 9%;\n\n  --foreground: 220 13% 91%;\n\n  --border: 220 13% 18%;\n\n  --card: 220 13% 11%;\n\n  --card-foreground: 220 13% 91%;\n\n  --card-border: 220 13% 15%;\n\n  --sidebar: 220 9% 13%;\n\n  --sidebar-foreground: 220 13% 91%;\n\n  --sidebar-border: 220 13% 18%;\n\n  --sidebar-primary: 217 91% 60%;\n\n  --sidebar-primary-foreground: 220 13% 9%;\n\n  --sidebar-accent: 220 13% 19%;\n\n  --sidebar-accent-foreground: 220 13% 91%;\n\n  --sidebar-ring: 217 91% 60%;\n\n  --popover: 220 13% 15%;\n\n  --popover-foreground: 220 13% 91%;\n\n  --popover-border: 220 13% 20%;\n\n  --primary: 217 91% 60%;\n\n  --primary-foreground: 0 0% 100%;\n\n  --secondary: 220 13% 21%;\n\n  --secondary-foreground: 220 13% 91%;\n\n  --muted: 220 13% 17%;\n\n  --muted-foreground: 220 9% 65%;\n\n  --accent: 220 14% 20%;\n\n  --accent-foreground: 220 13% 91%;\n\n  --destructive: 0 84% 60%;\n\n  --destructive-foreground: 0 0% 100%;\n\n  --input: 220 13% 29%;\n  --ring: 217 91% 60%;\n  --chart-1: 217 91% 70%;\n  --chart-2: 271 81% 70%;\n  --chart-3: 142 76% 55%;\n  --chart-4: 28 80% 65%;\n  --chart-5: 340 82% 65%;\n\n  --shadow-2xs: 0px 1px 2px 0px hsl(0 0% 0% / 0.30);\n  --shadow-xs: 0px 1px 2px 0px hsl(0 0% 0% / 0.40);\n  --shadow-sm: 0px 1px 2px 0px hsl(0 0% 0% / 0.40), 0px 1px 3px 0px hsl(0 0% 0% / 0.45);\n  --shadow: 0px 1px 2px 0px hsl(0 0% 0% / 0.40), 0px 2px 4px -1px hsl(0 0% 0% / 0.45);\n  --shadow-md: 0px 2px 4px -1px hsl(0 0% 0% / 0.40), 0px 4px 6px -1px hsl(0 0% 0% / 0.45);\n  --shadow-lg: 0px 4px 6px -2px hsl(0 0% 0% / 0.35), 0px 10px 15px -3px hsl(0 0% 0% / 0.45);\n  --shadow-xl: 0px 10px 10px -5px hsl(0 0% 0% / 0.30), 0px 20px 25px -5px hsl(0 0% 0% / 0.45);\n  --shadow-2xl: 0px 25px 50px -12px hsl(0 0% 0% / 0.60);\n\n  /* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n\n/**\n * Using the elevate system.\n * Automatic contrast adjustment.\n *\n * <element className=\"hover-elevate\" />\n * <element className=\"active-elevate-2\" />\n *\n * // Using the tailwind utility when a data attribute is \"on\"\n * <element className=\"toggle-elevate data-[state=on]:toggle-elevated\" />\n * // Or manually controlling the toggle state\n * <element className=\"toggle-elevate toggle-elevated\" />\n *\n * Elevation systems have to handle many states.\n * - not-hovered, vs. hovered vs. active  (three mutually exclusive states)\n * - toggled or not\n * - focused or not (this is not handled with these utilities)\n *\n * Even without handling focused or not, this is six possible combinations that\n * need to be distinguished from eachother visually.\n */\n@layer utilities {\n\n  /* Hide ugly search cancel button in Chrome until we can style it properly */\n  input[type=\"search\"]::-webkit-search-cancel-button {\n    @apply hidden;\n  }\n\n  /* Placeholder styling for contentEditable div */\n  [contenteditable][data-placeholder]:empty::before {\n    content: attr(data-placeholder);\n    color: hsl(var(--muted-foreground));\n    pointer-events: none;\n  }\n\n  /* .no-default-hover-elevate/no-default-active-elevate is an escape hatch so consumers of\n   * buttons/badges can remove the automatic brightness adjustment on interactions\n   * and program their own. */\n  .no-default-hover-elevate {}\n\n  .no-default-active-elevate {}\n\n\n  /**\n   * Toggleable backgrounds go behind the content. Hoverable/active goes on top.\n   * This way they can stack/compound. Both will overlap the parent's borders!\n   * So borders will be automatically adjusted both on toggle, and hover/active,\n   * and they will be compounded.\n   */\n  .toggle-elevate::before,\n  .toggle-elevate-2::before {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    border-radius: inherit;\n    z-index: -1;\n  }\n\n  .toggle-elevate.toggle-elevated::before {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.toggle-elevate::before {\n    inset: -1px;\n  }\n\n  /* Does not work on elements with overflow:hidden! */\n  .hover-elevate:not(.no-default-hover-elevate),\n  .active-elevate:not(.no-default-active-elevate),\n  .hover-elevate-2:not(.no-default-hover-elevate),\n  .active-elevate-2:not(.no-default-active-elevate) {\n    position: relative;\n    z-index: 0;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate)::after,\n  .active-elevate:not(.no-default-active-elevate)::after,\n  .hover-elevate-2:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:not(.no-default-active-elevate)::after {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    border-radius: inherit;\n    z-index: 999;\n  }\n\n  .hover-elevate:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-1);\n  }\n\n  .hover-elevate-2:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate-2:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate-2:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after {\n    inset: -1px;\n  }\n}","path":null,"size_bytes":11145,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1584,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":2695,"size_tokens":null},"client/src/components/SearchBar.tsx":{"content":"import { Input } from \"@/components/ui/input\";\nimport { Search, X } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface SearchBarProps {\n  value: string;\n  onChange: (value: string) => void;\n  placeholder?: string;\n}\n\nexport function SearchBar({ value, onChange, placeholder = \"T√¨m ki·∫øm t√†i li·ªáu...\" }: SearchBarProps) {\n  return (\n    <div className=\"relative w-full max-w-2xl mx-auto\">\n      <div className=\"relative\">\n        <Search className=\"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground pointer-events-none\" />\n        <Input\n          type=\"search\"\n          value={value}\n          onChange={(e) => onChange(e.target.value)}\n          placeholder={placeholder}\n          className=\"h-12 pl-12 pr-12 text-base rounded-lg border-input focus-visible:ring-2 focus-visible:ring-ring\"\n          data-testid=\"input-search\"\n        />\n        {value && (\n          <Button\n            size=\"icon\"\n            variant=\"ghost\"\n            onClick={() => onChange(\"\")}\n            className=\"absolute right-2 top-1/2 -translate-y-1/2 h-8 w-8\"\n            data-testid=\"button-clear-search\"\n          >\n            <X className=\"w-4 h-4\" />\n          </Button>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":1259,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \" ,\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary: \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n\n        outline: \" border [border-color:var(--badge-outline)] shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1202,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1467,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":711,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10481,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"client/src/pages/admin/Layout.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { User } from \"@shared/schema\";\nimport {\n  Sidebar,\n  SidebarContent,\n  SidebarGroup,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarMenu,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarProvider,\n} from \"@/components/ui/sidebar\";\nimport { LayoutDashboard, FileText, Users, Home, Tag, Upload, UserCheck, FolderKanban, MessageCircle, Bell, Coins } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\n\ninterface BadgeCounts {\n  pendingUploads: number;\n  unreadSupport: number;\n  newUsers: number;\n}\n\nconst menuItems = [\n  {\n    title: \"Dashboard\",\n    url: \"/admin\",\n    icon: LayoutDashboard,\n    badgeKey: null,\n  },\n  {\n    title: \"T√†i li·ªáu\",\n    url: \"/admin/documents\",\n    icon: FileText,\n    badgeKey: null,\n  },\n  {\n    title: \"Danh m·ª•c\",\n    url: \"/admin/categories\",\n    icon: FolderKanban,\n    badgeKey: null,\n  },\n  {\n    title: \"Tags\",\n    url: \"/admin/tags\",\n    icon: Tag,\n    badgeKey: null,\n  },\n  {\n    title: \"Upload H√†ng lo·∫°t\",\n    url: \"/admin/bulk-upload\",\n    icon: Upload,\n    badgeKey: null,\n  },\n  {\n    title: \"User Uploads\",\n    url: \"/admin/user-uploads\",\n    icon: UserCheck,\n    badgeKey: \"pendingUploads\" as keyof BadgeCounts,\n  },\n  {\n    title: \"H·ªó tr·ª£ Chat\",\n    url: \"/admin/support\",\n    icon: MessageCircle,\n    badgeKey: \"unreadSupport\" as keyof BadgeCounts,\n  },\n  {\n    title: \"Th√¥ng b√°o\",\n    url: \"/admin/notifications\",\n    icon: Bell,\n    badgeKey: null,\n  },\n  {\n    title: \"Ng∆∞·ªùi d√πng\",\n    url: \"/admin/users\",\n    icon: Users,\n    badgeKey: \"newUsers\" as keyof BadgeCounts,\n    isRed: true,\n  },\n  {\n    title: \"Check ƒêi·ªÉm User\",\n    url: \"/admin/user-points\",\n    icon: Coins,\n    badgeKey: null,\n  },\n];\n\ninterface AdminLayoutProps {\n  children: React.ReactNode;\n}\n\nexport default function AdminLayout({ children }: AdminLayoutProps) {\n  const [location] = useLocation();\n  \n  const { data: user } = useQuery<User>({\n    queryKey: [\"/api/auth/user\"],\n  });\n\n  const { data: badgeCounts } = useQuery<BadgeCounts>({\n    queryKey: [\"/api/admin/badge-counts\"],\n    refetchInterval: 30000, // Refresh every 30 seconds\n    enabled: !!user && user.role === \"admin\",\n  });\n\n  // Redirect if not admin\n  if (user && user.role !== \"admin\") {\n    window.location.href = \"/\";\n    return null;\n  }\n\n  const style = {\n    \"--sidebar-width\": \"16rem\",\n  };\n\n  return (\n    <SidebarProvider style={style as React.CSSProperties}>\n      <div className=\"flex h-screen w-full\">\n        <Sidebar>\n          <SidebarContent>\n            <SidebarGroup>\n              <SidebarGroupLabel>\n                <Link href=\"/\">\n                  <div className=\"flex items-center gap-2 cursor-pointer hover-elevate active-elevate-2 rounded-md p-2 -m-2\">\n                    <div className=\"h-8 w-8 rounded-lg bg-primary flex items-center justify-center\">\n                      <FileText className=\"h-4 w-4 text-primary-foreground\" />\n                    </div>\n                    <span className=\"font-semibold\">Admin Panel</span>\n                  </div>\n                </Link>\n              </SidebarGroupLabel>\n              <SidebarGroupContent>\n                <SidebarMenu>\n                  {menuItems.map((item) => {\n                    const badgeCount = item.badgeKey && badgeCounts ? badgeCounts[item.badgeKey] : 0;\n                    const isRed = (item as any).isRed;\n                    \n                    return (\n                      <SidebarMenuItem key={item.title}>\n                        <SidebarMenuButton asChild isActive={location === item.url}>\n                          <Link href={item.url}>\n                            <item.icon className=\"h-4 w-4\" />\n                            <span className=\"flex-1\">{item.title}</span>\n                            {badgeCount > 0 && (\n                              <Badge \n                                variant={isRed ? \"destructive\" : \"secondary\"}\n                                className=\"ml-auto text-xs min-w-[20px] h-5 flex items-center justify-center\"\n                                data-testid={`badge-${item.badgeKey}`}\n                              >\n                                {badgeCount}\n                              </Badge>\n                            )}\n                          </Link>\n                        </SidebarMenuButton>\n                      </SidebarMenuItem>\n                    );\n                  })}\n                </SidebarMenu>\n              </SidebarGroupContent>\n            </SidebarGroup>\n\n            <SidebarGroup className=\"mt-auto\">\n              <SidebarGroupContent>\n                <SidebarMenu>\n                  <SidebarMenuItem>\n                    <SidebarMenuButton asChild>\n                      <Link href=\"/\">\n                        <Home className=\"h-4 w-4\" />\n                        <span>V·ªÅ trang ch·ªß</span>\n                      </Link>\n                    </SidebarMenuButton>\n                  </SidebarMenuItem>\n                </SidebarMenu>\n              </SidebarGroupContent>\n            </SidebarGroup>\n          </SidebarContent>\n        </Sidebar>\n\n        <main className=\"flex-1 overflow-auto p-8\">\n          {children}\n        </main>\n      </div>\n    </SidebarProvider>\n  );\n}\n","path":null,"size_bytes":5302,"size_tokens":null},"client/src/pages/admin/DocumentForm.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport {\n  Form,\n  FormControl,\n  FormDescription,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { ArrowLeft, Upload, FileText } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Link } from \"wouter\";\nimport { Document } from \"@shared/schema\";\n\ninterface Category {\n  id: string;\n  name: string;\n  logoUrl?: string;\n  order: number;\n}\n\nconst documentFormSchema = z.object({\n  title: z.string().min(1, \"Ti√™u ƒë·ªÅ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng\"),\n  description: z.string().min(1, \"M√¥ t·∫£ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng\"),\n  category: z.string().min(1, \"Vui l√≤ng ch·ªçn danh m·ª•c\"),\n  pageCount: z.coerce.number().min(1, \"S·ªë trang ph·∫£i l·ªõn h∆°n 0\"),\n  coverImageUrl: z.string().url(\"URL ·∫£nh b√¨a kh√¥ng h·ª£p l·ªá\"),\n  videoUrl: z.string().url(\"URL video kh√¥ng h·ª£p l·ªá\"),\n  drmLicenseUrl: z.string().url(\"URL DRM license kh√¥ng h·ª£p l·ªá\").optional().or(z.literal(\"\")),\n});\n\ntype DocumentFormValues = z.infer<typeof documentFormSchema>;\n\ninterface DocumentFormProps {\n  documentId?: string;\n}\n\nexport default function DocumentForm({ documentId }: DocumentFormProps) {\n  const [, navigate] = useLocation();\n  const { toast } = useToast();\n  const [uploadedFile, setUploadedFile] = useState<File | null>(null);\n  const isEditing = !!documentId;\n\n  const { data: document, isLoading: isLoadingDocument } = useQuery<Document>({\n    queryKey: [`/api/admin/documents/${documentId}`],\n    enabled: isEditing,\n  });\n\n  const { data: categories = [] } = useQuery<Category[]>({\n    queryKey: [\"/api/categories\"],\n  });\n\n  const form = useForm<DocumentFormValues>({\n    resolver: zodResolver(documentFormSchema),\n    defaultValues: {\n      title: \"\",\n      description: \"\",\n      category: \"\",\n      pageCount: 1,\n      coverImageUrl: \"\",\n      videoUrl: \"\",\n      drmLicenseUrl: \"\",\n    },\n  });\n\n  // Reset form when document data is loaded\n  useEffect(() => {\n    if (document && isEditing) {\n      form.reset({\n        title: document.title,\n        description: document.description,\n        category: document.category,\n        pageCount: document.pageCount,\n        coverImageUrl: document.coverImageUrl,\n        videoUrl: document.videoUrl,\n        drmLicenseUrl: document.drmLicenseUrl || \"\",\n      });\n    }\n  }, [document, isEditing, form]);\n\n  const mutation = useMutation({\n    mutationFn: async (values: DocumentFormValues) => {\n      if (isEditing) {\n        await apiRequest(\"PATCH\", `/api/documents/${documentId}`, values);\n      } else {\n        await apiRequest(\"POST\", \"/api/documents\", values);\n      }\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/documents\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/documents\"] });\n      toast({\n        title: isEditing ? \"ƒê√£ c·∫≠p nh·∫≠t\" : \"ƒê√£ th√™m\",\n        description: isEditing ? \"T√†i li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t\" : \"T√†i li·ªáu m·ªõi ƒë√£ ƒë∆∞·ª£c th√™m\",\n      });\n      navigate(\"/admin/documents\");\n    },\n    onError: () => {\n      toast({\n        title: \"L·ªói\",\n        description: isEditing ? \"Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t t√†i li·ªáu\" : \"Kh√¥ng th·ªÉ t·∫°o t√†i li·ªáu\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      // Validate file type\n      const validTypes = [\n        \"application/pdf\",\n        \"application/vnd.ms-excel\",\n        \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n        \"text/csv\",\n      ];\n      \n      if (!validTypes.includes(file.type)) {\n        toast({\n          title: \"File kh√¥ng h·ª£p l·ªá\",\n          description: \"Ch·ªâ ch·∫•p nh·∫≠n file PDF, Excel ho·∫∑c CSV\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n\n      setUploadedFile(file);\n      toast({\n        title: \"File ƒë√£ ch·ªçn\",\n        description: `${file.name} - L∆∞u √Ω: Pipeline chuy·ªÉn ƒë·ªïi video s·∫Ω ƒë∆∞·ª£c t√≠ch h·ª£p sau`,\n      });\n    }\n  };\n\n  const onSubmit = (values: DocumentFormValues) => {\n    mutation.mutate(values);\n  };\n\n  if (isEditing && isLoadingDocument) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[400px]\">\n        <p className=\"text-muted-foreground\">ƒêang t·∫£i...</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center gap-4\">\n        <Link href=\"/admin/documents\">\n          <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-back\">\n            <ArrowLeft className=\"h-4 w-4\" />\n          </Button>\n        </Link>\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"heading-document-form\">\n            {isEditing ? \"Ch·ªânh s·ª≠a T√†i li·ªáu\" : \"Th√™m T√†i li·ªáu M·ªõi\"}\n          </h1>\n          <p className=\"text-muted-foreground\">\n            {isEditing ? \"C·∫≠p nh·∫≠t th√¥ng tin t√†i li·ªáu\" : \"T·∫°o t√†i li·ªáu m·ªõi trong h·ªá th·ªëng\"}\n          </p>\n        </div>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Th√¥ng tin t√†i li·ªáu</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n              {!isEditing && (\n                <div className=\"space-y-2\">\n                  <FormLabel>Upload File (PDF/Excel/CSV)</FormLabel>\n                  <div className=\"flex items-center gap-4\">\n                    <div className=\"flex-1\">\n                      <Input\n                        type=\"file\"\n                        accept=\".pdf,.xlsx,.xls,.csv\"\n                        onChange={handleFileChange}\n                        data-testid=\"input-file-upload\"\n                      />\n                    </div>\n                    {uploadedFile && (\n                      <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                        <FileText className=\"h-4 w-4\" />\n                        {uploadedFile.name}\n                      </div>\n                    )}\n                  </div>\n                  <FormDescription>\n                    T·∫£i l√™n file ngu·ªìn. Pipeline chuy·ªÉn ƒë·ªïi sang video DRM s·∫Ω ƒë∆∞·ª£c t√≠ch h·ª£p sau.\n                  </FormDescription>\n                </div>\n              )}\n\n              <FormField\n                control={form.control}\n                name=\"title\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Ti√™u ƒë·ªÅ</FormLabel>\n                    <FormControl>\n                      <Input {...field} data-testid=\"input-title\" placeholder=\"Nh·∫≠p ti√™u ƒë·ªÅ t√†i li·ªáu\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"description\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>M√¥ t·∫£</FormLabel>\n                    <FormControl>\n                      <Textarea\n                        {...field}\n                        data-testid=\"input-description\"\n                        placeholder=\"Nh·∫≠p m√¥ t·∫£ chi ti·∫øt v·ªÅ t√†i li·ªáu\"\n                        rows={4}\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <div className=\"grid gap-6 md:grid-cols-2\">\n                <FormField\n                  control={form.control}\n                  name=\"category\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Danh m·ª•c</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-category\">\n                            <SelectValue placeholder=\"Ch·ªçn danh m·ª•c\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          {categories.map((category) => (\n                            <SelectItem key={category.id} value={category.name}>\n                              {category.name}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"pageCount\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>S·ªë trang</FormLabel>\n                      <FormControl>\n                        <Input\n                          type=\"number\"\n                          {...field}\n                          data-testid=\"input-page-count\"\n                          placeholder=\"Nh·∫≠p s·ªë trang\"\n                          min={1}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <FormField\n                control={form.control}\n                name=\"coverImageUrl\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>URL ·∫£nh b√¨a</FormLabel>\n                    <FormControl>\n                      <Input\n                        {...field}\n                        data-testid=\"input-cover-image-url\"\n                        placeholder=\"https://example.com/cover.jpg\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"videoUrl\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>URL video DRM</FormLabel>\n                    <FormControl>\n                      <Input\n                        {...field}\n                        data-testid=\"input-video-url\"\n                        placeholder=\"https://example.com/video.mpd\"\n                      />\n                    </FormControl>\n                    <FormDescription>\n                      URL c·ªßa video ƒë√£ ƒë∆∞·ª£c m√£ h√≥a DRM (DASH/HLS)\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"drmLicenseUrl\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>URL DRM License (t√πy ch·ªçn)</FormLabel>\n                    <FormControl>\n                      <Input\n                        {...field}\n                        data-testid=\"input-drm-license-url\"\n                        placeholder=\"https://example.com/drm/license\"\n                      />\n                    </FormControl>\n                    <FormDescription>\n                      URL server c·∫•p license DRM (Widevine/PlayReady)\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <div className=\"flex items-center gap-4 pt-4\">\n                <Button\n                  type=\"submit\"\n                  disabled={mutation.isPending}\n                  data-testid=\"button-submit\"\n                >\n                  {mutation.isPending ? \"ƒêang l∆∞u...\" : isEditing ? \"C·∫≠p nh·∫≠t\" : \"T·∫°o t√†i li·ªáu\"}\n                </Button>\n                <Link href=\"/admin/documents\">\n                  <Button type=\"button\" variant=\"outline\" data-testid=\"button-cancel\">\n                    H·ªßy\n                  </Button>\n                </Link>\n              </div>\n            </form>\n          </Form>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":12884,"size_tokens":null},"client/src/pages/admin/Tags.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Tag, InsertTag } from \"@shared/schema\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Card,\n  CardContent,\n  CardDescription,\n  CardHeader,\n  CardTitle,\n} from \"@/components/ui/card\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Plus, Trash2, Tag as TagIcon } from \"lucide-react\";\n\nexport default function Tags() {\n  const { toast } = useToast();\n  const [newTagName, setNewTagName] = useState(\"\");\n  const [tagToDelete, setTagToDelete] = useState<Tag | null>(null);\n\n  const { data: tags, isLoading } = useQuery<Tag[]>({\n    queryKey: [\"/api/tags\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (tagData: InsertTag) => {\n      const response = await apiRequest(\"POST\", \"/api/admin/tags\", tagData);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/tags\"] });\n      setNewTagName(\"\");\n      toast({\n        title: \"Th√†nh c√¥ng\",\n        description: \"Tag ƒë√£ ƒë∆∞·ª£c t·∫°o\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"L·ªói\",\n        description: \"Kh√¥ng th·ªÉ t·∫°o tag\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await fetch(`/api/admin/tags/${id}`, {\n        method: \"DELETE\",\n      });\n      if (!response.ok) throw new Error(\"Failed to delete tag\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/tags\"] });\n      setTagToDelete(null);\n      toast({\n        title: \"Th√†nh c√¥ng\",\n        description: \"Tag ƒë√£ ƒë∆∞·ª£c x√≥a\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"L·ªói\",\n        description: \"Kh√¥ng th·ªÉ x√≥a tag\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleCreateTag = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!newTagName.trim()) {\n      toast({\n        title: \"L·ªói\",\n        description: \"T√™n tag kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    createMutation.mutate({ name: newTagName.trim() });\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-8\">\n        <div className=\"text-center\">ƒêang t·∫£i...</div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-8\">\n      <div className=\"max-w-4xl mx-auto\">\n        <div className=\"flex items-center gap-2 mb-6\">\n          <TagIcon className=\"h-6 w-6\" />\n          <h1 className=\"text-3xl font-bold\" data-testid=\"heading-tags\">Qu·∫£n l√Ω Tags</h1>\n        </div>\n\n        <Card className=\"mb-6\">\n          <CardHeader>\n            <CardTitle>Th√™m Tag M·ªõi</CardTitle>\n            <CardDescription>\n              T·∫°o tag m·ªõi ƒë·ªÉ ph√¢n lo·∫°i t√†i li·ªáu\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <form onSubmit={handleCreateTag} className=\"flex gap-2\">\n              <Input\n                type=\"text\"\n                placeholder=\"T√™n tag...\"\n                value={newTagName}\n                onChange={(e) => setNewTagName(e.target.value)}\n                data-testid=\"input-tag-name\"\n                className=\"flex-1\"\n              />\n              <Button\n                type=\"submit\"\n                disabled={createMutation.isPending}\n                data-testid=\"button-add-tag\"\n              >\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Th√™m Tag\n              </Button>\n            </form>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Danh s√°ch Tags</CardTitle>\n            <CardDescription>\n              {tags?.length || 0} tag hi·ªán c√≥\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            {!tags || tags.length === 0 ? (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                Ch∆∞a c√≥ tag n√†o\n              </div>\n            ) : (\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>T√™n</TableHead>\n                    <TableHead>Ng√†y t·∫°o</TableHead>\n                    <TableHead className=\"text-right\">H√†nh ƒë·ªông</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {tags.map((tag) => (\n                    <TableRow key={tag.id} data-testid={`row-tag-${tag.id}`}>\n                      <TableCell className=\"font-medium\">{tag.name}</TableCell>\n                      <TableCell>\n                        {tag.createdAt\n                          ? new Date(tag.createdAt).toLocaleDateString(\"vi-VN\")\n                          : \"-\"}\n                      </TableCell>\n                      <TableCell className=\"text-right\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={() => setTagToDelete(tag)}\n                          data-testid={`button-delete-tag-${tag.id}`}\n                        >\n                          <Trash2 className=\"h-4 w-4\" />\n                        </Button>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      <AlertDialog open={!!tagToDelete} onOpenChange={() => setTagToDelete(null)}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>X√°c nh·∫≠n x√≥a</AlertDialogTitle>\n            <AlertDialogDescription>\n              B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a tag \"{tagToDelete?.name}\"? H√†nh ƒë·ªông n√†y kh√¥ng\n              th·ªÉ ho√†n t√°c.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-delete\">H·ªßy</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => tagToDelete && deleteMutation.mutate(tagToDelete.id)}\n              disabled={deleteMutation.isPending}\n              data-testid=\"button-confirm-delete\"\n            >\n              X√≥a\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":6883,"size_tokens":null},"client/src/pages/admin/Documents.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useState } from \"react\";\nimport { Link } from \"wouter\";\nimport { Document } from \"@shared/schema\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { Plus, Search, Pencil, Trash2, Eye, ChevronLeft, ChevronRight, Calendar } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { vi } from \"date-fns/locale\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nconst ITEMS_PER_PAGE = 50;\n\nexport default function AdminDocuments() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [deleteId, setDeleteId] = useState<string | null>(null);\n  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());\n  const [showBulkDeleteDialog, setShowBulkDeleteDialog] = useState(false);\n  const [currentPage, setCurrentPage] = useState(1);\n  const { toast } = useToast();\n\n  const { data: documents = [], isLoading } = useQuery<Document[]>({\n    queryKey: [\"/api/admin/documents\"],\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await apiRequest(\"DELETE\", `/api/admin/documents/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/documents\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/documents\"] });\n      toast({\n        title: \"ƒê√£ x√≥a\",\n        description: \"T√†i li·ªáu ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng\",\n      });\n      setDeleteId(null);\n    },\n    onError: () => {\n      toast({\n        title: \"L·ªói\",\n        description: \"Kh√¥ng th·ªÉ x√≥a t√†i li·ªáu\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const bulkDeleteMutation = useMutation({\n    mutationFn: async (ids: string[]) => {\n      await apiRequest(\"POST\", \"/api/admin/documents/bulk-delete\", { ids });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/documents\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/documents\"] });\n      toast({\n        title: \"ƒê√£ x√≥a\",\n        description: `ƒê√£ x√≥a ${selectedIds.size} t√†i li·ªáu th√†nh c√¥ng`,\n      });\n      setSelectedIds(new Set());\n      setShowBulkDeleteDialog(false);\n    },\n    onError: () => {\n      toast({\n        title: \"L·ªói\",\n        description: \"Kh√¥ng th·ªÉ x√≥a t√†i li·ªáu\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const filteredDocuments = documents.filter((doc) =>\n    doc.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\n    doc.description.toLowerCase().includes(searchQuery.toLowerCase()) ||\n    doc.category.toLowerCase().includes(searchQuery.toLowerCase())\n  );\n\n  const totalPages = Math.ceil(filteredDocuments.length / ITEMS_PER_PAGE);\n  const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;\n  const endIndex = startIndex + ITEMS_PER_PAGE;\n  const paginatedDocuments = filteredDocuments.slice(startIndex, endIndex);\n\n  const handleSelectAll = (checked: boolean | \"indeterminate\") => {\n    if (checked === true) {\n      const newSelected = new Set(paginatedDocuments.map(doc => doc.id));\n      setSelectedIds(newSelected);\n    } else {\n      setSelectedIds(new Set());\n    }\n  };\n\n  const handleSelectOne = (id: string, checked: boolean | \"indeterminate\") => {\n    const newSelected = new Set(selectedIds);\n    if (checked === true) {\n      newSelected.add(id);\n    } else {\n      newSelected.delete(id);\n    }\n    setSelectedIds(newSelected);\n  };\n\n  const isAllSelected = paginatedDocuments.length > 0 && \n    paginatedDocuments.every(doc => selectedIds.has(doc.id));\n  const isSomeSelected = paginatedDocuments.some(doc => selectedIds.has(doc.id));\n\n  const handlePageChange = (page: number) => {\n    setCurrentPage(page);\n    setSelectedIds(new Set());\n  };\n\n  const handleBulkDelete = () => {\n    if (selectedIds.size > 0) {\n      bulkDeleteMutation.mutate(Array.from(selectedIds));\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"heading-admin-documents\">Qu·∫£n l√Ω T√†i li·ªáu</h1>\n          <p className=\"text-muted-foreground\">Th√™m, s·ª≠a v√† x√≥a t√†i li·ªáu</p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          {selectedIds.size > 0 && (\n            <Button \n              variant=\"destructive\" \n              onClick={() => setShowBulkDeleteDialog(true)}\n              data-testid=\"button-bulk-delete\"\n            >\n              <Trash2 className=\"h-4 w-4 mr-2\" />\n              X√≥a {selectedIds.size} t√†i li·ªáu\n            </Button>\n          )}\n          <Link href=\"/admin/documents/new\">\n            <Button data-testid=\"button-add-document\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Th√™m t√†i li·ªáu\n            </Button>\n          </Link>\n        </div>\n      </div>\n\n      <Card>\n        <CardContent className=\"pt-6\">\n          <div className=\"flex items-center justify-between gap-4 mb-4 flex-wrap\">\n            <div className=\"flex items-center gap-2\">\n              <Search className=\"h-4 w-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"T√¨m ki·∫øm t√†i li·ªáu...\"\n                value={searchQuery}\n                onChange={(e) => {\n                  setSearchQuery(e.target.value);\n                  setCurrentPage(1);\n                }}\n                data-testid=\"input-search-documents\"\n                className=\"max-w-sm\"\n              />\n            </div>\n            <div className=\"text-sm text-muted-foreground\">\n              T·ªïng c·ªông: {filteredDocuments.length} t√†i li·ªáu\n            </div>\n          </div>\n\n          {isLoading ? (\n            <p className=\"text-center text-muted-foreground py-8\">ƒêang t·∫£i...</p>\n          ) : filteredDocuments.length === 0 ? (\n            <p className=\"text-center text-muted-foreground py-8\">Kh√¥ng t√¨m th·∫•y t√†i li·ªáu</p>\n          ) : (\n            <>\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead className=\"w-12\">\n                      <Checkbox \n                        checked={isAllSelected}\n                        onCheckedChange={handleSelectAll}\n                        data-testid=\"checkbox-select-all\"\n                      />\n                    </TableHead>\n                    <TableHead>ID</TableHead>\n                    <TableHead>Cover</TableHead>\n                    <TableHead>Ti√™u ƒë·ªÅ</TableHead>\n                    <TableHead>Category</TableHead>\n                    <TableHead>Th·ªùi gian post</TableHead>\n                    <TableHead className=\"text-right\">L∆∞·ª£t xem</TableHead>\n                    <TableHead className=\"text-right\">Thao t√°c</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {paginatedDocuments.map((doc) => (\n                    <TableRow key={doc.id} data-testid={`row-document-${doc.id}`}>\n                      <TableCell>\n                        <Checkbox \n                          checked={selectedIds.has(doc.id)}\n                          onCheckedChange={(checked) => handleSelectOne(doc.id, checked)}\n                          data-testid={`checkbox-select-${doc.id}`}\n                        />\n                      </TableCell>\n                      <TableCell>\n                        <span className=\"font-mono text-xs text-muted-foreground\" data-testid={`text-postid-${doc.id}`}>\n                          {doc.postId || \"N/A\"}\n                        </span>\n                      </TableCell>\n                      <TableCell>\n                        <img \n                          src={doc.coverImageUrl} \n                          alt={doc.title} \n                          className=\"h-12 w-16 rounded object-cover\"\n                        />\n                      </TableCell>\n                      <TableCell className=\"font-medium\">{doc.title}</TableCell>\n                      <TableCell>{doc.category}</TableCell>\n                      <TableCell>\n                        <div className=\"flex items-center gap-1 text-sm text-muted-foreground\" data-testid={`text-created-${doc.id}`}>\n                          <Calendar className=\"h-3 w-3\" />\n                          {doc.createdAt \n                            ? format(new Date(doc.createdAt), \"dd/MM/yyyy HH:mm\", { locale: vi })\n                            : \"N/A\"\n                          }\n                        </div>\n                      </TableCell>\n                      <TableCell className=\"text-right\">\n                        <div className=\"flex items-center justify-end gap-1\">\n                          <Eye className=\"h-3 w-3\" />\n                          {doc.viewCount}\n                        </div>\n                      </TableCell>\n                      <TableCell className=\"text-right\">\n                        <div className=\"flex items-center justify-end gap-2\">\n                          <Link href={`/admin/documents/edit/${doc.id}`}>\n                            <Button \n                              variant=\"ghost\" \n                              size=\"icon\"\n                              data-testid={`button-edit-${doc.id}`}\n                            >\n                              <Pencil className=\"h-4 w-4\" />\n                            </Button>\n                          </Link>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => setDeleteId(doc.id)}\n                            data-testid={`button-delete-${doc.id}`}\n                          >\n                            <Trash2 className=\"h-4 w-4\" />\n                          </Button>\n                        </div>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n\n              {totalPages > 1 && (\n                <div className=\"flex items-center justify-between mt-4 pt-4 border-t\">\n                  <div className=\"text-sm text-muted-foreground\">\n                    Trang {currentPage} / {totalPages} (Hi·ªÉn th·ªã {startIndex + 1} - {Math.min(endIndex, filteredDocuments.length)} c·ªßa {filteredDocuments.length})\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => handlePageChange(currentPage - 1)}\n                      disabled={currentPage === 1}\n                      data-testid=\"button-prev-page\"\n                    >\n                      <ChevronLeft className=\"h-4 w-4 mr-1\" />\n                      Tr∆∞·ªõc\n                    </Button>\n                    <div className=\"flex items-center gap-1\">\n                      {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {\n                        let page: number;\n                        if (totalPages <= 5) {\n                          page = i + 1;\n                        } else if (currentPage <= 3) {\n                          page = i + 1;\n                        } else if (currentPage >= totalPages - 2) {\n                          page = totalPages - 4 + i;\n                        } else {\n                          page = currentPage - 2 + i;\n                        }\n                        return (\n                          <Button\n                            key={page}\n                            variant={currentPage === page ? \"default\" : \"outline\"}\n                            size=\"sm\"\n                            onClick={() => handlePageChange(page)}\n                            data-testid={`button-page-${page}`}\n                          >\n                            {page}\n                          </Button>\n                        );\n                      })}\n                    </div>\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => handlePageChange(currentPage + 1)}\n                      disabled={currentPage === totalPages}\n                      data-testid=\"button-next-page\"\n                    >\n                      Sau\n                      <ChevronRight className=\"h-4 w-4 ml-1\" />\n                    </Button>\n                  </div>\n                </div>\n              )}\n            </>\n          )}\n        </CardContent>\n      </Card>\n\n      <AlertDialog open={!!deleteId} onOpenChange={(open) => !open && setDeleteId(null)}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>X√°c nh·∫≠n x√≥a</AlertDialogTitle>\n            <AlertDialogDescription>\n              B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i li·ªáu n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-delete\">H·ªßy</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => deleteId && deleteMutation.mutate(deleteId)}\n              data-testid=\"button-confirm-delete\"\n            >\n              X√≥a\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      <AlertDialog open={showBulkDeleteDialog} onOpenChange={setShowBulkDeleteDialog}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>X√°c nh·∫≠n x√≥a h√†ng lo·∫°t</AlertDialogTitle>\n            <AlertDialogDescription>\n              B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a {selectedIds.size} t√†i li·ªáu ƒë√£ ch·ªçn? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-bulk-delete\">H·ªßy</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={handleBulkDelete}\n              disabled={bulkDeleteMutation.isPending}\n              data-testid=\"button-confirm-bulk-delete\"\n            >\n              {bulkDeleteMutation.isPending ? \"ƒêang x√≥a...\" : `X√≥a ${selectedIds.size} t√†i li·ªáu`}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":14918,"size_tokens":null},"client/src/pages/admin/Users.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useState } from \"react\";\nimport { User } from \"@shared/schema\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Search, Shield, User as UserIcon } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport default function AdminUsers() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const { toast } = useToast();\n\n  const { data: users = [], isLoading } = useQuery<User[]>({\n    queryKey: [\"/api/admin/users\"],\n  });\n\n  const updateRoleMutation = useMutation({\n    mutationFn: async ({ userId, role }: { userId: string; role: string }) => {\n      await apiRequest(\"PATCH\", `/api/admin/users/${userId}/role`, { role });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/users\"] });\n      toast({\n        title: \"ƒê√£ c·∫≠p nh·∫≠t\",\n        description: \"Vai tr√≤ ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c thay ƒë·ªïi\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"L·ªói\",\n        description: \"Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t vai tr√≤\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const filteredUsers = users.filter((user) =>\n    user.email?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n    user.firstName?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n    user.lastName?.toLowerCase().includes(searchQuery.toLowerCase())\n  );\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold\" data-testid=\"heading-admin-users\">Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</h1>\n        <p className=\"text-muted-foreground\">Xem v√† qu·∫£n l√Ω ng∆∞·ªùi d√πng</p>\n      </div>\n\n      <Card>\n        <CardContent className=\"pt-6\">\n          <div className=\"flex items-center gap-2 mb-4\">\n            <Search className=\"h-4 w-4 text-muted-foreground\" />\n            <Input\n              placeholder=\"T√¨m ki·∫øm ng∆∞·ªùi d√πng...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              data-testid=\"input-search-users\"\n              className=\"max-w-sm\"\n            />\n          </div>\n\n          {isLoading ? (\n            <p className=\"text-center text-muted-foreground py-8\">ƒêang t·∫£i...</p>\n          ) : filteredUsers.length === 0 ? (\n            <p className=\"text-center text-muted-foreground py-8\">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng</p>\n          ) : (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Ng∆∞·ªùi d√πng</TableHead>\n                  <TableHead>Email</TableHead>\n                  <TableHead>Vai tr√≤</TableHead>\n                  <TableHead>Ng√†y tham gia</TableHead>\n                  <TableHead className=\"text-right\">Thao t√°c</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {filteredUsers.map((user) => (\n                  <TableRow key={user.id} data-testid={`row-user-${user.id}`}>\n                    <TableCell>\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"h-9 w-9 rounded-full bg-primary flex items-center justify-center\">\n                          <span className=\"text-sm font-medium text-primary-foreground\">\n                            {user.firstName?.[0] ?? user.email?.[0] ?? \"?\"}\n                          </span>\n                        </div>\n                        <div>\n                          <p className=\"font-medium\">\n                            {user.firstName && user.lastName\n                              ? `${user.firstName} ${user.lastName}`\n                              : \"Ch∆∞a c·∫≠p nh·∫≠t\"}\n                          </p>\n                        </div>\n                      </div>\n                    </TableCell>\n                    <TableCell>{user.email}</TableCell>\n                    <TableCell>\n                      <Badge \n                        variant={user.role === \"admin\" ? \"default\" : \"secondary\"}\n                        data-testid={`badge-role-${user.id}`}\n                      >\n                        {user.role === \"admin\" ? (\n                          <>\n                            <Shield className=\"h-3 w-3 mr-1\" />\n                            Admin\n                          </>\n                        ) : (\n                          <>\n                            <UserIcon className=\"h-3 w-3 mr-1\" />\n                            User\n                          </>\n                        )}\n                      </Badge>\n                    </TableCell>\n                    <TableCell>\n                      {user.createdAt ? new Date(user.createdAt).toLocaleDateString(\"vi-VN\") : \"-\"}\n                    </TableCell>\n                    <TableCell className=\"text-right\">\n                      <Select\n                        value={user.role}\n                        onValueChange={(role) => updateRoleMutation.mutate({ userId: user.id, role })}\n                        disabled={updateRoleMutation.isPending}\n                      >\n                        <SelectTrigger \n                          className=\"w-32\"\n                          data-testid={`select-role-${user.id}`}\n                        >\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"user\">User</SelectItem>\n                          <SelectItem value=\"admin\">Admin</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":6209,"size_tokens":null},"client/src/pages/admin/Dashboard.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Users, FileText, Heart, Eye } from \"lucide-react\";\nimport { User, Document } from \"@shared/schema\";\n\nexport default function AdminDashboard() {\n  const { data: stats } = useQuery<{\n    totalDocuments: number;\n    totalUsers: number;\n    totalFavorites: number;\n    totalViews: number;\n  }>({\n    queryKey: [\"/api/admin/stats\"],\n  });\n\n  const { data: recentDocuments = [] } = useQuery<Document[]>({\n    queryKey: [\"/api/admin/documents/recent\"],\n  });\n\n  const { data: recentUsers = [] } = useQuery<User[]>({\n    queryKey: [\"/api/admin/users/recent\"],\n  });\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold\" data-testid=\"heading-admin-dashboard\">Dashboard</h1>\n        <p className=\"text-muted-foreground\">T·ªïng quan h·ªá th·ªëng</p>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">T·ªïng t√†i li·ªáu</CardTitle>\n            <FileText className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"stat-total-documents\">\n              {stats?.totalDocuments ?? 0}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Ng∆∞·ªùi d√πng</CardTitle>\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"stat-total-users\">\n              {stats?.totalUsers ?? 0}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">L∆∞·ª£t y√™u th√≠ch</CardTitle>\n            <Heart className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"stat-total-favorites\">\n              {stats?.totalFavorites ?? 0}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">L∆∞·ª£t xem</CardTitle>\n            <Eye className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"stat-total-views\">\n              {stats?.totalViews ?? 0}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-2\">\n        <Card>\n          <CardHeader>\n            <CardTitle>T√†i li·ªáu m·ªõi nh·∫•t</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-4\">\n              {recentDocuments.length === 0 ? (\n                <p className=\"text-sm text-muted-foreground\">Ch∆∞a c√≥ t√†i li·ªáu n√†o</p>\n              ) : (\n                recentDocuments.map((doc) => (\n                  <div key={doc.id} className=\"flex items-center gap-3\" data-testid={`recent-doc-${doc.id}`}>\n                    <img \n                      src={doc.coverImageUrl} \n                      alt={doc.title} \n                      className=\"h-12 w-12 rounded object-cover\"\n                    />\n                    <div className=\"flex-1 space-y-1\">\n                      <p className=\"text-sm font-medium leading-none\">{doc.title}</p>\n                      <p className=\"text-sm text-muted-foreground\">{doc.category}</p>\n                    </div>\n                  </div>\n                ))\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Ng∆∞·ªùi d√πng m·ªõi</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-4\">\n              {recentUsers.length === 0 ? (\n                <p className=\"text-sm text-muted-foreground\">Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o</p>\n              ) : (\n                recentUsers.map((user) => (\n                  <div key={user.id} className=\"flex items-center gap-3\" data-testid={`recent-user-${user.id}`}>\n                    <div className=\"h-9 w-9 rounded-full bg-primary flex items-center justify-center\">\n                      <span className=\"text-sm font-medium text-primary-foreground\">\n                        {user.firstName?.[0] ?? user.email?.[0] ?? \"?\"}\n                      </span>\n                    </div>\n                    <div className=\"flex-1 space-y-1\">\n                      <p className=\"text-sm font-medium leading-none\">\n                        {user.firstName && user.lastName\n                          ? `${user.firstName} ${user.lastName}`\n                          : user.email}\n                      </p>\n                      <p className=\"text-sm text-muted-foreground\">{user.email}</p>\n                    </div>\n                  </div>\n                ))\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":5513,"size_tokens":null},"client/src/components/AdminRoute.tsx":{"content":"import { useAuth } from \"@/hooks/useAuth\";\nimport { useEffect } from \"react\";\n\ninterface AdminRouteProps {\n  children: React.ReactNode;\n}\n\nexport function AdminRoute({ children }: AdminRouteProps) {\n  const { isAuthenticated, isLoading, user } = useAuth();\n\n  useEffect(() => {\n    if (!isLoading && !isAuthenticated) {\n      window.location.href = \"/api/login\";\n    }\n  }, [isAuthenticated, isLoading]);\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4\"></div>\n          <p className=\"text-muted-foreground\">ƒêang t·∫£i...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!isAuthenticated) {\n    return null;\n  }\n\n  // Check if user is admin\n  if (user?.role !== \"admin\") {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center max-w-md mx-auto p-6\">\n          <div className=\"text-6xl mb-4\">üö´</div>\n          <h1 className=\"text-2xl font-bold mb-2\">Truy c·∫≠p b·ªã t·ª´ ch·ªëi</h1>\n          <p className=\"text-muted-foreground mb-4\">\n            B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p v√†o trang qu·∫£n tr·ªã. Ch·ªâ c√≥ qu·∫£n tr·ªã vi√™n m·ªõi c√≥ th·ªÉ truy c·∫≠p khu v·ª±c n√†y.\n          </p>\n          <a\n            href=\"/\"\n            className=\"text-primary hover:underline\"\n            data-testid=\"link-back-home\"\n          >\n            ‚Üê Quay l·∫°i trang ch·ªß\n          </a>\n        </div>\n      </div>\n    );\n  }\n\n  return <>{children}</>;\n}\n","path":null,"size_bytes":1621,"size_tokens":null},"server/scripts/list-admins.ts":{"content":"#!/usr/bin/env tsx\n/**\n * Script ƒë·ªÉ li·ªát k√™ t·∫•t c·∫£ admin trong h·ªá th·ªëng\n * Usage: npx tsx server/scripts/list-admins.ts\n */\n\nimport { db } from \"../db\";\nimport { users } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\n\nasync function listAdmins() {\n  try {\n    console.log(\"üîç ƒêang t√¨m t·∫•t c·∫£ admin...\\n\");\n\n    const admins = await db\n      .select()\n      .from(users)\n      .where(eq(users.role, \"admin\"));\n\n    if (admins.length === 0) {\n      console.log(\"‚ö†Ô∏è  Ch∆∞a c√≥ admin n√†o trong h·ªá th·ªëng\");\n      console.log(\"üí° S·ª≠ d·ª•ng: npx tsx server/scripts/make-admin.ts <email>\");\n      process.exit(0);\n    }\n\n    console.log(`‚úÖ T√¨m th·∫•y ${admins.length} admin:\\n`);\n    \n    admins.forEach((admin, index) => {\n      console.log(`${index + 1}. ${admin.firstName || ''} ${admin.lastName || ''}`.trim());\n      console.log(`   üìß Email: ${admin.email}`);\n      console.log(`   üÜî ID: ${admin.id}`);\n      console.log(`   üìÖ T·∫°o l√∫c: ${admin.createdAt?.toLocaleString('vi-VN')}`);\n      console.log(\"\");\n    });\n\n  } catch (error) {\n    console.error(\"‚ùå L·ªói khi li·ªát k√™ admin:\", error);\n    process.exit(1);\n  } finally {\n    process.exit(0);\n  }\n}\n\nlistAdmins();\n","path":null,"size_bytes":1230,"size_tokens":null},"server/scripts/make-admin.ts":{"content":"#!/usr/bin/env tsx\n/**\n * Script ƒë·ªÉ b·ªï nhi·ªám admin th√¥ng qua email\n * Usage: npm run make-admin <email>\n * Example: npm run make-admin user@example.com\n */\n\nimport { db } from \"../db\";\nimport { users } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\n\nasync function makeAdmin(email: string) {\n  if (!email) {\n    console.error(\"‚ùå L·ªói: Vui l√≤ng cung c·∫•p email\");\n    console.log(\"C√°ch s·ª≠ d·ª•ng: npm run make-admin <email>\");\n    console.log(\"V√≠ d·ª•: npm run make-admin user@example.com\");\n    process.exit(1);\n  }\n\n  try {\n    console.log(`üîç ƒêang t√¨m user v·ªõi email: ${email}...`);\n\n    // T√¨m user theo email\n    const [user] = await db\n      .select()\n      .from(users)\n      .where(eq(users.email, email))\n      .limit(1);\n\n    if (!user) {\n      console.error(`‚ùå Kh√¥ng t√¨m th·∫•y user v·ªõi email: ${email}`);\n      console.log(\"\\nüí° L∆∞u √Ω: User ph·∫£i ƒëƒÉng nh·∫≠p √≠t nh·∫•t 1 l·∫ßn tr∆∞·ªõc khi b·ªï nhi·ªám admin\");\n      process.exit(1);\n    }\n\n    // Ki·ªÉm tra n·∫øu ƒë√£ l√† admin\n    if (user.role === \"admin\") {\n      console.log(`‚úÖ User ${email} ƒë√£ l√† admin r·ªìi!`);\n      console.log(`   T√™n: ${user.firstName} ${user.lastName}`);\n      console.log(`   ID: ${user.id}`);\n      process.exit(0);\n    }\n\n    // Update role th√†nh admin\n    console.log(`‚öôÔ∏è  ƒêang c·∫≠p nh·∫≠t role...`);\n    const [updatedUser] = await db\n      .update(users)\n      .set({ \n        role: \"admin\",\n        updatedAt: new Date()\n      })\n      .where(eq(users.email, email))\n      .returning();\n\n    console.log(\"\\n‚úÖ B·ªï nhi·ªám admin th√†nh c√¥ng!\");\n    console.log(`   Email: ${updatedUser.email}`);\n    console.log(`   T√™n: ${updatedUser.firstName} ${updatedUser.lastName}`);\n    console.log(`   Role: ${updatedUser.role}`);\n    console.log(`   ID: ${updatedUser.id}`);\n    console.log(\"\\nüéâ User n√†y gi·ªù ƒë√£ c√≥ quy·ªÅn admin!\");\n\n  } catch (error) {\n    console.error(\"‚ùå L·ªói khi b·ªï nhi·ªám admin:\", error);\n    process.exit(1);\n  } finally {\n    process.exit(0);\n  }\n}\n\n// L·∫•y email t·ª´ command line arguments\nconst email = process.argv[2];\nmakeAdmin(email);\n","path":null,"size_bytes":2136,"size_tokens":null},"server/pipeline/excel_to_png.py":{"content":"#!/usr/bin/env python3\nimport os\nimport sys\n\n# Always use local cache for Playwright browsers (matches pip-installed playwright version)\nscript_dir = os.path.dirname(os.path.abspath(__file__))\nworkspace_dir = os.path.dirname(os.path.dirname(script_dir))\nplaywright_path = os.path.join(workspace_dir, '.cache', 'ms-playwright')\nos.environ['PLAYWRIGHT_BROWSERS_PATH'] = playwright_path\nprint(f\"[Pipeline] Set PLAYWRIGHT_BROWSERS_PATH to: {playwright_path}\", file=sys.stderr)\n\nimport json\nimport pandas as pd\nfrom jinja2 import Environment, FileSystemLoader\nfrom playwright.sync_api import sync_playwright\nimport math\nimport shutil\nfrom PIL import Image, ImageDraw, ImageFont, ImageFilter\nimport re\nimport warnings\n\nwarnings.simplefilter(action='ignore', category=FutureWarning)\n\nTARGET_WIDTH, TARGET_HEIGHT = 2000, 1300\nROW_HEIGHT = 108\nROWS_PER_PAGE = 10\nDATA_COLS_TO_KEEP = 15\nINDEX_COL_WIDTH = 50\nTOP_3_COL_WIDTH = 200\nOTHER_COL_WIDTH = 105\nAVG_CHAR_WIDTH = 8.5\nCELL_PADDING_X = 10\nLINE_HEIGHT_ESTIMATE = 18\n\nMAX_LEAK_TOLERANCE = 5\n\nWATERMARK_TEXT = \"DATALD.COM\"\nWATERMARK_OPACITY = 90\nGRID_COLS = 3\nGRID_ROWS = 3\n\nCOVER_BLUR_RADIUS = 8\nFREE_PREVIEW_IMAGES = 10\n\nKEYWORDS_TO_MASK = [\n    \"trangvang\", \n    \"scribd\", \n    \"hsct\", \n    \"hosocongty\", \n    \"thu·∫ø\",\n    \"thue\",\n    \"masothue\", \n    \"data5s\", \n    \"google.com/maps/\"\n]\n\n# Keywords that trigger complete cell content removal (case-insensitive)\nKEYWORDS_TO_REMOVE_CELL = [\n    \"trang vang\",\n    \"trangvang\",\n    \"scribd\",\n    \"hsct\",\n    \"hosocongty\",\n    \"mst\",\n    \"masothue\",\n    \"data5s\",\n    \"google.com/map\"\n]\n\ndef mask_all_chars(match):\n    \"\"\"Callback: Thay th·∫ø to√†n b·ªô chu·ªói kh·ªõp b·∫±ng d·∫•u *\"\"\"\n    return '*' * len(match.group())\n\ndef mask_number_group(match):\n    \"\"\"Callback: M√£ h√≥a 50% ƒë·ªô d√†i c·ªßa c·ª•m s·ªë\"\"\"\n    digit_str = match.group()\n    length = len(digit_str)\n    num_to_mask = math.ceil(length / 2)\n    return (\"*\" * num_to_mask) + digit_str[num_to_mask:]\n\ndef mask_email_group(match):\n    \"\"\"Callback: M√£ h√≥a user c·ªßa email\"\"\"\n    email = match.group()\n    if '@' in email:\n        user_part, domain_part = email.split('@', 1)\n        masked_user = '*' * len(user_part)\n        return f\"{masked_user}@{domain_part}\"\n    return email\n\ndef log(msg):\n    \"\"\"Print log message to stderr to avoid interfering with JSON output.\"\"\"\n    print(msg, file=sys.stderr)\n\ndef should_remove_cell_content(value):\n    \"\"\"\n    Check if cell content should be completely removed based on keywords.\n    Returns True if the cell contains any keyword from KEYWORDS_TO_REMOVE_CELL (case-insensitive).\n    \"\"\"\n    text = str(value).lower()\n    if not text or text.strip() == 'nan':\n        return False\n    \n    for keyword in KEYWORDS_TO_REMOVE_CELL:\n        if keyword.lower() in text:\n            return True\n    return False\n\ndef clean_dataframe_cells(df):\n    \"\"\"\n    Pre-process DataFrame to remove cell contents that contain restricted keywords.\n    This must be called BEFORE HTML generation.\n    Returns the cleaned DataFrame.\n    \"\"\"\n    cleaned_count = 0\n    \n    def clean_cell(value):\n        nonlocal cleaned_count\n        if should_remove_cell_content(value):\n            cleaned_count += 1\n            return \"\"\n        return value\n    \n    try:\n        cleaned_df = df.map(clean_cell)\n    except AttributeError:\n        cleaned_df = df.applymap(clean_cell)\n    \n    if cleaned_count > 0:\n        log(f\"[Cleanup] Removed content from {cleaned_count} cells containing restricted keywords\")\n    \n    return cleaned_df\n\ndef mask_cell_value(value):\n    \"\"\"\n    H√†m m√£ h√≥a trung t√¢m.\n    Th·ª© t·ª± ∆∞u ti√™n: URL -> T·ª´ kh√≥a -> Email -> S·ªë\n    \"\"\"\n    text = str(value)\n    if not text or text.strip().lower() == 'nan':\n        return \"\"\n    \n    url_pattern = r'\\b(?:https?://|www\\.)\\S+\\b'\n    text = re.sub(url_pattern, mask_all_chars, text)\n\n    for keyword in KEYWORDS_TO_MASK:\n        pattern = re.compile(re.escape(keyword), re.IGNORECASE)\n        text = pattern.sub(mask_all_chars, text)\n\n    email_pattern = r'\\b[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}\\b'\n    text = re.sub(email_pattern, mask_email_group, text)\n\n    text = re.sub(r'\\d+', mask_number_group, text)\n    \n    return text\n\ndef check_html_leakage_count(html_path, file_name_check):\n    leak_count = 0\n    details = []\n    try:\n        with open(html_path, 'r', encoding='utf-8') as f:\n            content = f.read()\n        \n        email_pattern = r'\\b[a-zA-Z0-9][a-zA-Z0-9._%+-]*@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}\\b'\n        leaked_emails = re.findall(email_pattern, content)\n        if leaked_emails:\n            leak_count += len(leaked_emails)\n            details.extend(leaked_emails)\n\n        number_pattern = r'(?<!\\*)\\b\\d{7,}\\b'\n        leaked_numbers = re.findall(number_pattern, content)\n        if leaked_numbers:\n            for num in leaked_numbers:\n                if num in file_name_check:\n                    continue\n                leak_count += 1\n                details.append(num)\n            \n        return leak_count, details\n    except Exception as e:\n        return 1, [f\"Error reading file: {e}\"]\n\ndef get_column_widths(df_chunk):\n    if df_chunk.empty:\n        return []\n    try:\n        avg_lengths = df_chunk.astype(str).map(lambda x: len(str(x).strip())).mean()\n    except AttributeError:\n        avg_lengths = df_chunk.astype(str).applymap(lambda x: len(str(x).strip())).mean()\n    top_3_indices = avg_lengths.sort_values(ascending=False).head(3).index\n    data_widths = []\n    for i in range(len(df_chunk.columns)):\n        if i in top_3_indices:\n            data_widths.append(TOP_3_COL_WIDTH)\n        else:\n            data_widths.append(OTHER_COL_WIDTH)\n    return [INDEX_COL_WIDTH] + data_widths\n\ndef get_cell_class(text, col_width):\n    text_space = col_width - CELL_PADDING_X\n    if text_space <= 0:\n        return \"no-wrap-text\"\n    num_lines = math.ceil(len(str(text).strip()) * AVG_CHAR_WIDTH / text_space)\n    estimated_height = num_lines * LINE_HEIGHT_ESTIMATE\n    return \"wrap-text\" if estimated_height <= ROW_HEIGHT else \"no-wrap-text\"\n\ndef generate_html_for_sheet(df, file_name, sheet_name, template, html_dir):\n    generated_files = []\n    \n    if len(df.columns) > DATA_COLS_TO_KEEP:\n        df = df.iloc[:, :DATA_COLS_TO_KEEP]\n    df = df[df.apply(lambda row: any(str(cell).strip() != '' and str(cell).strip().lower() != 'nan' for cell in row), axis=1)]\n    if df.empty:\n        return []\n\n    num_pages = math.ceil(len(df) / ROWS_PER_PAGE)\n    for i in range(num_pages):\n        page_df = df.iloc[i*ROWS_PER_PAGE : (i+1)*ROWS_PER_PAGE]\n        temp_df = page_df.copy()\n        while len(temp_df.columns) < DATA_COLS_TO_KEEP:\n            temp_df[f'ph_{len(temp_df.columns)}'] = ''\n        col_widths = get_column_widths(temp_df)\n\n        page_data = []\n        for r_idx, row in page_df.iterrows():\n            row_cells = []\n            for c_idx, cell in enumerate(row):\n                val = mask_cell_value('' if str(cell).strip().lower() == 'nan' else cell)\n                row_cells.append({\"value\": val, \"class\": get_cell_class(val, col_widths[c_idx+1])})\n            while len(row_cells) < DATA_COLS_TO_KEEP:\n                row_cells.append({\"value\": \"\", \"class\": \"wrap-text\"})\n            page_data.append({\"excel_row_num\": r_idx + 1, \"cells\": row_cells})\n        while len(page_data) < ROWS_PER_PAGE:\n            page_data.append({\"excel_row_num\": \" \", \"cells\": [{\"value\": \"\", \"class\": \"wrap-text\"}]*DATA_COLS_TO_KEEP})\n\n        page_html_path = os.path.join(html_dir, f\"{file_name}_{sheet_name}_page_{i+1}.html\")\n        with open(page_html_path, 'w', encoding='utf-8') as f:\n            f.write(template.render({\"title\": f\"{file_name} - {sheet_name} - P{i+1}\", \"page_data\": page_data, \"column_widths\": col_widths}))\n        generated_files.append((f\"PAGE_{i+1}\", page_html_path, sheet_name))\n        \n    return generated_files\n\ndef add_blur_to_image(image_path, blur_radius=COVER_BLUR_RADIUS):\n    \"\"\"Apply Gaussian blur to an image for preview protection.\"\"\"\n    try:\n        img = Image.open(image_path)\n        blurred = img.filter(ImageFilter.GaussianBlur(radius=blur_radius))\n        blurred.save(image_path)\n        log(f\"[Blur] Applied blur (radius={blur_radius}) to: {os.path.basename(image_path)}\")\n    except Exception as e:\n        log(f\"Blur error: {e}\")\n\ndef add_watermark_to_image(image_path, apply_blur=False):\n    try:\n        base_image = Image.open(image_path).convert(\"RGBA\")\n        width, height = base_image.size\n        \n        if apply_blur:\n            base_image = base_image.filter(ImageFilter.GaussianBlur(radius=COVER_BLUR_RADIUS))\n        \n        txt_layer = Image.new(\"RGBA\", base_image.size, (255, 255, 255, 0))\n        draw = ImageDraw.Draw(txt_layer)\n        \n        font_size = int(width / 25)\n        try:\n            font_path = \"/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf\"\n            if not os.path.exists(font_path):\n                font_path = \"arial.ttf\"\n            if os.path.exists(font_path):\n                font = ImageFont.truetype(font_path, font_size)\n            else:\n                font = ImageFont.load_default()\n        except IOError:\n            font = ImageFont.load_default()\n        \n        step_x = width / GRID_COLS\n        step_y = height / GRID_ROWS\n        \n        text_color = (150, 150, 150, WATERMARK_OPACITY)\n        \n        for r in range(GRID_ROWS):\n            for c in range(GRID_COLS):\n                center_x = (c * step_x) + (step_x / 2)\n                center_y = (r * step_y) + (step_y / 2)\n                \n                bbox = draw.textbbox((0, 0), WATERMARK_TEXT, font=font)\n                text_w = bbox[2] - bbox[0]\n                text_h = bbox[3] - bbox[1]\n                \n                x = center_x - (text_w / 2)\n                y = center_y - (text_h / 2)\n                \n                draw.text((x, y), WATERMARK_TEXT, font=font, fill=text_color)\n        \n        combined = Image.alpha_composite(base_image, txt_layer)\n        combined = combined.convert(\"RGB\")\n        combined.save(image_path)\n        \n    except Exception as e:\n        log(f\"Watermark error: {e}\")\n\ndef create_images_from_list(html_list, file_name, image_dir):\n    created_images = []\n    global_image_index = 0\n    \n    with sync_playwright() as p:\n        launch_args = [\n            \"--no-sandbox\", \n            \"--disable-setuid-sandbox\",\n            \"--disable-dev-shm-usage\",\n            \"--disable-gpu\",\n            \"--single-process\"\n        ]\n        \n        log(\"[Pipeline] Starting browser (System Chromium)...\")\n        browser = None\n        try:\n            # Priority 1: Use channel chromium (system installed)\n            browser = p.chromium.launch(channel=\"chromium\", args=launch_args)\n        except Exception as e1:\n            log(f\"[Pipeline] Channel chromium failed: {e1}\")\n            try:\n                # Priority 2: Try to find specific path (common on Nix)\n                executable_path = shutil.which(\"chromium\")\n                if executable_path:\n                    log(f\"[Pipeline] Found chromium at: {executable_path}\")\n                    browser = p.chromium.launch(executable_path=executable_path, args=launch_args)\n                else:\n                    # Priority 3: Use default playwright browser\n                    log(\"[Pipeline] Trying default playwright browser...\")\n                    browser = p.chromium.launch(args=launch_args)\n            except Exception as e2:\n                log(f\"[Pipeline] All browser launch methods failed: {e2}\")\n                raise e2\n        \n        page = browser.new_page()\n        page.set_viewport_size({\"width\": TARGET_WIDTH, \"height\": TARGET_HEIGHT})\n        \n        for type_label, html_path, sheet_name in html_list:\n            sheet_output_dir = os.path.join(image_dir, file_name, sheet_name)\n            os.makedirs(sheet_output_dir, exist_ok=True)\n\n            img_filename = os.path.basename(html_path).replace(\".html\", \".png\")\n            img_path = os.path.join(sheet_output_dir, img_filename)\n            \n            page.goto(f\"file://{os.path.abspath(html_path)}\")\n            page.screenshot(path=img_path, full_page=False)\n            \n            should_blur = global_image_index >= FREE_PREVIEW_IMAGES\n            add_watermark_to_image(img_path, apply_blur=should_blur)\n            \n            if should_blur:\n                log(f\"[Preview] Image {global_image_index + 1} blurred (after {FREE_PREVIEW_IMAGES} free previews)\")\n            \n            created_images.append({\n                \"type\": \"page\",\n                \"sheet\": sheet_name,\n                \"page\": int(type_label.replace(\"PAGE_\", \"\")) if \"PAGE_\" in type_label else 1,\n                \"path\": img_path,\n                \"isBlurred\": should_blur\n            })\n            \n            global_image_index += 1\n\n        browser.close()\n    \n    log(f\"[Summary] Created {len(created_images)} images, {min(FREE_PREVIEW_IMAGES, len(created_images))} clear, {max(0, len(created_images) - FREE_PREVIEW_IMAGES)} blurred\")\n    return created_images\n\ndef cleanup_htmls(html_list):\n    for _, path, _ in html_list:\n        if os.path.exists(path):\n            os.remove(path)\n\ndef process_excel_file(excel_path, output_dir, template_path):\n    file_name = os.path.splitext(os.path.basename(excel_path))[0]\n    \n    html_dir = os.path.join(output_dir, \"temp_html\")\n    image_dir = output_dir\n    \n    os.makedirs(html_dir, exist_ok=True)\n    os.makedirs(image_dir, exist_ok=True)\n    \n    try:\n        all_sheets = pd.read_excel(excel_path, sheet_name=None, header=None)\n    except Exception as e:\n        return {\n            \"success\": False,\n            \"error\": f\"Failed to read Excel file: {e}\"\n        }\n\n    log(f\"[Pipeline] Processing: {file_name}\")\n    \n    # Step 0: Pre-process - Remove cell contents containing restricted keywords\n    log(f\"[Pipeline] Step 0: Cleaning cells with restricted keywords...\")\n    for sheet_name in all_sheets:\n        all_sheets[sheet_name] = clean_dataframe_cells(all_sheets[sheet_name])\n\n    template_dir = os.path.dirname(template_path)\n    template_name = os.path.basename(template_path)\n    env = Environment(loader=FileSystemLoader(template_dir))\n    template = env.get_template(template_name)\n\n    def generate_all_htmls():\n        total_htmls = []\n        for sheet_name, df in all_sheets.items():\n            sheet_htmls = generate_html_for_sheet(df, file_name, sheet_name, template, html_dir)\n            total_htmls.extend(sheet_htmls)\n        return total_htmls\n\n    log(f\"[Pipeline] Step 1: Generating HTML...\")\n    all_html_files = generate_all_htmls()\n    if not all_html_files:\n        return {\n            \"success\": False,\n            \"error\": \"No valid data found in Excel file\"\n        }\n\n    log(f\"[Pipeline] Step 2: Security check (tolerance: {MAX_LEAK_TOLERANCE})...\")\n    total_leaks = 0\n    all_leak_details = []\n    \n    for _, html_path, _ in all_html_files:\n        count, details = check_html_leakage_count(html_path, file_name)\n        total_leaks += count\n        all_leak_details.extend(details)\n    \n    should_retry = False\n    if total_leaks > MAX_LEAK_TOLERANCE:\n        log(f\"[Pipeline] Warning: {total_leaks} leaks detected. Retrying...\")\n        should_retry = True\n    elif total_leaks > 0:\n        log(f\"[Pipeline] Notice: {total_leaks} leaks (within tolerance). Continuing.\")\n    else:\n        log(f\"[Pipeline] Excellent: No leaks detected.\")\n\n    if should_retry:\n        cleanup_htmls(all_html_files)\n        all_html_files = generate_all_htmls()\n        total_leaks = 0\n        all_leak_details = []\n        for _, html_path, _ in all_html_files:\n            count, details = check_html_leakage_count(html_path, file_name)\n            total_leaks += count\n            all_leak_details.extend(details)\n\n    if total_leaks > MAX_LEAK_TOLERANCE:\n        cleanup_htmls(all_html_files)\n        return {\n            \"success\": False,\n            \"error\": f\"Security check failed: {total_leaks} leaks detected after retry\"\n        }\n\n    log(f\"[Pipeline] Step 3: Creating images...\")\n    try:\n        created_images = create_images_from_list(all_html_files, file_name, image_dir)\n        cleanup_htmls(all_html_files)\n        \n        if os.path.exists(html_dir):\n            try:\n                shutil.rmtree(html_dir)\n            except:\n                pass\n        \n        cover_photo = created_images[0][\"path\"] if created_images else None\n        \n        return {\n            \"success\": True,\n            \"fileName\": file_name,\n            \"totalImages\": len(created_images),\n            \"coverPhoto\": cover_photo,\n            \"images\": created_images,\n            \"outputDir\": image_dir\n        }\n    except Exception as e:\n        cleanup_htmls(all_html_files)\n        return {\n            \"success\": False,\n            \"error\": f\"Failed to create images: {e}\"\n        }\n\ndef main():\n    if len(sys.argv) < 4:\n        result = {\n            \"success\": False,\n            \"error\": \"Usage: python excel_to_png.py <excel_path> <output_dir> <template_path>\"\n        }\n        print(json.dumps(result))\n        sys.exit(1)\n    \n    excel_path = sys.argv[1]\n    output_dir = sys.argv[2]\n    template_path = sys.argv[3]\n    \n    if not os.path.exists(excel_path):\n        result = {\n            \"success\": False,\n            \"error\": f\"File not found: {excel_path}\"\n        }\n        print(json.dumps(result))\n        sys.exit(1)\n    \n    result = process_excel_file(excel_path, output_dir, template_path)\n    \n    output_json_path = os.path.join(output_dir, \"pipeline_result.json\")\n    with open(output_json_path, 'w', encoding='utf-8') as f:\n        json.dump(result, f, ensure_ascii=False, indent=2)\n    \n    print(json.dumps({\"success\": True, \"outputFile\": output_json_path}, ensure_ascii=False))\n\nif __name__ == \"__main__\":\n    main()\n","path":null,"size_bytes":17823,"size_tokens":null},"client/src/pages/admin/BulkUpload.tsx":{"content":"import { useState, useRef } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Label } from \"@/components/ui/label\";\nimport { Upload, File, Trash2, AlertCircle, FileText, FileSpreadsheet, Clock, CheckCircle, XCircle, Loader2, FolderOpen, RefreshCw } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { AdminUpload } from \"@shared/schema\";\n\ninterface UploadingFile {\n  file: File;\n  progress: number;\n  status: 'uploading' | 'success' | 'error';\n  error?: string;\n}\n\ninterface Category {\n  id: string;\n  name: string;\n  logoUrl?: string;\n  order: number;\n}\n\nexport default function AdminBulkUpload() {\n  const [uploadingFiles, setUploadingFiles] = useState<UploadingFile[]>([]);\n  const [selectedCategory, setSelectedCategory] = useState<string>(\"\");\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const { toast } = useToast();\n\n  const { data: uploads = [], isLoading } = useQuery<AdminUpload[]>({\n    queryKey: [\"/api/admin/uploads\"],\n  });\n\n  const { data: categories = [] } = useQuery<Category[]>({\n    queryKey: [\"/api/categories\"],\n  });\n\n  const uploadFiles = async (files: File[]) => {\n    const initialFiles: UploadingFile[] = files.map(file => ({\n      file,\n      progress: 0,\n      status: 'uploading' as const,\n    }));\n    \n    setUploadingFiles(initialFiles);\n\n    try {\n      const formData = new FormData();\n      files.forEach(file => {\n        formData.append(\"files\", file);\n      });\n      \n      if (selectedCategory) {\n        formData.append(\"category\", selectedCategory);\n      }\n\n      interface UploadResponse {\n        uploads?: AdminUpload[];\n        duplicates?: { fileName: string; existingFileName: string }[];\n        message?: string;\n      }\n      \n      const response = await new Promise<UploadResponse>((resolve, reject) => {\n        const xhr = new XMLHttpRequest();\n\n        xhr.upload.addEventListener(\"progress\", (e) => {\n          if (e.lengthComputable) {\n            const percentComplete = Math.round((e.loaded / e.total) * 100);\n            setUploadingFiles((prev) => \n              prev.map(uf => ({ ...uf, progress: percentComplete }))\n            );\n          }\n        });\n\n        xhr.addEventListener(\"load\", () => {\n          if (xhr.status >= 200 && xhr.status < 300) {\n            try {\n              const data = JSON.parse(xhr.responseText);\n              resolve(data);\n            } catch {\n              reject(new Error(\"Invalid response from server\"));\n            }\n          } else {\n            try {\n              const errorData = JSON.parse(xhr.responseText);\n              reject(new Error(errorData.message || \"Upload failed\"));\n            } catch {\n              reject(new Error(\"Upload failed\"));\n            }\n          }\n        });\n\n        xhr.addEventListener(\"error\", () => {\n          reject(new Error(\"Network error during upload\"));\n        });\n\n        xhr.open(\"POST\", \"/api/admin/uploads\");\n        xhr.withCredentials = true;\n        xhr.send(formData);\n      });\n\n      setUploadingFiles((prev) =>\n        prev.map(uf => ({ ...uf, status: 'success' as const, progress: 100 }))\n      );\n\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/uploads\"] });\n\n      // Show success message with duplicate info if applicable\n      const uploadCount = response.uploads?.length || 0;\n      const duplicateCount = response.duplicates?.length || 0;\n      \n      if (duplicateCount > 0) {\n        const duplicateNames = response.duplicates!.map(d => d.fileName).join(\", \");\n        toast({\n          title: \"Upload ho√†n t·∫•t\",\n          description: `ƒê√£ t·∫£i l√™n ${uploadCount} file. ${duplicateCount} file b·ªã tr√πng l·∫∑p ƒë√£ b·ªã b·ªè qua: ${duplicateNames}`,\n          variant: duplicateCount > 0 && uploadCount === 0 ? \"destructive\" : \"default\",\n        });\n      } else {\n        toast({\n          title: \"Th√†nh c√¥ng\",\n          description: `ƒê√£ t·∫£i l√™n ${uploadCount} file. Pipeline ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω.`,\n        });\n      }\n\n      setTimeout(() => {\n        setUploadingFiles([]);\n        if (fileInputRef.current) {\n          fileInputRef.current.value = \"\";\n        }\n      }, 3000);\n\n    } catch (error: any) {\n      setUploadingFiles((prev) =>\n        prev.map(uf => ({ \n          ...uf, \n          status: 'error' as const, \n          error: error.message || 'Upload failed' \n        }))\n      );\n\n      toast({\n        title: \"L·ªói\",\n        description: error.message || \"Kh√¥ng th·ªÉ t·∫£i l√™n file. Vui l√≤ng th·ª≠ l·∫°i.\",\n        variant: \"destructive\",\n      });\n\n      setTimeout(() => {\n        setUploadingFiles([]);\n        if (fileInputRef.current) {\n          fileInputRef.current.value = \"\";\n        }\n      }, 5000);\n    }\n  };\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await apiRequest(\"DELETE\", `/api/admin/uploads/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/uploads\"] });\n      toast({\n        title: \"ƒê√£ x√≥a\",\n        description: \"File ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"L·ªói\",\n        description: \"Kh√¥ng th·ªÉ x√≥a file. Vui l√≤ng th·ª≠ l·∫°i.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const reprocessMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await apiRequest(\"POST\", `/api/admin/uploads/${id}/reprocess`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/uploads\"] });\n      toast({\n        title: \"ƒêang x·ª≠ l√Ω l·∫°i\",\n        description: \"Pipeline ƒëang ƒë∆∞·ª£c ch·∫°y l·∫°i. Vui l√≤ng ƒë·ª£i...\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"L·ªói\",\n        description: \"Kh√¥ng th·ªÉ x·ª≠ l√Ω l·∫°i file. Vui l√≤ng th·ª≠ l·∫°i.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const selectedFiles = e.target.files;\n    if (!selectedFiles || selectedFiles.length === 0) return;\n\n    if (!selectedCategory) {\n      toast({\n        title: \"Ch∆∞a ch·ªçn danh m·ª•c\",\n        description: \"Vui l√≤ng ch·ªçn danh m·ª•c tr∆∞·ªõc khi upload file.\",\n        variant: \"destructive\",\n      });\n      if (fileInputRef.current) {\n        fileInputRef.current.value = \"\";\n      }\n      return;\n    }\n\n    const allowedTypes = [\n      \"application/pdf\",\n      \"text/csv\",\n      \"application/vnd.ms-excel\",\n      \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n    ];\n\n    const validFiles: File[] = [];\n    const errors: string[] = [];\n\n    for (let i = 0; i < selectedFiles.length; i++) {\n      const file = selectedFiles[i];\n      \n      if (!allowedTypes.includes(file.type)) {\n        errors.push(`${file.name}: Ch·ªâ ch·∫•p nh·∫≠n file PDF, CSV, ho·∫∑c Excel`);\n        continue;\n      }\n\n      if (file.size > 500 * 1024 * 1024) {\n        errors.push(`${file.name}: K√≠ch th∆∞·ªõc file kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 500MB`);\n        continue;\n      }\n\n      validFiles.push(file);\n    }\n\n    if (errors.length > 0) {\n      toast({\n        title: \"M·ªôt s·ªë file kh√¥ng h·ª£p l·ªá\",\n        description: errors.join(\", \"),\n        variant: \"destructive\",\n      });\n    }\n\n    if (validFiles.length > 0) {\n      uploadFiles(validFiles);\n    }\n  };\n\n  const formatFileSize = (bytes: number) => {\n    if (bytes < 1024) return `${bytes} B`;\n    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;\n    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;\n  };\n\n  const FileIcon = ({ fileType }: { fileType: string }) => {\n    if (fileType.includes(\"pdf\")) {\n      return <FileText className=\"w-5 h-5 text-primary\" />;\n    }\n    if (fileType.includes(\"csv\") || fileType.includes(\"excel\") || fileType.includes(\"spreadsheet\")) {\n      return <FileSpreadsheet className=\"w-5 h-5 text-primary\" />;\n    }\n    return <File className=\"w-5 h-5 text-primary\" />;\n  };\n\n  const getPipelineStatusBadge = (status: string, error?: string | null) => {\n    switch (status) {\n      case \"pending\":\n        return (\n          <Badge variant=\"secondary\" data-testid=\"badge-pipeline-pending\">\n            <Clock className=\"w-3 h-3 mr-1\" />\n            ƒêang ch·ªù\n          </Badge>\n        );\n      case \"processing\":\n        return (\n          <Badge variant=\"default\" data-testid=\"badge-pipeline-processing\">\n            <Clock className=\"w-3 h-3 mr-1\" />\n            ƒêang x·ª≠ l√Ω\n          </Badge>\n        );\n      case \"completed\":\n        return (\n          <Badge className=\"bg-green-500 hover:bg-green-600\" data-testid=\"badge-pipeline-completed\">\n            <CheckCircle className=\"w-3 h-3 mr-1\" />\n            Ho√†n th√†nh\n          </Badge>\n        );\n      case \"failed\":\n        return (\n          <div className=\"space-y-1\">\n            <Badge variant=\"destructive\" data-testid=\"badge-pipeline-failed\">\n              <XCircle className=\"w-3 h-3 mr-1\" />\n              Th·∫•t b·∫°i\n            </Badge>\n            {error && (\n              <div className=\"max-w-md\">\n                <p className=\"text-xs text-destructive whitespace-pre-wrap break-words\" data-testid=\"text-pipeline-error\">\n                  {error}\n                </p>\n              </div>\n            )}\n          </div>\n        );\n      default:\n        return <Badge variant=\"secondary\">{status}</Badge>;\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold\" data-testid=\"heading-admin-bulk-upload\">Upload h√†ng lo·∫°t</h1>\n        <p className=\"text-muted-foreground\">Upload file l·ªõn (t·ªëi ƒëa 500MB) ƒë·ªÉ x·ª≠ l√Ω qua pipeline</p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>T·∫£i l√™n file m·ªõi</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"category-select\">\n              <FolderOpen className=\"w-4 h-4 inline mr-2\" />\n              Danh m·ª•c\n            </Label>\n            <Select\n              value={selectedCategory}\n              onValueChange={setSelectedCategory}\n              disabled={uploadingFiles.length > 0}\n            >\n              <SelectTrigger id=\"category-select\" data-testid=\"select-admin-category\">\n                <SelectValue placeholder=\"Ch·ªçn danh m·ª•c cho file upload\" />\n              </SelectTrigger>\n              <SelectContent>\n                {categories.map((category) => (\n                  <SelectItem \n                    key={category.id} \n                    value={category.name}\n                    data-testid={`option-category-${category.id}`}\n                  >\n                    {category.name}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div>\n            <input\n              ref={fileInputRef}\n              type=\"file\"\n              accept=\".pdf,.csv,.xlsx,.xls\"\n              multiple\n              onChange={handleFileSelect}\n              className=\"hidden\"\n              data-testid=\"input-admin-file\"\n              disabled={uploadingFiles.length > 0 || !selectedCategory}\n            />\n            <Button\n              onClick={() => fileInputRef.current?.click()}\n              disabled={uploadingFiles.length > 0 || !selectedCategory}\n              className=\"w-full\"\n              data-testid=\"button-admin-upload-select\"\n            >\n              <Upload className=\"w-4 h-4 mr-2\" />\n              {uploadingFiles.length > 0 \n                ? \"ƒêang t·∫£i l√™n...\" \n                : !selectedCategory \n                  ? \"Vui l√≤ng ch·ªçn danh m·ª•c tr∆∞·ªõc\" \n                  : \"Ch·ªçn file (t·ªëi ƒëa 500MB, c√≥ th·ªÉ ch·ªçn nhi·ªÅu file)\"}\n            </Button>\n          </div>\n\n          {uploadingFiles.length > 0 && (\n            <div className=\"space-y-3\" data-testid=\"progress-admin-upload\">\n              {uploadingFiles.map((uploadingFile, index) => (\n                <div key={index} className=\"space-y-1 p-3 border rounded-lg\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-2 flex-1 min-w-0\">\n                      {uploadingFile.status === 'uploading' && (\n                        <Loader2 className=\"w-4 h-4 animate-spin text-primary flex-shrink-0\" />\n                      )}\n                      {uploadingFile.status === 'success' && (\n                        <CheckCircle className=\"w-4 h-4 text-green-500 flex-shrink-0\" />\n                      )}\n                      {uploadingFile.status === 'error' && (\n                        <XCircle className=\"w-4 h-4 text-destructive flex-shrink-0\" />\n                      )}\n                      <span className=\"text-sm font-medium truncate\">\n                        {uploadingFile.file.name}\n                      </span>\n                    </div>\n                    <span className=\"text-sm text-muted-foreground ml-2 flex-shrink-0\">\n                      {uploadingFile.status === 'uploading' && `${uploadingFile.progress}%`}\n                      {uploadingFile.status === 'success' && 'Ho√†n th√†nh'}\n                      {uploadingFile.status === 'error' && 'L·ªói'}\n                    </span>\n                  </div>\n                  {uploadingFile.status === 'uploading' && (\n                    <Progress value={uploadingFile.progress} className=\"h-1\" />\n                  )}\n                  {uploadingFile.status === 'error' && uploadingFile.error && (\n                    <p className=\"text-xs text-destructive\">{uploadingFile.error}</p>\n                  )}\n                </div>\n              ))}\n            </div>\n          )}\n\n          <Alert>\n            <AlertCircle className=\"h-4 w-4\" />\n            <AlertDescription>\n              File ƒë∆∞·ª£c upload s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c x·ª≠ l√Ω qua pipeline. B·∫°n c√≥ th·ªÉ ch·ªçn nhi·ªÅu file c√πng l√∫c (t·ªëi ƒëa 10 file).\n            </AlertDescription>\n          </Alert>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>File ƒë√£ upload ({uploads.length})</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <p className=\"text-center text-muted-foreground py-8\">ƒêang t·∫£i...</p>\n          ) : uploads.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"text-no-admin-files\">\n              <File className=\"w-12 h-12 mx-auto mb-2 opacity-50\" />\n              <p className=\"text-sm\">Ch∆∞a c√≥ file n√†o ƒë∆∞·ª£c upload</p>\n            </div>\n          ) : (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>File</TableHead>\n                  <TableHead>Danh m·ª•c</TableHead>\n                  <TableHead>K√≠ch th∆∞·ªõc</TableHead>\n                  <TableHead>Tr·∫°ng th√°i Pipeline</TableHead>\n                  <TableHead>Ng√†y upload</TableHead>\n                  <TableHead className=\"text-right\">Thao t√°c</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {uploads.map((upload) => (\n                  <TableRow key={upload.id} data-testid={`row-admin-upload-${upload.id}`}>\n                    <TableCell>\n                      <div className=\"flex items-center gap-2\">\n                        <FileIcon fileType={upload.fileType} />\n                        <span className=\"font-medium\" data-testid={`text-admin-filename-${upload.id}`}>\n                          {upload.fileName}\n                        </span>\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      {upload.category ? (\n                        <Badge variant=\"outline\" data-testid={`badge-category-${upload.id}`}>\n                          {upload.category}\n                        </Badge>\n                      ) : (\n                        <span className=\"text-muted-foreground text-sm\">-</span>\n                      )}\n                    </TableCell>\n                    <TableCell>{formatFileSize(upload.fileSize)}</TableCell>\n                    <TableCell>{getPipelineStatusBadge(upload.pipelineStatus, upload.pipelineError)}</TableCell>\n                    <TableCell>\n                      {upload.uploadedAt ? new Date(upload.uploadedAt).toLocaleString(\"vi-VN\") : \"-\"}\n                    </TableCell>\n                    <TableCell className=\"text-right\">\n                      <div className=\"flex items-center justify-end gap-1\">\n                        {upload.pipelineStatus === \"failed\" && (\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => reprocessMutation.mutate(upload.id)}\n                            disabled={reprocessMutation.isPending}\n                            title=\"X·ª≠ l√Ω l·∫°i\"\n                            data-testid={`button-admin-reprocess-${upload.id}`}\n                          >\n                            <RefreshCw className={`w-4 h-4 text-primary ${reprocessMutation.isPending ? 'animate-spin' : ''}`} />\n                          </Button>\n                        )}\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={() => deleteMutation.mutate(upload.id)}\n                          disabled={deleteMutation.isPending}\n                          title=\"X√≥a\"\n                          data-testid={`button-admin-delete-${upload.id}`}\n                        >\n                          <Trash2 className=\"w-4 h-4 text-destructive\" />\n                        </Button>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":18619,"size_tokens":null},"server/pipeline/runner.ts":{"content":"import { spawn } from \"child_process\";\nimport path from \"path\";\nimport fs from \"fs/promises\";\nimport { uploadToSpaces, generateFolderName, uploadOriginalToArchive } from \"../services/doSpaces\";\nimport xlsx from \"xlsx\";\n\nconst PIPELINE_DIR = path.join(process.cwd(), \"server\", \"pipeline\");\nconst MAX_ROWS_PER_POST = 1000;\nconst ROWS_PER_PAGE = 10;\n\nexport interface PipelineResult {\n  success: boolean;\n  fileName?: string;\n  totalImages?: number;\n  coverPhoto?: string;\n  images?: Array<{\n    type: \"page\";\n    sheet: string;\n    page: number;\n    path: string;\n    isBlurred?: boolean;\n  }>;\n  outputDir?: string;\n  error?: string;\n}\n\nasync function uploadAndCleanupOriginalFile(\n  sourcePath: string, \n  postId: string, \n  originalFileName: string,\n  outputDir?: string\n): Promise<{ success: boolean; archiveUrl?: string; error?: string }> {\n  const ext = path.extname(originalFileName);\n  const baseName = path.basename(originalFileName, ext);\n  const newFileName = `${postId}-${baseName}${ext}`;\n  const remoteKey = `Original-Files/${newFileName}`;\n  \n  console.log(`[Pipeline] Uploading original file to archive: ${newFileName}`);\n  \n  const uploadResult = await uploadOriginalToArchive(sourcePath, remoteKey);\n  \n  if (!uploadResult.success) {\n    console.error(`[Pipeline] Failed to upload original to archive: ${uploadResult.error}`);\n    return { success: false, error: uploadResult.error };\n  }\n  \n  console.log(`[Pipeline] Original file archived: ${uploadResult.url}`);\n  \n  try {\n    await fs.unlink(sourcePath);\n    console.log(`[Pipeline] Deleted source file: ${sourcePath}`);\n  } catch (err) {\n    console.warn(`[Pipeline] Failed to delete source file: ${sourcePath}`, err);\n  }\n  \n  if (outputDir) {\n    try {\n      await fs.rm(outputDir, { recursive: true, force: true });\n      console.log(`[Pipeline] Deleted temp output directory: ${outputDir}`);\n    } catch (err) {\n      console.warn(`[Pipeline] Failed to delete temp directory: ${outputDir}`, err);\n    }\n  }\n  \n  console.log(`[Pipeline] Cleanup completed - all local files removed`);\n  \n  return { success: true, archiveUrl: uploadResult.url };\n}\n\ninterface ExcelInfo {\n  totalRows: number;\n  needsSplit: boolean;\n  partCount: number;\n}\n\nfunction getExcelRowCount(filePath: string): ExcelInfo {\n  try {\n    const workbook = xlsx.readFile(filePath);\n    let totalDataRows = 0;\n    \n    for (const sheetName of workbook.SheetNames) {\n      const sheet = workbook.Sheets[sheetName];\n      if (!sheet['!ref']) continue;\n      const range = xlsx.utils.decode_range(sheet['!ref']);\n      const sheetRows = range.e.r - range.s.r + 1;\n      const dataRows = Math.max(0, sheetRows - 1);\n      totalDataRows += dataRows;\n    }\n    \n    const needsSplit = totalDataRows > MAX_ROWS_PER_POST;\n    const partCount = needsSplit ? Math.ceil(totalDataRows / MAX_ROWS_PER_POST) : 1;\n    \n    console.log(`[Pipeline] Excel has ${totalDataRows} total data rows (excluding headers), needsSplit: ${needsSplit}, parts: ${partCount}`);\n    \n    return { totalRows: totalDataRows, needsSplit, partCount };\n  } catch (error) {\n    console.error(`[Pipeline] Error reading Excel for row count:`, error);\n    return { totalRows: 0, needsSplit: false, partCount: 1 };\n  }\n}\n\ninterface SheetData {\n  sheetName: string;\n  headers: any[];\n  rows: any[][];\n}\n\nasync function splitExcelFile(filePath: string, outputDir: string, maxRowsPerPart: number = MAX_ROWS_PER_POST): Promise<string[]> {\n  try {\n    const workbook = xlsx.readFile(filePath);\n    const fileName = path.basename(filePath, path.extname(filePath));\n    const ext = path.extname(filePath);\n    const splitFiles: string[] = [];\n    \n    const allSheetData: SheetData[] = [];\n    \n    for (const sheetName of workbook.SheetNames) {\n      const sheet = workbook.Sheets[sheetName];\n      const data = xlsx.utils.sheet_to_json(sheet, { header: 1, defval: '' }) as any[][];\n      \n      if (data.length < 2) continue;\n      \n      const headers = data[0];\n      const dataRows = data.slice(1);\n      \n      if (dataRows.length > 0 && headers.length > 0) {\n        allSheetData.push({\n          sheetName,\n          headers,\n          rows: dataRows\n        });\n      }\n    }\n    \n    if (allSheetData.length === 0) {\n      return [filePath];\n    }\n    \n    let currentPart: SheetData[] = [];\n    let currentRowCount = 0;\n    let partNumber = 1;\n    \n    for (const sheetData of allSheetData) {\n      let remainingRows = [...sheetData.rows];\n      \n      while (remainingRows.length > 0) {\n        const spaceInPart = maxRowsPerPart - currentRowCount;\n        \n        if (spaceInPart <= 0) {\n          const partPath = await writePartFileMultiSheet(outputDir, fileName, ext, partNumber, currentPart);\n          splitFiles.push(partPath);\n          console.log(`[Pipeline] Created part ${partNumber} with ${currentRowCount} rows across ${currentPart.length} sheets`);\n          \n          currentPart = [];\n          currentRowCount = 0;\n          partNumber++;\n          continue;\n        }\n        \n        const rowsToAdd = remainingRows.slice(0, spaceInPart);\n        remainingRows = remainingRows.slice(spaceInPart);\n        \n        const existingSheet = currentPart.find(s => s.sheetName === sheetData.sheetName);\n        if (existingSheet) {\n          existingSheet.rows.push(...rowsToAdd);\n        } else {\n          currentPart.push({\n            sheetName: sheetData.sheetName,\n            headers: sheetData.headers,\n            rows: rowsToAdd\n          });\n        }\n        currentRowCount += rowsToAdd.length;\n      }\n    }\n    \n    if (currentPart.length > 0 && currentRowCount > 0) {\n      const partPath = await writePartFileMultiSheet(outputDir, fileName, ext, partNumber, currentPart);\n      splitFiles.push(partPath);\n      console.log(`[Pipeline] Created final part ${partNumber} with ${currentRowCount} rows across ${currentPart.length} sheets`);\n    }\n    \n    return splitFiles;\n  } catch (error) {\n    console.error(`[Pipeline] Error splitting Excel file:`, error);\n    throw error;\n  }\n}\n\nasync function writePartFileMultiSheet(outputDir: string, fileName: string, ext: string, partNumber: number, sheets: SheetData[]): Promise<string> {\n  const partFileName = `${fileName}_part${partNumber}${ext}`;\n  const partPath = path.join(outputDir, partFileName);\n  \n  const newWorkbook = xlsx.utils.book_new();\n  \n  for (const sheet of sheets) {\n    const allData = [sheet.headers, ...sheet.rows];\n    const newSheet = xlsx.utils.aoa_to_sheet(allData);\n    xlsx.utils.book_append_sheet(newWorkbook, newSheet, sheet.sheetName);\n  }\n  \n  xlsx.writeFile(newWorkbook, partPath);\n  return partPath;\n}\n\nasync function uploadImagesToSpaces(\n  images: PipelineResult[\"images\"],\n  folderName: string,\n  coverPhotoPath?: string\n): Promise<{ imageUrls: Array<{ sheet: string; page: number; url: string; isBlurred: boolean }>; coverUrl: string | null }> {\n  const imageUrls: Array<{ sheet: string; page: number; url: string; isBlurred: boolean }> = [];\n  let coverUrl: string | null = null;\n  \n  if (!images || images.length === 0) {\n    return { imageUrls, coverUrl };\n  }\n  \n  for (let i = 0; i < images.length; i++) {\n    const img = images[i];\n    const imgFileName = `${String(i + 1).padStart(3, '0')}_${img.sheet}_page${img.page}.png`;\n    \n    const result = await uploadToSpaces({\n      localFilePath: img.path,\n      remoteKey: `${folderName}/${imgFileName}`,\n    });\n    \n    if (result.success && result.url) {\n      imageUrls.push({\n        sheet: img.sheet,\n        page: img.page,\n        url: result.url,\n        isBlurred: img.isBlurred || false,\n      });\n      \n      if (i === 0) {\n        coverUrl = result.url;\n      }\n    } else {\n      console.error(`[Pipeline] Failed to upload image: ${img.path}`, result.error);\n    }\n  }\n  \n  return { imageUrls, coverUrl };\n}\n\nexport interface PipelineOptions {\n  excelFilePath: string;\n  outputDir: string;\n  onProgress?: (message: string) => void;\n}\n\nexport async function runExcelToPngPipeline(options: PipelineOptions): Promise<PipelineResult> {\n  const { excelFilePath, outputDir, onProgress } = options;\n  \n  const scriptPath = path.join(PIPELINE_DIR, \"excel_to_png.py\");\n  const templatePath = path.join(PIPELINE_DIR, \"template.html\");\n  \n  console.log(`[Pipeline] Script path: ${scriptPath}`);\n  console.log(`[Pipeline] Template path: ${templatePath}`);\n  \n  try {\n    await fs.access(excelFilePath);\n  } catch (error) {\n    return {\n      success: false,\n      error: `Excel file not found: ${excelFilePath}`,\n    };\n  }\n  \n  await fs.mkdir(outputDir, { recursive: true });\n  \n  return new Promise((resolve) => {\n    const pythonProcess = spawn(\"python3\", [\n      scriptPath,\n      excelFilePath,\n      outputDir,\n      templatePath,\n    ], {\n      env: {\n        ...process.env,\n        PLAYWRIGHT_BROWSERS_PATH: path.join(process.cwd(), '.cache', 'ms-playwright'),\n        LD_LIBRARY_PATH: `${process.env.LD_LIBRARY_PATH || ''}:/nix/store`,\n      }\n    });\n    \n    let stdout = \"\";\n    let stderr = \"\";\n    \n    pythonProcess.stdout.on(\"data\", (data) => {\n      const message = data.toString();\n      stdout += message;\n      if (onProgress) {\n        onProgress(message);\n      }\n    });\n    \n    pythonProcess.stderr.on(\"data\", (data) => {\n      const message = data.toString();\n      stderr += message;\n      if (onProgress) {\n        onProgress(`[ERROR] ${message}`);\n      }\n    });\n    \n    pythonProcess.on(\"close\", async (code) => {\n      if (code !== 0) {\n        resolve({\n          success: false,\n          error: `Pipeline failed with code ${code}: ${stderr}`,\n        });\n        return;\n      }\n      \n      try {\n        const stdoutJson = JSON.parse(stdout.trim());\n        \n        if (!stdoutJson.success || !stdoutJson.outputFile) {\n          resolve({\n            success: false,\n            error: `Python script did not return output file path. Stdout: ${stdout}`,\n          });\n          return;\n        }\n        \n        const resultData = await fs.readFile(stdoutJson.outputFile, 'utf-8');\n        const result = JSON.parse(resultData);\n        resolve(result);\n      } catch (error) {\n        resolve({\n          success: false,\n          error: `Failed to parse pipeline output. Error: ${error}. Stdout: ${stdout.substring(0, 200)}`,\n        });\n      }\n    });\n    \n    pythonProcess.on(\"error\", (error) => {\n      resolve({\n        success: false,\n        error: `Failed to start pipeline: ${error.message}`,\n      });\n    });\n  });\n}\n\nasync function processSinglePart(\n  partFilePath: string,\n  outputDir: string,\n  uploadId: string,\n  storage: any,\n  baseTitle: string,\n  baseDescription: string,\n  category: string,\n  subcategory: string | null,\n  partNumber: number,\n  totalParts: number,\n  originalFileName: string,\n  parentPostId?: string\n): Promise<{ success: boolean; postId?: string; error?: string }> {\n  const partTitle = totalParts > 1 ? `[${partNumber}] - ${baseTitle}` : baseTitle;\n  const partDesc = totalParts > 1 \n    ? `${baseDescription} (Ph·∫ßn ${partNumber}/${totalParts})`\n    : baseDescription;\n  \n  const partOutputDir = path.join(outputDir, `part${partNumber}`);\n  \n  const result = await runExcelToPngPipeline({\n    excelFilePath: partFilePath,\n    outputDir: partOutputDir,\n    onProgress: (msg) => console.log(`[Pipeline ${uploadId} P${partNumber}]`, msg),\n  });\n  \n  if (!result.success) {\n    return { success: false, error: result.error };\n  }\n  \n  console.log(`[Pipeline] Part ${partNumber}: Generated ${result.totalImages} images`);\n  \n  const pageCount = result.totalImages || 1;\n  const document = await storage.createDocument({\n    title: partTitle,\n    description: partDesc,\n    category,\n    subcategory,\n    pageCount,\n    pointsCost: pageCount,\n    coverImageUrl: '/placeholder-cover.png',\n    imageUrls: [],\n    originalFileName,\n    parentPostId: parentPostId || null,\n    postIndex: totalParts > 1 ? partNumber : null,\n    totalParts: totalParts > 1 ? totalParts : null,\n  });\n  \n  const postId = document.postId;\n  console.log(`[Pipeline] Part ${partNumber}: Document created with postId: ${postId}`);\n  \n  const partFolderName = generateFolderName(postId, `${originalFileName}_part${partNumber}`);\n  const { imageUrls, coverUrl } = await uploadImagesToSpaces(result.images, partFolderName, result.coverPhoto);\n  \n  console.log(`[Pipeline] Part ${partNumber}: Uploaded ${imageUrls.length} images to DO Spaces`);\n  \n  await storage.updateDocument(document.id, {\n    coverImageUrl: coverUrl || '/placeholder-cover.png',\n    imageUrls: imageUrls,\n  });\n  \n  if (partNumber === 1) {\n    const archiveResult = await uploadAndCleanupOriginalFile(partFilePath, postId, originalFileName, result.outputDir);\n    if (!archiveResult.success) {\n      console.warn(`[Pipeline] Part ${partNumber}: Failed to archive original file, but document is created`);\n    }\n  } else {\n    try {\n      if (result.outputDir) {\n        await fs.rm(result.outputDir, { recursive: true, force: true });\n      }\n    } catch (cleanupErr) {\n      console.warn(`[Pipeline] Part ${partNumber}: Failed to cleanup temp files:`, cleanupErr);\n    }\n  }\n  \n  console.log(`[Pipeline] Part ${partNumber}: Document completed: \"${partTitle}\" with ${imageUrls.length} images`);\n  \n  return { success: true, postId };\n}\n\nexport async function processAdminUpload(uploadId: string, filePath: string, storage: any): Promise<void> {\n  console.log(`[Pipeline] Starting processing for admin upload ${uploadId}`);\n  \n  const outputDir = path.join(process.cwd(), \"uploads\", \"pipeline-output\", uploadId);\n  const splitDir = path.join(outputDir, \"split-files\");\n  const originalFileName = path.basename(filePath);\n  \n  await storage.updatePipelineStatus(uploadId, \"processing\", new Date());\n  \n  try {\n    const excelInfo = getExcelRowCount(filePath);\n    \n    const uploadRecord = await storage.getAdminUploadById(uploadId);\n    let baseTitle = path.basename(filePath, path.extname(filePath));\n    let baseDescription = `T√†i li·ªáu ƒë∆∞·ª£c t·∫°o t·ª´ admin upload`;\n    let category = uploadRecord?.category || 'Kh√°c';\n    let subcategory = uploadRecord?.subcategory || null;\n    \n    if (uploadRecord?.aiStatus === 'completed' && uploadRecord.aiGeneratedTitle) {\n      baseTitle = uploadRecord.aiGeneratedTitle;\n      baseDescription = uploadRecord.aiGeneratedDescription || baseDescription;\n      console.log(`[Pipeline] Using AI-generated metadata for document`);\n    } else {\n      console.log(`[Pipeline] No AI metadata available, using default values`);\n    }\n    \n    console.log(`[Pipeline] Using admin-selected category: \"${category}\"`);\n    \n    if (excelInfo.needsSplit) {\n      console.log(`[Pipeline] File has ${excelInfo.totalRows} rows, splitting into ${excelInfo.partCount} parts`);\n      \n      await fs.mkdir(splitDir, { recursive: true });\n      const splitFiles = await splitExcelFile(filePath, splitDir, MAX_ROWS_PER_POST);\n      \n      console.log(`[Pipeline] Created ${splitFiles.length} split files`);\n      \n      const createdPostIds: string[] = [];\n      let parentPostId: string | undefined = undefined;\n      \n      for (let i = 0; i < splitFiles.length; i++) {\n        const partResult = await processSinglePart(\n          splitFiles[i],\n          outputDir,\n          uploadId,\n          storage,\n          baseTitle,\n          baseDescription,\n          category,\n          subcategory,\n          i + 1,\n          splitFiles.length,\n          originalFileName,\n          parentPostId\n        );\n        \n        if (!partResult.success) {\n          throw new Error(`Part ${i + 1} failed: ${partResult.error}`);\n        }\n        \n        if (partResult.postId) {\n          createdPostIds.push(partResult.postId);\n          if (i === 0) {\n            parentPostId = partResult.postId;\n          }\n        }\n      }\n      \n      try {\n        await fs.rm(splitDir, { recursive: true, force: true });\n      } catch (cleanupErr) {\n        console.warn(`[Pipeline] Failed to cleanup split files:`, cleanupErr);\n      }\n      \n      console.log(`[Pipeline] All ${splitFiles.length} parts completed. PostIds: ${createdPostIds.join(', ')}`);\n      await storage.updatePipelineStatus(uploadId, \"completed\", undefined, new Date());\n      \n    } else {\n      const result = await runExcelToPngPipeline({\n        excelFilePath: filePath,\n        outputDir,\n        onProgress: (msg) => console.log(`[Pipeline ${uploadId}]`, msg),\n      });\n      \n      if (result.success) {\n        console.log(`[Pipeline] Excel-to-PNG completed for upload ${uploadId}`);\n        console.log(`[Pipeline] Generated ${result.totalImages} images`);\n        \n        const pageCount = result.totalImages || 1;\n        const document = await storage.createDocument({\n          title: baseTitle,\n          description: baseDescription,\n          category,\n          subcategory,\n          pageCount,\n          pointsCost: pageCount,\n          coverImageUrl: '/placeholder-cover.png',\n          imageUrls: [],\n          originalFileName,\n        });\n        \n        const postId = document.postId;\n        console.log(`[Pipeline] Document created with postId: ${postId}`);\n        \n        const folderName = generateFolderName(postId, originalFileName);\n        console.log(`[Pipeline] Uploading images to DO Spaces folder: ${folderName}`);\n        \n        const { imageUrls, coverUrl } = await uploadImagesToSpaces(result.images, folderName, result.coverPhoto);\n        \n        console.log(`[Pipeline] Uploaded ${imageUrls.length} images to DO Spaces`);\n        \n        await storage.updateDocument(document.id, {\n          coverImageUrl: coverUrl || '/placeholder-cover.png',\n          imageUrls: imageUrls,\n        });\n        \n        console.log(`[Pipeline] Document updated with DO Spaces URLs`);\n        \n        const archiveResult = await uploadAndCleanupOriginalFile(filePath, postId, originalFileName, result.outputDir);\n        if (!archiveResult.success) {\n          console.warn(`[Pipeline] Failed to archive original file: ${archiveResult.error}`);\n        }\n        \n        console.log(`[Pipeline] Document completed: \"${baseTitle}\" with ${imageUrls.length} images`);\n        await storage.updatePipelineStatus(uploadId, \"completed\", undefined, new Date());\n      } else {\n        const errorMessage = result.error || \"Unknown pipeline error\";\n        console.error(`[Pipeline] Excel-to-PNG failed for upload ${uploadId}:`, errorMessage);\n        await storage.updatePipelineStatus(uploadId, \"failed\", undefined, new Date(), errorMessage);\n      }\n    }\n  } catch (error: any) {\n    const errorMessage = error?.message || String(error);\n    console.error(`[Pipeline] Processing failed:`, errorMessage);\n    await storage.updatePipelineStatus(uploadId, \"failed\", undefined, new Date(), errorMessage);\n  }\n}\n\nexport async function processUserUploadApproval(uploadId: string, filePath: string, storage: any): Promise<void> {\n  console.log(`[Pipeline] Starting processing for approved user upload ${uploadId}`);\n  \n  const outputDir = path.join(process.cwd(), \"uploads\", \"user-pipeline-output\", uploadId);\n  const splitDir = path.join(outputDir, \"split-files\");\n  const originalFileName = path.basename(filePath);\n  \n  await storage.updateUserUploadPipelineStatus(uploadId, \"processing\", new Date());\n  \n  try {\n    const excelInfo = getExcelRowCount(filePath);\n    \n    const uploadRecord = await storage.getUserUploadById(uploadId);\n    let baseTitle = path.basename(filePath, path.extname(filePath));\n    let baseDescription = `T√†i li·ªáu ƒë∆∞·ª£c t·∫°o t·ª´ upload c·ªßa ng∆∞·ªùi d√πng`;\n    let category = uploadRecord?.approvedCategory || 'Kh√°c';\n    let subcategory = uploadRecord?.approvedSubcategory || null;\n    \n    if (uploadRecord?.aiStatus === 'completed' && uploadRecord.aiGeneratedTitle) {\n      baseTitle = uploadRecord.aiGeneratedTitle;\n      baseDescription = uploadRecord.aiGeneratedDescription || baseDescription;\n      console.log(`[Pipeline] Using AI-generated metadata for document`);\n    } else {\n      console.log(`[Pipeline] No AI metadata available, using default values`);\n    }\n    \n    console.log(`[Pipeline] Using admin-approved category: \"${category}\"`);\n    \n    if (excelInfo.needsSplit) {\n      console.log(`[Pipeline] File has ${excelInfo.totalRows} rows, splitting into ${excelInfo.partCount} parts`);\n      \n      await fs.mkdir(splitDir, { recursive: true });\n      const splitFiles = await splitExcelFile(filePath, splitDir, MAX_ROWS_PER_POST);\n      \n      console.log(`[Pipeline] Created ${splitFiles.length} split files`);\n      \n      const createdPostIds: string[] = [];\n      let parentPostId: string | undefined = undefined;\n      \n      for (let i = 0; i < splitFiles.length; i++) {\n        const partResult = await processSinglePart(\n          splitFiles[i],\n          outputDir,\n          uploadId,\n          storage,\n          baseTitle,\n          baseDescription,\n          category,\n          subcategory,\n          i + 1,\n          splitFiles.length,\n          originalFileName,\n          parentPostId\n        );\n        \n        if (!partResult.success) {\n          throw new Error(`Part ${i + 1} failed: ${partResult.error}`);\n        }\n        \n        if (partResult.postId) {\n          createdPostIds.push(partResult.postId);\n          if (i === 0) {\n            parentPostId = partResult.postId;\n          }\n        }\n      }\n      \n      try {\n        await fs.rm(splitDir, { recursive: true, force: true });\n      } catch (cleanupErr) {\n        console.warn(`[Pipeline] Failed to cleanup split files:`, cleanupErr);\n      }\n      \n      console.log(`[Pipeline] All ${splitFiles.length} parts completed. PostIds: ${createdPostIds.join(', ')}`);\n      await storage.updateUserUploadPipelineStatus(uploadId, \"completed\", undefined, new Date());\n      \n    } else {\n      const result = await runExcelToPngPipeline({\n        excelFilePath: filePath,\n        outputDir,\n        onProgress: (msg) => console.log(`[Pipeline ${uploadId}]`, msg),\n      });\n      \n      if (result.success) {\n        console.log(`[Pipeline] Excel-to-PNG completed for user upload ${uploadId}`);\n        console.log(`[Pipeline] Generated ${result.totalImages} images`);\n        \n        const pageCount = result.totalImages || 1;\n        const document = await storage.createDocument({\n          title: baseTitle,\n          description: baseDescription,\n          category,\n          subcategory,\n          pageCount,\n          pointsCost: pageCount,\n          coverImageUrl: '/placeholder-cover.png',\n          imageUrls: [],\n          originalFileName,\n        });\n        \n        const postId = document.postId;\n        console.log(`[Pipeline] Document created with postId: ${postId}`);\n        \n        const folderName = generateFolderName(postId, originalFileName);\n        console.log(`[Pipeline] Uploading images to DO Spaces folder: ${folderName}`);\n        \n        const { imageUrls, coverUrl } = await uploadImagesToSpaces(result.images, folderName, result.coverPhoto);\n        \n        console.log(`[Pipeline] Uploaded ${imageUrls.length} images to DO Spaces`);\n        \n        await storage.updateDocument(document.id, {\n          coverImageUrl: coverUrl || '/placeholder-cover.png',\n          imageUrls: imageUrls,\n        });\n        \n        console.log(`[Pipeline] Document updated with DO Spaces URLs`);\n        \n        const archiveResult = await uploadAndCleanupOriginalFile(filePath, postId, originalFileName, result.outputDir);\n        if (!archiveResult.success) {\n          console.warn(`[Pipeline] Failed to archive original file: ${archiveResult.error}`);\n        }\n        \n        console.log(`[Pipeline] Document completed: \"${baseTitle}\" with ${imageUrls.length} images`);\n        await storage.updateUserUploadPipelineStatus(uploadId, \"completed\", undefined, new Date());\n      } else {\n        const errorMessage = result.error || \"Unknown pipeline error\";\n        console.error(`[Pipeline] Excel-to-PNG failed for user upload ${uploadId}:`, errorMessage);\n        await storage.updateUserUploadPipelineStatus(uploadId, \"failed\", undefined, new Date());\n      }\n    }\n  } catch (error: any) {\n    const errorMessage = error?.message || String(error);\n    console.error(`[Pipeline] Processing failed:`, errorMessage);\n    await storage.updateUserUploadPipelineStatus(uploadId, \"failed\", undefined, new Date());\n  }\n}\n","path":null,"size_bytes":24311,"size_tokens":null},"PIPELINE_INTEGRATION.md":{"content":"# üéØ Pipeline Excel-to-PNG Integration - Ho√†n t·∫•t\n\n## ‚úÖ T·ªïng quan\n\nPipeline chuy·ªÉn ƒë·ªïi Excel th√†nh PNG images **ƒë√£ ƒë∆∞·ª£c t√≠ch h·ª£p ho√†n ch·ªânh** v√†o h·ªá th·ªëng. Pipeline t·ª± ƒë·ªông ch·∫°y khi:\n\n1. **Admin upload file h√†ng lo·∫°t** (t·ªëi ƒëa 500MB) ‚Üí Pipeline t·ª± ƒë·ªông x·ª≠ l√Ω\n2. **Admin duy·ªát user upload** ‚Üí Pipeline t·ª± ƒë·ªông x·ª≠ l√Ω\n\n## üìÅ C·∫•u tr√∫c Files\n\n```\nserver/pipeline/\n‚îú‚îÄ‚îÄ excel_to_png.py      # Script Python chuy·ªÉn ƒë·ªïi Excel ‚Üí PNG\n‚îú‚îÄ‚îÄ template.html        # Template HTML cho rendering\n‚îî‚îÄ‚îÄ runner.ts            # TypeScript service ƒë·ªÉ ch·∫°y Python script\n\nuploads/\n‚îú‚îÄ‚îÄ pipeline-output/     # Output t·ª´ admin bulk uploads\n‚îÇ   ‚îî‚îÄ‚îÄ {uploadId}/\n‚îÇ       ‚îî‚îÄ‚îÄ images/\n‚îÇ           ‚îî‚îÄ‚îÄ {fileName}/\n‚îÇ               ‚îî‚îÄ‚îÄ {sheetName}/\n‚îÇ                   ‚îú‚îÄ‚îÄ coverphoto-{sheetName}.png  ‚Üê ·∫¢NH COVER\n‚îÇ                   ‚îú‚îÄ‚îÄ {sheetName}_page_1.png\n‚îÇ                   ‚îú‚îÄ‚îÄ {sheetName}_page_2.png\n‚îÇ                   ‚îî‚îÄ‚îÄ ...\n‚îÇ\n‚îî‚îÄ‚îÄ user-pipeline-output/  # Output t·ª´ approved user uploads\n    ‚îî‚îÄ‚îÄ {uploadId}/\n        ‚îî‚îÄ‚îÄ images/\n            ‚îî‚îÄ‚îÄ (c√πng c·∫•u tr√∫c nh∆∞ tr√™n)\n```\n\n## üé® Output Pipeline\n\n### M·ªói Excel file t·∫°o ra:\n\n1. **Cover Photo** (cho m·ªói sheet):\n   - File: `coverphoto-{sheetName}.png`\n   - K√≠ch th∆∞·ªõc: 800x500px\n   - Hi·ªáu ·ª©ng: Blur nh·∫π (~10%)\n   - **M·ª•c ƒë√≠ch**: L√†m ·∫£nh ƒë·∫°i di·ªán cho document card\n\n2. **Page Images** (trang d·ªØ li·ªáu):\n   - File: `{sheetName}_page_1.png`, `{sheetName}_page_2.png`, ...\n   - K√≠ch th∆∞·ªõc: 2000x1300px\n   - M·ªói trang: 10 rows d·ªØ li·ªáu\n   - T·ªëi ƒëa: 15 columns\n\n### V√≠ d·ª• Output\n\nN·∫øu file Excel c√≥ 25 rows v√† 2 sheets:\n\n```\noutput_images/\n‚îî‚îÄ‚îÄ my_excel_file/\n    ‚îú‚îÄ‚îÄ Sheet1/\n    ‚îÇ   ‚îú‚îÄ‚îÄ coverphoto-Sheet1.png       ‚Üê COVER PHOTO\n    ‚îÇ   ‚îú‚îÄ‚îÄ Sheet1_page_1.png\n    ‚îÇ   ‚îú‚îÄ‚îÄ Sheet1_page_2.png\n    ‚îÇ   ‚îî‚îÄ‚îÄ Sheet1_page_3.png\n    ‚îî‚îÄ‚îÄ Sheet2/\n        ‚îú‚îÄ‚îÄ coverphoto-Sheet2.png       ‚Üê COVER PHOTO\n        ‚îú‚îÄ‚îÄ Sheet2_page_1.png\n        ‚îú‚îÄ‚îÄ Sheet2_page_2.png\n        ‚îî‚îÄ‚îÄ Sheet2_page_3.png\n```\n\n## üîÑ Integration Points\n\n### 1. Admin Bulk Upload\n\n**File**: `server/routes.ts` (line ~565)\n\n```typescript\n// Sau khi upload th√†nh c√¥ng\nconst upload = await storage.createAdminUpload({ ... });\n\n// Pipeline CH·ªà ch·∫°y cho Excel files (skip PDF/CSV)\nconst isExcelFile = file.mimetype === \"application/vnd.ms-excel\" || \n                    file.mimetype === \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\";\n\nif (isExcelFile) {\n  processAdminUpload(upload.id, file.path, storage).catch((error) => {\n    console.error(`[Pipeline] Error:`, error);\n  });\n} else {\n  console.log(`[Pipeline] Skipping pipeline for non-Excel file`);\n}\n```\n\n**Database tracking:**\n- `admin_uploads.pipelineStatus`: `pending` ‚Üí `processing` ‚Üí `completed` / `failed`\n- `admin_uploads.pipelineStartedAt`: Timestamp khi b·∫Øt ƒë·∫ßu\n- `admin_uploads.pipelineCompletedAt`: Timestamp khi ho√†n t·∫•t\n\n### 2. User Upload Approval\n\n**File**: `server/routes.ts` (line ~640)\n\n```typescript\n// Sau khi admin duy·ªát\nconst upload = await storage.approveUserUpload(id, adminId);\n\n// Pipeline CH·ªà ch·∫°y cho Excel files (skip PDF/CSV)\nconst isExcelFile = upload.fileType === \"application/vnd.ms-excel\" || \n                    upload.fileType === \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\";\n\nif (isExcelFile) {\n  processUserUploadApproval(upload.id, upload.filePath, storage).catch((error) => {\n    console.error(`[Pipeline] Error:`, error);\n  });\n} else {\n  console.log(`[Pipeline] Skipping pipeline for non-Excel file`);\n}\n```\n\n**Status tracking:**\n- User uploads: Console logs only (no DB pipeline status fields)\n- Admin uploads: Full DB tracking with status/timestamps\n- **Why?** User uploads are smaller (10MB limit) and less critical than admin bulk uploads (500MB)\n\n## üõ†Ô∏è Technical Stack\n\n### Backend Service\n- **Language**: TypeScript\n- **Runner**: `server/pipeline/runner.ts`\n- **Method**: Spawn Python process v·ªõi `child_process.spawn`\n- **Communication**: JSON output t·ª´ Python script\n\n### Python Pipeline\n- **pandas**: ƒê·ªçc Excel files\n- **jinja2**: Render HTML templates\n- **playwright**: Screenshot HTML ‚Üí PNG\n- **pillow**: X·ª≠ l√Ω ·∫£nh (blur, resize cover photos)\n\n## ‚ö†Ô∏è Dependencies\n\n### Python Packages (‚úÖ ƒê√£ c√†i)\n```bash\npandas==2.3.3\njinja2==3.1.6\nplaywright==1.55.0\npillow==12.0.0\nopenpyxl==3.1.5\n```\n\n### System Dependencies (‚ùå C·∫ßn thi·∫øt cho Playwright)\n\nPlaywright c·∫ßn c√°c system libraries sau ƒë·ªÉ ch·∫°y Chromium browser:\n\n- libnspr4\n- libnss3\n- libdbus-1-3\n- libatk1.0-0\n- libatk-bridge2.0-0\n- libcups2\n- libxkbcommon0\n- libatspi2.0-0\n- libxcomposite1\n- libxdamage1\n- libxfixes3\n- libgbm1\n- libcairo2\n- libpango-1.0-0\n- libasound2\n\n**‚ö†Ô∏è L∆∞u √Ω**: Tr√™n Replit environment hi·ªán t·∫°i, c√°c system dependencies n√†y **ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t ƒë·∫ßy ƒë·ªß**. Pipeline s·∫Ω b√°o l·ªói khi ch·∫°y tr√™n Replit.\n\n## üöÄ C√°ch test Pipeline\n\n### Option 1: Test tr√™n Production Environment\n\nDeploy application l√™n m√¥i tr∆∞·ªùng c√≥ ƒë·∫ßy ƒë·ªß system dependencies:\n\n1. **Replit Published Deployment**:\n   - Click \"Publish\" ƒë·ªÉ deploy\n   - System dependencies s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c c√†i ƒë·∫∑t\n   - Pipeline s·∫Ω ho·∫°t ƒë·ªông ƒë·∫ßy ƒë·ªß\n\n2. **Server ri√™ng** (Ubuntu/Debian):\n   ```bash\n   # Install system dependencies\n   sudo apt-get update\n   sudo apt-get install -y \\\n     libnspr4 libnss3 libdbus-1-3 libatk1.0-0 \\\n     libatk-bridge2.0-0 libcups2 libxkbcommon0 \\\n     libatspi2.0-0 libxcomposite1 libxdamage1 \\\n     libxfixes3 libgbm1 libcairo2 libpango-1.0-0 libasound2\n\n   # Install Playwright browsers\n   python3 -m playwright install chromium\n   ```\n\n### Option 2: Test v·ªõi Mock Data\n\nT√¥i ƒë√£ t·∫°o sample Excel file ƒë·ªÉ test:\n\n```bash\n# T·∫°o sample Excel\npython3 test-data/create_sample_excel.py\n\n# C√≥ th·ªÉ upload file n√†y qua Admin Panel ‚Üí Upload H√†ng lo·∫°t\n# File: test-data/sample_data.xlsx (9KB)\n```\n\n## üìä Pipeline Workflow\n\n```\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ 1. Admin Upload File (ho·∫∑c User Approval)  ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n               ‚îÇ\n               v\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ 2. Save file to disk                        ‚îÇ\n‚îÇ    - Admin: Admin-Upload/                   ‚îÇ\n‚îÇ    - User:  User-Upload/                    ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n               ‚îÇ\n               v\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ 3. Trigger Pipeline (asynchronous)          ‚îÇ\n‚îÇ    - Update status: pending ‚Üí processing    ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n               ‚îÇ\n               v\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ 4. Python Script Execute                    ‚îÇ\n‚îÇ    - Read Excel sheets                      ‚îÇ\n‚îÇ    - Render HTML table                      ‚îÇ\n‚îÇ    - Screenshot to PNG (Playwright)         ‚îÇ\n‚îÇ    - Generate cover photo (blur + resize)   ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n               ‚îÇ\n               v\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ 5. Save Output Images                       ‚îÇ\n‚îÇ    uploads/pipeline-output/{uploadId}/      ‚îÇ\n‚îÇ    ‚îî‚îÄ‚îÄ images/{fileName}/{sheetName}/       ‚îÇ\n‚îÇ        ‚îú‚îÄ‚îÄ coverphoto-{sheet}.png  ‚Üê COVER  ‚îÇ\n‚îÇ        ‚îú‚îÄ‚îÄ {sheet}_page_1.png               ‚îÇ\n‚îÇ        ‚îî‚îÄ‚îÄ {sheet}_page_2.png               ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n               ‚îÇ\n               v\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ 6. Update Database                          ‚îÇ\n‚îÇ    - Status: processing ‚Üí completed         ‚îÇ\n‚îÇ    - Log completedAt timestamp              ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n## üéØ C√°ch s·ª≠ d·ª•ng Cover Photos\n\nCover photos ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông v√† c√≥ th·ªÉ d√πng ƒë·ªÉ:\n\n1. **Document Card Thumbnails**:\n   ```typescript\n   // Frontend s·∫Ω hi·ªÉn th·ªã cover photo l√†m ·∫£nh ƒë·∫°i di·ªán\n   <img src={document.coverPhotoPath} alt={document.title} />\n   ```\n\n2. **Gallery View**:\n   - Cover photos c√≥ k√≠ch th∆∞·ªõc t·ªëi ∆∞u (800x500)\n   - Hi·ªáu ·ª©ng blur nh·∫π t·∫°o aesthetic appeal\n   - Ph√π h·ª£p ƒë·ªÉ preview n·ªôi dung Excel\n\n3. **Auto-update Documents**:\n   - Sau khi pipeline ho√†n t·∫•t, c√≥ th·ªÉ t·ª± ƒë·ªông:\n     - T·∫°o document m·ªõi v·ªõi cover photo\n     - Set coverImage path\n     - Link c√°c page images v√†o videoUrl array\n\n## üìù Console Logs\n\nPipeline s·∫Ω log c√°c th√¥ng tin sau:\n\n```bash\n[Pipeline] Admin upload created: abc-123, triggering pipeline...\n[Pipeline] Starting processing for admin upload abc-123\n[Pipeline abc-123] B·∫Øt ƒë·∫ßu chuy·ªÉn ƒë·ªïi Excel sang PNG...\n[Pipeline abc-123] --- X·ª≠ l√Ω file: sample_data ---\n[Pipeline abc-123] -> X·ª≠ l√Ω sheet: Danh s√°ch nh√¢n vi√™n\n[Pipeline abc-123]   -> T·∫°o ·∫£nh 2000x1300 t·ª´: sample_data_Danh s√°ch_cover.html\n[Pipeline abc-123]      ‚úÖ ƒê√£ l∆∞u ·∫£nh: sample_data_Danh s√°ch_cover.png\n[Pipeline abc-123]      üé® ƒê√£ t·∫°o cover photo: coverphoto-Danh s√°ch.png\n[Pipeline] Completed successfully for upload abc-123\n[Pipeline] Generated 15 images\n[Pipeline] Cover photos: [.../coverphoto-Sheet1.png, ...]\n```\n\n## ‚úÖ What's Working\n\n- ‚úÖ Python scripts integrated into project\n- ‚úÖ TypeScript pipeline runner service\n- ‚úÖ Admin bulk upload triggers pipeline (Excel only)\n- ‚úÖ User upload approval triggers pipeline (Excel only)\n- ‚úÖ **File type filtering**: PDF/CSV uploads skip pipeline gracefully\n- ‚úÖ Database status tracking for admin uploads (pending/processing/completed/failed)\n- ‚úÖ Console-based tracking for user uploads\n- ‚úÖ **Robust JSON parsing**: Handles Python warnings and stdout noise\n- ‚úÖ Asynchronous processing (kh√¥ng block response)\n- ‚úÖ Error handling & logging\n- ‚úÖ Cover photo generation v·ªõi blur effect\n- ‚úÖ Multi-sheet Excel support\n- ‚úÖ Automatic pagination (10 rows/page)\n\n## ‚è≥ What Needs Production Environment\n\n- ‚è≥ Playwright system dependencies\n- ‚è≥ Actual PNG generation (c·∫ßn browser)\n- ‚è≥ Full end-to-end testing\n\n## üîó Related Files\n\n| File | Purpose |\n|------|---------|\n| `server/pipeline/excel_to_png.py` | Python conversion script |\n| `server/pipeline/template.html` | HTML template for rendering |\n| `server/pipeline/runner.ts` | TypeScript runner service |\n| `server/routes.ts` | Integration points (line 565, 634) |\n| `server/storage.ts` | Database operations |\n| `shared/schema.ts` | Database schema with pipeline fields |\n\n## üéâ T√≥m l·∫°i\n\nPipeline **ƒë√£ ƒë∆∞·ª£c t√≠ch h·ª£p ho√†n ch·ªânh** v√†o c·∫£ admin upload v√† user upload approval workflows. \n\nCode ho·∫°t ƒë·ªông ch√≠nh x√°c, ch·ªâ c·∫ßn deploy l√™n m√¥i tr∆∞·ªùng production (v·ªõi ƒë·∫ßy ƒë·ªß system dependencies) ƒë·ªÉ pipeline ch·∫°y v√† t·∫°o cover photos t·ª± ƒë·ªông!\n","path":null,"size_bytes":12203,"size_tokens":null},"pyproject.toml":{"content":"[project]\nname = \"repl-nix-workspace\"\nversion = \"0.1.0\"\ndescription = \"Add your description here\"\nrequires-python = \">=3.11\"\ndependencies = [\n    \"jinja2>=3.1.6\",\n    \"openpyxl>=3.1.5\",\n    \"pandas>=2.3.3\",\n    \"pillow>=12.0.0\",\n    \"playwright>=1.55.0\",\n    \"xlrd>=2.0.2\",\n]\n","path":null,"size_bytes":276,"size_tokens":null},"main.py":{"content":"def main():\n    print(\"Hello from repl-nix-workspace!\")\n\n\nif __name__ == \"__main__\":\n    main()\n","path":null,"size_bytes":96,"size_tokens":null},"attached_assets/excel_to_png_1761633350424.py":{"content":"import os\r\nimport pandas as pd\r\nfrom jinja2 import Environment, FileSystemLoader\r\nfrom playwright.sync_api import sync_playwright\r\nimport math\r\nimport shutil\r\nfrom PIL import Image, ImageFilter\r\n\r\n# --- C·∫§U H√åNH ---\r\nEXCEL_DIR = \"excel_files\"\r\nHTML_DIR = \"output_html\"\r\nIMAGE_DIR = \"output_images\"\r\n\r\nTARGET_WIDTH, TARGET_HEIGHT = 2000, 1300\r\nROW_HEIGHT = 108\r\n\r\nROWS_PER_PAGE = 10\r\nDATA_COLS_TO_KEEP = 15\r\n\r\nINDEX_COL_WIDTH = 50\r\nTOP_3_COL_WIDTH = 200\r\nOTHER_COL_WIDTH = 105\r\n\r\nAVG_CHAR_WIDTH = 8.5\r\nCELL_PADDING_X = 10\r\nLINE_HEIGHT_ESTIMATE = 18\r\n\r\n# Cover photo\r\nCOVER_WIDTH, COVER_HEIGHT = 800, 500\r\nCOVER_BLUR_RADIUS = 1.5  # ~10% m·ªù nh·∫π\r\n\r\n# --- H√†m ph·ª• tr·ª£ ---\r\ndef get_column_widths(df_chunk):\r\n    if df_chunk.empty:\r\n        return []\r\n    avg_lengths = df_chunk.astype(str).applymap(lambda x: len(str(x).strip())).mean()\r\n    top_3_indices = avg_lengths.sort_values(ascending=False).head(3).index\r\n    data_widths = []\r\n    for i in range(len(df_chunk.columns)):\r\n        if i in top_3_indices:\r\n            data_widths.append(TOP_3_COL_WIDTH)\r\n        else:\r\n            data_widths.append(OTHER_COL_WIDTH)\r\n    return [INDEX_COL_WIDTH] + data_widths\r\n\r\ndef get_cell_class(text, col_width):\r\n    text_space = col_width - CELL_PADDING_X\r\n    if text_space <= 0:\r\n        return \"no-wrap-text\"\r\n    num_lines = math.ceil(len(str(text).strip()) * AVG_CHAR_WIDTH / text_space)\r\n    estimated_height = num_lines * LINE_HEIGHT_ESTIMATE\r\n    return \"wrap-text\" if estimated_height <= ROW_HEIGHT else \"no-wrap-text\"\r\n\r\ndef html_to_fixed_size_image(html_path, image_path):\r\n    print(f\"  -> T·∫°o ·∫£nh {TARGET_WIDTH}x{TARGET_HEIGHT} t·ª´: {os.path.basename(html_path)}\")\r\n    with sync_playwright() as p:\r\n        browser = p.chromium.launch()\r\n        page = browser.new_page()\r\n        page.set_viewport_size({\"width\": TARGET_WIDTH, \"height\": TARGET_HEIGHT})\r\n        page.goto(f\"file://{os.path.abspath(html_path)}\")\r\n        page.screenshot(path=image_path, full_page=False)\r\n        browser.close()\r\n    print(f\"     ‚úÖ ƒê√£ l∆∞u ·∫£nh: {os.path.basename(image_path)}\")\r\n\r\ndef blur_and_resize_cover(image_path, output_path):\r\n    img = Image.open(image_path)\r\n    blurred = img.filter(ImageFilter.GaussianBlur(radius=COVER_BLUR_RADIUS))\r\n    img_w, img_h = blurred.size\r\n    ratio = min(COVER_WIDTH / img_w, COVER_HEIGHT / img_h)\r\n    new_w = int(img_w * ratio)\r\n    new_h = int(img_h * ratio)\r\n    resized = blurred.resize((new_w, new_h), Image.LANCZOS)\r\n    final_img = Image.new(\"RGB\", (COVER_WIDTH, COVER_HEIGHT), (255, 255, 255))\r\n    offset_x = (COVER_WIDTH - new_w) // 2\r\n    offset_y = (COVER_HEIGHT - new_h) // 2\r\n    final_img.paste(resized, (offset_x, offset_y))\r\n    final_img.save(output_path)\r\n    print(f\"     üé® ƒê√£ t·∫°o cover photo: {os.path.basename(output_path)}\")\r\n\r\n# --- X·ª≠ l√Ω t·ª´ng sheet ---\r\ndef process_sheet(df, file_name, sheet_name, template):\r\n    # Gi·ªØ t·ªëi ƒëa DATA_COLS_TO_KEEP c·ªôt\r\n    if len(df.columns) > DATA_COLS_TO_KEEP:\r\n        df = df.iloc[:, :DATA_COLS_TO_KEEP]\r\n\r\n    # X√≥a t·∫•t c·∫£ row tr·ªëng ho√†n to√†n (kh√¥ng c√≥ n·ªôi dung)\r\n    df = df[df.apply(lambda row: any(str(cell).strip() != '' and str(cell).strip().lower() != 'nan' for cell in row), axis=1)]\r\n    if df.empty:\r\n        print(f\"Sheet '{sheet_name}' kh√¥ng c√≥ d·ªØ li·ªáu sau khi l·ªçc.\")\r\n        return\r\n\r\n    # Th∆∞ m·ª•c output\r\n    image_output_dir = os.path.join(IMAGE_DIR, file_name, sheet_name)\r\n    os.makedirs(image_output_dir, exist_ok=True)\r\n    os.makedirs(HTML_DIR, exist_ok=True)\r\n\r\n    # --- Cover photo (trang ƒë·∫ßu ti√™n) ---\r\n    first_page_df = df.iloc[:ROWS_PER_PAGE]\r\n    temp_df = first_page_df.copy()\r\n    while len(temp_df.columns) < DATA_COLS_TO_KEEP:\r\n        temp_df[f'placeholder_{len(temp_df.columns)}'] = ''\r\n\r\n    column_widths_px = get_column_widths(temp_df)\r\n    processed_page_data = []\r\n    for r_idx, row in first_page_df.iterrows():\r\n        row_cells = []\r\n        for c_idx, cell_value in enumerate(row):\r\n            cell_value = '' if str(cell_value).strip().lower() == 'nan' else cell_value\r\n            col_width = column_widths_px[c_idx + 1]\r\n            cell_class = get_cell_class(cell_value, col_width)\r\n            row_cells.append({\"value\": cell_value, \"class\": cell_class})\r\n        while len(row_cells) < DATA_COLS_TO_KEEP:\r\n            row_cells.append({\"value\": \"\", \"class\": \"wrap-text\"})\r\n        processed_page_data.append({\"excel_row_num\": r_idx + 1, \"cells\": row_cells})\r\n    while len(processed_page_data) < ROWS_PER_PAGE:\r\n        empty_cells = [{\"value\": \"\", \"class\": \"wrap-text\"}] * DATA_COLS_TO_KEEP\r\n        processed_page_data.append({\"excel_row_num\": \" \", \"cells\": empty_cells})\r\n\r\n    render_data = {\"title\": f\"{file_name} - {sheet_name} - Cover\", \"page_data\": processed_page_data, \"column_widths\": column_widths_px}\r\n    html_path = os.path.join(HTML_DIR, f\"{file_name}_{sheet_name}_cover.html\")\r\n    with open(html_path, 'w', encoding='utf-8') as f:\r\n        f.write(template.render(render_data))\r\n\r\n    cover_image_path = os.path.join(image_output_dir, f\"coverphoto-{sheet_name}.png\")\r\n    html_to_fixed_size_image(html_path, cover_image_path)\r\n    blur_and_resize_cover(cover_image_path, cover_image_path)\r\n    os.remove(html_path)\r\n\r\n    # --- C√°c trang d·ªØ li·ªáu ---\r\n    total_rows = len(df)\r\n    num_pages = math.ceil(total_rows / ROWS_PER_PAGE)\r\n    for page_idx in range(num_pages):\r\n        start_row = page_idx * ROWS_PER_PAGE\r\n        end_row = start_row + ROWS_PER_PAGE\r\n        page_df = df.iloc[start_row:end_row]\r\n\r\n        temp_df = page_df.copy()\r\n        while len(temp_df.columns) < DATA_COLS_TO_KEEP:\r\n            temp_df[f'placeholder_{len(temp_df.columns)}'] = ''\r\n        column_widths_px = get_column_widths(temp_df)\r\n\r\n        processed_page_data = []\r\n        for r_idx, row in page_df.iterrows():\r\n            row_cells = []\r\n            for c_idx, cell_value in enumerate(row):\r\n                cell_value = '' if str(cell_value).strip().lower() == 'nan' else cell_value\r\n                col_width = column_widths_px[c_idx + 1]\r\n                cell_class = get_cell_class(cell_value, col_width)\r\n                row_cells.append({\"value\": cell_value, \"class\": cell_class})\r\n            while len(row_cells) < DATA_COLS_TO_KEEP:\r\n                row_cells.append({\"value\": \"\", \"class\": \"wrap-text\"})\r\n            processed_page_data.append({\"excel_row_num\": r_idx + 1, \"cells\": row_cells})\r\n        while len(processed_page_data) < ROWS_PER_PAGE:\r\n            empty_cells = [{\"value\": \"\", \"class\": \"wrap-text\"}] * DATA_COLS_TO_KEEP\r\n            processed_page_data.append({\"excel_row_num\": \" \", \"cells\": empty_cells})\r\n\r\n        render_data = {\"title\": f\"{file_name} - {sheet_name} - Trang {page_idx+1}\", \"page_data\": processed_page_data, \"column_widths\": column_widths_px}\r\n        html_filename = f\"{file_name}_{sheet_name}_page_{page_idx+1}.html\"\r\n        html_path = os.path.join(HTML_DIR, html_filename)\r\n        with open(html_path, 'w', encoding='utf-8') as f:\r\n            f.write(template.render(render_data))\r\n\r\n        page_image_path = os.path.join(image_output_dir, f\"{sheet_name}_page_{page_idx+1}.png\")\r\n        html_to_fixed_size_image(html_path, page_image_path)\r\n        os.remove(html_path)\r\n\r\n# --- X·ª≠ l√Ω file ---\r\ndef process_excel_file(excel_path, template):\r\n    file_name = os.path.splitext(os.path.basename(excel_path))[0]\r\n    print(f\"\\n--- X·ª≠ l√Ω file: {file_name} ---\")\r\n    try:\r\n        all_sheets = pd.read_excel(excel_path, sheet_name=None, header=None)\r\n    except Exception as e:\r\n        print(f\"L·ªói ƒë·ªçc file '{excel_path}': {e}\")\r\n        return\r\n    for sheet_name, df in all_sheets.items():\r\n        print(f\"-> X·ª≠ l√Ω sheet: {sheet_name}\")\r\n        process_sheet(df, file_name, sheet_name, template)\r\n\r\n# --- Main ---\r\ndef main():\r\n    print(\"B·∫Øt ƒë·∫ßu chuy·ªÉn ƒë·ªïi Excel sang PNG (x√≥a row tr·ªëng, b·ªè 'nan', t·∫°o cover)...\")\r\n    os.makedirs(HTML_DIR, exist_ok=True)\r\n    os.makedirs(IMAGE_DIR, exist_ok=True)\r\n\r\n    env = Environment(loader=FileSystemLoader('.'))\r\n    template = env.get_template('template.html')\r\n\r\n    excel_files = [f for f in os.listdir(EXCEL_DIR) if f.endswith(('.xlsx', '.xls'))]\r\n    if not excel_files:\r\n        print(f\"\\nC·∫¢NH B√ÅO: Kh√¥ng t√¨m th·∫•y file Excel trong '{EXCEL_DIR}'.\")\r\n        return\r\n\r\n    for filename in excel_files:\r\n        excel_path = os.path.join(EXCEL_DIR, filename)\r\n        process_excel_file(excel_path, template)\r\n\r\n    if os.path.exists(HTML_DIR):\r\n        shutil.rmtree(HTML_DIR)\r\n\r\n    print(\"\\nüéâ Ho√†n t·∫•t! Ki·ªÉm tra th∆∞ m·ª•c 'output_images'.\")\r\n\r\nif __name__ == \"__main__\":\r\n    main()\r\n","path":null,"size_bytes":8668,"size_tokens":null},"client/src/pages/admin/UserUploads.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { FileText, CheckCircle, XCircle, Clock, ExternalLink, FolderOpen, Coins } from \"lucide-react\";\nimport type { UserUpload } from \"@shared/schema\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\n\ntype UserUploadWithUser = UserUpload & { userName: string; userEmail: string };\n\ninterface Category {\n  id: string;\n  name: string;\n  logoUrl?: string;\n  order: number;\n}\n\nexport default function AdminUserUploads() {\n  const { toast } = useToast();\n  const [approveDialogOpen, setApproveDialogOpen] = useState(false);\n  const [rejectDialogOpen, setRejectDialogOpen] = useState(false);\n  const [selectedUpload, setSelectedUpload] = useState<UserUploadWithUser | null>(null);\n  const [selectedCategory, setSelectedCategory] = useState<string>(\"\");\n  const [pointsToAward, setPointsToAward] = useState<string>(\"\");\n  const [rejectReason, setRejectReason] = useState<string>(\"\");\n\n  const { data: uploads = [], isLoading } = useQuery<UserUploadWithUser[]>({\n    queryKey: [\"/api/admin/user-uploads\"],\n  });\n\n  const { data: categories = [] } = useQuery<Category[]>({\n    queryKey: [\"/api/categories\"],\n  });\n\n  const approveMutation = useMutation({\n    mutationFn: async ({ id, category, points }: { id: string; category: string; points: number }) => {\n      return apiRequest(\"PATCH\", `/api/admin/user-uploads/${id}/approve`, { category, points });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/user-uploads\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/documents\"] });\n      setApproveDialogOpen(false);\n      setSelectedUpload(null);\n      setSelectedCategory(\"\");\n      setPointsToAward(\"\");\n      toast({\n        title: \"ƒê√£ ph√™ duy·ªát\",\n        description: \"File ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát, c·ªông ƒëi·ªÉm v√† g·ª≠i th√¥ng b√°o t·ªõi user\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"L·ªói\",\n        description: error.message || \"Kh√¥ng th·ªÉ ph√™ duy·ªát file\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const rejectMutation = useMutation({\n    mutationFn: async ({ id, reason }: { id: string; reason: string }) => {\n      return apiRequest(\"PATCH\", `/api/admin/user-uploads/${id}/reject`, { reason });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/user-uploads\"] });\n      setRejectDialogOpen(false);\n      setSelectedUpload(null);\n      setRejectReason(\"\");\n      toast({\n        title: \"ƒê√£ t·ª´ ch·ªëi\",\n        description: \"File ƒë√£ b·ªã t·ª´ ch·ªëi v√† g·ª≠i th√¥ng b√°o t·ªõi user\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"L·ªói\",\n        description: error.message || \"Kh√¥ng th·ªÉ t·ª´ ch·ªëi file\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleApproveClick = (upload: UserUploadWithUser) => {\n    setSelectedUpload(upload);\n    setSelectedCategory(\"\");\n    setPointsToAward(\"\");\n    setApproveDialogOpen(true);\n  };\n\n  const handleRejectClick = (upload: UserUploadWithUser) => {\n    setSelectedUpload(upload);\n    setRejectReason(\"\");\n    setRejectDialogOpen(true);\n  };\n\n  const handleConfirmApprove = () => {\n    if (!selectedUpload) return;\n    if (!selectedCategory) {\n      toast({\n        title: \"L·ªói\",\n        description: \"Vui l√≤ng ch·ªçn danh m·ª•c cho document\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    const points = parseInt(pointsToAward) || 0;\n    approveMutation.mutate({ id: selectedUpload.id, category: selectedCategory, points });\n  };\n\n  const handleConfirmReject = () => {\n    if (!selectedUpload) return;\n    if (!rejectReason.trim()) {\n      toast({\n        title: \"L·ªói\",\n        description: \"Vui l√≤ng nh·∫≠p l√Ω do t·ª´ ch·ªëi\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    rejectMutation.mutate({ id: selectedUpload.id, reason: rejectReason.trim() });\n  };\n\n  const getStatusBadge = (status: \"pending\" | \"approved\" | \"rejected\") => {\n    switch (status) {\n      case \"pending\":\n        return (\n          <Badge variant=\"secondary\" className=\"gap-1\" data-testid={`badge-status-pending`}>\n            <Clock className=\"h-3 w-3\" />\n            Ch·ªù duy·ªát\n          </Badge>\n        );\n      case \"approved\":\n        return (\n          <Badge className=\"gap-1 bg-green-600 hover:bg-green-700\" data-testid={`badge-status-approved`}>\n            <CheckCircle className=\"h-3 w-3\" />\n            ƒê√£ duy·ªát\n          </Badge>\n        );\n      case \"rejected\":\n        return (\n          <Badge variant=\"destructive\" className=\"gap-1\" data-testid={`badge-status-rejected`}>\n            <XCircle className=\"h-3 w-3\" />\n            T·ª´ ch·ªëi\n          </Badge>\n        );\n    }\n  };\n\n  const formatFileSize = (bytes: number) => {\n    if (bytes === 0) return \"0 Bytes\";\n    const k = 1024;\n    const sizes = [\"Bytes\", \"KB\", \"MB\", \"GB\"];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + \" \" + sizes[i];\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <div className=\"text-muted-foreground\">ƒêang t·∫£i...</div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold tracking-tight\">User Uploads</h1>\n        <p className=\"text-muted-foreground\">\n          Qu·∫£n l√Ω files ƒë∆∞·ª£c upload b·ªüi users\n        </p>\n      </div>\n\n      <Alert>\n        <AlertDescription>\n          Khi ph√™ duy·ªát file, b·∫°n c·∫ßn ch·ªçn danh m·ª•c cho document. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t·∫°o document v√† trigger pipeline x·ª≠ l√Ω.\n        </AlertDescription>\n      </Alert>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Danh s√°ch User Uploads</CardTitle>\n          <CardDescription>\n            T·ªïng s·ªë: {uploads.length} files\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {uploads.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"text-no-uploads\">\n              Ch∆∞a c√≥ user upload n√†o\n            </div>\n          ) : (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>User</TableHead>\n                  <TableHead>Filename</TableHead>\n                  <TableHead>K√≠ch th∆∞·ªõc</TableHead>\n                  <TableHead>Ng√†y upload</TableHead>\n                  <TableHead>Tr·∫°ng th√°i</TableHead>\n                  <TableHead className=\"text-right\">Actions</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {uploads.map((upload) => (\n                  <TableRow key={upload.id} data-testid={`row-upload-${upload.id}`}>\n                    <TableCell>\n                      <div className=\"flex flex-col\">\n                        <span className=\"font-medium\" data-testid={`text-username-${upload.id}`}>\n                          {upload.userName || \"Unknown\"}\n                        </span>\n                        <span className=\"text-sm text-muted-foreground\" data-testid={`text-useremail-${upload.id}`}>\n                          {upload.userEmail}\n                        </span>\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"flex items-center gap-2\">\n                        <FileText className=\"h-4 w-4 text-muted-foreground\" />\n                        <div className=\"flex flex-col\">\n                          <span className=\"font-medium\" data-testid={`text-filename-${upload.id}`}>\n                            {upload.fileName}\n                          </span>\n                          {upload.filePath && (\n                            <a\n                              href={upload.filePath.replace(/^.*\\/(User-Upload|Admin-Upload)/, '/$1')}\n                              target=\"_blank\"\n                              rel=\"noopener noreferrer\"\n                              className=\"text-sm text-primary hover:underline flex items-center gap-1\"\n                              data-testid={`link-file-${upload.id}`}\n                            >\n                              Xem file <ExternalLink className=\"h-3 w-3\" />\n                            </a>\n                          )}\n                        </div>\n                      </div>\n                    </TableCell>\n                    <TableCell data-testid={`text-filesize-${upload.id}`}>\n                      {formatFileSize(upload.fileSize)}\n                    </TableCell>\n                    <TableCell data-testid={`text-uploaddate-${upload.id}`}>\n                      {upload.uploadedAt\n                        ? new Date(upload.uploadedAt).toLocaleString(\"vi-VN\")\n                        : \"-\"}\n                    </TableCell>\n                    <TableCell>{getStatusBadge(upload.approvalStatus as \"pending\" | \"approved\" | \"rejected\")}</TableCell>\n                    <TableCell className=\"text-right\">\n                      {upload.approvalStatus === \"pending\" && (\n                        <div className=\"flex justify-end gap-2\">\n                          <Button\n                            size=\"sm\"\n                            variant=\"default\"\n                            onClick={() => handleApproveClick(upload)}\n                            disabled={approveMutation.isPending || rejectMutation.isPending}\n                            data-testid={`button-approve-${upload.id}`}\n                          >\n                            <CheckCircle className=\"h-4 w-4 mr-1\" />\n                            Duy·ªát\n                          </Button>\n                          <Button\n                            size=\"sm\"\n                            variant=\"destructive\"\n                            onClick={() => handleRejectClick(upload)}\n                            disabled={approveMutation.isPending || rejectMutation.isPending}\n                            data-testid={`button-reject-${upload.id}`}\n                          >\n                            <XCircle className=\"h-4 w-4 mr-1\" />\n                            T·ª´ ch·ªëi\n                          </Button>\n                        </div>\n                      )}\n                      {upload.approvalStatus === \"approved\" && (\n                        <span className=\"text-sm text-muted-foreground\">\n                          ƒê√£ duy·ªát b·ªüi Admin\n                        </span>\n                      )}\n                      {upload.approvalStatus === \"rejected\" && (\n                        <span className=\"text-sm text-muted-foreground\">\n                          ƒê√£ t·ª´ ch·ªëi\n                        </span>\n                      )}\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={approveDialogOpen} onOpenChange={setApproveDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Ph√™ duy·ªát Upload</DialogTitle>\n            <DialogDescription>\n              Ch·ªçn danh m·ª•c cho document s·∫Ω ƒë∆∞·ª£c t·∫°o t·ª´ file n√†y.\n            </DialogDescription>\n          </DialogHeader>\n          \n          {selectedUpload && (\n            <div className=\"space-y-4 py-4\">\n              <div className=\"flex items-center gap-2 p-3 bg-muted rounded-lg\">\n                <FileText className=\"h-5 w-5 text-muted-foreground\" />\n                <div>\n                  <p className=\"font-medium\">{selectedUpload.fileName}</p>\n                  <p className=\"text-sm text-muted-foreground\">\n                    B·ªüi: {selectedUpload.userName} ({selectedUpload.userEmail})\n                  </p>\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"approve-category\">\n                  <FolderOpen className=\"w-4 h-4 inline mr-2\" />\n                  Danh m·ª•c <span className=\"text-destructive\">*</span>\n                </Label>\n                <Select\n                  value={selectedCategory}\n                  onValueChange={setSelectedCategory}\n                >\n                  <SelectTrigger id=\"approve-category\" data-testid=\"select-approve-category\">\n                    <SelectValue placeholder=\"Ch·ªçn danh m·ª•c cho document\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {categories.map((category) => (\n                      <SelectItem \n                        key={category.id} \n                        value={category.name}\n                        data-testid={`option-approve-category-${category.id}`}\n                      >\n                        {category.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"approve-points\">\n                  <Coins className=\"w-4 h-4 inline mr-2\" />\n                  S·ªë ƒëi·ªÉm th∆∞·ªüng cho user\n                </Label>\n                <Input\n                  id=\"approve-points\"\n                  type=\"number\"\n                  min=\"0\"\n                  placeholder=\"Nh·∫≠p s·ªë ƒëi·ªÉm (VD: 10)\"\n                  value={pointsToAward}\n                  onChange={(e) => setPointsToAward(e.target.value)}\n                  data-testid=\"input-approve-points\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  ƒêi·ªÉm s·∫Ω ƒë∆∞·ª£c c·ªông v√†o t√†i kho·∫£n c·ªßa user. ƒê·ªÉ tr·ªëng ho·∫∑c 0 n·∫øu kh√¥ng th∆∞·ªüng ƒëi·ªÉm.\n                </p>\n              </div>\n            </div>\n          )}\n\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setApproveDialogOpen(false)}\n              disabled={approveMutation.isPending}\n              data-testid=\"button-cancel-approve\"\n            >\n              H·ªßy\n            </Button>\n            <Button\n              onClick={handleConfirmApprove}\n              disabled={approveMutation.isPending || !selectedCategory}\n              data-testid=\"button-confirm-approve\"\n            >\n              {approveMutation.isPending ? \"ƒêang x·ª≠ l√Ω...\" : \"X√°c nh·∫≠n ph√™ duy·ªát\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={rejectDialogOpen} onOpenChange={setRejectDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>T·ª´ ch·ªëi Upload</DialogTitle>\n            <DialogDescription>\n              Vui l√≤ng nh·∫≠p l√Ω do t·ª´ ch·ªëi ƒë·ªÉ th√¥ng b√°o cho user.\n            </DialogDescription>\n          </DialogHeader>\n          \n          {selectedUpload && (\n            <div className=\"space-y-4 py-4\">\n              <div className=\"flex items-center gap-2 p-3 bg-muted rounded-lg\">\n                <FileText className=\"h-5 w-5 text-muted-foreground\" />\n                <div>\n                  <p className=\"font-medium\">{selectedUpload.fileName}</p>\n                  <p className=\"text-sm text-muted-foreground\">\n                    B·ªüi: {selectedUpload.userName} ({selectedUpload.userEmail})\n                  </p>\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"reject-reason\">\n                  L√Ω do t·ª´ ch·ªëi <span className=\"text-destructive\">*</span>\n                </Label>\n                <Textarea\n                  id=\"reject-reason\"\n                  placeholder=\"Nh·∫≠p l√Ω do t·ª´ ch·ªëi file n√†y...\"\n                  value={rejectReason}\n                  onChange={(e) => setRejectReason(e.target.value)}\n                  rows={4}\n                  data-testid=\"textarea-reject-reason\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  L√Ω do n√†y s·∫Ω ƒë∆∞·ª£c g·ª≠i th√¥ng b√°o t·ªõi user.\n                </p>\n              </div>\n            </div>\n          )}\n\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setRejectDialogOpen(false)}\n              disabled={rejectMutation.isPending}\n              data-testid=\"button-cancel-reject\"\n            >\n              H·ªßy\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={handleConfirmReject}\n              disabled={rejectMutation.isPending || !rejectReason.trim()}\n              data-testid=\"button-confirm-reject\"\n            >\n              {rejectMutation.isPending ? \"ƒêang x·ª≠ l√Ω...\" : \"X√°c nh·∫≠n t·ª´ ch·ªëi\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":17750,"size_tokens":null},"test-data/create_sample_excel.py":{"content":"#!/usr/bin/env python3\nimport pandas as pd\nimport os\n\n# Create sample data\ndata = {\n    'STT': range(1, 26),\n    'H·ªç v√† t√™n': [f'Nguy·ªÖn VƒÉn {chr(65+i)}' for i in range(25)],\n    'Tu·ªïi': [20 + (i % 30) for i in range(25)],\n    'ƒê·ªãa ch·ªâ': [f'S·ªë {i+1}, ƒê∆∞·ªùng {chr(65+i%5)}, Qu·∫≠n {(i%12)+1}, TP.HCM' for i in range(25)],\n    'ƒêi·ªán tho·∫°i': [f'09{10000000 + i*111111}' for i in range(25)],\n    'Email': [f'user{i+1}@example.com' for i in range(25)],\n    'Ch·ª©c v·ª•': ['Nh√¢n vi√™n' if i % 3 != 0 else 'Qu·∫£n l√Ω' for i in range(25)],\n    'Ph√≤ng ban': [f'Ph√≤ng {chr(65+i%5)}' for i in range(25)],\n    'M·ª©c l∆∞∆°ng': [f'{(i+10)*1000000} VNƒê' for i in range(25)],\n    'Ng√†y v√†o l√†m': [f'{(i%28)+1:02d}/0{(i%9)+1}/2023' for i in range(25)],\n}\n\n# Create DataFrame\ndf = pd.DataFrame(data)\n\n# Save to Excel\noutput_file = 'test-data/sample_data.xlsx'\nos.makedirs('test-data', exist_ok=True)\n\n# Create Excel writer with multiple sheets\nwith pd.ExcelWriter(output_file, engine='openpyxl') as writer:\n    df.to_excel(writer, sheet_name='Danh s√°ch nh√¢n vi√™n', index=False)\n    df.iloc[:10].to_excel(writer, sheet_name='Top 10', index=False)\n    df[['H·ªç v√† t√™n', 'Email', 'Ch·ª©c v·ª•']].to_excel(writer, sheet_name='Th√¥ng tin c∆° b·∫£n', index=False)\n\nprint(f\"Created sample Excel file: {output_file}\")\nprint(f\"File size: {os.path.getsize(output_file)} bytes\")\n","path":null,"size_bytes":1389,"size_tokens":null},"ADMIN_FEATURES.md":{"content":"# ‚úÖ T√≠nh nƒÉng Admin Panel - ƒê√É HO√ÄN TH√ÄNH\n\nT·∫•t c·∫£ 4 y√™u c·∫ßu c·ªßa b·∫°n **ƒë√£ ƒë∆∞·ª£c tri·ªÉn khai ƒë·∫ßy ƒë·ªß**!\n\n---\n\n## üìã Danh s√°ch t√≠nh nƒÉng c√≥ s·∫µn\n\n### ‚úÖ 1. Upload File H√†ng lo·∫°t (500MB max)\n\n**ƒê∆∞·ªùng d·∫´n:** Admin Panel ‚Üí **Upload H√†ng lo·∫°t**\n\n**T√≠nh nƒÉng:**\n- ‚úÖ Upload file PDF, Excel (.xlsx), CSV\n- ‚úÖ Gi·ªõi h·∫°n 500MB m·ªói file\n- ‚úÖ Thanh progress bar th·ªùi gian th·ª±c (XMLHttpRequest tracking)\n- ‚úÖ Hi·ªÉn th·ªã tr·∫°ng th√°i pipeline:\n  - Pending (ƒëang ch·ªù)\n  - Processing (ƒëang x·ª≠ l√Ω)\n  - Completed (ho√†n t·∫•t)\n  - Failed (th·∫•t b·∫°i)\n- ‚úÖ Xem l·ªãch s·ª≠ upload\n- ‚úÖ X√≥a file ƒë√£ upload\n- ‚úÖ Pipeline trigger placeholder (s·∫µn s√†ng t√≠ch h·ª£p)\n\n**API Backend:**\n- `POST /api/admin/uploads` - Upload file (max 500MB)\n- `GET /api/admin/uploads` - L·∫•y danh s√°ch uploads\n- `DELETE /api/admin/uploads/:id` - X√≥a upload\n\n**Database:**\n- Table: `admin_uploads`\n- Columns: id, uploadedBy, fileName, fileType, filePath, fileSize, pipelineStatus, uploadedAt\n\n---\n\n### ‚úÖ 2. Qu·∫£n l√Ω Upload t·ª´ User (Approval Workflow)\n\n**ƒê∆∞·ªùng d·∫´n:** Admin Panel ‚Üí **User Uploads**\n\n**T√≠nh nƒÉng:**\n- ‚úÖ Xem t·∫•t c·∫£ file user upload\n- ‚úÖ Hi·ªÉn th·ªã th√¥ng tin:\n  - T√™n & email ng∆∞·ªùi upload\n  - T√™n file & k√≠ch th∆∞·ªõc\n  - Ng√†y upload\n  - Tr·∫°ng th√°i (Pending/Approved/Rejected)\n- ‚úÖ N√∫t **Duy·ªát** (Approve) cho file pending\n- ‚úÖ N√∫t **T·ª´ ch·ªëi** (Reject) cho file pending\n- ‚úÖ Link xem/t·∫£i file ƒë·ªÉ review\n- ‚úÖ Khi duy·ªát ‚Üí trigger pipeline processing (placeholder)\n- ‚úÖ L·ªçc theo tr·∫°ng th√°i\n- ‚úÖ Ghi nh·∫≠n admin n√†o ƒë√£ duy·ªát\n\n**API Backend:**\n- `GET /api/admin/user-uploads` - L·∫•y t·∫•t c·∫£ user uploads (join v·ªõi users table)\n- `PATCH /api/admin/user-uploads/:id/approve` - Ph√™ duy·ªát file\n- `PATCH /api/admin/user-uploads/:id/reject` - T·ª´ ch·ªëi file\n\n**Database:**\n- Table: `user_uploads`\n- Columns: id, userId, fileName, filePath, fileSize, approvalStatus, reviewedBy, reviewedAt, uploadedAt\n\n---\n\n### ‚úÖ 3. Qu·∫£n l√Ω User (Th√†nh vi√™n)\n\n**ƒê∆∞·ªùng d·∫´n:** Admin Panel ‚Üí **Ng∆∞·ªùi d√πng**\n\n**T√≠nh nƒÉng:**\n- ‚úÖ Xem danh s√°ch t·∫•t c·∫£ users\n- ‚úÖ Hi·ªÉn th·ªã th√¥ng tin:\n  - T√™n ƒë·∫ßy ƒë·ªß\n  - Email\n  - Role (Admin/User)\n  - S·ªë l∆∞·ª£ng favorites\n  - Ng√†y tham gia\n- ‚úÖ **Thay ƒë·ªïi role** (Admin ‚Üî User)\n- ‚úÖ ƒê·∫øm s·ªë l∆∞·ª£ng th√†nh vi√™n ƒëƒÉng k√Ω\n- ‚úÖ T√¨m ki·∫øm users\n- ‚úÖ S·∫Øp x·∫øp theo t√™n/email/role\n\n**API Backend:**\n- `GET /api/admin/users` - L·∫•y t·∫•t c·∫£ users\n- `PATCH /api/admin/users/:id/role` - Thay ƒë·ªïi role\n\n**Database:**\n- Table: `users`\n- Columns: id, email, firstName, lastName, role, createdAt, updatedAt\n\n---\n\n### ‚úÖ 4. Qu·∫£n l√Ω T√†i li·ªáu (Posts/Documents)\n\n**ƒê∆∞·ªùng d·∫´n:** Admin Panel ‚Üí **T√†i li·ªáu**\n\n**T√≠nh nƒÉng:**\n- ‚úÖ Xem t·∫•t c·∫£ t√†i li·ªáu (documents)\n- ‚úÖ **Th√™m m·ªõi** t√†i li·ªáu\n- ‚úÖ **Ch·ªânh s·ª≠a** t√†i li·ªáu (ti√™u ƒë·ªÅ, m√¥ t·∫£, category, video URLs, tags)\n- ‚úÖ **X√≥a** t√†i li·ªáu\n- ‚úÖ Hi·ªÉn th·ªã:\n  - ·∫¢nh cover\n  - Ti√™u ƒë·ªÅ\n  - Category\n  - S·ªë l∆∞·ª£t xem\n  - Tags\n  - Video URLs (DRM)\n  - Ng√†y t·∫°o\n- ‚úÖ Qu·∫£n l√Ω tags cho t·ª´ng document\n- ‚úÖ Preview document\n- ‚úÖ T√¨m ki·∫øm documents\n\n**API Backend:**\n- `GET /api/admin/documents` - L·∫•y t·∫•t c·∫£ documents\n- `POST /api/documents` - T·∫°o document m·ªõi\n- `GET /api/documents/:id` - Chi ti·∫øt document\n- `PUT /api/documents/:id` - C·∫≠p nh·∫≠t document\n- `DELETE /api/documents/:id` - X√≥a document\n- `GET /api/documents/:id/tags` - L·∫•y tags c·ªßa document\n- `POST /api/documents/:id/tags` - Set tags cho document\n\n**Database:**\n- Table: `documents`\n- Columns: id, title, description, category, coverImage, videoUrl, drmLicenseUrl, viewCount, createdAt\n- Related tables: `tags`, `document_tags`\n\n---\n\n## üéØ C√°ch truy c·∫≠p Admin Panel\n\n### B∆∞·ªõc 1: ƒêƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n Admin\n\n1. M·ªü website\n2. Click n√∫t **\"ƒêƒÉng nh·∫≠p\"**\n3. ƒêƒÉng nh·∫≠p b·∫±ng Replit Auth\n\n### B∆∞·ªõc 2: Ki·ªÉm tra b·∫°n c√≥ quy·ªÅn Admin\n\nCh·∫°y l·ªánh n√†y ƒë·ªÉ b·ªï nhi·ªám admin:\n```bash\nnpx tsx server/scripts/make-admin.ts <email-c·ªßa-b·∫°n>\n```\n\nHo·∫∑c xem danh s√°ch admin hi·ªán c√≥:\n```bash\nnpx tsx server/scripts/list-admins.ts\n```\n\n### B∆∞·ªõc 3: Truy c·∫≠p Admin Panel\n\nSau khi ƒëƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n admin, b·∫°n s·∫Ω th·∫•y menu b√™n tr√°i:\n\n```\n‚îå‚îÄ Admin Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ                           ‚îÇ\n‚îÇ  üìä Dashboard             ‚îÇ\n‚îÇ  üìÑ T√†i li·ªáu              ‚îÇ  ‚Üê Qu·∫£n l√Ω posts (th√™m/s·ª≠a/x√≥a)\n‚îÇ  üè∑Ô∏è  Tags                  ‚îÇ\n‚îÇ  üì§ Upload H√†ng lo·∫°t      ‚îÇ  ‚Üê Upload bulk files (500MB)\n‚îÇ  ‚úÖ User Uploads          ‚îÇ  ‚Üê Duy·ªát user uploads\n‚îÇ  üë• Ng∆∞·ªùi d√πng            ‚îÇ  ‚Üê Qu·∫£n l√Ω users\n‚îÇ                           ‚îÇ\n‚îÇ  üè† V·ªÅ trang ch·ªß          ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n---\n\n## üìä Dashboard (Trang t·ªïng quan)\n\n**ƒê∆∞·ªùng d·∫´n:** Admin Panel ‚Üí **Dashboard**\n\n**Hi·ªÉn th·ªã:**\n- üìÑ T·ªïng s·ªë t√†i li·ªáu\n- üë• T·ªïng s·ªë users\n- ‚ù§Ô∏è  T·ªïng l∆∞·ª£t favorite\n- üëÅÔ∏è  T·ªïng l∆∞·ª£t xem\n- üìã Danh s√°ch users m·ªõi nh·∫•t\n- üìÑ Danh s√°ch documents m·ªõi nh·∫•t\n\n---\n\n## üîí B·∫£o m·∫≠t\n\n- ‚úÖ T·∫•t c·∫£ routes `/api/admin/*` y√™u c·∫ßu role=\"admin\"\n- ‚úÖ Middleware `isAdmin` ki·ªÉm tra quy·ªÅn\n- ‚úÖ Frontend AdminRoute component b·∫£o v·ªá pages\n- ‚úÖ Session-based authentication\n- ‚úÖ CSRF protection\n\n---\n\n## üì± Giao di·ªán\n\n- ‚úÖ Responsive design (mobile/tablet/desktop)\n- ‚úÖ Dark/Light mode support\n- ‚úÖ Vietnamese labels\n- ‚úÖ Toast notifications\n- ‚úÖ Loading states\n- ‚úÖ Empty states\n- ‚úÖ Error handling\n- ‚úÖ Confirmation dialogs\n- ‚úÖ Progress indicators\n\n---\n\n## üöÄ T·∫•t c·∫£ t√≠nh nƒÉng ƒë√£ s·∫µn s√†ng!\n\nB·∫°n ch·ªâ c·∫ßn:\n1. ƒêƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n admin\n2. Refresh browser (Ctrl+F5 ho·∫∑c Cmd+Shift+R)\n3. Xem menu b√™n tr√°i Admin Panel\n\n**N·∫øu ch∆∞a th·∫•y Admin Panel:**\n- Ki·ªÉm tra email ƒë√£ ƒë∆∞·ª£c b·ªï nhi·ªám admin ch∆∞a:\n  ```bash\n  npx tsx server/scripts/list-admins.ts\n  ```\n- N·∫øu ch∆∞a, b·ªï nhi·ªám admin:\n  ```bash\n  npx tsx server/scripts/make-admin.ts <email>\n  ```\n- Logout v√† login l·∫°i\n","path":null,"size_bytes":6305,"size_tokens":null},"client/src/components/UploadDialog.tsx":{"content":"import { useState, useRef } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Upload, File, CheckCircle2, XCircle, AlertCircle, FileText, FileSpreadsheet, Clock, Check, X } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { UserUpload } from \"@shared/schema\";\n\nexport function UploadDialog() {\n  const [isOpen, setIsOpen] = useState(false);\n  const [uploadProgress, setUploadProgress] = useState(0);\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const { toast } = useToast();\n\n  const { data: uploads = [], isLoading } = useQuery<UserUpload[]>({\n    queryKey: [\"/api/user-uploads\"],\n    enabled: isOpen,\n  });\n\n  const uploadMutation = useMutation({\n    mutationFn: async (file: File) => {\n      const formData = new FormData();\n      formData.append(\"file\", file);\n\n      setUploadProgress(10);\n\n      const response = await fetch(\"/api/user-uploads\", {\n        method: \"POST\",\n        body: formData,\n        credentials: \"include\",\n      });\n\n      setUploadProgress(80);\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({ message: \"Upload failed\" }));\n        throw new Error(errorData.message || \"Upload failed\");\n      }\n\n      setUploadProgress(100);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/user-uploads\"] });\n      toast({\n        title: \"T·∫£i l√™n th√†nh c√¥ng\",\n        description: \"Vui l√≤ng ƒë·ª£i x√©t duy·ªát trong v√≤ng 24h. B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o khi file ƒë∆∞·ª£c duy·ªát ho·∫∑c t·ª´ ch·ªëi.\",\n      });\n      setUploadProgress(0);\n      setSelectedFile(null);\n      if (fileInputRef.current) {\n        fileInputRef.current.value = \"\";\n      }\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"L·ªói\",\n        description: error.message || \"Kh√¥ng th·ªÉ t·∫£i l√™n t·ªáp. Vui l√≤ng th·ª≠ l·∫°i.\",\n        variant: \"destructive\",\n      });\n      setUploadProgress(0);\n    },\n  });\n\n\n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (!file) return;\n\n    const allowedTypes = [\n      \"application/pdf\",\n      \"text/csv\",\n      \"application/vnd.ms-excel\",\n      \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n    ];\n\n    if (!allowedTypes.includes(file.type)) {\n      toast({\n        title: \"L·ªói\",\n        description: \"Ch·ªâ ch·∫•p nh·∫≠n t·ªáp PDF, CSV, ho·∫∑c Excel.\",\n        variant: \"destructive\",\n      });\n      if (fileInputRef.current) {\n        fileInputRef.current.value = \"\";\n      }\n      return;\n    }\n\n    if (file.size > 10 * 1024 * 1024) {\n      toast({\n        title: \"L·ªói\",\n        description: \"K√≠ch th∆∞·ªõc t·ªáp kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 10MB.\",\n        variant: \"destructive\",\n      });\n      if (fileInputRef.current) {\n        fileInputRef.current.value = \"\";\n      }\n      return;\n    }\n\n    setSelectedFile(file);\n  };\n\n  const handleConfirmUpload = () => {\n    if (!selectedFile) return;\n    uploadMutation.mutate(selectedFile);\n  };\n\n  const handleCancelSelection = () => {\n    setSelectedFile(null);\n    if (fileInputRef.current) {\n      fileInputRef.current.value = \"\";\n    }\n  };\n\n  const formatFileSize = (bytes: number) => {\n    if (bytes < 1024) return `${bytes} B`;\n    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;\n    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;\n  };\n\n  const FileIcon = ({ fileType }: { fileType: string }) => {\n    if (fileType.includes(\"pdf\")) {\n      return <FileText className=\"w-8 h-8 text-primary\" />;\n    }\n    if (fileType.includes(\"csv\") || fileType.includes(\"excel\") || fileType.includes(\"spreadsheet\")) {\n      return <FileSpreadsheet className=\"w-8 h-8 text-primary\" />;\n    }\n    return <File className=\"w-8 h-8 text-primary\" />;\n  };\n\n  const StatusBadge = ({ status }: { status: string }) => {\n    switch (status) {\n      case \"approved\":\n        return (\n          <Badge variant=\"default\" className=\"bg-green-500 hover:bg-green-600 text-white text-xs\" data-testid=\"badge-approved\">\n            <Check className=\"w-3 h-3 mr-1\" />\n            ƒê√£ duy·ªát\n          </Badge>\n        );\n      case \"rejected\":\n        return (\n          <Badge variant=\"destructive\" className=\"text-xs\" data-testid=\"badge-rejected\">\n            <X className=\"w-3 h-3 mr-1\" />\n            T·ª´ ch·ªëi\n          </Badge>\n        );\n      default:\n        return (\n          <Badge variant=\"secondary\" className=\"text-xs\" data-testid=\"badge-pending\">\n            <Clock className=\"w-3 h-3 mr-1\" />\n            ƒêang x·ª≠ l√Ω\n          </Badge>\n        );\n    }\n  };\n\n  const canUploadMore = uploads.length < 10;\n\n  return (\n    <Dialog open={isOpen} onOpenChange={setIsOpen}>\n      <DialogTrigger asChild>\n        <Button variant=\"outline\" data-testid=\"button-upload-open\">\n          <Upload className=\"w-4 h-4 mr-2\" />\n          T·∫£i l√™n\n        </Button>\n      </DialogTrigger>\n      <DialogContent className=\"sm:max-w-md\" data-testid=\"dialog-upload\">\n        <DialogHeader>\n          <DialogTitle>T·ªáp c·ªßa t√¥i</DialogTitle>\n          <DialogDescription>\n            B·∫°n c√≥ th·ªÉ t·∫£i l√™n t·ªëi ƒëa 10 t·ªáp (PDF, CSV, ho·∫∑c Excel, t·ªëi ƒëa 10MB m·ªói t·ªáp)\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-4\">\n          {/* File input (hidden) */}\n          <input\n            ref={fileInputRef}\n            type=\"file\"\n            accept=\".pdf,.csv,.xlsx,.xls\"\n            onChange={handleFileSelect}\n            className=\"hidden\"\n            data-testid=\"input-file\"\n            disabled={!canUploadMore || uploadMutation.isPending || selectedFile !== null}\n          />\n\n          {/* Selected file preview */}\n          {selectedFile && !uploadMutation.isPending && (\n            <div className=\"space-y-3\">\n              <Alert data-testid=\"alert-file-selected\">\n                <File className=\"h-4 w-4\" />\n                <AlertDescription>\n                  <div className=\"space-y-2\">\n                    <div>\n                      <p className=\"font-medium\">{selectedFile.name}</p>\n                      <p className=\"text-xs text-muted-foreground\">\n                        {formatFileSize(selectedFile.size)}\n                      </p>\n                    </div>\n                    <p className=\"text-xs\">\n                      T·ªáp s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω t·ª± ƒë·ªông b·∫±ng AI ƒë·ªÉ t·∫°o ti√™u ƒë·ªÅ, m√¥ t·∫£ v√† ph√¢n lo·∫°i.\n                    </p>\n                  </div>\n                </AlertDescription>\n              </Alert>\n              <div className=\"flex gap-2\">\n                <Button\n                  onClick={handleConfirmUpload}\n                  className=\"flex-1\"\n                  data-testid=\"button-upload-confirm\"\n                >\n                  <Upload className=\"w-4 h-4 mr-2\" />\n                  ƒêƒÉng l√™n\n                </Button>\n                <Button\n                  onClick={handleCancelSelection}\n                  variant=\"outline\"\n                  className=\"flex-1\"\n                  data-testid=\"button-upload-cancel\"\n                >\n                  <XCircle className=\"w-4 h-4 mr-2\" />\n                  H·ªßy\n                </Button>\n              </div>\n            </div>\n          )}\n\n          {/* Upload button (only show when no file selected) */}\n          {!selectedFile && !uploadMutation.isPending && (\n            <Button\n              onClick={() => fileInputRef.current?.click()}\n              disabled={!canUploadMore}\n              className=\"w-full\"\n              data-testid=\"button-upload-select\"\n            >\n              <Upload className=\"w-4 h-4 mr-2\" />\n              Ch·ªçn t·ªáp\n            </Button>\n          )}\n\n          {/* Upload progress */}\n          {uploadMutation.isPending && (\n            <div className=\"space-y-2\" data-testid=\"progress-upload\">\n              <Progress value={uploadProgress} />\n              <p className=\"text-sm text-muted-foreground text-center\">\n                {uploadProgress}%\n              </p>\n            </div>\n          )}\n\n          {/* Limit info */}\n          {!canUploadMore && (\n            <Alert data-testid=\"alert-limit-reached\">\n              <AlertCircle className=\"h-4 w-4\" />\n              <AlertDescription>\n                ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 10 t·ªáp. Vui l√≤ng li√™n h·ªá admin ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£.\n              </AlertDescription>\n            </Alert>\n          )}\n\n          {/* File list */}\n          <div className=\"space-y-2\">\n            <h4 className=\"text-sm font-medium\">T·ªáp ƒë√£ t·∫£i l√™n ({uploads.length}/10)</h4>\n            {isLoading ? (\n              <div className=\"space-y-2\">\n                {[1, 2].map((i) => (\n                  <div key={i} className=\"h-16 bg-muted animate-pulse rounded-md\" />\n                ))}\n              </div>\n            ) : uploads.length === 0 ? (\n              <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"text-no-files\">\n                <File className=\"w-12 h-12 mx-auto mb-2 opacity-50\" />\n                <p className=\"text-sm\">Ch∆∞a c√≥ t·ªáp n√†o</p>\n              </div>\n            ) : (\n              <div className=\"space-y-2\">\n                {uploads.map((upload) => (\n                  <div\n                    key={upload.id}\n                    className=\"flex items-center gap-3 p-3 border rounded-md\"\n                    data-testid={`file-item-${upload.id}`}\n                  >\n                    <FileIcon fileType={upload.fileType} />\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"text-sm font-medium truncate\" data-testid={`text-filename-${upload.id}`}>\n                        {upload.fileName}\n                      </p>\n                      <p className=\"text-xs text-muted-foreground\">\n                        {formatFileSize(upload.fileSize)}\n                      </p>\n                    </div>\n                    <StatusBadge status={upload.approvalStatus} />\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":10710,"size_tokens":null},"ADMIN_SETUP.md":{"content":"# üîê H∆∞·ªõng d·∫´n B·ªï nhi·ªám Admin\n\nQuick reference ƒë·ªÉ b·ªï nhi·ªám admin cho DRM Video Document Library Platform.\n\n## ‚ö° Quick Start\n\n### B∆∞·ªõc 1: User ƒëƒÉng nh·∫≠p v√†o website\nUser ph·∫£i ƒëƒÉng nh·∫≠p √≠t nh·∫•t 1 l·∫ßn ƒë·ªÉ t√†i kho·∫£n ƒë∆∞·ª£c t·∫°o trong database.\n\n### B∆∞·ªõc 2: Ch·∫°y l·ªánh b·ªï nhi·ªám admin\n\n```bash\nnpx tsx server/scripts/make-admin.ts <email-c·ªßa-user>\n```\n\n**V√≠ d·ª•:**\n```bash\nnpx tsx server/scripts/make-admin.ts admin@example.com\n```\n\n### B∆∞·ªõc 3: X√°c nh·∫≠n\nUser logout v√† login l·∫°i ƒë·ªÉ th·∫•y Admin Panel.\n\n---\n\n## üìã C√°c l·ªánh th∆∞·ªùng d√πng\n\n### 1. B·ªï nhi·ªám Admin\n```bash\nnpx tsx server/scripts/make-admin.ts <email>\n```\n\n### 2. Xem danh s√°ch Admin\n```bash\nnpx tsx server/scripts/list-admins.ts\n```\n\n---\n\n## ‚úÖ K·∫øt qu·∫£ mong ƒë·ª£i\n\n### Th√†nh c√¥ng:\n```\nüîç ƒêang t√¨m user v·ªõi email: admin@example.com...\n‚öôÔ∏è  ƒêang c·∫≠p nh·∫≠t role...\n\n‚úÖ B·ªï nhi·ªám admin th√†nh c√¥ng!\n   Email: admin@example.com\n   T√™n: Nguy·ªÖn VƒÉn A\n   Role: admin\n   ID: 47369284\n\nüéâ User n√†y gi·ªù ƒë√£ c√≥ quy·ªÅn admin!\n```\n\n### User ch∆∞a t·ªìn t·∫°i:\n```\n‚ùå Kh√¥ng t√¨m th·∫•y user v·ªõi email: admin@example.com\n\nüí° L∆∞u √Ω: User ph·∫£i ƒëƒÉng nh·∫≠p √≠t nh·∫•t 1 l·∫ßn tr∆∞·ªõc khi b·ªï nhi·ªám admin\n```\n\n### User ƒë√£ l√† admin:\n```\n‚úÖ User admin@example.com ƒë√£ l√† admin r·ªìi!\n   T√™n: Nguy·ªÖn VƒÉn A\n   ID: 47369284\n```\n\n---\n\n## üéØ Quy·ªÅn c·ªßa Admin\n\nSau khi ƒë∆∞·ª£c b·ªï nhi·ªám, admin c√≥ th·ªÉ:\n- ‚úÖ Truy c·∫≠p Admin Panel (menu b√™n tr√°i)\n- ‚úÖ Qu·∫£n l√Ω t√†i li·ªáu (th√™m/s·ª≠a/x√≥a)\n- ‚úÖ Qu·∫£n l√Ω tags\n- ‚úÖ Upload file h√†ng lo·∫°t (max 500MB)\n- ‚úÖ Ph√™ duy·ªát user uploads\n- ‚úÖ Qu·∫£n l√Ω users\n\n---\n\n## üìö Chi ti·∫øt ƒë·∫ßy ƒë·ªß\n\nXem file `server/scripts/README.md` ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt v√† troubleshooting.\n","path":null,"size_bytes":1832,"size_tokens":null},"ADMIN_CHECKLIST.md":{"content":"# ‚úÖ Admin Panel Checklist - Ki·ªÉm tra nhanh\n\n## üéØ M·ª•c ti√™u: X√°c nh·∫≠n 4 t√≠nh nƒÉng admin\n\n### ‚òëÔ∏è Y√™u c·∫ßu 1: Upload File H√†ng lo·∫°t (500MB)\n\n**V·ªã tr√≠:** Admin Panel ‚Üí **Upload H√†ng lo·∫°t**\n\n- [ ] Th·∫•y trang \"Bulk Upload\"\n- [ ] C√≥ n√∫t ch·ªçn file (PDF/Excel/CSV)\n- [ ] Gi·ªõi h·∫°n 500MB ƒë∆∞·ª£c hi·ªÉn th·ªã\n- [ ] C√≥ thanh progress bar\n- [ ] Hi·ªÉn th·ªã b·∫£ng l·ªãch s·ª≠ upload\n- [ ] C√≥ tr·∫°ng th√°i pipeline (Pending/Processing/Completed/Failed)\n- [ ] C√≥ n√∫t x√≥a file\n\n**Test:**\n1. Click \"Ch·ªçn file\"\n2. Ch·ªçn file PDF/CSV/Excel nh·ªè (< 10MB)\n3. Click \"Upload\"\n4. Xem thanh progress bar ch·∫°y 0% ‚Üí 100%\n5. File xu·∫•t hi·ªán trong b·∫£ng d∆∞·ªõi\n\n---\n\n### ‚òëÔ∏è Y√™u c·∫ßu 2: Qu·∫£n l√Ω User Uploads (Approval)\n\n**V·ªã tr√≠:** Admin Panel ‚Üí **User Uploads**\n\n- [ ] Th·∫•y trang \"User Uploads\"\n- [ ] Hi·ªÉn th·ªã danh s√°ch file user ƒë√£ upload\n- [ ] Th·∫•y th√¥ng tin: t√™n user, email, filename, size, ng√†y upload\n- [ ] Th·∫•y tr·∫°ng th√°i: Pending/Approved/Rejected\n- [ ] File pending c√≥ n√∫t \"Duy·ªát\" v√† \"T·ª´ ch·ªëi\"\n- [ ] C√≥ link xem file (icon external link)\n\n**Test:**\n1. Xem danh s√°ch user uploads\n2. T√¨m file c√≥ status \"Pending\"\n3. Click n√∫t \"Duy·ªát\" ho·∫∑c \"T·ª´ ch·ªëi\"\n4. Th·∫•y toast notification\n5. Status c·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c\n\n---\n\n### ‚òëÔ∏è Y√™u c·∫ßu 3: Qu·∫£n l√Ω User (Th√†nh vi√™n)\n\n**V·ªã tr√≠:** Admin Panel ‚Üí **Ng∆∞·ªùi d√πng**\n\n- [ ] Th·∫•y trang \"Users\"\n- [ ] Hi·ªÉn th·ªã t·ªïng s·ªë th√†nh vi√™n\n- [ ] B·∫£ng user v·ªõi: t√™n, email, role, favorites, ng√†y tham gia\n- [ ] C√≥ dropdown thay ƒë·ªïi role (Admin/User)\n- [ ] T√¨m ki·∫øm user\n\n**Test:**\n1. Xem s·ªë l∆∞·ª£ng users\n2. T√¨m 1 user c√≥ role \"user\"\n3. Thay ƒë·ªïi role th√†nh \"admin\"\n4. Th·∫•y toast \"C·∫≠p nh·∫≠t th√†nh c√¥ng\"\n5. Role c·∫≠p nh·∫≠t ngay\n\n---\n\n### ‚òëÔ∏è Y√™u c·∫ßu 4: Qu·∫£n l√Ω T√†i li·ªáu (Edit/Delete Posts)\n\n**V·ªã tr√≠:** Admin Panel ‚Üí **T√†i li·ªáu**\n\n- [ ] Th·∫•y trang \"Documents\"\n- [ ] B·∫£ng t√†i li·ªáu v·ªõi: cover, title, category, views, tags\n- [ ] N√∫t \"Th√™m t√†i li·ªáu\"\n- [ ] Icon Edit (b√∫t ch√¨) m·ªói t√†i li·ªáu\n- [ ] Icon Delete (th√πng r√°c) m·ªói t√†i li·ªáu\n- [ ] T√¨m ki·∫øm/filter t√†i li·ªáu\n\n**Test:**\n1. Click icon Edit (pencil) b·∫•t k·ª≥ document\n2. Th·∫•y form ch·ªânh s·ª≠a v·ªõi t·∫•t c·∫£ fields\n3. Thay ƒë·ªïi title\n4. Click \"C·∫≠p nh·∫≠t\"\n5. Th·∫•y toast \"C·∫≠p nh·∫≠t th√†nh c√¥ng\"\n6. Title ƒë√£ thay ƒë·ªïi\n\n**Test Delete:**\n1. Click icon Delete (trash)\n2. Th·∫•y dialog x√°c nh·∫≠n\n3. Click \"X√≥a\"\n4. Document bi·∫øn m·∫•t kh·ªèi list\n\n---\n\n## üöÄ H∆∞·ªõng d·∫´n nhanh\n\n### N·∫øu KH√îNG th·∫•y Admin Panel:\n\n1. **Ki·ªÉm tra b·∫°n ƒë√£ login ch∆∞a:**\n   - Xem g√≥c ph·∫£i tr√™n c√≥ t√™n user kh√¥ng\n   - N·∫øu ch∆∞a ‚Üí Click \"ƒêƒÉng nh·∫≠p\"\n\n2. **Ki·ªÉm tra t√†i kho·∫£n c√≥ quy·ªÅn admin ch∆∞a:**\n   ```bash\n   npx tsx server/scripts/list-admins.ts\n   ```\n\n3. **N·∫øu ch∆∞a l√† admin, b·ªï nhi·ªám:**\n   ```bash\n   npx tsx server/scripts/make-admin.ts <email-c·ªßa-b·∫°n>\n   ```\n\n4. **Logout v√† login l·∫°i:**\n   - Click avatar ‚Üí Logout\n   - Login l·∫°i\n   - Refresh browser (Ctrl+F5)\n\n### N·∫øu ƒê√É th·∫•y nh∆∞ng thi·∫øu menu items:\n\n1. **Hard refresh browser:**\n   - Windows/Linux: `Ctrl + Shift + R` ho·∫∑c `Ctrl + F5`\n   - Mac: `Cmd + Shift + R`\n\n2. **Clear cache v√† refresh:**\n   - Chrome: F12 ‚Üí Network tab ‚Üí Check \"Disable cache\"\n   - Firefox: F12 ‚Üí Network tab ‚Üí Check \"Disable cache\"\n\n3. **Th·ª≠ truy c·∫≠p tr·ª±c ti·∫øp:**\n   - http://localhost:5000/admin/bulk-upload\n   - http://localhost:5000/admin/user-uploads\n   - http://localhost:5000/admin/users\n   - http://localhost:5000/admin/documents\n\n---\n\n## üìã Menu Admin Panel (ƒë·∫ßy ƒë·ªß)\n\nSau khi login v·ªõi t√†i kho·∫£n admin, b·∫°n ph·∫£i th·∫•y:\n\n```\nAdmin Panel\n‚îú‚îÄ üìä Dashboard\n‚îú‚îÄ üìÑ T√†i li·ªáu          ‚Üê Y√äU C·∫¶U 4: Edit/Delete posts\n‚îú‚îÄ üè∑Ô∏è  Tags\n‚îú‚îÄ üì§ Upload H√†ng lo·∫°t  ‚Üê Y√äU C·∫¶U 1: Bulk upload 500MB\n‚îú‚îÄ ‚úÖ User Uploads      ‚Üê Y√äU C·∫¶U 2: Approve user uploads\n‚îî‚îÄ üë• Ng∆∞·ªùi d√πng        ‚Üê Y√äU C·∫¶U 3: User management\n```\n\n---\n\n## ‚úÖ T·∫•t c·∫£ t√≠nh nƒÉng ƒê√É C√ì\n\nN·∫øu b·∫°n ƒë√£ l√†m theo c√°c b∆∞·ªõc tr√™n m√† v·∫´n kh√¥ng th·∫•y, vui l√≤ng:\n\n1. **Ch·ª•p m√†n h√¨nh** menu b√™n tr√°i Admin Panel\n2. **Check console log** (F12 ‚Üí Console tab)\n3. **Ki·ªÉm tra email admin:**\n   ```bash\n   npx tsx server/scripts/list-admins.ts\n   ```\n\nServer ƒëang ch·∫°y t·ªët, t·∫•t c·∫£ API endpoints ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng!\n","path":null,"size_bytes":4492,"size_tokens":null},"server/scripts/README.md":{"content":"# Admin Management Scripts\n\nC√°c script qu·∫£n l√Ω admin cho DRM Video Document Library Platform.\n\n## üìã Danh s√°ch Scripts\n\n### 1. B·ªï nhi·ªám Admin (make-admin.ts)\nG√°n role admin cho user th√¥ng qua email.\n\n### 2. Li·ªát k√™ Admin (list-admins.ts)\nXem danh s√°ch t·∫•t c·∫£ admin trong h·ªá th·ªëng.\n\n---\n\n## üöÄ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng\n\n### B·ªï nhi·ªám Admin qua Email\n\n**L∆∞u √Ω quan tr·ªçng:** User ph·∫£i ƒëƒÉng nh·∫≠p √≠t nh·∫•t 1 l·∫ßn tr∆∞·ªõc khi c√≥ th·ªÉ ƒë∆∞·ª£c b·ªï nhi·ªám admin.\n\n**C√°ch 1: S·ª≠ d·ª•ng npx tsx (Khuy·∫øn ngh·ªã)**\n```bash\nnpx tsx server/scripts/make-admin.ts <email>\n```\n\n**V√≠ d·ª•:**\n```bash\nnpx tsx server/scripts/make-admin.ts admin@example.com\n```\n\n**K·∫øt qu·∫£ th√†nh c√¥ng:**\n```\nüîç ƒêang t√¨m user v·ªõi email: admin@example.com...\n‚öôÔ∏è  ƒêang c·∫≠p nh·∫≠t role...\n\n‚úÖ B·ªï nhi·ªám admin th√†nh c√¥ng!\n   Email: admin@example.com\n   T√™n: Nguy·ªÖn VƒÉn A\n   Role: admin\n   ID: 123e4567-e89b-12d3-a456-426614174000\n\nüéâ User n√†y gi·ªù ƒë√£ c√≥ quy·ªÅn admin!\n```\n\n**N·∫øu user ch∆∞a t·ªìn t·∫°i:**\n```\n‚ùå Kh√¥ng t√¨m th·∫•y user v·ªõi email: unknown@example.com\n\nüí° L∆∞u √Ω: User ph·∫£i ƒëƒÉng nh·∫≠p √≠t nh·∫•t 1 l·∫ßn tr∆∞·ªõc khi b·ªï nhi·ªám admin\n```\n\n**N·∫øu ƒë√£ l√† admin:**\n```\n‚úÖ User admin@example.com ƒë√£ l√† admin r·ªìi!\n   T√™n: Nguy·ªÖn VƒÉn A\n   ID: 123e4567-e89b-12d3-a456-426614174000\n```\n\n---\n\n### Li·ªát k√™ t·∫•t c·∫£ Admin\n\n**L·ªánh:**\n```bash\nnpx tsx server/scripts/list-admins.ts\n```\n\n**K·∫øt qu·∫£:**\n```\nüîç ƒêang t√¨m t·∫•t c·∫£ admin...\n\n‚úÖ T√¨m th·∫•y 2 admin:\n\n1. Nguy·ªÖn VƒÉn A\n   üìß Email: admin1@example.com\n   üÜî ID: 123e4567-e89b-12d3-a456-426614174000\n   üìÖ T·∫°o l√∫c: 27/10/2025, 11:30:00\n\n2. Tr·∫ßn Th·ªã B\n   üìß Email: admin2@example.com\n   üÜî ID: 987f6543-c21b-45d6-b789-987654321000\n   üìÖ T·∫°o l√∫c: 28/10/2025, 09:15:00\n```\n\n---\n\n## üìù Quy tr√¨nh b·ªï nhi·ªám Admin l·∫ßn ƒë·∫ßu\n\n1. **User ƒëƒÉng nh·∫≠p v√†o h·ªá th·ªëng** (qua Replit Auth)\n   - Truy c·∫≠p website\n   - Click \"ƒêƒÉng nh·∫≠p\"\n   - ƒêƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n Replit\n\n2. **Ki·ªÉm tra email c·ªßa user**\n   - User c√≥ th·ªÉ xem email trong profile\n\n3. **Ch·∫°y script b·ªï nhi·ªám admin**\n   ```bash\n   npx tsx server/scripts/make-admin.ts <email-c·ªßa-user>\n   ```\n\n4. **X√°c nh·∫≠n**\n   - User logout v√† login l·∫°i\n   - User gi·ªù c√≥ quy·ªÅn truy c·∫≠p Admin Panel\n   - Admin Panel xu·∫•t hi·ªán trong menu\n\n---\n\n## üîß Troubleshooting\n\n### L·ªói: \"Cannot find module\"\n**Nguy√™n nh√¢n:** Dependencies ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t\n\n**Gi·∫£i ph√°p:**\n```bash\nnpm install\n```\n\n### L·ªói: \"Database connection failed\"\n**Nguy√™n nh√¢n:** Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c database\n\n**Gi·∫£i ph√°p:**\n- Ki·ªÉm tra bi·∫øn m√¥i tr∆∞·ªùng DATABASE_URL\n- ƒê·∫£m b·∫£o database ƒëang ch·∫°y\n\n### L·ªói: \"User must login first\"\n**Nguy√™n nh√¢n:** User ch∆∞a t·ª´ng ƒëƒÉng nh·∫≠p v√†o h·ªá th·ªëng\n\n**Gi·∫£i ph√°p:**\n1. M·ªü website trong tr√¨nh duy·ªát\n2. ƒêƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n Replit c·ªßa user\n3. Sau ƒë√≥ ch·∫°y l·∫°i script\n\n---\n\n## üí° Tips\n\n- **B·ªï nhi·ªám nhi·ªÅu admin:** Ch·∫°y script nhi·ªÅu l·∫ßn v·ªõi email kh√°c nhau\n- **Ki·ªÉm tra danh s√°ch:** D√πng `list-admins.ts` ƒë·ªÉ xem t·∫•t c·∫£ admin\n- **An to√†n:** Script kh√¥ng th·ªÉ x√≥a admin, ch·ªâ th√™m m·ªõi\n\n---\n\n## üîê B·∫£o m·∫≠t\n\n- Ch·ªâ ng∆∞·ªùi c√≥ quy·ªÅn truy c·∫≠p terminal/database m·ªõi ch·∫°y ƒë∆∞·ª£c script\n- Script kh√¥ng c√≥ API endpoint, kh√¥ng th·ªÉ g·ªçi t·ª´ web\n- M·ªçi thay ƒë·ªïi ƒë∆∞·ª£c log ra console\n","path":null,"size_bytes":3490,"size_tokens":null},"server/mongo-storage.ts":{"content":"import { randomUUID } from \"crypto\";\nimport {\n  User,\n  DocumentModel,\n  Favorite,\n  Tag,\n  DocumentTag,\n  UserUpload,\n  AdminUpload,\n  Category,\n  ChatConversation,\n  ChatMessage,\n  Notification,\n  NotificationRead,\n} from \"./models\";\nimport type { IStorage } from \"./storage\";\nimport type {\n  User as UserType,\n  UpsertUser,\n  Document as DocumentType,\n  InsertDocument,\n  DocumentWithFavorite,\n  Favorite as FavoriteType,\n  InsertFavorite,\n  Tag as TagType,\n  InsertTag,\n  UserUpload as UserUploadType,\n  InsertUserUpload,\n  AdminUpload as AdminUploadType,\n  InsertAdminUpload,\n} from \"@shared/schema\";\n\n// Helper to convert undefined to null for Drizzle compatibility\nfunction toNull<T>(value: T | undefined): T | null {\n  return value === undefined ? null : value;\n}\n\n// Helper to serialize imageUrls array to JSON string for schema compatibility\nfunction serializeImageUrls(imageUrls: any[] | undefined | null): string | null {\n  if (!imageUrls || imageUrls.length === 0) return null;\n  return JSON.stringify(imageUrls);\n}\n\n// Helper to deserialize imageUrls from JSON string or array for MongoDB storage\nfunction deserializeImageUrls(imageUrls: any): any[] {\n  if (!imageUrls) return [];\n  if (Array.isArray(imageUrls)) return imageUrls;\n  try {\n    const parsed = JSON.parse(imageUrls);\n    return Array.isArray(parsed) ? parsed : [];\n  } catch {\n    return [];\n  }\n}\n\n// Helper to create a base document object with all standard fields\nfunction mapDocumentToBase(doc: any): DocumentType {\n  return {\n    id: doc._id,\n    postId: doc.postId || '',\n    title: doc.title,\n    description: doc.description,\n    category: doc.category,\n    subcategory: doc.subcategory || null,\n    pageCount: doc.pageCount,\n    pointsCost: doc.pointsCost || doc.pageCount || 0,\n    coverImageUrl: doc.coverImageUrl,\n    imageUrls: serializeImageUrls(doc.imageUrls),\n    viewCount: doc.viewCount,\n    favoriteCount: doc.favoriteCount || 0,\n    originalFileName: doc.originalFileName || null,\n    parentPostId: doc.parentPostId || null,\n    postIndex: doc.postIndex || null,\n    totalParts: doc.totalParts || null,\n    createdAt: toNull(doc.createdAt),\n    updatedAt: toNull(doc.updatedAt),\n  };\n}\n\n// Helper to create a document with favorite status\nfunction mapDocumentWithFavorite(doc: any, isFavorited: boolean): DocumentWithFavorite {\n  return {\n    ...mapDocumentToBase(doc),\n    isFavorited,\n  };\n}\n\n// Generate unique 10-digit post ID\nasync function generateUniquePostId(): Promise<string> {\n  let attempts = 0;\n  const maxAttempts = 100;\n  \n  while (attempts < maxAttempts) {\n    // Generate random 10-digit number (1000000000 to 9999999999)\n    const postId = Math.floor(1000000000 + Math.random() * 9000000000).toString();\n    \n    // Check if postId already exists\n    const existing = await DocumentModel.findOne({ postId });\n    if (!existing) {\n      return postId;\n    }\n    attempts++;\n  }\n  \n  throw new Error(\"Failed to generate unique post ID after maximum attempts\");\n}\n\nexport class MongoDBStorage implements IStorage {\n  // User operations (REQUIRED for Replit Auth)\n  async getUser(id: string): Promise<UserType | undefined> {\n    const user = await User.findById(id);\n    if (!user) return undefined;\n\n    return {\n      id: user._id,\n      email: toNull(user.email),\n      firstName: toNull(user.firstName),\n      lastName: toNull(user.lastName),\n      profileImageUrl: toNull(user.profileImageUrl),\n      role: user.role,\n      points: user.points || 0,\n      createdAt: toNull(user.createdAt),\n      updatedAt: toNull(user.updatedAt),\n    };\n  }\n\n  async upsertUser(userData: UpsertUser): Promise<UserType> {\n    // First, check if a user with this email already exists (from previous auth system)\n    if (userData.email) {\n      const existingByEmail = await User.findOne({ email: userData.email });\n      if (existingByEmail && existingByEmail._id !== userData.id) {\n        // User exists with different ID - update the existing user's ID to match the new auth provider\n        await User.findByIdAndDelete(existingByEmail._id);\n        console.log(`[Auth] Migrated user ${userData.email} from old ID ${existingByEmail._id} to new ID ${userData.id}`);\n      }\n    }\n\n    const user = await User.findByIdAndUpdate(\n      userData.id,\n      {\n        $set: {\n          _id: userData.id,\n          email: userData.email,\n          firstName: userData.firstName,\n          lastName: userData.lastName,\n          profileImageUrl: userData.profileImageUrl,\n          updatedAt: new Date(),\n        },\n        $setOnInsert: {\n          createdAt: new Date(),\n          role: userData.role || \"user\",\n        }\n      },\n      { upsert: true, new: true, setDefaultsOnInsert: true }\n    );\n\n    return {\n      id: user._id,\n      email: toNull(user.email),\n      firstName: toNull(user.firstName),\n      lastName: toNull(user.lastName),\n      profileImageUrl: toNull(user.profileImageUrl),\n      role: user.role,\n      points: user.points || 0,\n      createdAt: toNull(user.createdAt),\n      updatedAt: toNull(user.updatedAt),\n    };\n  }\n\n  // Document operations\n  async getAllDocuments(userId?: string): Promise<DocumentWithFavorite[]> {\n    const docs = await DocumentModel.find().sort({ createdAt: -1 });\n\n    if (!userId) {\n      return docs.map(doc => mapDocumentWithFavorite(doc, false));\n    }\n\n    // Get user favorites\n    const userFavorites = await Favorite.find({ userId }).select('documentId');\n    const favoritedIds = new Set(userFavorites.map(f => f.documentId));\n\n    return docs.map(doc => mapDocumentWithFavorite(doc, favoritedIds.has(doc._id)));\n  }\n\n  async getDocumentById(id: string, userId?: string): Promise<DocumentWithFavorite | undefined> {\n    const document = await DocumentModel.findById(id);\n    \n    if (!document) {\n      return undefined;\n    }\n\n    let isFavorited = false;\n    if (userId) {\n      const favorite = await Favorite.findOne({ userId, documentId: id });\n      isFavorited = !!favorite;\n    }\n\n    return mapDocumentWithFavorite(document, isFavorited);\n  }\n\n  async getRelatedDocuments(documentId: string, userId?: string): Promise<DocumentWithFavorite[]> {\n    const currentDoc = await DocumentModel.findById(documentId);\n    \n    if (!currentDoc) {\n      return [];\n    }\n\n    // Get documents with same category, excluding current document\n    const relatedDocs = await DocumentModel.find({\n      category: currentDoc.category,\n      _id: { $ne: documentId }\n    })\n      .sort({ viewCount: -1 })\n      .limit(6);\n\n    if (!userId || relatedDocs.length === 0) {\n      return relatedDocs.map(doc => mapDocumentWithFavorite(doc, false));\n    }\n\n    const docIds = relatedDocs.map(d => d._id);\n    const userFavorites = await Favorite.find({\n      userId,\n      documentId: { $in: docIds }\n    }).select('documentId');\n\n    const favoritedIds = new Set(userFavorites.map(f => f.documentId));\n\n    return relatedDocs.map(doc => mapDocumentWithFavorite(doc, favoritedIds.has(doc._id)));\n  }\n\n  async createDocument(document: InsertDocument): Promise<DocumentType> {\n    const postId = await generateUniquePostId();\n    \n    const docData: any = document;\n    const newDoc = await DocumentModel.create({\n      _id: randomUUID(),\n      postId,\n      title: document.title,\n      description: document.description,\n      category: document.category,\n      subcategory: docData.subcategory || null,\n      pageCount: document.pageCount,\n      pointsCost: docData.pointsCost || document.pageCount || 0,\n      coverImageUrl: document.coverImageUrl,\n      imageUrls: deserializeImageUrls((document as any).imageUrls),\n      originalFileName: docData.originalFileName || null,\n      parentPostId: docData.parentPostId || null,\n      postIndex: docData.postIndex || null,\n      totalParts: docData.totalParts || null,\n    });\n\n    return mapDocumentToBase(newDoc);\n  }\n\n  async updateDocument(id: string, document: Partial<InsertDocument>): Promise<DocumentType | undefined> {\n    // Prepare update data, deserializing imageUrls if present\n    const updateData: any = { ...document, updatedAt: new Date() };\n    if ((document as any).imageUrls !== undefined) {\n      updateData.imageUrls = deserializeImageUrls((document as any).imageUrls);\n    }\n    \n    const updated = await DocumentModel.findByIdAndUpdate(\n      id,\n      updateData,\n      { new: true }\n    );\n    \n    if (!updated) return undefined;\n\n    return mapDocumentToBase(updated);\n  }\n\n  async deleteDocument(id: string): Promise<boolean> {\n    const result = await DocumentModel.deleteOne({ _id: id });\n    return result.deletedCount > 0;\n  }\n\n  async incrementViewCount(id: string): Promise<void> {\n    await DocumentModel.findByIdAndUpdate(id, { $inc: { viewCount: 1 } });\n  }\n\n  // Favorite operations\n  async addFavorite(favorite: InsertFavorite): Promise<FavoriteType> {\n    const newFavorite = await Favorite.create({\n      _id: randomUUID(),\n      ...favorite,\n    });\n    \n    // Increment favorite count on document\n    await DocumentModel.findByIdAndUpdate(\n      favorite.documentId,\n      { $inc: { favoriteCount: 1 } }\n    );\n\n    return {\n      id: newFavorite._id,\n      userId: newFavorite.userId,\n      documentId: newFavorite.documentId,\n      createdAt: toNull(newFavorite.createdAt),\n    };\n  }\n\n  async removeFavorite(userId: string, documentId: string): Promise<boolean> {\n    const result = await Favorite.deleteOne({ userId, documentId });\n    \n    if (result.deletedCount > 0) {\n      // Decrement favorite count on document\n      await DocumentModel.findByIdAndUpdate(\n        documentId,\n        { $inc: { favoriteCount: -1 } }\n      );\n      return true;\n    }\n    return false;\n  }\n\n  async getUserFavorites(userId: string): Promise<string[]> {\n    const favorites = await Favorite.find({ userId }).select('documentId');\n    return favorites.map(f => f.documentId);\n  }\n\n  // Tag operations\n  async getAllTags(): Promise<TagType[]> {\n    const tags = await Tag.find().sort({ name: 1 });\n    return tags.map(tag => ({\n      id: tag._id,\n      name: tag.name,\n      createdAt: toNull(tag.createdAt),\n    }));\n  }\n\n  async createTag(tag: InsertTag): Promise<TagType> {\n    const newTag = await Tag.create({\n      _id: randomUUID(),\n      name: tag.name,\n    });\n    \n    return {\n      id: newTag._id,\n      name: newTag.name,\n      createdAt: toNull(newTag.createdAt),\n    };\n  }\n\n  async deleteTag(id: string): Promise<boolean> {\n    const result = await Tag.deleteOne({ _id: id });\n    return result.deletedCount > 0;\n  }\n\n  async getDocumentTags(documentId: string): Promise<TagType[]> {\n    const docTags = await DocumentTag.find({ documentId });\n    const tags = await Tag.find({\n      _id: { $in: docTags.map(dt => dt.tagId) }\n    });\n    \n    return tags.map(tag => ({\n      id: tag._id,\n      name: tag.name,\n      createdAt: toNull(tag.createdAt),\n    }));\n  }\n\n  async setDocumentTags(documentId: string, tagIds: string[]): Promise<void> {\n    // Remove existing tags\n    await DocumentTag.deleteMany({ documentId });\n\n    // Add new tags\n    if (tagIds.length > 0) {\n      await DocumentTag.insertMany(\n        tagIds.map(tagId => ({\n          _id: randomUUID(),\n          documentId,\n          tagId,\n        }))\n      );\n    }\n  }\n\n  // Admin operations\n  async getAllUsers(): Promise<UserType[]> {\n    const users = await User.find().sort({ createdAt: -1 });\n    return users.map(user => ({\n      id: user._id,\n      email: toNull(user.email),\n      firstName: toNull(user.firstName),\n      lastName: toNull(user.lastName),\n      profileImageUrl: toNull(user.profileImageUrl),\n      role: user.role,\n      points: user.points || 0,\n      createdAt: toNull(user.createdAt),\n      updatedAt: toNull(user.updatedAt),\n    }));\n  }\n\n  async getRecentUsers(limit: number): Promise<UserType[]> {\n    const users = await User.find().sort({ createdAt: -1 }).limit(limit);\n    return users.map(user => ({\n      id: user._id,\n      email: toNull(user.email),\n      firstName: toNull(user.firstName),\n      lastName: toNull(user.lastName),\n      profileImageUrl: toNull(user.profileImageUrl),\n      role: user.role,\n      points: user.points || 0,\n      createdAt: toNull(user.createdAt),\n      updatedAt: toNull(user.updatedAt),\n    }));\n  }\n\n  async updateUserRole(userId: string, role: string): Promise<UserType | undefined> {\n    const updated = await User.findByIdAndUpdate(\n      userId,\n      { role, updatedAt: new Date() },\n      { new: true }\n    );\n    \n    if (!updated) return undefined;\n\n    return {\n      id: updated._id,\n      email: toNull(updated.email),\n      firstName: toNull(updated.firstName),\n      lastName: toNull(updated.lastName),\n      profileImageUrl: toNull(updated.profileImageUrl),\n      role: updated.role,\n      points: updated.points || 0,\n      createdAt: toNull(updated.createdAt),\n      updatedAt: toNull(updated.updatedAt),\n    };\n  }\n\n  async updateUserPoints(userId: string, points: number): Promise<UserType | undefined> {\n    const updated = await User.findByIdAndUpdate(\n      userId,\n      { points, updatedAt: new Date() },\n      { new: true }\n    );\n    \n    if (!updated) return undefined;\n\n    return {\n      id: updated._id,\n      email: toNull(updated.email),\n      firstName: toNull(updated.firstName),\n      lastName: toNull(updated.lastName),\n      profileImageUrl: toNull(updated.profileImageUrl),\n      role: updated.role,\n      points: updated.points || 0,\n      createdAt: toNull(updated.createdAt),\n      updatedAt: toNull(updated.updatedAt),\n    };\n  }\n\n  async getAllDocumentsForAdmin(): Promise<DocumentType[]> {\n    const docs = await DocumentModel.find().sort({ createdAt: -1 });\n    return docs.map(doc => mapDocumentToBase(doc));\n  }\n\n  async getDocumentByIdForAdmin(id: string): Promise<DocumentType | undefined> {\n    const document = await DocumentModel.findById(id);\n    if (!document) return undefined;\n\n    return mapDocumentToBase(document);\n  }\n\n  async getRecentDocuments(limit: number): Promise<DocumentType[]> {\n    const docs = await DocumentModel.find().sort({ createdAt: -1 }).limit(limit);\n    return docs.map(doc => mapDocumentToBase(doc));\n  }\n\n  async getAdminStats(): Promise<{\n    totalDocuments: number;\n    totalUsers: number;\n    totalFavorites: number;\n    totalViews: number;\n  }> {\n    const [docCount, userCount, favCount, viewSum] = await Promise.all([\n      DocumentModel.countDocuments(),\n      User.countDocuments(),\n      Favorite.countDocuments(),\n      DocumentModel.aggregate([\n        { $group: { _id: null, total: { $sum: '$viewCount' } } }\n      ]).then(result => result[0]?.total || 0),\n    ]);\n\n    return {\n      totalDocuments: docCount,\n      totalUsers: userCount,\n      totalFavorites: favCount,\n      totalViews: viewSum,\n    };\n  }\n\n  // User upload operations\n  async getUserUploads(userId: string): Promise<UserUploadType[]> {\n    const uploads = await UserUpload.find({ userId }).sort({ slot: 1 });\n    return uploads.map(upload => ({\n      id: upload._id,\n      userId: upload.userId,\n      slot: upload.slot,\n      fileName: upload.fileName,\n      fileType: upload.fileType,\n      filePath: upload.filePath,\n      fileSize: upload.fileSize,\n      approvalStatus: upload.approvalStatus,\n      reviewedBy: toNull(upload.reviewedBy),\n      reviewedAt: toNull(upload.reviewedAt),\n      pipelineStatus: toNull(upload.pipelineStatus),\n      pipelineStartedAt: toNull(upload.pipelineStartedAt),\n      pipelineCompletedAt: toNull(upload.pipelineCompletedAt),\n      aiStatus: toNull(upload.aiStatus),\n      aiGeneratedTitle: toNull(upload.aiGeneratedTitle),\n      aiGeneratedDescription: toNull(upload.aiGeneratedDescription),\n      aiGeneratedCategory: toNull(upload.aiGeneratedCategory),\n      aiGeneratedAt: toNull(upload.aiGeneratedAt),\n      aiError: toNull(upload.aiError),\n      uploadedAt: toNull(upload.uploadedAt),\n    }));\n  }\n\n  async getUserUploadCount(userId: string): Promise<number> {\n    return await UserUpload.countDocuments({ userId });\n  }\n\n  async findAvailableSlot(userId: string): Promise<number | null> {\n    const uploads = await this.getUserUploads(userId);\n    const usedSlots = uploads.map(u => u.slot);\n    \n    // User can upload up to 10 files (slots 1-10)\n    for (let slot = 1; slot <= 10; slot++) {\n      if (!usedSlots.includes(slot)) return slot;\n    }\n    return null;\n  }\n\n  async createUserUpload(upload: InsertUserUpload): Promise<UserUploadType> {\n    const newUpload = await UserUpload.create({\n      _id: randomUUID(),\n      ...upload,\n    });\n    \n    return {\n      id: newUpload._id,\n      userId: newUpload.userId,\n      slot: newUpload.slot,\n      fileName: newUpload.fileName,\n      fileType: newUpload.fileType,\n      filePath: newUpload.filePath,\n      fileSize: newUpload.fileSize,\n      approvalStatus: newUpload.approvalStatus,\n      reviewedBy: toNull(newUpload.reviewedBy),\n      reviewedAt: toNull(newUpload.reviewedAt),\n      pipelineStatus: toNull(newUpload.pipelineStatus),\n      pipelineStartedAt: toNull(newUpload.pipelineStartedAt),\n      pipelineCompletedAt: toNull(newUpload.pipelineCompletedAt),\n      aiStatus: toNull(newUpload.aiStatus),\n      aiGeneratedTitle: toNull(newUpload.aiGeneratedTitle),\n      aiGeneratedDescription: toNull(newUpload.aiGeneratedDescription),\n      aiGeneratedCategory: toNull(newUpload.aiGeneratedCategory),\n      aiGeneratedAt: toNull(newUpload.aiGeneratedAt),\n      aiError: toNull(newUpload.aiError),\n      uploadedAt: toNull(newUpload.uploadedAt),\n    };\n  }\n\n  async deleteUserUpload(id: string, userId: string): Promise<boolean> {\n    const result = await UserUpload.deleteOne({ _id: id, userId });\n    return result.deletedCount > 0;\n  }\n\n  // Admin upload operations\n  async getAdminUploads(): Promise<AdminUploadType[]> {\n    const uploads = await AdminUpload.find().sort({ uploadedAt: -1 });\n    return uploads.map(upload => ({\n      id: upload._id,\n      uploadedBy: upload.uploadedBy,\n      fileName: upload.fileName,\n      fileType: upload.fileType,\n      filePath: upload.filePath,\n      fileSize: upload.fileSize,\n      category: toNull(upload.category),\n      pipelineStatus: upload.pipelineStatus,\n      pipelineError: toNull(upload.pipelineError),\n      pipelineStartedAt: toNull(upload.pipelineStartedAt),\n      pipelineCompletedAt: toNull(upload.pipelineCompletedAt),\n      aiStatus: toNull(upload.aiStatus),\n      aiGeneratedTitle: toNull(upload.aiGeneratedTitle),\n      aiGeneratedDescription: toNull(upload.aiGeneratedDescription),\n      aiGeneratedCategory: toNull(upload.aiGeneratedCategory),\n      aiGeneratedAt: toNull(upload.aiGeneratedAt),\n      aiError: toNull(upload.aiError),\n      uploadedAt: toNull(upload.uploadedAt),\n    }));\n  }\n\n  async getAdminUploadById(id: string): Promise<AdminUploadType | undefined> {\n    const upload = await AdminUpload.findById(id);\n    if (!upload) return undefined;\n\n    return {\n      id: upload._id,\n      uploadedBy: upload.uploadedBy,\n      fileName: upload.fileName,\n      fileType: upload.fileType,\n      filePath: upload.filePath,\n      fileSize: upload.fileSize,\n      category: toNull(upload.category),\n      subcategory: toNull(upload.subcategory),\n      pipelineStatus: upload.pipelineStatus,\n      pipelineError: toNull(upload.pipelineError),\n      pipelineStartedAt: toNull(upload.pipelineStartedAt),\n      pipelineCompletedAt: toNull(upload.pipelineCompletedAt),\n      aiStatus: toNull(upload.aiStatus),\n      aiGeneratedTitle: toNull(upload.aiGeneratedTitle),\n      aiGeneratedDescription: toNull(upload.aiGeneratedDescription),\n      aiGeneratedCategory: toNull(upload.aiGeneratedCategory),\n      aiGeneratedAt: toNull(upload.aiGeneratedAt),\n      aiError: toNull(upload.aiError),\n      uploadedAt: toNull(upload.uploadedAt),\n    };\n  }\n\n  async createAdminUpload(upload: InsertAdminUpload): Promise<AdminUploadType> {\n    const newUpload = await AdminUpload.create({\n      _id: randomUUID(),\n      ...upload,\n    });\n    \n    return {\n      id: newUpload._id,\n      uploadedBy: newUpload.uploadedBy,\n      fileName: newUpload.fileName,\n      fileType: newUpload.fileType,\n      filePath: newUpload.filePath,\n      fileSize: newUpload.fileSize,\n      category: toNull(newUpload.category),\n      subcategory: toNull(newUpload.subcategory),\n      pipelineStatus: newUpload.pipelineStatus,\n      pipelineStartedAt: toNull(newUpload.pipelineStartedAt),\n      pipelineCompletedAt: toNull(newUpload.pipelineCompletedAt),\n      aiStatus: toNull(newUpload.aiStatus),\n      aiGeneratedTitle: toNull(newUpload.aiGeneratedTitle),\n      aiGeneratedDescription: toNull(newUpload.aiGeneratedDescription),\n      aiGeneratedCategory: toNull(newUpload.aiGeneratedCategory),\n      aiGeneratedAt: toNull(newUpload.aiGeneratedAt),\n      aiError: toNull(newUpload.aiError),\n      uploadedAt: toNull(newUpload.uploadedAt),\n    };\n  }\n\n  async deleteAdminUpload(id: string): Promise<boolean> {\n    const result = await AdminUpload.deleteOne({ _id: id });\n    return result.deletedCount > 0;\n  }\n\n  async checkDuplicateFileHash(fileHash: string): Promise<{ isDuplicate: boolean; existingFileName?: string; existingUploadType?: 'admin' | 'user' }> {\n    // Check in admin uploads\n    const adminDuplicate = await AdminUpload.findOne({ fileHash });\n    if (adminDuplicate) {\n      return {\n        isDuplicate: true,\n        existingFileName: adminDuplicate.fileName,\n        existingUploadType: 'admin'\n      };\n    }\n\n    // Check in user uploads\n    const userDuplicate = await UserUpload.findOne({ fileHash });\n    if (userDuplicate) {\n      return {\n        isDuplicate: true,\n        existingFileName: userDuplicate.fileName,\n        existingUploadType: 'user'\n      };\n    }\n\n    return { isDuplicate: false };\n  }\n\n  async deleteAllDuplicateRecords(): Promise<{ adminDeleted: number; userDeleted: number; details: string[] }> {\n    const details: string[] = [];\n    let adminDeleted = 0;\n    let userDeleted = 0;\n\n    // Find duplicates in admin uploads (group by fileHash, keep only the oldest one)\n    const adminDuplicates = await AdminUpload.aggregate([\n      { $group: { _id: \"$fileHash\", count: { $sum: 1 }, docs: { $push: { id: \"$_id\", fileName: \"$fileName\", uploadedAt: \"$uploadedAt\" } } } },\n      { $match: { count: { $gt: 1 } } }\n    ]);\n\n    for (const group of adminDuplicates) {\n      if (group.docs && group.docs.length > 1) {\n        // Sort by uploadedAt, keep the oldest\n        const sorted = group.docs.sort((a: any, b: any) => new Date(a.uploadedAt).getTime() - new Date(b.uploadedAt).getTime());\n        // Delete all except the first (oldest)\n        for (let i = 1; i < sorted.length; i++) {\n          await AdminUpload.deleteOne({ _id: sorted[i].id });\n          details.push(`Admin: Deleted duplicate \"${sorted[i].fileName}\"`);\n          adminDeleted++;\n        }\n      }\n    }\n\n    // Find duplicates in user uploads (group by fileHash, keep only the oldest one)\n    const userDuplicates = await UserUpload.aggregate([\n      { $group: { _id: \"$fileHash\", count: { $sum: 1 }, docs: { $push: { id: \"$_id\", fileName: \"$fileName\", uploadedAt: \"$uploadedAt\" } } } },\n      { $match: { count: { $gt: 1 } } }\n    ]);\n\n    for (const group of userDuplicates) {\n      if (group.docs && group.docs.length > 1) {\n        // Sort by uploadedAt, keep the oldest\n        const sorted = group.docs.sort((a: any, b: any) => new Date(a.uploadedAt).getTime() - new Date(b.uploadedAt).getTime());\n        // Delete all except the first (oldest)\n        for (let i = 1; i < sorted.length; i++) {\n          await UserUpload.deleteOne({ _id: sorted[i].id });\n          details.push(`User: Deleted duplicate \"${sorted[i].fileName}\"`);\n          userDeleted++;\n        }\n      }\n    }\n\n    return { adminDeleted, userDeleted, details };\n  }\n\n  async clearAllUploads(): Promise<{ adminCleared: number; userCleared: number }> {\n    const adminResult = await AdminUpload.deleteMany({});\n    const userResult = await UserUpload.deleteMany({});\n    return {\n      adminCleared: adminResult.deletedCount,\n      userCleared: userResult.deletedCount\n    };\n  }\n\n  async updatePipelineStatus(\n    id: string, \n    status: string, \n    startedAt?: Date, \n    completedAt?: Date,\n    error?: string\n  ): Promise<AdminUploadType | undefined> {\n    const updateData: any = { pipelineStatus: status };\n    if (startedAt) updateData.pipelineStartedAt = startedAt;\n    if (completedAt) updateData.pipelineCompletedAt = completedAt;\n    if (error !== undefined) updateData.pipelineError = error;\n    if (status === 'completed') updateData.pipelineError = null;\n\n    const updated = await AdminUpload.findByIdAndUpdate(\n      id,\n      updateData,\n      { new: true }\n    );\n    \n    if (!updated) return undefined;\n\n    return {\n      id: updated._id,\n      uploadedBy: updated.uploadedBy,\n      fileName: updated.fileName,\n      fileType: updated.fileType,\n      filePath: updated.filePath,\n      fileSize: updated.fileSize,\n      category: toNull(updated.category),\n      pipelineStatus: updated.pipelineStatus,\n      pipelineError: toNull(updated.pipelineError),\n      pipelineStartedAt: toNull(updated.pipelineStartedAt),\n      pipelineCompletedAt: toNull(updated.pipelineCompletedAt),\n      aiStatus: toNull(updated.aiStatus),\n      aiGeneratedTitle: toNull(updated.aiGeneratedTitle),\n      aiGeneratedDescription: toNull(updated.aiGeneratedDescription),\n      aiGeneratedCategory: toNull(updated.aiGeneratedCategory),\n      aiGeneratedAt: toNull(updated.aiGeneratedAt),\n      aiError: toNull(updated.aiError),\n      uploadedAt: toNull(updated.uploadedAt),\n    };\n  }\n\n  // User upload approval operations\n  async getAllUserUploads(): Promise<(UserUploadType & { userName: string; userEmail: string })[]> {\n    const uploads = await UserUpload.find()\n      .sort({ uploadedAt: -1 });\n    \n    // Fetch user details for each upload\n    const result = [];\n    for (const upload of uploads) {\n      const user = await User.findById(upload.userId);\n      result.push({\n        id: upload._id,\n        userId: upload.userId,\n        slot: upload.slot,\n        fileName: upload.fileName,\n        fileType: upload.fileType,\n        filePath: upload.filePath,\n        fileSize: upload.fileSize,\n        approvalStatus: upload.approvalStatus,\n        reviewedBy: toNull(upload.reviewedBy),\n        reviewedAt: toNull(upload.reviewedAt),\n        pipelineStatus: toNull(upload.pipelineStatus),\n        pipelineStartedAt: toNull(upload.pipelineStartedAt),\n        pipelineCompletedAt: toNull(upload.pipelineCompletedAt),\n        aiStatus: toNull(upload.aiStatus),\n        aiGeneratedTitle: toNull(upload.aiGeneratedTitle),\n        aiGeneratedDescription: toNull(upload.aiGeneratedDescription),\n        aiGeneratedCategory: toNull(upload.aiGeneratedCategory),\n        aiGeneratedAt: toNull(upload.aiGeneratedAt),\n        aiError: toNull(upload.aiError),\n        uploadedAt: toNull(upload.uploadedAt),\n        userName: user ? `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email : 'Unknown',\n        userEmail: user?.email || 'unknown@example.com',\n      });\n    }\n    return result;\n  }\n\n  async getUserUploadById(id: string): Promise<UserUploadType | undefined> {\n    const upload = await UserUpload.findById(id);\n    if (!upload) return undefined;\n\n    return {\n      id: upload._id,\n      userId: upload.userId,\n      slot: upload.slot,\n      fileName: upload.fileName,\n      fileType: upload.fileType,\n      filePath: upload.filePath,\n      fileSize: upload.fileSize,\n      approvalStatus: upload.approvalStatus,\n      reviewedBy: toNull(upload.reviewedBy),\n      reviewedAt: toNull(upload.reviewedAt),\n      approvedCategory: toNull((upload as any).approvedCategory),\n      pipelineStatus: toNull(upload.pipelineStatus),\n      pipelineStartedAt: toNull(upload.pipelineStartedAt),\n      pipelineCompletedAt: toNull(upload.pipelineCompletedAt),\n      aiStatus: toNull(upload.aiStatus),\n      aiGeneratedTitle: toNull(upload.aiGeneratedTitle),\n      aiGeneratedDescription: toNull(upload.aiGeneratedDescription),\n      aiGeneratedCategory: toNull(upload.aiGeneratedCategory),\n      aiGeneratedAt: toNull(upload.aiGeneratedAt),\n      aiError: toNull(upload.aiError),\n      uploadedAt: toNull(upload.uploadedAt),\n    };\n  }\n\n  async approveUserUpload(id: string, adminId: string, category: string): Promise<UserUploadType | undefined> {\n    const updated = await UserUpload.findByIdAndUpdate(\n      id,\n      {\n        approvalStatus: \"approved\",\n        reviewedBy: adminId,\n        reviewedAt: new Date(),\n        approvedCategory: category,\n      },\n      { new: true }\n    );\n    \n    if (!updated) return undefined;\n\n    return {\n      id: updated._id,\n      userId: updated.userId,\n      slot: updated.slot,\n      fileName: updated.fileName,\n      fileType: updated.fileType,\n      filePath: updated.filePath,\n      fileSize: updated.fileSize,\n      approvalStatus: updated.approvalStatus,\n      reviewedBy: toNull(updated.reviewedBy),\n      reviewedAt: toNull(updated.reviewedAt),\n      approvedCategory: toNull((updated as any).approvedCategory),\n      pipelineStatus: toNull(updated.pipelineStatus),\n      pipelineStartedAt: toNull(updated.pipelineStartedAt),\n      pipelineCompletedAt: toNull(updated.pipelineCompletedAt),\n      aiStatus: toNull(updated.aiStatus),\n      aiGeneratedTitle: toNull(updated.aiGeneratedTitle),\n      aiGeneratedDescription: toNull(updated.aiGeneratedDescription),\n      aiGeneratedCategory: toNull(updated.aiGeneratedCategory),\n      aiGeneratedAt: toNull(updated.aiGeneratedAt),\n      aiError: toNull(updated.aiError),\n      uploadedAt: toNull(updated.uploadedAt),\n    };\n  }\n\n  async rejectUserUpload(id: string, adminId: string): Promise<UserUploadType | undefined> {\n    const updated = await UserUpload.findByIdAndUpdate(\n      id,\n      {\n        approvalStatus: \"rejected\",\n        reviewedBy: adminId,\n        reviewedAt: new Date(),\n      },\n      { new: true }\n    );\n    \n    if (!updated) return undefined;\n\n    return {\n      id: updated._id,\n      userId: updated.userId,\n      slot: updated.slot,\n      fileName: updated.fileName,\n      fileType: updated.fileType,\n      filePath: updated.filePath,\n      fileSize: updated.fileSize,\n      approvalStatus: updated.approvalStatus,\n      reviewedBy: toNull(updated.reviewedBy),\n      reviewedAt: toNull(updated.reviewedAt),\n      pipelineStatus: toNull(updated.pipelineStatus),\n      pipelineStartedAt: toNull(updated.pipelineStartedAt),\n      pipelineCompletedAt: toNull(updated.pipelineCompletedAt),\n      aiStatus: toNull(updated.aiStatus),\n      aiGeneratedTitle: toNull(updated.aiGeneratedTitle),\n      aiGeneratedDescription: toNull(updated.aiGeneratedDescription),\n      aiGeneratedCategory: toNull(updated.aiGeneratedCategory),\n      aiGeneratedAt: toNull(updated.aiGeneratedAt),\n      aiError: toNull(updated.aiError),\n      uploadedAt: toNull(updated.uploadedAt),\n    };\n  }\n\n  async updateUserUploadPipelineStatus(\n    id: string,\n    status: string,\n    startedAt?: Date,\n    completedAt?: Date\n  ): Promise<UserUploadType | undefined> {\n    const updateData: any = { pipelineStatus: status };\n    if (startedAt) updateData.pipelineStartedAt = startedAt;\n    if (completedAt) updateData.pipelineCompletedAt = completedAt;\n\n    const updated = await UserUpload.findByIdAndUpdate(\n      id,\n      updateData,\n      { new: true }\n    );\n    \n    if (!updated) return undefined;\n\n    return {\n      id: updated._id,\n      userId: updated.userId,\n      slot: updated.slot,\n      fileName: updated.fileName,\n      fileType: updated.fileType,\n      filePath: updated.filePath,\n      fileSize: updated.fileSize,\n      approvalStatus: updated.approvalStatus,\n      reviewedBy: toNull(updated.reviewedBy),\n      reviewedAt: toNull(updated.reviewedAt),\n      pipelineStatus: toNull(updated.pipelineStatus),\n      pipelineStartedAt: toNull(updated.pipelineStartedAt),\n      pipelineCompletedAt: toNull(updated.pipelineCompletedAt),\n      aiStatus: toNull(updated.aiStatus),\n      aiGeneratedTitle: toNull(updated.aiGeneratedTitle),\n      aiGeneratedDescription: toNull(updated.aiGeneratedDescription),\n      aiGeneratedCategory: toNull(updated.aiGeneratedCategory),\n      aiGeneratedAt: toNull(updated.aiGeneratedAt),\n      aiError: toNull(updated.aiError),\n      uploadedAt: toNull(updated.uploadedAt),\n    };\n  }\n\n  async updateUserUploadMetadata(\n    id: string,\n    metadata: { title: string; description: string; category: string }\n  ): Promise<void> {\n    await UserUpload.findByIdAndUpdate(id, {\n      aiStatus: \"completed\",\n      aiGeneratedTitle: metadata.title,\n      aiGeneratedDescription: metadata.description,\n      aiGeneratedCategory: metadata.category,\n      aiGeneratedAt: new Date(),\n      aiError: undefined,\n    });\n  }\n\n  async updateAdminUploadMetadata(\n    id: string,\n    metadata: { title: string; description: string; category: string }\n  ): Promise<void> {\n    await AdminUpload.findByIdAndUpdate(id, {\n      aiStatus: \"completed\",\n      aiGeneratedTitle: metadata.title,\n      aiGeneratedDescription: metadata.description,\n      aiGeneratedCategory: metadata.category,\n      aiGeneratedAt: new Date(),\n      aiError: undefined,\n    });\n  }\n\n  async updateUserUploadAIError(id: string, error: string): Promise<void> {\n    await UserUpload.findByIdAndUpdate(id, {\n      aiStatus: \"failed\",\n      aiError: error,\n    });\n  }\n\n  async updateAdminUploadAIError(id: string, error: string): Promise<void> {\n    await AdminUpload.findByIdAndUpdate(id, {\n      aiStatus: \"failed\",\n      aiError: error,\n    });\n  }\n\n  // Category operations\n  async getAllCategories() {\n    const categories = await Category.find().sort({ order: 1 });\n    return categories.map(cat => ({\n      _id: cat._id,\n      id: cat._id,\n      name: cat.name,\n      logoUrl: cat.logoUrl,\n      order: cat.order,\n      createdAt: cat.createdAt,\n      updatedAt: cat.updatedAt,\n    }));\n  }\n\n  async getCategoryById(id: string) {\n    const category = await Category.findById(id);\n    if (!category) return undefined;\n    \n    return {\n      _id: category._id,\n      id: category._id,\n      name: category.name,\n      logoUrl: category.logoUrl,\n      order: category.order,\n      createdAt: category.createdAt,\n      updatedAt: category.updatedAt,\n    };\n  }\n\n  async createCategory(categoryData: Partial<{ name: string; logoUrl?: string; order: number }>) {\n    const category = new Category({\n      _id: randomUUID(),\n      name: categoryData.name,\n      logoUrl: categoryData.logoUrl,\n      order: categoryData.order || 0,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    });\n    \n    await category.save();\n    \n    return {\n      _id: category._id,\n      id: category._id,\n      name: category.name,\n      logoUrl: category.logoUrl,\n      order: category.order,\n      createdAt: category.createdAt,\n      updatedAt: category.updatedAt,\n    };\n  }\n\n  async updateCategory(id: string, categoryData: Partial<{ name?: string; logoUrl?: string; order?: number }>) {\n    const category = await Category.findByIdAndUpdate(\n      id,\n      {\n        $set: {\n          ...categoryData,\n          updatedAt: new Date(),\n        },\n      },\n      { new: true }\n    );\n    \n    if (!category) return undefined;\n    \n    return {\n      _id: category._id,\n      id: category._id,\n      name: category.name,\n      logoUrl: category.logoUrl,\n      order: category.order,\n      createdAt: category.createdAt,\n      updatedAt: category.updatedAt,\n    };\n  }\n\n  async deleteCategory(id: string): Promise<boolean> {\n    const result = await Category.findByIdAndDelete(id);\n    return !!result;\n  }\n\n  // Chat support operations\n  async getOrCreateConversation(userId?: string, guestId?: string, guestName?: string, guestEmail?: string) {\n    let conversation;\n    \n    if (userId) {\n      conversation = await ChatConversation.findOne({ userId, status: \"active\" });\n    } else if (guestId) {\n      conversation = await ChatConversation.findOne({ guestId, status: \"active\" });\n    }\n\n    if (conversation) {\n      return {\n        _id: conversation._id,\n        id: conversation._id,\n        userId: conversation.userId,\n        guestId: conversation.guestId,\n        guestName: conversation.guestName,\n        guestEmail: conversation.guestEmail,\n        status: conversation.status,\n        unreadByAdmin: conversation.unreadByAdmin,\n        unreadByUser: conversation.unreadByUser,\n        lastMessageAt: conversation.lastMessageAt,\n        lastMessagePreview: conversation.lastMessagePreview,\n        createdAt: conversation.createdAt,\n        updatedAt: conversation.updatedAt,\n      };\n    }\n\n    const newConversation = new ChatConversation({\n      _id: randomUUID(),\n      userId,\n      guestId,\n      guestName,\n      guestEmail,\n      status: \"active\",\n      unreadByAdmin: 0,\n      unreadByUser: 0,\n      lastMessageAt: new Date(),\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    });\n\n    await newConversation.save();\n\n    return {\n      _id: newConversation._id,\n      id: newConversation._id,\n      userId: newConversation.userId,\n      guestId: newConversation.guestId,\n      guestName: newConversation.guestName,\n      guestEmail: newConversation.guestEmail,\n      status: newConversation.status,\n      unreadByAdmin: newConversation.unreadByAdmin,\n      unreadByUser: newConversation.unreadByUser,\n      lastMessageAt: newConversation.lastMessageAt,\n      lastMessagePreview: newConversation.lastMessagePreview,\n      createdAt: newConversation.createdAt,\n      updatedAt: newConversation.updatedAt,\n    };\n  }\n\n  async getConversationById(id: string) {\n    const conversation = await ChatConversation.findById(id);\n    if (!conversation) return undefined;\n\n    return {\n      _id: conversation._id,\n      id: conversation._id,\n      userId: conversation.userId,\n      guestId: conversation.guestId,\n      guestName: conversation.guestName,\n      guestEmail: conversation.guestEmail,\n      status: conversation.status,\n      unreadByAdmin: conversation.unreadByAdmin,\n      unreadByUser: conversation.unreadByUser,\n      lastMessageAt: conversation.lastMessageAt,\n      lastMessagePreview: conversation.lastMessagePreview,\n      createdAt: conversation.createdAt,\n      updatedAt: conversation.updatedAt,\n    };\n  }\n\n  async getConversationByUserId(userId: string) {\n    const conversation = await ChatConversation.findOne({ userId, status: \"active\" });\n    if (!conversation) return undefined;\n\n    return {\n      _id: conversation._id,\n      id: conversation._id,\n      userId: conversation.userId,\n      guestId: conversation.guestId,\n      guestName: conversation.guestName,\n      guestEmail: conversation.guestEmail,\n      status: conversation.status,\n      unreadByAdmin: conversation.unreadByAdmin,\n      unreadByUser: conversation.unreadByUser,\n      lastMessageAt: conversation.lastMessageAt,\n      lastMessagePreview: conversation.lastMessagePreview,\n      createdAt: conversation.createdAt,\n      updatedAt: conversation.updatedAt,\n    };\n  }\n\n  async getConversationByGuestId(guestId: string) {\n    const conversation = await ChatConversation.findOne({ guestId, status: \"active\" });\n    if (!conversation) return undefined;\n\n    return {\n      _id: conversation._id,\n      id: conversation._id,\n      userId: conversation.userId,\n      guestId: conversation.guestId,\n      guestName: conversation.guestName,\n      guestEmail: conversation.guestEmail,\n      status: conversation.status,\n      unreadByAdmin: conversation.unreadByAdmin,\n      unreadByUser: conversation.unreadByUser,\n      lastMessageAt: conversation.lastMessageAt,\n      lastMessagePreview: conversation.lastMessagePreview,\n      createdAt: conversation.createdAt,\n      updatedAt: conversation.updatedAt,\n    };\n  }\n\n  async getAllConversations() {\n    const conversations = await ChatConversation.find()\n      .sort({ lastMessageAt: -1 });\n\n    return conversations.map(conversation => ({\n      _id: conversation._id,\n      id: conversation._id,\n      userId: conversation.userId,\n      guestId: conversation.guestId,\n      guestName: conversation.guestName,\n      guestEmail: conversation.guestEmail,\n      status: conversation.status,\n      unreadByAdmin: conversation.unreadByAdmin,\n      unreadByUser: conversation.unreadByUser,\n      lastMessageAt: conversation.lastMessageAt,\n      lastMessagePreview: conversation.lastMessagePreview,\n      createdAt: conversation.createdAt,\n      updatedAt: conversation.updatedAt,\n    }));\n  }\n\n  async updateConversationStatus(id: string, status: \"active\" | \"closed\") {\n    const conversation = await ChatConversation.findByIdAndUpdate(\n      id,\n      { $set: { status, updatedAt: new Date() } },\n      { new: true }\n    );\n\n    if (!conversation) return undefined;\n\n    return {\n      _id: conversation._id,\n      id: conversation._id,\n      userId: conversation.userId,\n      guestId: conversation.guestId,\n      guestName: conversation.guestName,\n      guestEmail: conversation.guestEmail,\n      status: conversation.status,\n      unreadByAdmin: conversation.unreadByAdmin,\n      unreadByUser: conversation.unreadByUser,\n      lastMessageAt: conversation.lastMessageAt,\n      lastMessagePreview: conversation.lastMessagePreview,\n      createdAt: conversation.createdAt,\n      updatedAt: conversation.updatedAt,\n    };\n  }\n\n  // Chat message operations\n  async getMessagesByConversationId(conversationId: string) {\n    const messages = await ChatMessage.find({ conversationId })\n      .sort({ createdAt: 1 });\n\n    return messages.map(message => ({\n      _id: message._id,\n      id: message._id,\n      conversationId: message.conversationId,\n      senderType: message.senderType,\n      senderId: message.senderId,\n      senderName: message.senderName,\n      content: message.content,\n      isRead: message.isRead,\n      createdAt: message.createdAt,\n    }));\n  }\n\n  async createMessage(messageData: Partial<{\n    conversationId: string;\n    senderType: \"user\" | \"admin\" | \"system\";\n    senderId?: string;\n    senderName?: string;\n    content: string;\n  }>) {\n    const message = new ChatMessage({\n      _id: randomUUID(),\n      conversationId: messageData.conversationId,\n      senderType: messageData.senderType,\n      senderId: messageData.senderId,\n      senderName: messageData.senderName,\n      content: messageData.content,\n      isRead: false,\n      createdAt: new Date(),\n    });\n\n    await message.save();\n\n    // Update conversation with last message info and unread count\n    const updateData: any = {\n      lastMessageAt: new Date(),\n      lastMessagePreview: messageData.content?.substring(0, 100),\n      updatedAt: new Date(),\n    };\n\n    if (messageData.senderType === \"user\") {\n      updateData.$inc = { unreadByAdmin: 1 };\n    } else if (messageData.senderType === \"admin\") {\n      updateData.$inc = { unreadByUser: 1 };\n    }\n\n    await ChatConversation.findByIdAndUpdate(\n      messageData.conversationId,\n      messageData.senderType === \"user\" || messageData.senderType === \"admin\"\n        ? { $set: { lastMessageAt: new Date(), lastMessagePreview: messageData.content?.substring(0, 100), updatedAt: new Date() }, $inc: { [messageData.senderType === \"user\" ? \"unreadByAdmin\" : \"unreadByUser\"]: 1 } }\n        : { $set: { lastMessageAt: new Date(), lastMessagePreview: messageData.content?.substring(0, 100), updatedAt: new Date() } }\n    );\n\n    return {\n      _id: message._id,\n      id: message._id,\n      conversationId: message.conversationId,\n      senderType: message.senderType,\n      senderId: message.senderId,\n      senderName: message.senderName,\n      content: message.content,\n      isRead: message.isRead,\n      createdAt: message.createdAt,\n    };\n  }\n\n  async markMessagesAsRead(conversationId: string, senderType: \"user\" | \"admin\") {\n    // Mark all messages from the other party as read\n    const oppositeType = senderType === \"user\" ? \"admin\" : \"user\";\n    \n    await ChatMessage.updateMany(\n      { conversationId, senderType: oppositeType, isRead: false },\n      { $set: { isRead: true } }\n    );\n\n    // Reset unread count for the reader\n    const updateField = senderType === \"user\" ? \"unreadByUser\" : \"unreadByAdmin\";\n    await ChatConversation.findByIdAndUpdate(\n      conversationId,\n      { $set: { [updateField]: 0 } }\n    );\n  }\n\n  // Notification methods\n  async createNotification(data: {\n    title: string;\n    content: string;\n    type: \"all\" | \"single\";\n    targetUserId?: string;\n    senderId: string;\n    senderName?: string;\n  }) {\n    const notification = new Notification({\n      _id: randomUUID(),\n      ...data,\n      isRead: false,\n      createdAt: new Date(),\n    });\n    await notification.save();\n    return {\n      id: notification._id,\n      _id: notification._id,\n      title: notification.title,\n      content: notification.content,\n      type: notification.type,\n      targetUserId: notification.targetUserId,\n      senderId: notification.senderId,\n      senderName: notification.senderName,\n      isRead: notification.isRead,\n      createdAt: notification.createdAt,\n    };\n  }\n\n  async getNotificationsForUser(userId: string) {\n    // Get all notifications that are either:\n    // 1. Type \"all\" (broadcast to everyone)\n    // 2. Type \"single\" and targetUserId matches this user\n    const notifications = await Notification.find({\n      $or: [\n        { type: \"all\" },\n        { type: \"single\", targetUserId: userId }\n      ]\n    }).sort({ createdAt: -1 }).limit(50);\n\n    // Get read status for each notification\n    const readNotifications = await NotificationRead.find({\n      userId,\n      notificationId: { $in: notifications.map(n => n._id) }\n    });\n    const readSet = new Set(readNotifications.map(r => r.notificationId));\n\n    return notifications.map(n => ({\n      id: n._id,\n      _id: n._id,\n      title: n.title,\n      content: n.content,\n      type: n.type,\n      targetUserId: n.targetUserId,\n      senderId: n.senderId,\n      senderName: n.senderName,\n      isRead: readSet.has(n._id),\n      createdAt: n.createdAt,\n    }));\n  }\n\n  async getUnreadNotificationCount(userId: string) {\n    // Get all notifications for this user\n    const notifications = await Notification.find({\n      $or: [\n        { type: \"all\" },\n        { type: \"single\", targetUserId: userId }\n      ]\n    });\n\n    // Get read notifications\n    const readNotifications = await NotificationRead.find({\n      userId,\n      notificationId: { $in: notifications.map(n => n._id) }\n    });\n    const readSet = new Set(readNotifications.map(r => r.notificationId));\n\n    // Count unread\n    return notifications.filter(n => !readSet.has(n._id)).length;\n  }\n\n  async markNotificationAsRead(notificationId: string, userId: string) {\n    const existing = await NotificationRead.findOne({ notificationId, userId });\n    if (!existing) {\n      const read = new NotificationRead({\n        _id: randomUUID(),\n        notificationId,\n        userId,\n        readAt: new Date(),\n      });\n      await read.save();\n    }\n    return true;\n  }\n\n  async markAllNotificationsAsRead(userId: string) {\n    // Get all unread notifications for this user\n    const notifications = await Notification.find({\n      $or: [\n        { type: \"all\" },\n        { type: \"single\", targetUserId: userId }\n      ]\n    });\n\n    const readNotifications = await NotificationRead.find({\n      userId,\n      notificationId: { $in: notifications.map(n => n._id) }\n    });\n    const readSet = new Set(readNotifications.map(r => r.notificationId));\n\n    // Create read records for unread notifications\n    const unreadNotifications = notifications.filter(n => !readSet.has(n._id));\n    for (const notification of unreadNotifications) {\n      const read = new NotificationRead({\n        _id: randomUUID(),\n        notificationId: notification._id,\n        userId,\n        readAt: new Date(),\n      });\n      await read.save();\n    }\n    return true;\n  }\n\n  async getAllNotifications() {\n    const notifications = await Notification.find()\n      .sort({ createdAt: -1 })\n      .limit(100);\n    return notifications.map(n => ({\n      id: n._id,\n      _id: n._id,\n      title: n.title,\n      content: n.content,\n      type: n.type,\n      targetUserId: n.targetUserId,\n      senderId: n.senderId,\n      senderName: n.senderName,\n      isRead: n.isRead,\n      createdAt: n.createdAt,\n    }));\n  }\n\n  async deleteNotification(notificationId: string) {\n    await NotificationRead.deleteMany({ notificationId });\n    const result = await Notification.findByIdAndDelete(notificationId);\n    return !!result;\n  }\n}\n\nexport const storage = new MongoDBStorage();\n","path":null,"size_bytes":48415,"size_tokens":null},"server/scripts/test-mongo-connection.ts":{"content":"import mongoose from \"mongoose\";\n\nconst MONGO_URI = process.env.MONGO_URI;\n\nasync function testConnection() {\n  console.log(\"üîç Testing MongoDB Connection...\\n\");\n  \n  if (!MONGO_URI) {\n    console.error(\"‚ùå MONGO_URI environment variable not found!\");\n    process.exit(1);\n  }\n\n  const uriWithoutPassword = MONGO_URI.replace(/:[^:@]+@/, \":***@\");\n  console.log(\"üìù Connection URI (password hidden):\");\n  console.log(`   ${uriWithoutPassword}\\n`);\n\n  const uriParts = MONGO_URI.match(/mongodb\\+srv:\\/\\/([^:]+):([^@]+)@([^/]+)\\/?([^?]*)/);\n  \n  if (uriParts) {\n    console.log(\"üîç URI Components:\");\n    console.log(`   Username: ${uriParts[1]}`);\n    console.log(`   Password: ${\"*\".repeat(uriParts[2].length)} (${uriParts[2].length} chars)`);\n    console.log(`   Host: ${uriParts[3]}`);\n    console.log(`   Database: ${uriParts[4] || \"(default: test)\"}\\n`);\n  }\n\n  try {\n    console.log(\"üîÑ Attempting to connect...\");\n    await mongoose.connect(MONGO_URI, {\n      serverSelectionTimeoutMS: 10000,\n      connectTimeoutMS: 10000,\n    });\n    \n    console.log(\"‚úÖ MongoDB connected successfully!\");\n    console.log(`   Database: ${mongoose.connection.db.databaseName}`);\n    console.log(`   Host: ${mongoose.connection.host}`);\n    \n    const collections = await mongoose.connection.db.listCollections().toArray();\n    console.log(`   Collections: ${collections.length}`);\n    \n    if (collections.length > 0) {\n      console.log(`   Found collections: ${collections.map(c => c.name).join(\", \")}`);\n    }\n    \n    await mongoose.disconnect();\n    console.log(\"\\n‚úÖ Test completed successfully!\");\n    \n  } catch (error) {\n    console.error(\"\\n‚ùå Connection failed!\");\n    \n    if (error instanceof Error) {\n      console.error(`   Error: ${error.message}`);\n      \n      if (error.message.includes(\"authentication failed\")) {\n        console.log(\"\\nüí° Troubleshooting Steps:\");\n        console.log(\"   1. Ki·ªÉm tra MongoDB Atlas ‚Üí Database Access\");\n        console.log(\"   2. X√°c nh·∫≠n user t·ªìn t·∫°i v√† password ƒë√∫ng\");\n        console.log(\"   3. User ph·∫£i c√≥ quy·ªÅn 'Read and write to any database'\");\n        console.log(\"   4. N·∫øu password c√≥ k√Ω t·ª± ƒë·∫∑c bi·ªát, c·∫ßn URL encode\");\n        console.log(\"   5. Th·ª≠ t·∫°o user m·ªõi v·ªõi password ƒë∆°n gi·∫£n ƒë·ªÉ test\");\n      }\n      \n      if (error.message.includes(\"ENOTFOUND\")) {\n        console.log(\"\\nüí° Troubleshooting Steps:\");\n        console.log(\"   1. Ki·ªÉm tra Network Access trong MongoDB Atlas\");\n        console.log(\"   2. Th√™m IP 0.0.0.0/0 v√†o whitelist ƒë·ªÉ test\");\n        console.log(\"   3. X√°c nh·∫≠n cluster ƒëang ch·∫°y (kh√¥ng paused)\");\n      }\n    }\n    \n    throw error;\n  } finally {\n    process.exit(0);\n  }\n}\n\ntestConnection();\n","path":null,"size_bytes":2758,"size_tokens":null},"server/scripts/export-postgres-data.ts":{"content":"import { db } from \"../db\";\nimport { \n  users, \n  documents, \n  favorites, \n  tags, \n  documentTags,\n  userUploads,\n  adminUploads \n} from \"../../shared/schema\";\nimport fs from \"fs/promises\";\nimport path from \"path\";\n\nasync function exportData() {\n  console.log(\"üîÑ Starting PostgreSQL data export...\");\n  \n  const exportDir = path.join(process.cwd(), \"postgres-backup\");\n  await fs.mkdir(exportDir, { recursive: true });\n\n  try {\n    const [\n      usersData,\n      documentsData,\n      favoritesData,\n      tagsData,\n      documentTagsData,\n      userUploadsData,\n      adminUploadsData\n    ] = await Promise.all([\n      db.select().from(users),\n      db.select().from(documents),\n      db.select().from(favorites),\n      db.select().from(tags),\n      db.select().from(documentTags),\n      db.select().from(userUploads),\n      db.select().from(adminUploads)\n    ]);\n\n    const exportData = {\n      users: usersData,\n      documents: documentsData,\n      favorites: favoritesData,\n      tags: tagsData,\n      documentTags: documentTagsData,\n      userUploads: userUploadsData,\n      adminUploads: adminUploadsData,\n      exportedAt: new Date().toISOString(),\n      counts: {\n        users: usersData.length,\n        documents: documentsData.length,\n        favorites: favoritesData.length,\n        tags: tagsData.length,\n        documentTags: documentTagsData.length,\n        userUploads: userUploadsData.length,\n        adminUploads: adminUploadsData.length\n      }\n    };\n\n    await fs.writeFile(\n      path.join(exportDir, \"postgres-backup.json\"),\n      JSON.stringify(exportData, null, 2)\n    );\n\n    console.log(\"\\n‚úÖ Export completed successfully!\");\n    console.log(\"üìä Exported data:\");\n    console.log(`   - Users: ${exportData.counts.users}`);\n    console.log(`   - Documents: ${exportData.counts.documents}`);\n    console.log(`   - Favorites: ${exportData.counts.favorites}`);\n    console.log(`   - Tags: ${exportData.counts.tags}`);\n    console.log(`   - Document Tags: ${exportData.counts.documentTags}`);\n    console.log(`   - User Uploads: ${exportData.counts.userUploads}`);\n    console.log(`   - Admin Uploads: ${exportData.counts.adminUploads}`);\n    console.log(`\\nüìÅ Backup saved to: ${exportDir}/postgres-backup.json`);\n\n  } catch (error) {\n    console.error(\"‚ùå Export failed:\", error);\n    throw error;\n  } finally {\n    process.exit(0);\n  }\n}\n\nexportData();\n","path":null,"size_bytes":2390,"size_tokens":null},"server/scripts/promote-admin.ts":{"content":"import { connectMongoDB } from \"../mongodb\";\nimport { User } from \"../models\";\n\n/**\n * Script to promote a user to admin role\n * Usage: tsx server/scripts/promote-admin.ts <user-id>\n */\n\nasync function promoteUserToAdmin(userId: string) {\n  try {\n    console.log(`Connecting to MongoDB...`);\n    await connectMongoDB();\n    \n    console.log(`Looking up user: ${userId}`);\n    const user = await User.findById(userId);\n    \n    if (!user) {\n      console.error(`‚ùå User not found: ${userId}`);\n      process.exit(1);\n    }\n    \n    console.log(`Found user: ${user.email} (${user.firstName} ${user.lastName})`);\n    console.log(`Current role: ${user.role}`);\n    \n    if (user.role === \"admin\") {\n      console.log(`‚úÖ User is already an admin!`);\n      process.exit(0);\n    }\n    \n    console.log(`Promoting user to admin...`);\n    user.role = \"admin\";\n    await user.save();\n    \n    console.log(`‚úÖ Successfully promoted ${user.email} to admin!`);\n    console.log(`Please logout and login again to see the changes.`);\n    \n    process.exit(0);\n  } catch (error) {\n    console.error(\"Error promoting user:\", error);\n    process.exit(1);\n  }\n}\n\n// Get user ID from command line arguments\nconst userId = process.argv[2];\n\nif (!userId) {\n  console.error(\"Usage: tsx server/scripts/promote-admin.ts <user-id>\");\n  console.error(\"Example: tsx server/scripts/promote-admin.ts 47369284\");\n  process.exit(1);\n}\n\npromoteUserToAdmin(userId);\n","path":null,"size_bytes":1435,"size_tokens":null},"server/services/aiProcessor.ts":{"content":"import { extractTextFromFile } from \"./textExtractor\";\nimport { generateMetadataFromText } from \"./gemini\";\nimport type { MongoDBStorage } from \"../mongo-storage\";\n\nexport interface AIProcessingResult {\n  success: boolean;\n  metadata?: {\n    title: string;\n    description: string;\n    category: string;\n  };\n  error?: string;\n}\n\nexport async function processFileWithAI(\n  filePath: string,\n  mimeType: string,\n  uploadId: string,\n  uploadType: 'user' | 'admin',\n  storage: MongoDBStorage,\n  inputCategory?: string\n): Promise<AIProcessingResult> {\n  const logPrefix = `[AI-${uploadType === 'user' ? 'User' : 'Admin'}] Upload ${uploadId}:`;\n  \n  try {\n    console.log(`${logPrefix} Starting AI processing for ${filePath}${inputCategory ? ` (category: ${inputCategory})` : ''}`);\n\n    // Step 1: Extract text from file\n    console.log(`${logPrefix} Extracting text...`);\n    const extractionResult = await extractTextFromFile(filePath, mimeType);\n    \n    if (!extractionResult.success || !extractionResult.text) {\n      const errorMsg = extractionResult.error || \"Failed to extract text from file\";\n      console.error(`${logPrefix} Text extraction failed:`, errorMsg);\n      \n      // Update database with error\n      if (uploadType === 'user') {\n        await storage.updateUserUploadAIError(uploadId, errorMsg);\n      } else {\n        await storage.updateAdminUploadAIError(uploadId, errorMsg);\n      }\n      \n      return {\n        success: false,\n        error: errorMsg\n      };\n    }\n\n    console.log(`${logPrefix} Text extracted (${extractionResult.text.length} chars)`);\n\n    // Determine file type for context\n    const fileType = mimeType.includes('pdf') ? 'PDF' \n      : mimeType.includes('excel') || mimeType.includes('spreadsheet') ? 'Excel'\n      : mimeType.includes('csv') ? 'CSV'\n      : 'document';\n\n    // Step 2: Generate metadata using Gemini AI with category context\n    console.log(`${logPrefix} Generating metadata with Gemini AI...`);\n    const metadataResult = await generateMetadataFromText(extractionResult.text, fileType, inputCategory);\n    \n    if (!metadataResult.success || !metadataResult.metadata) {\n      const errorMsg = metadataResult.error || \"Failed to generate metadata\";\n      console.error(`${logPrefix} Metadata generation failed:`, errorMsg);\n      \n      // Update database with error\n      if (uploadType === 'user') {\n        await storage.updateUserUploadAIError(uploadId, errorMsg);\n      } else {\n        await storage.updateAdminUploadAIError(uploadId, errorMsg);\n      }\n      \n      return {\n        success: false,\n        error: errorMsg\n      };\n    }\n\n    const { title, description } = metadataResult.metadata;\n    // Use input category (admin-selected) or default to \"Kh√°c\"\n    const category = inputCategory || \"Kh√°c\";\n    \n    console.log(`${logPrefix} Metadata generated successfully:`);\n    console.log(`  - Title: ${title.substring(0, 50)}...`);\n    console.log(`  - Category: ${category}`);\n\n    // Step 3: Update upload record with AI-generated metadata\n    console.log(`${logPrefix} Updating database with AI metadata...`);\n    \n    if (uploadType === 'user') {\n      await storage.updateUserUploadMetadata(uploadId, { title, description, category });\n    } else {\n      await storage.updateAdminUploadMetadata(uploadId, { title, description, category });\n    }\n\n    console.log(`${logPrefix} ‚úÖ AI processing completed successfully!`);\n\n    return {\n      success: true,\n      metadata: { title, description, category }\n    };\n\n  } catch (error: any) {\n    const errorMsg = error.message || \"Unexpected error during AI processing\";\n    console.error(`${logPrefix} ‚ùå Unexpected error:`, errorMsg);\n    \n    // Update database with error\n    try {\n      if (uploadType === 'user') {\n        await storage.updateUserUploadAIError(uploadId, errorMsg);\n      } else {\n        await storage.updateAdminUploadAIError(uploadId, errorMsg);\n      }\n    } catch (dbError) {\n      console.error(`${logPrefix} Failed to update error in database:`, dbError);\n    }\n    \n    return {\n      success: false,\n      error: errorMsg\n    };\n  }\n}\n","path":null,"size_bytes":4099,"size_tokens":null},"server/scripts/test-gemini.ts":{"content":"import { testGeminiConnection, generateMetadataFromText } from \"../services/gemini\";\n\nasync function main() {\n  console.log(\"üß™ Testing Gemini AI Service...\\n\");\n\n  // Test 1: Connection test\n  console.log(\"üìù Test 1: Connection Test\");\n  const connectionOk = await testGeminiConnection();\n  \n  if (!connectionOk) {\n    console.error(\"\\n‚ùå Connection test failed. Stopping tests.\");\n    process.exit(1);\n  }\n\n  console.log(\"\\n\" + \"=\".repeat(60) + \"\\n\");\n\n  // Test 2: Vietnamese document\n  console.log(\"üìù Test 2: Vietnamese Document\");\n  const vietnameseTest = await generateMetadataFromText(\n    `H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng Microsoft Excel cho ng∆∞·ªùi m·ªõi b·∫Øt ƒë·∫ßu\n    \n    Microsoft Excel l√† ph·∫ßn m·ªÅm b·∫£ng t√≠nh m·∫°nh m·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng r·ªông r√£i trong c√°c doanh nghi·ªáp. \n    T√†i li·ªáu n√†y h∆∞·ªõng d·∫´n c√°c ch·ª©c nƒÉng c∆° b·∫£n nh∆∞:\n    - T·∫°o v√† ƒë·ªãnh d·∫°ng b·∫£ng t√≠nh\n    - S·ª≠ d·ª•ng c√¥ng th·ª©c v√† h√†m\n    - T·∫°o bi·ªÉu ƒë·ªì v√† ƒë·ªì th·ªã\n    - Ph√¢n t√≠ch d·ªØ li·ªáu v·ªõi Pivot Table\n    \n    Ph√π h·ª£p cho ng∆∞·ªùi m·ªõi h·ªçc Excel t·ª´ c∆° b·∫£n ƒë·∫øn n√¢ng cao.`,\n    \"Excel\"\n  );\n\n  if (vietnameseTest.success) {\n    console.log(\"‚úÖ Success!\");\n    console.log(\"Title:\", vietnameseTest.metadata?.title);\n    console.log(\"Description:\", vietnameseTest.metadata?.description);\n    console.log(\"Category:\", vietnameseTest.metadata?.category);\n  } else {\n    console.log(\"‚ùå Failed:\", vietnameseTest.error);\n  }\n\n  console.log(\"\\n\" + \"=\".repeat(60) + \"\\n\");\n\n  // Test 3: Business document\n  console.log(\"üìù Test 3: Business Document\");\n  const businessTest = await generateMetadataFromText(\n    `B√°o c√°o t√†i ch√≠nh qu√Ω 4 nƒÉm 2024\n    \n    T·ªïng quan:\n    - Doanh thu: 150 t·ª∑ VNƒê (tƒÉng 25% so v·ªõi c√πng k·ª≥)\n    - L·ª£i nhu·∫≠n sau thu·∫ø: 30 t·ª∑ VNƒê\n    - T·ªïng t√†i s·∫£n: 500 t·ª∑ VNƒê\n    \n    Ph√¢n t√≠ch:\n    C√¥ng ty ƒë√£ c√≥ s·ª± tƒÉng tr∆∞·ªüng ·∫•n t∆∞·ª£ng nh·ªù v√†o chi·∫øn l∆∞·ª£c m·ªü r·ªông th·ªã tr∆∞·ªùng \n    v√† c·∫£i thi·ªán hi·ªáu qu·∫£ ho·∫°t ƒë·ªông. C√°c ch·ªâ s·ªë t√†i ch√≠nh ƒë·ªÅu ƒë·∫°t m·ª•c ti√™u ƒë·ªÅ ra.`,\n    \"PDF\"\n  );\n\n  if (businessTest.success) {\n    console.log(\"‚úÖ Success!\");\n    console.log(\"Title:\", businessTest.metadata?.title);\n    console.log(\"Description:\", businessTest.metadata?.description);\n    console.log(\"Category:\", businessTest.metadata?.category);\n  } else {\n    console.log(\"‚ùå Failed:\", businessTest.error);\n  }\n\n  console.log(\"\\n‚úÖ All tests completed!\\n\");\n}\n\nmain().catch(console.error);\n","path":null,"size_bytes":2547,"size_tokens":null},"server/scripts/test-text-extraction.ts":{"content":"import { extractTextFromFile } from \"../services/textExtractor\";\nimport fs from \"fs/promises\";\nimport path from \"path\";\n\nasync function createTestCSV() {\n  const testDir = path.join(process.cwd(), \"test-files\");\n  await fs.mkdir(testDir, { recursive: true });\n  \n  const csvContent = `Name,Age,City,Occupation\nNguy·ªÖn VƒÉn A,25,H√† N·ªôi,K·ªπ s∆∞ ph·∫ßn m·ªÅm\nTr·∫ßn Th·ªã B,30,TP. H·ªì Ch√≠ Minh,Gi√°o vi√™n\nL√™ VƒÉn C,28,ƒê√† N·∫µng,B√°c sƒ©\nPh·∫°m Th·ªã D,35,H·∫£i Ph√≤ng,Lu·∫≠t s∆∞`;\n  \n  const csvPath = path.join(testDir, \"test.csv\");\n  await fs.writeFile(csvPath, csvContent, 'utf-8');\n  \n  return csvPath;\n}\n\nasync function main() {\n  console.log(\"üß™ Testing Text Extraction Service...\\n\");\n\n  // Test 1: CSV extraction\n  console.log(\"üìù Test 1: CSV Extraction\");\n  const csvPath = await createTestCSV();\n  const csvResult = await extractTextFromFile(csvPath, \"text/csv\");\n  \n  if (csvResult.success) {\n    console.log(\"‚úÖ CSV extraction successful!\");\n    console.log(\"Extracted text length:\", csvResult.text?.length);\n    console.log(\"Row count:\", csvResult.metadata?.rowCount);\n    console.log(\"\\nFirst 200 characters:\");\n    console.log(csvResult.text?.substring(0, 200));\n  } else {\n    console.log(\"‚ùå CSV extraction failed:\", csvResult.error);\n  }\n\n  console.log(\"\\n\" + \"=\".repeat(60) + \"\\n\");\n\n  // Test 2: Unsupported format\n  console.log(\"üìù Test 2: Unsupported File Type\");\n  const unsupportedResult = await extractTextFromFile(\"/tmp/test.txt\", \"text/plain\");\n  \n  if (!unsupportedResult.success) {\n    console.log(\"‚úÖ Correctly rejected unsupported file type\");\n    console.log(\"Error:\", unsupportedResult.error);\n  } else {\n    console.log(\"‚ùå Should have rejected unsupported file type\");\n  }\n\n  console.log(\"\\n‚úÖ Text extraction tests completed!\\n\");\n  \n  // Cleanup\n  await fs.rm(path.join(process.cwd(), \"test-files\"), { recursive: true, force: true });\n}\n\nmain().catch(console.error);\n","path":null,"size_bytes":1923,"size_tokens":null},"server/services/textExtractor.ts":{"content":"import fs from \"fs/promises\";\nimport path from \"path\";\nimport { createRequire } from \"module\";\nimport { parse as csvParse } from \"csv-parse/sync\";\n\n// pdf-parse and xlsx are CommonJS modules, need to use require in ESM\nconst require = createRequire(import.meta.url);\nconst pdfParse = require(\"pdf-parse\");\nconst XLSX = require(\"xlsx\");\n\nexport interface TextExtractionResult {\n  success: boolean;\n  text?: string;\n  error?: string;\n  metadata?: {\n    pageCount?: number;\n    sheetNames?: string[];\n    rowCount?: number;\n  };\n}\n\n/**\n * Extract text from PDF files using pdf-parse\n */\nasync function extractFromPDF(filePath: string): Promise<TextExtractionResult> {\n  try {\n    const dataBuffer = await fs.readFile(filePath);\n    const data = await pdfParse(dataBuffer);\n\n    if (!data.text || data.text.trim().length === 0) {\n      return {\n        success: false,\n        error: \"PDF file contains no extractable text. It may be image-based or encrypted.\",\n      };\n    }\n\n    return {\n      success: true,\n      text: data.text,\n      metadata: {\n        pageCount: data.numpages,\n      },\n    };\n  } catch (error: any) {\n    console.error(\"PDF extraction error:\", error);\n    return {\n      success: false,\n      error: `Failed to extract text from PDF: ${error.message}`,\n    };\n  }\n}\n\n/**\n * Extract text from Excel files (XLS, XLSX) using xlsx\n */\nasync function extractFromExcel(filePath: string): Promise<TextExtractionResult> {\n  try {\n    const workbook = XLSX.readFile(filePath);\n    const sheetNames = workbook.SheetNames;\n\n    if (sheetNames.length === 0) {\n      return {\n        success: false,\n        error: \"Excel file contains no sheets.\",\n      };\n    }\n\n    // Extract text from all sheets\n    const textParts: string[] = [];\n    let totalRows = 0;\n\n    for (const sheetName of sheetNames) {\n      const worksheet = workbook.Sheets[sheetName];\n      \n      // Convert sheet to JSON to get structured data\n      const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });\n      totalRows += jsonData.length;\n\n      // Add sheet name as header\n      textParts.push(`\\n=== Sheet: ${sheetName} ===\\n`);\n\n      // Convert rows to text\n      for (const row of jsonData as any[]) {\n        if (Array.isArray(row) && row.length > 0) {\n          const rowText = row\n            .filter(cell => cell !== null && cell !== undefined && cell !== '')\n            .join(' | ');\n          \n          if (rowText.trim()) {\n            textParts.push(rowText);\n          }\n        }\n      }\n    }\n\n    const extractedText = textParts.join('\\n').trim();\n\n    if (!extractedText || extractedText.length === 0) {\n      return {\n        success: false,\n        error: \"Excel file contains no extractable data.\",\n      };\n    }\n\n    return {\n      success: true,\n      text: extractedText,\n      metadata: {\n        sheetNames,\n        rowCount: totalRows,\n      },\n    };\n  } catch (error: any) {\n    console.error(\"Excel extraction error:\", error);\n    return {\n      success: false,\n      error: `Failed to extract text from Excel: ${error.message}`,\n    };\n  }\n}\n\n/**\n * Extract text from CSV files using csv-parse\n */\nasync function extractFromCSV(filePath: string): Promise<TextExtractionResult> {\n  try {\n    const fileContent = await fs.readFile(filePath, 'utf-8');\n\n    // Parse CSV\n    const records = csvParse(fileContent, {\n      skip_empty_lines: true,\n      trim: true,\n      relax_column_count: true, // Allow varying column counts\n    });\n\n    if (!records || records.length === 0) {\n      return {\n        success: false,\n        error: \"CSV file contains no data.\",\n      };\n    }\n\n    // Convert CSV data to text\n    const textParts: string[] = [];\n    \n    for (const row of records) {\n      if (Array.isArray(row) && row.length > 0) {\n        const rowText = row\n          .filter((cell: any) => cell !== null && cell !== undefined && cell !== '')\n          .join(' | ');\n        \n        if (rowText.trim()) {\n          textParts.push(rowText);\n        }\n      }\n    }\n\n    const extractedText = textParts.join('\\n').trim();\n\n    if (!extractedText || extractedText.length === 0) {\n      return {\n        success: false,\n        error: \"CSV file contains no extractable data.\",\n      };\n    }\n\n    return {\n      success: true,\n      text: extractedText,\n      metadata: {\n        rowCount: records.length,\n      },\n    };\n  } catch (error: any) {\n    console.error(\"CSV extraction error:\", error);\n    return {\n      success: false,\n      error: `Failed to extract text from CSV: ${error.message}`,\n    };\n  }\n}\n\n/**\n * Extract text from a file based on its MIME type\n * Supports: PDF, Excel (XLS, XLSX), CSV\n */\nexport async function extractTextFromFile(\n  filePath: string,\n  mimeType: string\n): Promise<TextExtractionResult> {\n  console.log(`üìÑ Extracting text from: ${path.basename(filePath)} (${mimeType})`);\n\n  // Verify file exists\n  try {\n    await fs.access(filePath);\n  } catch (error) {\n    return {\n      success: false,\n      error: `File not found: ${filePath}`,\n    };\n  }\n\n  // Route to appropriate extractor based on MIME type\n  if (mimeType === \"application/pdf\") {\n    return await extractFromPDF(filePath);\n  } \n  else if (\n    mimeType === \"application/vnd.ms-excel\" || \n    mimeType === \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\"\n  ) {\n    return await extractFromExcel(filePath);\n  } \n  else if (mimeType === \"text/csv\") {\n    return await extractFromCSV(filePath);\n  } \n  else {\n    return {\n      success: false,\n      error: `Unsupported file type: ${mimeType}. Supported types: PDF, Excel (XLS/XLSX), CSV`,\n    };\n  }\n}\n\n/**\n * Extract text with file size limit check (to prevent memory issues)\n */\nexport async function extractTextWithSizeCheck(\n  filePath: string,\n  mimeType: string,\n  maxSizeMB: number = 50\n): Promise<TextExtractionResult> {\n  try {\n    const stats = await fs.stat(filePath);\n    const fileSizeMB = stats.size / (1024 * 1024);\n\n    if (fileSizeMB > maxSizeMB) {\n      return {\n        success: false,\n        error: `File too large (${fileSizeMB.toFixed(2)}MB). Maximum size: ${maxSizeMB}MB`,\n      };\n    }\n\n    return await extractTextFromFile(filePath, mimeType);\n  } catch (error: any) {\n    return {\n      success: false,\n      error: `Failed to check file size: ${error.message}`,\n    };\n  }\n}\n","path":null,"size_bytes":6306,"size_tokens":null},"server/mongodb.ts":{"content":"import mongoose from \"mongoose\";\nimport MongoStore from \"connect-mongo\";\nimport session from \"express-session\";\nimport type { SessionOptions } from \"express-session\";\n\nconst MONGO_URI = process.env.MONGO_URI;\nconst USE_MONGO = process.env.USE_MONGO !== \"false\";\n\nexport async function connectMongoDB(retries = 3, retryDelay = 2000): Promise<boolean> {\n  if (!USE_MONGO) {\n    console.log(\"‚ö†Ô∏è  MongoDB disabled via USE_MONGO=false - using in-memory storage\");\n    return false;\n  }\n\n  if (!MONGO_URI) {\n    console.warn(\"‚ö†Ô∏è  MONGO_URI not configured - falling back to in-memory storage\");\n    return false;\n  }\n\n  for (let i = 0; i < retries; i++) {\n    try {\n      await mongoose.connect(MONGO_URI, {\n        serverSelectionTimeoutMS: 5000,\n        connectTimeoutMS: 10000,\n      });\n      console.log(\"‚úÖ MongoDB connected successfully\");\n      return true;\n    } catch (error) {\n      console.error(`‚ùå MongoDB connection attempt ${i + 1}/${retries} failed:`, error instanceof Error ? error.message : error);\n      \n      if (i === retries - 1) {\n        console.error(\"‚ö†Ô∏è  MongoDB connection failed after all retries\");\n        console.error(\"‚ö†Ô∏è  This may be due to IP whitelisting in MongoDB Atlas\");\n        console.error(\"‚ö†Ô∏è  Please check: https://www.mongodb.com/docs/atlas/security-whitelist/\");\n        console.error(\"‚ö†Ô∏è  Falling back to IN-MEMORY storage (data not persisted)\");\n        return false;\n      }\n      \n      await new Promise(resolve => setTimeout(resolve, retryDelay));\n    }\n  }\n  \n  return false;\n}\n\nmongoose.connection.on(\"error\", (error) => {\n  console.error(\"MongoDB connection error:\", error);\n});\n\nmongoose.connection.on(\"disconnected\", () => {\n  console.warn(\"MongoDB disconnected\");\n});\n\nexport function createSessionStore(mongoConnected: boolean): SessionOptions[\"store\"] {\n  if (mongoConnected && MONGO_URI) {\n    console.log(\"‚úÖ Using MongoDB session store\");\n    return MongoStore.create({\n      mongoUrl: MONGO_URI,\n      collectionName: \"sessions\",\n      ttl: 7 * 24 * 60 * 60,\n      autoRemove: \"native\",\n      touchAfter: 24 * 3600,\n      // Removed crypto encryption to avoid decryption errors with old sessions\n      // Sessions are still secure via httpOnly cookies and SESSION_SECRET\n    });\n  } else {\n    console.log(\"‚ö†Ô∏è  Using in-memory session store (sessions lost on restart)\");\n    return new session.MemoryStore();\n  }\n}\n\nexport { mongoose };\n","path":null,"size_bytes":2427,"size_tokens":null},"client/src/components/SEOHead.tsx":{"content":"import { useEffect } from \"react\";\n\ninterface SEOHeadProps {\n  title: string;\n  description: string;\n  keywords?: string;\n  imageUrl?: string;\n  url?: string;\n  type?: \"website\" | \"article\" | \"video.other\";\n}\n\nexport function SEOHead({ \n  title, \n  description, \n  keywords,\n  imageUrl,\n  url,\n  type = \"article\"\n}: SEOHeadProps) {\n  useEffect(() => {\n    const fullTitle = `${title} - Th∆∞ Vi·ªán T√†i Li·ªáu`;\n    const previousTitle = document.title;\n    \n    document.title = fullTitle;\n    \n    const metaTags: Record<string, string> = {\n      description: description,\n      \"og:title\": fullTitle,\n      \"og:description\": description,\n      \"og:type\": type,\n      \"twitter:card\": \"summary_large_image\",\n      \"twitter:title\": fullTitle,\n      \"twitter:description\": description,\n    };\n\n    if (keywords) {\n      metaTags.keywords = keywords;\n    }\n\n    if (imageUrl) {\n      metaTags[\"og:image\"] = imageUrl;\n      metaTags[\"twitter:image\"] = imageUrl;\n    }\n\n    if (url) {\n      metaTags[\"og:url\"] = url;\n    }\n\n    const createdMetaTags: HTMLMetaElement[] = [];\n    const previousMetaValues: Map<string, string> = new Map();\n\n    Object.entries(metaTags).forEach(([name, content]) => {\n      let meta = document.querySelector<HTMLMetaElement>(`meta[name=\"${name}\"], meta[property=\"${name}\"]`);\n      \n      if (!meta) {\n        meta = document.createElement(\"meta\");\n        if (name.startsWith(\"og:\")) {\n          meta.setAttribute(\"property\", name);\n        } else {\n          meta.setAttribute(\"name\", name);\n        }\n        document.head.appendChild(meta);\n        createdMetaTags.push(meta);\n      } else {\n        const previousValue = meta.getAttribute(\"content\") || \"\";\n        previousMetaValues.set(name, previousValue);\n      }\n      \n      meta.setAttribute(\"content\", content);\n    });\n\n    return () => {\n      document.title = previousTitle;\n      \n      createdMetaTags.forEach((meta) => {\n        meta.remove();\n      });\n      \n      previousMetaValues.forEach((value, name) => {\n        const meta = document.querySelector<HTMLMetaElement>(`meta[name=\"${name}\"], meta[property=\"${name}\"]`);\n        if (meta) {\n          if (value) {\n            meta.setAttribute(\"content\", value);\n          } else {\n            meta.remove();\n          }\n        }\n      });\n    };\n  }, [title, description, keywords, imageUrl, url, type]);\n\n  return null;\n}\n","path":null,"size_bytes":2375,"size_tokens":null},"server/services/gemini.ts":{"content":"import { GoogleGenerativeAI } from \"@google/generative-ai\";\n\nlet genAI: GoogleGenerativeAI | null = null;\n\nfunction getGenAI(): GoogleGenerativeAI | null {\n  if (genAI) return genAI;\n  \n  const GOOGLE_API_KEY = process.env.GOOGLE_API_KEY;\n  \n  if (!GOOGLE_API_KEY) {\n    console.warn(\"‚ö†Ô∏è  GOOGLE_API_KEY not found. AI metadata generation will be disabled.\");\n    return null;\n  }\n  \n  genAI = new GoogleGenerativeAI(GOOGLE_API_KEY);\n  return genAI;\n}\n\nexport interface GeneratedMetadata {\n  title: string;\n  description: string;\n}\n\nexport interface AIGenerationResult {\n  success: boolean;\n  metadata?: GeneratedMetadata;\n  error?: string;\n}\n\n/**\n * Build system prompt with category context for better SEO optimization\n */\nfunction buildSystemPrompt(category?: string): string {\n  const categoryContext = category \n    ? `\\n\\nDANH M·ª§C D·ªÆ LI·ªÜU: \"${category}\"\nƒê√¢y l√† d·ªØ li·ªáu kh√°ch h√†ng thu·ªôc lƒ©nh v·ª±c \"${category}\". H√£y t·∫°o ti√™u ƒë·ªÅ v√† m√¥ t·∫£ ph√π h·ª£p v·ªõi ƒë·∫∑c th√π c·ªßa ng√†nh ${category}, s·ª≠ d·ª•ng c√°c t·ª´ kh√≥a SEO li√™n quan ƒë·∫øn lƒ©nh v·ª±c n√†y.\n\nG·ª£i √Ω t·ª´ kh√≥a theo danh m·ª•c:\n- Casino: data casino, danh s√°ch kh√°ch VIP casino, d·ªØ li·ªáu c∆∞·ª£c, ng∆∞·ªùi ch∆°i casino\n- Doanh Nghi·ªáp: data doanh nghi·ªáp, danh s√°ch c√¥ng ty, th√¥ng tin doanh nghi·ªáp, CEO, gi√°m ƒë·ªëc\n- B·∫•t ƒê·ªông S·∫£n: data b·∫•t ƒë·ªông s·∫£n, kh√°ch h√†ng mua nh√†, nh√† ƒë·∫ßu t∆∞ BƒêS, m√¥i gi·ªõi\n- Ng√¢n H√†ng: data ng√¢n h√†ng, kh√°ch h√†ng vay, t√≠n d·ª•ng, th·∫ª ng√¢n h√†ng\n- B·∫£o Hi·ªÉm: data b·∫£o hi·ªÉm, kh√°ch h√†ng b·∫£o hi·ªÉm, h·ª£p ƒë·ªìng b·∫£o hi·ªÉm\n- Email: danh s√°ch email, email marketing, data email kh√°ch h√†ng\n- Kh√°c: data kh√°ch h√†ng, danh s√°ch kh√°ch h√†ng, th√¥ng tin li√™n h·ªá`\n    : '';\n\n  return `B·∫°n l√† m·ªôt chuy√™n gia ph√¢n t√≠ch t√†i li·ªáu ti·∫øng Vi·ªát v√† SEO chuy√™n v·ªÅ d·ªØ li·ªáu kh√°ch h√†ng. Nhi·ªám v·ª• c·ªßa b·∫°n l√† ƒë·ªçc n·ªôi dung t√†i li·ªáu v√† t·∫°o ti√™u ƒë·ªÅ, m√¥ t·∫£ chu·∫©n SEO cho th∆∞ vi·ªán t√†i li·ªáu data kh√°ch h√†ng.${categoryContext}\n\nH√£y tr·∫£ v·ªÅ JSON v·ªõi format sau (CH√çNH X√ÅC, kh√¥ng th√™m markdown ho·∫∑c text kh√°c):\n{\n  \"title\": \"Ti√™u ƒë·ªÅ ng·∫Øn g·ªçn, c√≥ k√®m t·ª´ kh√≥a SEO (t·ªëi ƒëa 100 k√Ω t·ª±)\",\n  \"description\": \"M√¥ t·∫£ chi ti·∫øt n·ªôi dung t√†i li·ªáu, c√≥ k√®m t·ª´ kh√≥a SEO (200-300 k√Ω t·ª±)\"\n}\n\nL∆∞u √Ω:\n- Title: Ng·∫Øn g·ªçn, thu h√∫t, bao g·ªìm t·ª´ kh√≥a \"data\" ho·∫∑c \"d·ªØ li·ªáu\" + lƒ©nh v·ª±c c·ª• th·ªÉ, ph·∫£n √°nh ch√≠nh x√°c n·ªôi dung\n- Description: M√¥ t·∫£ r√µ r√†ng v·ªÅ lo·∫°i data, s·ªë l∆∞·ª£ng (n·∫øu c√≥), ch·∫•t l∆∞·ª£ng d·ªØ li·ªáu, v√† l·ª£i √≠ch khi s·ª≠ d·ª•ng\n- S·ª≠ d·ª•ng ng√¥n ng·ªØ chuy√™n nghi·ªáp, h∆∞·ªõng ƒë·∫øn kh√°ch h√†ng B2B\n- QUAN TR·ªåNG: KH√îNG ƒê∆Ø·ª¢C ti·∫øt l·ªô ngu·ªìn d·ªØ li·ªáu trong Ti√™u ƒë·ªÅ v√† M√¥ t·∫£ (v√≠ d·ª•: kh√¥ng ƒë·ªÅ c·∫≠p t√™n c√¥ng ty, t·ªï ch·ª©c, website, ·ª©ng d·ª•ng n∆°i d·ªØ li·ªáu ƒë∆∞·ª£c thu th·∫≠p)\n- QUAN TR·ªåNG: KH√îNG ƒê∆Ø·ª¢C ti·∫øt l·ªô d·ªØ li·ªáu ƒë∆∞·ª£c l·∫•y t·ª´ ƒë√¢u trong Ti√™u ƒë·ªÅ v√† M√¥ t·∫£ (v√≠ d·ª•: kh√¥ng n√≥i \"l·∫•y t·ª´ Facebook\", \"thu th·∫≠p t·ª´ Zalo\", \"t·ª´ website X\")\n- QUAN TR·ªåNG: KH√îNG ƒê∆Ø·ª¢C s·ª≠ d·ª•ng c√°c t·ª´ ng·ªØ li√™n quan ƒë·∫øn vi·ªác mua b√°n, cung c·∫•p d·ªØ li·ªáu kh√°ch h√†ng (v√≠ d·ª•: kh√¥ng d√πng \"mua data\", \"b√°n data\", \"cung c·∫•p d·ªØ li·ªáu\", \"mua d·ªØ li·ªáu kh√°ch h√†ng\", \"b√°n th√¥ng tin\", \"kinh doanh data\")\n- Tr·∫£ v·ªÅ CH√çNH X√ÅC format JSON, kh√¥ng th√™m markdown ho·∫∑c gi·∫£i th√≠ch`;\n}\n\n/**\n * Extract text preview from content (first 4000 characters)\n * This ensures we don't exceed Gemini's context limits\n */\nfunction extractTextPreview(content: string): string {\n  const MAX_CHARS = 4000;\n  if (content.length <= MAX_CHARS) {\n    return content;\n  }\n  return content.substring(0, MAX_CHARS) + \"\\n\\n[... n·ªôi dung c√≤n l·∫°i ƒë√£ ƒë∆∞·ª£c c·∫Øt b·ªõt ƒë·ªÉ ph√¢n t√≠ch ...]\";\n}\n\n/**\n * Retry function with exponential backoff\n */\nasync function retryWithBackoff<T>(\n  fn: () => Promise<T>,\n  maxRetries: number = 3,\n  initialDelayMs: number = 1000\n): Promise<T> {\n  let lastError: Error | null = null;\n  \n  for (let attempt = 0; attempt < maxRetries; attempt++) {\n    try {\n      return await fn();\n    } catch (error: any) {\n      lastError = error;\n      \n      // Don't retry on certain errors\n      if (error.message?.includes(\"API key\") || error.message?.includes(\"quota\")) {\n        throw error;\n      }\n      \n      // If not last attempt, wait and retry\n      if (attempt < maxRetries - 1) {\n        const delay = initialDelayMs * Math.pow(2, attempt);\n        console.log(`‚è≥ Retry attempt ${attempt + 1}/${maxRetries} after ${delay}ms...`);\n        await new Promise(resolve => setTimeout(resolve, delay));\n      }\n    }\n  }\n  \n  throw lastError;\n}\n\n/**\n * Generate metadata from document text content using Gemini AI\n * @param content - Text content extracted from the document\n * @param fileType - Type of file (PDF, Excel, CSV) for context\n * @param category - Category of the document for better SEO optimization\n * @returns AIGenerationResult with metadata or error\n */\nexport async function generateMetadataFromText(\n  content: string,\n  fileType: string = \"document\",\n  category?: string\n): Promise<AIGenerationResult> {\n  const ai = getGenAI();\n  if (!ai) {\n    return {\n      success: false,\n      error: \"Google API key not configured. AI metadata generation is disabled.\",\n    };\n  }\n\n  try {\n    console.log(`ü§ñ Starting AI metadata generation for ${fileType}${category ? ` (category: ${category})` : ''}...`);\n    \n    // Validate input\n    if (!content || content.trim().length === 0) {\n      return {\n        success: false,\n        error: \"Content is empty. Cannot generate metadata from empty content.\",\n      };\n    }\n\n    // Extract preview to avoid context limits\n    const textPreview = extractTextPreview(content);\n    \n    // Build system prompt with category context\n    const systemPrompt = buildSystemPrompt(category);\n    \n    // Create user prompt with category hint\n    const categoryHint = category ? ` thu·ªôc danh m·ª•c \"${category}\"` : '';\n    const userPrompt = `Ph√¢n t√≠ch t√†i li·ªáu ${fileType}${categoryHint} sau v√† t·∫°o metadata SEO:\\n\\n${textPreview}`;\n\n    // Call Gemini API with retry\n    const model = ai.getGenerativeModel({ model: \"gemini-2.5-pro\" });\n    \n    const result = await retryWithBackoff(async () => {\n      const response = await model.generateContent([\n        { text: systemPrompt },\n        { text: userPrompt }\n      ]);\n      return response.response;\n    });\n\n    const responseText = result.text();\n    console.log(\"üìù Gemini response:\", responseText);\n\n    // Parse JSON response\n    let metadata: GeneratedMetadata;\n    try {\n      // Remove markdown code blocks if present\n      const cleanedText = responseText\n        .replace(/```json\\s*/g, '')\n        .replace(/```\\s*/g, '')\n        .trim();\n      \n      metadata = JSON.parse(cleanedText);\n    } catch (parseError: any) {\n      console.error(\"‚ùå JSON parse error:\", parseError.message);\n      return {\n        success: false,\n        error: `Failed to parse AI response as JSON: ${parseError.message}`,\n      };\n    }\n\n    // Validate metadata structure\n    if (!metadata.title || !metadata.description) {\n      return {\n        success: false,\n        error: \"AI response missing required fields (title or description)\",\n      };\n    }\n\n    // Truncate if needed\n    metadata.title = metadata.title.substring(0, 200);\n    metadata.description = metadata.description.substring(0, 500);\n\n    console.log(\"‚úÖ AI metadata generated successfully:\", metadata);\n\n    return {\n      success: true,\n      metadata,\n    };\n\n  } catch (error: any) {\n    console.error(\"‚ùå Gemini AI error:\", error);\n    \n    // Provide user-friendly error messages\n    let errorMessage = \"Failed to generate metadata using AI\";\n    if (error.message) {\n      if (error.message.includes(\"API key\")) {\n        errorMessage = \"Invalid Google API key\";\n      } else if (error.message.includes(\"quota\")) {\n        errorMessage = \"API quota exceeded. Please try again later.\";\n      } else if (error.message.includes(\"timeout\")) {\n        errorMessage = \"AI request timed out. Please try again.\";\n      } else {\n        errorMessage = `AI error: ${error.message}`;\n      }\n    }\n\n    return {\n      success: false,\n      error: errorMessage,\n    };\n  }\n}\n\n/**\n * Test function to verify Gemini API connection\n */\nexport async function testGeminiConnection(): Promise<boolean> {\n  const ai = getGenAI();\n  if (!ai) {\n    console.error(\"‚ùå Google API key not configured\");\n    return false;\n  }\n\n  try {\n    const testResult = await generateMetadataFromText(\n      \"ƒê√¢y l√† m·ªôt t√†i li·ªáu test v·ªÅ c√¥ng ngh·ªá th√¥ng tin v√† l·∫≠p tr√¨nh.\",\n      \"PDF\"\n    );\n    \n    if (testResult.success) {\n      console.log(\"‚úÖ Gemini AI connection test successful!\");\n      return true;\n    } else {\n      console.error(\"‚ùå Gemini AI test failed:\", testResult.error);\n      return false;\n    }\n  } catch (error: any) {\n    console.error(\"‚ùå Gemini AI connection test error:\", error.message);\n    return false;\n  }\n}\n","path":null,"size_bytes":9144,"size_tokens":null},"server/models/index.ts":{"content":"import mongoose, { Schema, Document } from \"mongoose\";\n\nexport interface IUser extends Document {\n  _id: string;\n  email: string;\n  firstName?: string;\n  lastName?: string;\n  profileImageUrl?: string;\n  role: \"admin\" | \"user\";\n  points: number;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\nexport interface IDocumentImage {\n  sheet: string;\n  page: number;\n  url: string;\n}\n\nexport interface IDocument extends Document {\n  _id: string;\n  postId: string;\n  title: string;\n  description: string;\n  category: string;\n  pageCount: number;\n  pointsCost: number;\n  coverImageUrl: string;\n  imageUrls: IDocumentImage[];\n  viewCount: number;\n  favoriteCount: number;\n  aiGenerated: boolean;\n  aiGeneratedAt?: Date;\n  originalFileName?: string;\n  parentPostId?: string;\n  postIndex?: number;\n  totalParts?: number;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\nexport interface IFavorite extends Document {\n  _id: string;\n  userId: string;\n  documentId: string;\n  createdAt: Date;\n}\n\nexport interface ITag extends Document {\n  _id: string;\n  name: string;\n  createdAt: Date;\n}\n\nexport interface IDocumentTag extends Document {\n  _id: string;\n  documentId: string;\n  tagId: string;\n  createdAt: Date;\n}\n\nexport interface IUserUpload extends Document {\n  _id: string;\n  userId: string;\n  slot: number;\n  fileName: string;\n  fileType: string;\n  filePath: string;\n  fileSize: number;\n  fileHash?: string;\n  approvalStatus: \"pending\" | \"approved\" | \"rejected\";\n  reviewedBy?: string;\n  reviewedAt?: Date;\n  approvedCategory?: string;\n  pipelineStatus: \"not_started\" | \"processing\" | \"completed\" | \"failed\" | \"skipped\";\n  pipelineStartedAt?: Date;\n  pipelineCompletedAt?: Date;\n  aiStatus?: \"pending\" | \"processing\" | \"completed\" | \"failed\";\n  aiError?: string;\n  aiGeneratedTitle?: string;\n  aiGeneratedDescription?: string;\n  aiGeneratedCategory?: string;\n  aiGeneratedAt?: Date;\n  uploadedAt: Date;\n}\n\nexport interface IAdminUpload extends Document {\n  _id: string;\n  uploadedBy: string;\n  fileName: string;\n  fileType: string;\n  filePath: string;\n  fileSize: number;\n  fileHash?: string;\n  category?: string;\n  pipelineStatus: \"pending\" | \"processing\" | \"completed\" | \"failed\";\n  pipelineError?: string;\n  pipelineStartedAt?: Date;\n  pipelineCompletedAt?: Date;\n  aiStatus?: \"pending\" | \"processing\" | \"completed\" | \"failed\";\n  aiError?: string;\n  aiGeneratedTitle?: string;\n  aiGeneratedDescription?: string;\n  aiGeneratedCategory?: string;\n  aiGeneratedAt?: Date;\n  uploadedAt: Date;\n}\n\nexport interface ICategory extends Document {\n  _id: string;\n  name: string;\n  logoUrl?: string;\n  order: number;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\nexport interface ISubcategory extends Document {\n  _id: string;\n  name: string;\n  categoryId: string;\n  order: number;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\nexport interface IChatConversation extends Document {\n  _id: string;\n  \n  userId?: string;\n  guestId?: string;\n  guestName?: string;\n  guestEmail?: string;\n  \n  status: \"active\" | \"closed\";\n  unreadByAdmin: number;\n  unreadByUser: number;\n  lastMessageAt: Date;\n  lastMessagePreview?: string;\n  \n  createdAt: Date;\n  updatedAt: Date;\n}\n\nexport interface IChatMessage extends Document {\n  _id: string;\n  conversationId: string;\n  \n  senderType: \"user\" | \"admin\" | \"system\";\n  senderId?: string;\n  senderName?: string;\n  \n  content: string;\n  isRead: boolean;\n  \n  createdAt: Date;\n}\n\nexport interface INotification extends Document {\n  _id: string;\n  title: string;\n  content: string;\n  type: \"all\" | \"single\";\n  targetUserId?: string;\n  senderId: string;\n  senderName?: string;\n  isRead: boolean;\n  createdAt: Date;\n}\n\nexport interface INotificationRead extends Document {\n  _id: string;\n  notificationId: string;\n  userId: string;\n  readAt: Date;\n}\n\nexport interface IPointsAuditLog extends Document {\n  _id: string;\n  userId: string;\n  adminId: string;\n  adminEmail: string;\n  previousPoints: number;\n  newPoints: number;\n  changeAmount: number;\n  reason: string;\n  ipAddress?: string;\n  userAgent?: string;\n  createdAt: Date;\n}\n\nconst UserSchema = new Schema<IUser>({\n  _id: { type: String, required: true },\n  email: { type: String, required: true, unique: true },\n  firstName: String,\n  lastName: String,\n  profileImageUrl: String,\n  role: { type: String, enum: [\"admin\", \"user\"], default: \"user\" },\n  points: { type: Number, default: 0 },\n  createdAt: { type: Date, default: Date.now },\n  updatedAt: { type: Date, default: Date.now }\n});\n\nconst DocumentImageSchema = new Schema({\n  sheet: { type: String, required: true },\n  page: { type: Number, required: true },\n  url: { type: String, required: true }\n}, { _id: false });\n\nconst DocumentSchema = new Schema<IDocument>({\n  _id: { type: String, required: true },\n  postId: { type: String, required: true, unique: true },\n  title: { type: String, required: true },\n  description: { type: String, required: true },\n  category: { type: String, required: true },\n  pageCount: { type: Number, required: true },\n  pointsCost: { type: Number, default: 0 },\n  coverImageUrl: { type: String, required: true },\n  imageUrls: { type: [DocumentImageSchema], default: [] },\n  viewCount: { type: Number, default: 0 },\n  favoriteCount: { type: Number, default: 0 },\n  aiGenerated: { type: Boolean, default: false },\n  aiGeneratedAt: Date,\n  originalFileName: String,\n  parentPostId: String,\n  postIndex: Number,\n  totalParts: Number,\n  createdAt: { type: Date, default: Date.now },\n  updatedAt: { type: Date, default: Date.now }\n});\n\nconst FavoriteSchema = new Schema<IFavorite>({\n  _id: { type: String, required: true },\n  userId: { type: String, required: true, ref: \"User\" },\n  documentId: { type: String, required: true, ref: \"Document\" },\n  createdAt: { type: Date, default: Date.now }\n});\n\nFavoriteSchema.index({ userId: 1, documentId: 1 }, { unique: true });\n\nconst TagSchema = new Schema<ITag>({\n  _id: { type: String, required: true },\n  name: { type: String, required: true, unique: true },\n  createdAt: { type: Date, default: Date.now }\n});\n\nconst DocumentTagSchema = new Schema<IDocumentTag>({\n  _id: { type: String, required: true },\n  documentId: { type: String, required: true, ref: \"Document\" },\n  tagId: { type: String, required: true, ref: \"Tag\" },\n  createdAt: { type: Date, default: Date.now }\n});\n\nDocumentTagSchema.index({ documentId: 1, tagId: 1 }, { unique: true });\n\nconst UserUploadSchema = new Schema<IUserUpload>({\n  _id: { type: String, required: true },\n  userId: { type: String, required: true, ref: \"User\" },\n  slot: { type: Number, required: true, min: 1, max: 10 },\n  fileName: { type: String, required: true },\n  fileType: { type: String, required: true },\n  filePath: { type: String, required: true },\n  fileSize: { type: Number, required: true },\n  fileHash: { type: String, index: true },\n  approvalStatus: { \n    type: String, \n    enum: [\"pending\", \"approved\", \"rejected\"], \n    default: \"pending\" \n  },\n  reviewedBy: { type: String, ref: \"User\" },\n  reviewedAt: Date,\n  approvedCategory: String,\n  pipelineStatus: { \n    type: String, \n    enum: [\"not_started\", \"processing\", \"completed\", \"failed\", \"skipped\"], \n    default: \"not_started\" \n  },\n  pipelineStartedAt: Date,\n  pipelineCompletedAt: Date,\n  aiStatus: { \n    type: String, \n    enum: [\"pending\", \"processing\", \"completed\", \"failed\"] \n  },\n  aiError: String,\n  aiGeneratedTitle: String,\n  aiGeneratedDescription: String,\n  aiGeneratedCategory: String,\n  aiGeneratedAt: Date,\n  uploadedAt: { type: Date, default: Date.now }\n});\n\nUserUploadSchema.index({ userId: 1, slot: 1 }, { unique: true });\n\nconst AdminUploadSchema = new Schema<IAdminUpload>({\n  _id: { type: String, required: true },\n  uploadedBy: { type: String, required: true, ref: \"User\" },\n  fileName: { type: String, required: true },\n  fileType: { type: String, required: true },\n  filePath: { type: String, required: true },\n  fileSize: { type: Number, required: true },\n  fileHash: { type: String, index: true },\n  category: String,\n  pipelineStatus: { \n    type: String, \n    enum: [\"pending\", \"processing\", \"completed\", \"failed\"], \n    default: \"pending\" \n  },\n  pipelineError: String,\n  pipelineStartedAt: Date,\n  pipelineCompletedAt: Date,\n  aiStatus: { \n    type: String, \n    enum: [\"pending\", \"processing\", \"completed\", \"failed\"] \n  },\n  aiError: String,\n  aiGeneratedTitle: String,\n  aiGeneratedDescription: String,\n  aiGeneratedCategory: String,\n  aiGeneratedAt: Date,\n  uploadedAt: { type: Date, default: Date.now }\n});\n\nconst CategorySchema = new Schema<ICategory>({\n  _id: { type: String, required: true },\n  name: { type: String, required: true, unique: true },\n  logoUrl: String,\n  order: { type: Number, required: true },\n  createdAt: { type: Date, default: Date.now },\n  updatedAt: { type: Date, default: Date.now }\n});\n\nconst SubcategorySchema = new Schema<ISubcategory>({\n  _id: { type: String, required: true },\n  name: { type: String, required: true },\n  categoryId: { type: String, required: true, ref: \"Category\" },\n  order: { type: Number, required: true },\n  createdAt: { type: Date, default: Date.now },\n  updatedAt: { type: Date, default: Date.now }\n});\n\nSubcategorySchema.index({ categoryId: 1, name: 1 }, { unique: true });\n\nconst ChatConversationSchema = new Schema<IChatConversation>({\n  _id: { type: String, required: true },\n  userId: { type: String, ref: \"User\" },\n  guestId: String,\n  guestName: String,\n  guestEmail: String,\n  status: { type: String, enum: [\"active\", \"closed\"], default: \"active\" },\n  unreadByAdmin: { type: Number, default: 0 },\n  unreadByUser: { type: Number, default: 0 },\n  lastMessageAt: { type: Date, default: Date.now },\n  lastMessagePreview: String,\n  createdAt: { type: Date, default: Date.now },\n  updatedAt: { type: Date, default: Date.now }\n});\n\nChatConversationSchema.index({ userId: 1 });\nChatConversationSchema.index({ guestId: 1 });\nChatConversationSchema.index({ status: 1, lastMessageAt: -1 });\n\nconst ChatMessageSchema = new Schema<IChatMessage>({\n  _id: { type: String, required: true },\n  conversationId: { type: String, required: true, ref: \"ChatConversation\" },\n  senderType: { type: String, enum: [\"user\", \"admin\", \"system\"], required: true },\n  senderId: String,\n  senderName: String,\n  content: { type: String, required: true },\n  isRead: { type: Boolean, default: false },\n  createdAt: { type: Date, default: Date.now }\n});\n\nChatMessageSchema.index({ conversationId: 1, createdAt: 1 });\n\nconst NotificationSchema = new Schema<INotification>({\n  _id: { type: String, required: true },\n  title: { type: String, required: true },\n  content: { type: String, required: true },\n  type: { type: String, enum: [\"all\", \"single\"], required: true },\n  targetUserId: { type: String, ref: \"User\" },\n  senderId: { type: String, required: true, ref: \"User\" },\n  senderName: String,\n  isRead: { type: Boolean, default: false },\n  createdAt: { type: Date, default: Date.now }\n});\n\nNotificationSchema.index({ type: 1, createdAt: -1 });\nNotificationSchema.index({ targetUserId: 1, createdAt: -1 });\n\nconst NotificationReadSchema = new Schema<INotificationRead>({\n  _id: { type: String, required: true },\n  notificationId: { type: String, required: true, ref: \"Notification\" },\n  userId: { type: String, required: true, ref: \"User\" },\n  readAt: { type: Date, default: Date.now }\n});\n\nNotificationReadSchema.index({ notificationId: 1, userId: 1 }, { unique: true });\nNotificationReadSchema.index({ userId: 1, readAt: -1 });\n\nconst PointsAuditLogSchema = new Schema<IPointsAuditLog>({\n  _id: { type: String, required: true },\n  userId: { type: String, required: true, ref: \"User\" },\n  adminId: { type: String, required: true, ref: \"User\" },\n  adminEmail: { type: String, required: true },\n  previousPoints: { type: Number, required: true },\n  newPoints: { type: Number, required: true },\n  changeAmount: { type: Number, required: true },\n  reason: { type: String, required: true },\n  ipAddress: String,\n  userAgent: String,\n  createdAt: { type: Date, default: Date.now }\n});\n\nPointsAuditLogSchema.index({ userId: 1, createdAt: -1 });\nPointsAuditLogSchema.index({ adminId: 1, createdAt: -1 });\nPointsAuditLogSchema.index({ createdAt: -1 });\n\nexport const User = mongoose.model<IUser>(\"User\", UserSchema);\nexport const DocumentModel = mongoose.model<IDocument>(\"Document\", DocumentSchema);\nexport const Favorite = mongoose.model<IFavorite>(\"Favorite\", FavoriteSchema);\nexport const Tag = mongoose.model<ITag>(\"Tag\", TagSchema);\nexport const DocumentTag = mongoose.model<IDocumentTag>(\"DocumentTag\", DocumentTagSchema);\nexport const UserUpload = mongoose.model<IUserUpload>(\"UserUpload\", UserUploadSchema);\nexport const AdminUpload = mongoose.model<IAdminUpload>(\"AdminUpload\", AdminUploadSchema);\nexport const Category = mongoose.model<ICategory>(\"Category\", CategorySchema);\nexport const Subcategory = mongoose.model<ISubcategory>(\"Subcategory\", SubcategorySchema);\nexport const ChatConversation = mongoose.model<IChatConversation>(\"ChatConversation\", ChatConversationSchema);\nexport const ChatMessage = mongoose.model<IChatMessage>(\"ChatMessage\", ChatMessageSchema);\nexport const Notification = mongoose.model<INotification>(\"Notification\", NotificationSchema);\nexport const NotificationRead = mongoose.model<INotificationRead>(\"NotificationRead\", NotificationReadSchema);\nexport const PointsAuditLog = mongoose.model<IPointsAuditLog>(\"PointsAuditLog\", PointsAuditLogSchema);\n","path":null,"size_bytes":13323,"size_tokens":null},"server/scripts/migrate-to-mongodb.ts":{"content":"import fs from \"fs/promises\";\nimport path from \"path\";\nimport { connectMongoDB } from \"../mongodb\";\nimport {\n  User,\n  DocumentModel,\n  Favorite,\n  Tag,\n  DocumentTag,\n  UserUpload,\n  AdminUpload\n} from \"../models\";\n\nasync function migrate() {\n  console.log(\"üîÑ Starting PostgreSQL ‚Üí MongoDB migration...\\n\");\n\n  try {\n    await connectMongoDB();\n\n    const backupPath = path.join(process.cwd(), \"postgres-backup\", \"postgres-backup.json\");\n    const backupData = JSON.parse(await fs.readFile(backupPath, \"utf-8\"));\n\n    console.log(\"üì• Loading backup data...\");\n    console.log(`   - Users: ${backupData.users.length}`);\n    console.log(`   - Documents: ${backupData.documents.length}`);\n    console.log(`   - Favorites: ${backupData.favorites.length}`);\n    console.log(`   - Tags: ${backupData.tags.length}`);\n    console.log(`   - Document Tags: ${backupData.documentTags.length}`);\n    console.log(`   - User Uploads: ${backupData.userUploads.length}`);\n    console.log(`   - Admin Uploads: ${backupData.adminUploads.length}\\n`);\n\n    await User.deleteMany({});\n    console.log(\"üóëÔ∏è  Cleared existing users\");\n\n    await DocumentModel.deleteMany({});\n    console.log(\"üóëÔ∏è  Cleared existing documents\");\n\n    await Favorite.deleteMany({});\n    console.log(\"üóëÔ∏è  Cleared existing favorites\");\n\n    await Tag.deleteMany({});\n    console.log(\"üóëÔ∏è  Cleared existing tags\");\n\n    await DocumentTag.deleteMany({});\n    console.log(\"üóëÔ∏è  Cleared existing document tags\");\n\n    await UserUpload.deleteMany({});\n    console.log(\"üóëÔ∏è  Cleared existing user uploads\");\n\n    await AdminUpload.deleteMany({});\n    console.log(\"üóëÔ∏è  Cleared existing admin uploads\\n\");\n\n    if (backupData.users.length > 0) {\n      const users = backupData.users.map((u: any) => ({\n        _id: u.id,\n        email: u.email,\n        firstName: u.firstName,\n        lastName: u.lastName,\n        profileImageUrl: u.profileImageUrl,\n        role: u.role,\n        createdAt: u.createdAt,\n        updatedAt: u.updatedAt\n      }));\n      await User.insertMany(users);\n      console.log(`‚úÖ Migrated ${users.length} users`);\n    }\n\n    if (backupData.documents.length > 0) {\n      const documents = backupData.documents.map((d: any) => ({\n        _id: d.id,\n        postId: d.postId,\n        title: d.title,\n        description: d.description,\n        category: d.category,\n        pageCount: d.pageCount,\n        coverImageUrl: d.coverImageUrl,\n        imageUrls: d.imageUrls || [],\n        viewCount: d.viewCount || 0,\n        favoriteCount: 0,\n        aiGenerated: false,\n        createdAt: d.createdAt,\n        updatedAt: d.updatedAt\n      }));\n      await DocumentModel.insertMany(documents);\n      console.log(`‚úÖ Migrated ${documents.length} documents`);\n    }\n\n    if (backupData.favorites.length > 0) {\n      const favorites = backupData.favorites.map((f: any) => ({\n        _id: f.id,\n        userId: f.userId,\n        documentId: f.documentId,\n        createdAt: f.createdAt\n      }));\n      await Favorite.insertMany(favorites);\n      console.log(`‚úÖ Migrated ${favorites.length} favorites`);\n\n      const favoriteCounts = favorites.reduce((acc: any, f: any) => {\n        acc[f.documentId] = (acc[f.documentId] || 0) + 1;\n        return acc;\n      }, {});\n\n      for (const [docId, count] of Object.entries(favoriteCounts)) {\n        await DocumentModel.updateOne({ _id: docId }, { favoriteCount: count });\n      }\n      console.log(`‚úÖ Updated favorite counts for ${Object.keys(favoriteCounts).length} documents`);\n    }\n\n    if (backupData.tags.length > 0) {\n      const tags = backupData.tags.map((t: any) => ({\n        _id: t.id,\n        name: t.name,\n        createdAt: t.createdAt\n      }));\n      await Tag.insertMany(tags);\n      console.log(`‚úÖ Migrated ${tags.length} tags`);\n    }\n\n    if (backupData.documentTags.length > 0) {\n      const documentTags = backupData.documentTags.map((dt: any) => ({\n        _id: dt.id,\n        documentId: dt.documentId,\n        tagId: dt.tagId,\n        createdAt: dt.createdAt\n      }));\n      await DocumentTag.insertMany(documentTags);\n      console.log(`‚úÖ Migrated ${documentTags.length} document tags`);\n    }\n\n    if (backupData.userUploads.length > 0) {\n      const userUploads = backupData.userUploads.map((u: any) => ({\n        _id: u.id,\n        userId: u.userId,\n        slot: u.slot,\n        fileName: u.fileName,\n        fileType: u.fileType,\n        filePath: u.filePath,\n        fileSize: u.fileSize,\n        approvalStatus: u.approvalStatus,\n        reviewedBy: u.reviewedBy,\n        reviewedAt: u.reviewedAt,\n        pipelineStatus: u.pipelineStatus,\n        pipelineStartedAt: u.pipelineStartedAt,\n        pipelineCompletedAt: u.pipelineCompletedAt,\n        aiStatus: \"pending\",\n        uploadedAt: u.uploadedAt\n      }));\n      await UserUpload.insertMany(userUploads);\n      console.log(`‚úÖ Migrated ${userUploads.length} user uploads`);\n    }\n\n    if (backupData.adminUploads.length > 0) {\n      const adminUploads = backupData.adminUploads.map((a: any) => ({\n        _id: a.id,\n        uploadedBy: a.uploadedBy,\n        fileName: a.fileName,\n        fileType: a.fileType,\n        filePath: a.filePath,\n        fileSize: a.fileSize,\n        pipelineStatus: a.pipelineStatus,\n        pipelineStartedAt: a.pipelineStartedAt,\n        pipelineCompletedAt: a.pipelineCompletedAt,\n        aiStatus: \"pending\",\n        uploadedAt: a.uploadedAt\n      }));\n      await AdminUpload.insertMany(adminUploads);\n      console.log(`‚úÖ Migrated ${adminUploads.length} admin uploads`);\n    }\n\n    console.log(\"\\n‚úÖ Migration completed successfully!\");\n\n    const finalCounts = {\n      users: await User.countDocuments(),\n      documents: await DocumentModel.countDocuments(),\n      favorites: await Favorite.countDocuments(),\n      tags: await Tag.countDocuments(),\n      documentTags: await DocumentTag.countDocuments(),\n      userUploads: await UserUpload.countDocuments(),\n      adminUploads: await AdminUpload.countDocuments()\n    };\n\n    console.log(\"\\nüìä Final MongoDB counts:\");\n    console.log(`   - Users: ${finalCounts.users}`);\n    console.log(`   - Documents: ${finalCounts.documents}`);\n    console.log(`   - Favorites: ${finalCounts.favorites}`);\n    console.log(`   - Tags: ${finalCounts.tags}`);\n    console.log(`   - Document Tags: ${finalCounts.documentTags}`);\n    console.log(`   - User Uploads: ${finalCounts.userUploads}`);\n    console.log(`   - Admin Uploads: ${finalCounts.adminUploads}`);\n\n  } catch (error) {\n    console.error(\"‚ùå Migration failed:\", error);\n    throw error;\n  } finally {\n    process.exit(0);\n  }\n}\n\nmigrate();\n","path":null,"size_bytes":6628,"size_tokens":null},"server/scripts/check-uploads.ts":{"content":"import { connectMongoDB } from \"../mongodb\";\nimport { UserUpload } from \"../models\";\n\nasync function checkUploads() {\n  try {\n    console.log(\"Connecting to MongoDB...\");\n    await connectMongoDB();\n    \n    console.log(\"\\nFetching user uploads...\");\n    const uploads = await UserUpload.find().populate('userId');\n    \n    console.log(`\\nFound ${uploads.length} uploads:\\n`);\n    \n    for (const upload of uploads) {\n      console.log(`Upload ID: ${upload._id}`);\n      console.log(`  User: ${upload.userId}`);\n      console.log(`  Filename: ${upload.fileName}`);\n      console.log(`  File Path: ${upload.filePath}`);\n      console.log(`  File Type: ${upload.fileType}`);\n      console.log(`  File Size: ${upload.fileSize} bytes`);\n      console.log(`  Status: ${upload.approvalStatus}`);\n      console.log(`  Uploaded: ${upload.uploadedAt}`);\n      console.log('---');\n    }\n    \n    process.exit(0);\n  } catch (error) {\n    console.error(\"Error:\", error);\n    process.exit(1);\n  }\n}\n\ncheckUploads();\n","path":null,"size_bytes":1003,"size_tokens":null},"server/db.ts":{"content":"// Reference: javascript_database blueprint\nimport { Pool, neonConfig } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-serverless';\nimport ws from \"ws\";\nimport * as schema from \"@shared/schema\";\n\nneonConfig.webSocketConstructor = ws;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle({ client: pool, schema });\n","path":null,"size_bytes":527,"size_tokens":null},"server/mem-storage.ts":{"content":"import type { IStorage } from \"./storage\";\nimport type {\n  User,\n  Document,\n  Favorite,\n  Tag,\n  DocumentTag,\n  DocumentWithFavorite,\n  UserUpload,\n  AdminUpload,\n} from \"@shared/schema\";\nimport type { ICategory, IChatConversation, IChatMessage } from \"./models\";\n\nexport class MemStorage implements IStorage {\n  private users: Map<string, User> = new Map();\n  private documents: Map<string, Document> = new Map();\n  private favorites: Map<string, Favorite> = new Map();\n  private tags: Map<string, Tag> = new Map();\n  private documentTags: Map<string, DocumentTag> = new Map();\n  private userUploads: Map<string, UserUpload> = new Map();\n  private adminUploads: Map<string, AdminUpload> = new Map();\n  private usedPostIds: Set<string> = new Set();\n  private categories: Map<string, ICategory> = new Map();\n  private conversations: Map<string, IChatConversation> = new Map();\n  private messages: Map<string, IChatMessage> = new Map();\n\n  constructor() {\n    console.log(\"‚ö†Ô∏è  Using IN-MEMORY storage - data will be lost on restart!\");\n    console.log(\"‚ö†Ô∏è  Fix MongoDB Atlas IP whitelist to enable persistent storage\");\n  }\n\n  private generateUniquePostId(): string {\n    let attempts = 0;\n    const maxAttempts = 100;\n    \n    while (attempts < maxAttempts) {\n      const postId = Math.floor(1000000000 + Math.random() * 9000000000).toString();\n      if (!this.usedPostIds.has(postId)) {\n        this.usedPostIds.add(postId);\n        return postId;\n      }\n      attempts++;\n    }\n    throw new Error(\"Failed to generate unique post ID\");\n  }\n\n  // User operations\n  async getUser(id: string): Promise<User | undefined> {\n    return this.users.get(id);\n  }\n\n  async upsertUser(user: Partial<User> & { id: string }): Promise<User> {\n    const existing = this.users.get(user.id);\n    const updated: User = {\n      ...existing,\n      ...user,\n      id: user.id,\n      role: user.role || existing?.role || \"user\",\n      createdAt: existing?.createdAt || new Date(),\n      updatedAt: new Date(),\n    } as User;\n    this.users.set(user.id, updated);\n    return updated;\n  }\n\n  // Document operations\n  async getAllDocuments(userId?: string): Promise<DocumentWithFavorite[]> {\n    const docs = Array.from(this.documents.values());\n    return docs.map(doc => this.addFavoriteFlag(doc, userId));\n  }\n\n  async getDocumentById(id: string, userId?: string): Promise<DocumentWithFavorite | undefined> {\n    const doc = this.documents.get(id);\n    return doc ? this.addFavoriteFlag(doc, userId) : undefined;\n  }\n\n  async getRelatedDocuments(documentId: string, userId?: string): Promise<DocumentWithFavorite[]> {\n    const doc = this.documents.get(documentId);\n    if (!doc) return [];\n    \n    const related = Array.from(this.documents.values())\n      .filter(d => d.id !== documentId && d.category === doc.category)\n      .slice(0, 4);\n    \n    return related.map(d => this.addFavoriteFlag(d, userId));\n  }\n\n  async createDocument(document: Partial<Document>): Promise<Document> {\n    const id = this.generateId();\n    const postId = this.generateUniquePostId();\n    const newDoc: Document = {\n      id,\n      postId,\n      title: document.title || \"\",\n      description: document.description || \"\",\n      category: document.category || \"\",\n      pageCount: document.pageCount || 0,\n      coverImageUrl: document.coverImageUrl || \"\",\n      imageUrls: (document as any).imageUrls || null,\n      viewCount: 0,\n      favoriteCount: 0,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    };\n    this.documents.set(id, newDoc);\n    return newDoc;\n  }\n\n  async updateDocument(id: string, document: Partial<Document>): Promise<Document | undefined> {\n    const existing = this.documents.get(id);\n    if (!existing) return undefined;\n    \n    const updated: Document = {\n      ...existing,\n      ...document,\n      id,\n      updatedAt: new Date(),\n    };\n    this.documents.set(id, updated);\n    return updated;\n  }\n\n  async deleteDocument(id: string): Promise<boolean> {\n    return this.documents.delete(id);\n  }\n\n  async incrementViewCount(id: string): Promise<void> {\n    const doc = this.documents.get(id);\n    if (doc) {\n      doc.viewCount++;\n      this.documents.set(id, doc);\n    }\n  }\n\n  // Favorite operations\n  async addFavorite(favorite: Partial<Favorite>): Promise<Favorite> {\n    const id = this.generateId();\n    const newFav: Favorite = {\n      id,\n      userId: favorite.userId!,\n      documentId: favorite.documentId!,\n      createdAt: new Date(),\n    };\n    this.favorites.set(id, newFav);\n    \n    // Update favorite count\n    const doc = this.documents.get(newFav.documentId);\n    if (doc) {\n      doc.favoriteCount++;\n      this.documents.set(doc.id, doc);\n    }\n    \n    return newFav;\n  }\n\n  async removeFavorite(userId: string, documentId: string): Promise<boolean> {\n    const fav = Array.from(this.favorites.values()).find(\n      f => f.userId === userId && f.documentId === documentId\n    );\n    \n    if (!fav) return false;\n    \n    this.favorites.delete(fav.id);\n    \n    // Update favorite count\n    const doc = this.documents.get(documentId);\n    if (doc && doc.favoriteCount > 0) {\n      doc.favoriteCount--;\n      this.documents.set(doc.id, doc);\n    }\n    \n    return true;\n  }\n\n  async getUserFavorites(userId: string): Promise<string[]> {\n    return Array.from(this.favorites.values())\n      .filter(f => f.userId === userId)\n      .map(f => f.documentId);\n  }\n\n  // Tag operations\n  async getAllTags(): Promise<Tag[]> {\n    return Array.from(this.tags.values());\n  }\n\n  async createTag(tag: Partial<Tag>): Promise<Tag> {\n    const id = this.generateId();\n    const newTag: Tag = {\n      id,\n      name: tag.name!,\n      createdAt: new Date(),\n    };\n    this.tags.set(id, newTag);\n    return newTag;\n  }\n\n  async deleteTag(id: string): Promise<boolean> {\n    return this.tags.delete(id);\n  }\n\n  async getDocumentTags(documentId: string): Promise<Tag[]> {\n    const docTagIds = Array.from(this.documentTags.values())\n      .filter(dt => dt.documentId === documentId)\n      .map(dt => dt.tagId);\n    \n    return Array.from(this.tags.values())\n      .filter(tag => docTagIds.includes(tag.id));\n  }\n\n  async setDocumentTags(documentId: string, tagIds: string[]): Promise<void> {\n    // Remove existing tags for this document\n    const existingDocTags = Array.from(this.documentTags.values())\n      .filter(dt => dt.documentId === documentId);\n    existingDocTags.forEach(dt => this.documentTags.delete(dt.id));\n    \n    // Add new tags\n    tagIds.forEach(tagId => {\n      const id = this.generateId();\n      const docTag: DocumentTag = {\n        id,\n        documentId,\n        tagId,\n        createdAt: new Date(),\n      };\n      this.documentTags.set(id, docTag);\n    });\n  }\n\n  // Admin operations\n  async getAllUsers(): Promise<User[]> {\n    return Array.from(this.users.values());\n  }\n\n  async getRecentUsers(limit: number): Promise<User[]> {\n    return Array.from(this.users.values())\n      .sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime())\n      .slice(0, limit);\n  }\n\n  async updateUserRole(userId: string, role: string): Promise<User | undefined> {\n    const user = this.users.get(userId);\n    if (!user) return undefined;\n    \n    user.role = role as \"admin\" | \"user\";\n    user.updatedAt = new Date();\n    this.users.set(userId, user);\n    return user;\n  }\n\n  async getAllDocumentsForAdmin(): Promise<Document[]> {\n    return Array.from(this.documents.values());\n  }\n\n  async getDocumentByIdForAdmin(id: string): Promise<Document | undefined> {\n    return this.documents.get(id);\n  }\n\n  async getRecentDocuments(limit: number): Promise<Document[]> {\n    return Array.from(this.documents.values())\n      .sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime())\n      .slice(0, limit);\n  }\n\n  async getAdminStats(): Promise<{\n    totalDocuments: number;\n    totalUsers: number;\n    totalFavorites: number;\n    totalViews: number;\n  }> {\n    const docs = Array.from(this.documents.values());\n    return {\n      totalDocuments: docs.length,\n      totalUsers: this.users.size,\n      totalFavorites: this.favorites.size,\n      totalViews: docs.reduce((sum, doc) => sum + doc.viewCount, 0),\n    };\n  }\n\n  // User upload operations\n  async getUserUploads(userId: string): Promise<UserUpload[]> {\n    return Array.from(this.userUploads.values())\n      .filter(u => u.userId === userId);\n  }\n\n  async getUserUploadCount(userId: string): Promise<number> {\n    return Array.from(this.userUploads.values())\n      .filter(u => u.userId === userId)\n      .length;\n  }\n\n  async findAvailableSlot(userId: string): Promise<number | null> {\n    const uploads = await this.getUserUploads(userId);\n    const usedSlots = uploads.map(u => u.slot);\n    \n    // User can upload up to 10 files (slots 1-10)\n    for (let slot = 1; slot <= 10; slot++) {\n      if (!usedSlots.includes(slot)) return slot;\n    }\n    return null;\n  }\n\n  async createUserUpload(upload: Partial<UserUpload>): Promise<UserUpload> {\n    const id = this.generateId();\n    const newUpload: UserUpload = {\n      id,\n      userId: upload.userId!,\n      slot: upload.slot!,\n      fileName: upload.fileName!,\n      fileType: upload.fileType!,\n      filePath: upload.filePath!,\n      fileSize: upload.fileSize!,\n      approvalStatus: \"pending\",\n      reviewedBy: null,\n      reviewedAt: null,\n      approvedCategory: null,\n      pipelineStatus: \"not_started\",\n      pipelineStartedAt: null,\n      pipelineCompletedAt: null,\n      aiStatus: \"pending\",\n      aiGeneratedTitle: null,\n      aiGeneratedDescription: null,\n      aiGeneratedCategory: null,\n      aiGeneratedAt: null,\n      aiError: null,\n      uploadedAt: new Date(),\n    };\n    this.userUploads.set(id, newUpload);\n    return newUpload;\n  }\n\n  async deleteUserUpload(id: string, userId: string): Promise<boolean> {\n    const upload = this.userUploads.get(id);\n    if (!upload || upload.userId !== userId) return false;\n    return this.userUploads.delete(id);\n  }\n\n  // Admin upload operations\n  async getAdminUploads(): Promise<AdminUpload[]> {\n    return Array.from(this.adminUploads.values())\n      .sort((a, b) => b.uploadedAt.getTime() - a.uploadedAt.getTime());\n  }\n\n  async createAdminUpload(upload: Partial<AdminUpload>): Promise<AdminUpload> {\n    const id = this.generateId();\n    const newUpload: AdminUpload = {\n      id,\n      uploadedBy: upload.uploadedBy!,\n      fileName: upload.fileName!,\n      fileType: upload.fileType!,\n      filePath: upload.filePath!,\n      fileSize: upload.fileSize!,\n      category: upload.category || null,\n      pipelineStatus: \"not_started\",\n      pipelineStartedAt: null,\n      pipelineCompletedAt: null,\n      aiStatus: \"pending\",\n      aiGeneratedTitle: null,\n      aiGeneratedDescription: null,\n      aiGeneratedCategory: null,\n      aiGeneratedAt: null,\n      aiError: null,\n      uploadedAt: new Date(),\n    };\n    this.adminUploads.set(id, newUpload);\n    return newUpload;\n  }\n\n  async deleteAdminUpload(id: string): Promise<boolean> {\n    return this.adminUploads.delete(id);\n  }\n\n  async updatePipelineStatus(\n    id: string,\n    status: string,\n    startedAt?: Date,\n    completedAt?: Date\n  ): Promise<AdminUpload | undefined> {\n    const upload = this.adminUploads.get(id);\n    if (!upload) return undefined;\n    \n    upload.pipelineStatus = status as any;\n    if (startedAt) upload.pipelineStartedAt = startedAt;\n    if (completedAt) upload.pipelineCompletedAt = completedAt;\n    \n    this.adminUploads.set(id, upload);\n    return upload;\n  }\n\n  // User upload approval operations\n  async getAllUserUploads(): Promise<(UserUpload & { userName: string; userEmail: string })[]> {\n    const uploads = Array.from(this.userUploads.values());\n    return uploads.map(upload => {\n      const user = this.users.get(upload.userId);\n      return {\n        ...upload,\n        userName: user ? `${user.firstName || \"\"} ${user.lastName || \"\"}`.trim() : \"Unknown\",\n        userEmail: user?.email || \"unknown\",\n      };\n    });\n  }\n\n  async approveUserUpload(id: string, adminId: string, category: string): Promise<UserUpload | undefined> {\n    const upload = this.userUploads.get(id);\n    if (!upload) return undefined;\n    \n    upload.approvalStatus = \"approved\";\n    upload.reviewedBy = adminId;\n    upload.reviewedAt = new Date();\n    upload.approvedCategory = category;\n    \n    this.userUploads.set(id, upload);\n    return upload;\n  }\n\n  async rejectUserUpload(id: string, adminId: string): Promise<UserUpload | undefined> {\n    const upload = this.userUploads.get(id);\n    if (!upload) return undefined;\n    \n    upload.approvalStatus = \"rejected\";\n    upload.reviewedBy = adminId;\n    upload.reviewedAt = new Date();\n    \n    this.userUploads.set(id, upload);\n    return upload;\n  }\n\n  async updateUserUploadPipelineStatus(\n    id: string,\n    status: string,\n    startedAt?: Date,\n    completedAt?: Date\n  ): Promise<UserUpload | undefined> {\n    const upload = this.userUploads.get(id);\n    if (!upload) return undefined;\n    \n    upload.pipelineStatus = status as any;\n    if (startedAt) upload.pipelineStartedAt = startedAt;\n    if (completedAt) upload.pipelineCompletedAt = completedAt;\n    \n    this.userUploads.set(id, upload);\n    return upload;\n  }\n\n  // Duplicate file detection\n  async checkDuplicateFileHash(fileHash: string): Promise<{ isDuplicate: boolean; existingFileName?: string; existingUploadType?: 'admin' | 'user' }> {\n    for (const upload of this.adminUploads.values()) {\n      if ((upload as any).fileHash === fileHash) {\n        return { isDuplicate: true, existingFileName: upload.fileName, existingUploadType: 'admin' };\n      }\n    }\n    for (const upload of this.userUploads.values()) {\n      if ((upload as any).fileHash === fileHash) {\n        return { isDuplicate: true, existingFileName: upload.fileName, existingUploadType: 'user' };\n      }\n    }\n    return { isDuplicate: false };\n  }\n\n  async deleteAllDuplicateRecords(): Promise<{ adminDeleted: number; userDeleted: number; details: string[] }> {\n    return { adminDeleted: 0, userDeleted: 0, details: [] };\n  }\n\n  async clearAllUploads(): Promise<{ adminCleared: number; userCleared: number }> {\n    const adminCleared = this.adminUploads.size;\n    const userCleared = this.userUploads.size;\n    this.adminUploads.clear();\n    this.userUploads.clear();\n    return { adminCleared, userCleared };\n  }\n\n  async getAdminUploadById(id: string): Promise<AdminUpload | undefined> {\n    return this.adminUploads.get(id);\n  }\n\n  async getUserUploadById(id: string): Promise<UserUpload | undefined> {\n    return this.userUploads.get(id);\n  }\n\n  // Category operations\n  async getAllCategories(): Promise<ICategory[]> {\n    return Array.from(this.categories.values()).sort((a, b) => (a.order || 0) - (b.order || 0));\n  }\n\n  async getCategoryById(id: string): Promise<ICategory | undefined> {\n    return this.categories.get(id);\n  }\n\n  async createCategory(category: Partial<ICategory>): Promise<ICategory> {\n    const id = this.generateId();\n    const newCategory: ICategory = {\n      _id: id,\n      name: category.name || \"\",\n      order: category.order || 0,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    } as ICategory;\n    this.categories.set(id, newCategory);\n    return newCategory;\n  }\n\n  async updateCategory(id: string, category: Partial<ICategory>): Promise<ICategory | undefined> {\n    const existing = this.categories.get(id);\n    if (!existing) return undefined;\n    \n    const updated: ICategory = {\n      ...existing,\n      ...category,\n      updatedAt: new Date(),\n    } as ICategory;\n    this.categories.set(id, updated);\n    return updated;\n  }\n\n  async deleteCategory(id: string): Promise<boolean> {\n    return this.categories.delete(id);\n  }\n\n  // Chat support operations\n  async getOrCreateConversation(userId?: string, guestId?: string, guestName?: string, guestEmail?: string): Promise<IChatConversation> {\n    if (userId) {\n      const existing = Array.from(this.conversations.values()).find(c => c.userId === userId);\n      if (existing) return existing;\n    }\n    if (guestId) {\n      const existing = Array.from(this.conversations.values()).find(c => c.guestId === guestId);\n      if (existing) return existing;\n    }\n    \n    const id = this.generateId();\n    const conversation: IChatConversation = {\n      _id: id,\n      userId: userId || null,\n      guestId: guestId || null,\n      guestName: guestName || null,\n      guestEmail: guestEmail || null,\n      status: \"active\",\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    } as IChatConversation;\n    this.conversations.set(id, conversation);\n    return conversation;\n  }\n\n  async getConversationById(id: string): Promise<IChatConversation | undefined> {\n    return this.conversations.get(id);\n  }\n\n  async getConversationByUserId(userId: string): Promise<IChatConversation | undefined> {\n    return Array.from(this.conversations.values()).find(c => c.userId === userId);\n  }\n\n  async getConversationByGuestId(guestId: string): Promise<IChatConversation | undefined> {\n    return Array.from(this.conversations.values()).find(c => c.guestId === guestId);\n  }\n\n  async getAllConversations(): Promise<IChatConversation[]> {\n    return Array.from(this.conversations.values());\n  }\n\n  async updateConversationStatus(id: string, status: \"active\" | \"closed\"): Promise<IChatConversation | undefined> {\n    const conversation = this.conversations.get(id);\n    if (!conversation) return undefined;\n    \n    conversation.status = status;\n    conversation.updatedAt = new Date();\n    this.conversations.set(id, conversation);\n    return conversation;\n  }\n\n  // Chat message operations\n  async getMessagesByConversationId(conversationId: string): Promise<IChatMessage[]> {\n    return Array.from(this.messages.values())\n      .filter(m => m.conversationId?.toString() === conversationId)\n      .sort((a, b) => a.createdAt.getTime() - b.createdAt.getTime());\n  }\n\n  async createMessage(message: Partial<IChatMessage>): Promise<IChatMessage> {\n    const id = this.generateId();\n    const newMessage: IChatMessage = {\n      _id: id,\n      conversationId: message.conversationId!,\n      senderType: message.senderType!,\n      senderId: message.senderId || null,\n      content: message.content || \"\",\n      isRead: false,\n      createdAt: new Date(),\n    } as IChatMessage;\n    this.messages.set(id, newMessage);\n    return newMessage;\n  }\n\n  async markMessagesAsRead(conversationId: string, senderType: \"user\" | \"admin\"): Promise<void> {\n    for (const [id, message] of this.messages.entries()) {\n      if (message.conversationId?.toString() === conversationId && message.senderType !== senderType) {\n        message.isRead = true;\n        this.messages.set(id, message);\n      }\n    }\n  }\n\n  // Helper methods\n  private addFavoriteFlag(doc: Document, userId?: string): DocumentWithFavorite {\n    const isFavorited = userId\n      ? Array.from(this.favorites.values()).some(\n          f => f.userId === userId && f.documentId === doc.id\n        )\n      : false;\n    \n    return { ...doc, isFavorited };\n  }\n\n  private generateId(): string {\n    return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n  }\n}\n","path":null,"size_bytes":19100,"size_tokens":null},"client/src/pages/admin/Categories.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Collapsible, CollapsibleContent, CollapsibleTrigger } from \"@/components/ui/collapsible\";\nimport { AlertCircle, Plus, Trash2, Pencil, ImageIcon, ChevronDown, ChevronRight, FolderTree } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface Category {\n  _id: string;\n  id: string;\n  name: string;\n  logoUrl?: string;\n  order: number;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\ninterface Subcategory {\n  _id: string;\n  id: string;\n  name: string;\n  categoryId: string;\n  order: number;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\nexport default function Categories() {\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [editingCategory, setEditingCategory] = useState<Category | null>(null);\n  const [newCategoryName, setNewCategoryName] = useState(\"\");\n  const [newCategoryOrder, setNewCategoryOrder] = useState(\"\");\n  const [selectedLogo, setSelectedLogo] = useState<File | null>(null);\n  const [logoPreview, setLogoPreview] = useState<string | null>(null);\n  const [editCategoryName, setEditCategoryName] = useState(\"\");\n  const [editCategoryOrder, setEditCategoryOrder] = useState(\"\");\n  const [editSelectedLogo, setEditSelectedLogo] = useState<File | null>(null);\n  const [editLogoPreview, setEditLogoPreview] = useState<string | null>(null);\n  const [expandedCategories, setExpandedCategories] = useState<Set<string>>(new Set());\n  const [isSubcategoryDialogOpen, setIsSubcategoryDialogOpen] = useState(false);\n  const [isEditSubcategoryDialogOpen, setIsEditSubcategoryDialogOpen] = useState(false);\n  const [selectedCategoryForSubcategory, setSelectedCategoryForSubcategory] = useState<Category | null>(null);\n  const [newSubcategoryName, setNewSubcategoryName] = useState(\"\");\n  const [newSubcategoryOrder, setNewSubcategoryOrder] = useState(\"\");\n  const [editingSubcategory, setEditingSubcategory] = useState<Subcategory | null>(null);\n  const [editSubcategoryName, setEditSubcategoryName] = useState(\"\");\n  const [editSubcategoryOrder, setEditSubcategoryOrder] = useState(\"\");\n  const { toast } = useToast();\n\n  const { data: categories, isLoading, error } = useQuery<Category[]>({\n    queryKey: [\"/api/categories\"],\n  });\n\n  const { data: subcategories } = useQuery<Subcategory[]>({\n    queryKey: [\"/api/subcategories\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (formData: FormData) => {\n      const response = await fetch(\"/api/categories\", {\n        method: \"POST\",\n        body: formData,\n        credentials: \"include\",\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Failed to create category\");\n      }\n\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/categories\"] });\n      setIsCreateDialogOpen(false);\n      setNewCategoryName(\"\");\n      setNewCategoryOrder(\"\");\n      setSelectedLogo(null);\n      setLogoPreview(null);\n      toast({\n        title: \"Th√†nh c√¥ng\",\n        description: \"Danh m·ª•c ƒë√£ ƒë∆∞·ª£c t·∫°o\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"L·ªói\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await apiRequest(\"DELETE\", `/api/categories/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/categories\"] });\n      toast({\n        title: \"Th√†nh c√¥ng\",\n        description: \"Danh m·ª•c ƒë√£ ƒë∆∞·ª£c x√≥a\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"L·ªói\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, formData }: { id: string; formData: FormData }) => {\n      const response = await fetch(`/api/categories/${id}`, {\n        method: \"PATCH\",\n        body: formData,\n        credentials: \"include\",\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Failed to update category\");\n      }\n\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/categories\"] });\n      setIsEditDialogOpen(false);\n      setEditingCategory(null);\n      setEditCategoryName(\"\");\n      setEditCategoryOrder(\"\");\n      setEditSelectedLogo(null);\n      setEditLogoPreview(null);\n      toast({\n        title: \"Th√†nh c√¥ng\",\n        description: \"Danh m·ª•c ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"L·ªói\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const createSubcategoryMutation = useMutation({\n    mutationFn: async (data: { name: string; categoryId: string; order: number }) => {\n      return await apiRequest(\"POST\", \"/api/subcategories\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/subcategories\"] });\n      setIsSubcategoryDialogOpen(false);\n      setSelectedCategoryForSubcategory(null);\n      setNewSubcategoryName(\"\");\n      setNewSubcategoryOrder(\"\");\n      toast({\n        title: \"Th√†nh c√¥ng\",\n        description: \"Danh m·ª•c con ƒë√£ ƒë∆∞·ª£c t·∫°o\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"L·ªói\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateSubcategoryMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: { name: string; order: number } }) => {\n      return await apiRequest(\"PATCH\", `/api/subcategories/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/subcategories\"] });\n      setIsEditSubcategoryDialogOpen(false);\n      setEditingSubcategory(null);\n      setEditSubcategoryName(\"\");\n      setEditSubcategoryOrder(\"\");\n      toast({\n        title: \"Th√†nh c√¥ng\",\n        description: \"Danh m·ª•c con ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"L·ªói\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteSubcategoryMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await apiRequest(\"DELETE\", `/api/subcategories/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/subcategories\"] });\n      toast({\n        title: \"Th√†nh c√¥ng\",\n        description: \"Danh m·ª•c con ƒë√£ ƒë∆∞·ª£c x√≥a\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"L·ªói\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleCreateCategory = async (e: React.FormEvent) => {\n    e.preventDefault();\n\n    if (!newCategoryName.trim()) {\n      toast({\n        title: \"L·ªói\",\n        description: \"T√™n danh m·ª•c kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const formData = new FormData();\n    formData.append(\"name\", newCategoryName.trim());\n    formData.append(\"order\", newCategoryOrder || \"0\");\n    \n    if (selectedLogo) {\n      formData.append(\"logo\", selectedLogo);\n    }\n\n    createMutation.mutate(formData);\n  };\n\n  const handleLogoSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      setSelectedLogo(file);\n      const reader = new FileReader();\n      reader.onloadend = () => {\n        setLogoPreview(reader.result as string);\n      };\n      reader.readAsDataURL(file);\n    }\n  };\n\n  const handleDeleteCategory = (id: string, name: string) => {\n    if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a danh m·ª•c \"${name}\"?`)) {\n      deleteMutation.mutate(id);\n    }\n  };\n\n  const handleEditCategory = (category: Category) => {\n    setEditingCategory(category);\n    setEditCategoryName(category.name);\n    setEditCategoryOrder(category.order.toString());\n    setEditLogoPreview(category.logoUrl || null);\n    setEditSelectedLogo(null);\n    setIsEditDialogOpen(true);\n  };\n\n  const handleEditLogoSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      setEditSelectedLogo(file);\n      const reader = new FileReader();\n      reader.onloadend = () => {\n        setEditLogoPreview(reader.result as string);\n      };\n      reader.readAsDataURL(file);\n    }\n  };\n\n  const handleUpdateCategory = async (e: React.FormEvent) => {\n    e.preventDefault();\n\n    if (!editingCategory) return;\n\n    if (!editCategoryName.trim()) {\n      toast({\n        title: \"L·ªói\",\n        description: \"T√™n danh m·ª•c kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const formData = new FormData();\n    formData.append(\"name\", editCategoryName.trim());\n    formData.append(\"order\", editCategoryOrder || \"0\");\n    \n    if (editSelectedLogo) {\n      formData.append(\"logo\", editSelectedLogo);\n    }\n\n    updateMutation.mutate({ id: editingCategory.id, formData });\n  };\n\n  const toggleCategoryExpand = (categoryId: string) => {\n    setExpandedCategories(prev => {\n      const next = new Set(prev);\n      if (next.has(categoryId)) {\n        next.delete(categoryId);\n      } else {\n        next.add(categoryId);\n      }\n      return next;\n    });\n  };\n\n  const handleAddSubcategory = (category: Category) => {\n    setSelectedCategoryForSubcategory(category);\n    setNewSubcategoryName(\"\");\n    setNewSubcategoryOrder(\"\");\n    setIsSubcategoryDialogOpen(true);\n  };\n\n  const handleCreateSubcategory = async (e: React.FormEvent) => {\n    e.preventDefault();\n\n    if (!selectedCategoryForSubcategory) return;\n\n    if (!newSubcategoryName.trim()) {\n      toast({\n        title: \"L·ªói\",\n        description: \"T√™n danh m·ª•c con kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    createSubcategoryMutation.mutate({\n      name: newSubcategoryName.trim(),\n      categoryId: selectedCategoryForSubcategory.id,\n      order: parseInt(newSubcategoryOrder) || 0,\n    });\n  };\n\n  const handleEditSubcategory = (subcategory: Subcategory) => {\n    setEditingSubcategory(subcategory);\n    setEditSubcategoryName(subcategory.name);\n    setEditSubcategoryOrder(subcategory.order.toString());\n    setIsEditSubcategoryDialogOpen(true);\n  };\n\n  const handleUpdateSubcategory = async (e: React.FormEvent) => {\n    e.preventDefault();\n\n    if (!editingSubcategory) return;\n\n    if (!editSubcategoryName.trim()) {\n      toast({\n        title: \"L·ªói\",\n        description: \"T√™n danh m·ª•c con kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    updateSubcategoryMutation.mutate({\n      id: editingSubcategory.id,\n      data: {\n        name: editSubcategoryName.trim(),\n        order: parseInt(editSubcategoryOrder) || 0,\n      },\n    });\n  };\n\n  const handleDeleteSubcategory = (id: string, name: string) => {\n    if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a danh m·ª•c con \"${name}\"?`)) {\n      deleteSubcategoryMutation.mutate(id);\n    }\n  };\n\n  const getSubcategoriesForCategory = (categoryId: string) => {\n    return subcategories?.filter(s => s.categoryId === categoryId) || [];\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between flex-wrap gap-2\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"heading-categories\">Qu·∫£n l√Ω Danh m·ª•c</h1>\n          <p className=\"text-muted-foreground\">T·∫°o v√† qu·∫£n l√Ω danh m·ª•c cho t√†i li·ªáu</p>\n        </div>\n        <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-create-category\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              T·∫°o Danh m·ª•c\n            </Button>\n          </DialogTrigger>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>T·∫°o Danh m·ª•c M·ªõi</DialogTitle>\n              <DialogDescription>\n                Th√™m danh m·ª•c m·ªõi v·ªõi t√™n v√† logo t√πy ch·ªçn\n              </DialogDescription>\n            </DialogHeader>\n            <form onSubmit={handleCreateCategory}>\n              <div className=\"space-y-4 py-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"category-name\">T√™n danh m·ª•c</Label>\n                  <Input\n                    id=\"category-name\"\n                    placeholder=\"Nh·∫≠p t√™n danh m·ª•c...\"\n                    value={newCategoryName}\n                    onChange={(e) => setNewCategoryName(e.target.value)}\n                    data-testid=\"input-category-name\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"category-order\">Th·ª© t·ª± hi·ªÉn th·ªã</Label>\n                  <Input\n                    id=\"category-order\"\n                    type=\"number\"\n                    placeholder=\"0\"\n                    value={newCategoryOrder}\n                    onChange={(e) => setNewCategoryOrder(e.target.value)}\n                    data-testid=\"input-category-order\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"category-logo\">Logo danh m·ª•c (t√πy ch·ªçn)</Label>\n                  <div className=\"flex items-center gap-4\">\n                    <Input\n                      id=\"category-logo\"\n                      type=\"file\"\n                      accept=\"image/*\"\n                      onChange={handleLogoSelect}\n                      className=\"flex-1\"\n                      data-testid=\"input-category-logo\"\n                    />\n                    {logoPreview && (\n                      <img \n                        src={logoPreview} \n                        alt=\"Logo preview\" \n                        className=\"w-12 h-12 object-contain rounded border\"\n                      />\n                    )}\n                    {!logoPreview && (\n                      <div className=\"w-12 h-12 rounded border flex items-center justify-center bg-muted\">\n                        <ImageIcon className=\"w-6 h-6 text-muted-foreground\" />\n                      </div>\n                    )}\n                  </div>\n                </div>\n              </div>\n              <DialogFooter>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => {\n                    setIsCreateDialogOpen(false);\n                    setNewCategoryName(\"\");\n                    setNewCategoryOrder(\"\");\n                    setSelectedLogo(null);\n                    setLogoPreview(null);\n                  }}\n                  data-testid=\"button-cancel\"\n                >\n                  H·ªßy\n                </Button>\n                <Button\n                  type=\"submit\"\n                  disabled={createMutation.isPending}\n                  data-testid=\"button-submit-category\"\n                >\n                  {createMutation.isPending ? \"ƒêang t·∫°o...\" : \"T·∫°o\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </DialogContent>\n        </Dialog>\n\n        {/* Edit Category Dialog */}\n        <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Ch·ªânh s·ª≠a Danh m·ª•c</DialogTitle>\n              <DialogDescription>\n                C·∫≠p nh·∫≠t th√¥ng tin danh m·ª•c\n              </DialogDescription>\n            </DialogHeader>\n            <form onSubmit={handleUpdateCategory}>\n              <div className=\"space-y-4 py-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"edit-category-name\">T√™n danh m·ª•c</Label>\n                  <Input\n                    id=\"edit-category-name\"\n                    placeholder=\"Nh·∫≠p t√™n danh m·ª•c...\"\n                    value={editCategoryName}\n                    onChange={(e) => setEditCategoryName(e.target.value)}\n                    data-testid=\"input-edit-category-name\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"edit-category-order\">Th·ª© t·ª± hi·ªÉn th·ªã</Label>\n                  <Input\n                    id=\"edit-category-order\"\n                    type=\"number\"\n                    placeholder=\"0\"\n                    value={editCategoryOrder}\n                    onChange={(e) => setEditCategoryOrder(e.target.value)}\n                    data-testid=\"input-edit-category-order\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"edit-category-logo\">Logo danh m·ª•c</Label>\n                  <div className=\"flex items-center gap-4\">\n                    <Input\n                      id=\"edit-category-logo\"\n                      type=\"file\"\n                      accept=\"image/*\"\n                      onChange={handleEditLogoSelect}\n                      className=\"flex-1\"\n                      data-testid=\"input-edit-category-logo\"\n                    />\n                    {editLogoPreview && (\n                      <img \n                        src={editLogoPreview} \n                        alt=\"Logo preview\" \n                        className=\"w-12 h-12 object-contain rounded border\"\n                      />\n                    )}\n                    {!editLogoPreview && (\n                      <div className=\"w-12 h-12 rounded border flex items-center justify-center bg-muted\">\n                        <ImageIcon className=\"w-6 h-6 text-muted-foreground\" />\n                      </div>\n                    )}\n                  </div>\n                  <p className=\"text-xs text-muted-foreground\">\n                    ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën thay ƒë·ªïi logo\n                  </p>\n                </div>\n              </div>\n              <DialogFooter>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => {\n                    setIsEditDialogOpen(false);\n                    setEditingCategory(null);\n                    setEditCategoryName(\"\");\n                    setEditCategoryOrder(\"\");\n                    setEditSelectedLogo(null);\n                    setEditLogoPreview(null);\n                  }}\n                  data-testid=\"button-edit-cancel\"\n                >\n                  H·ªßy\n                </Button>\n                <Button\n                  type=\"submit\"\n                  disabled={updateMutation.isPending}\n                  data-testid=\"button-edit-submit\"\n                >\n                  {updateMutation.isPending ? \"ƒêang c·∫≠p nh·∫≠t...\" : \"C·∫≠p nh·∫≠t\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </DialogContent>\n        </Dialog>\n\n        {/* Create Subcategory Dialog */}\n        <Dialog open={isSubcategoryDialogOpen} onOpenChange={setIsSubcategoryDialogOpen}>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>T·∫°o Danh m·ª•c Con</DialogTitle>\n              <DialogDescription>\n                Th√™m danh m·ª•c con cho \"{selectedCategoryForSubcategory?.name}\"\n              </DialogDescription>\n            </DialogHeader>\n            <form onSubmit={handleCreateSubcategory}>\n              <div className=\"space-y-4 py-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"subcategory-name\">T√™n danh m·ª•c con</Label>\n                  <Input\n                    id=\"subcategory-name\"\n                    placeholder=\"Nh·∫≠p t√™n danh m·ª•c con...\"\n                    value={newSubcategoryName}\n                    onChange={(e) => setNewSubcategoryName(e.target.value)}\n                    data-testid=\"input-subcategory-name\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"subcategory-order\">Th·ª© t·ª± hi·ªÉn th·ªã</Label>\n                  <Input\n                    id=\"subcategory-order\"\n                    type=\"number\"\n                    placeholder=\"0\"\n                    value={newSubcategoryOrder}\n                    onChange={(e) => setNewSubcategoryOrder(e.target.value)}\n                    data-testid=\"input-subcategory-order\"\n                  />\n                </div>\n              </div>\n              <DialogFooter>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => {\n                    setIsSubcategoryDialogOpen(false);\n                    setSelectedCategoryForSubcategory(null);\n                    setNewSubcategoryName(\"\");\n                    setNewSubcategoryOrder(\"\");\n                  }}\n                  data-testid=\"button-subcategory-cancel\"\n                >\n                  H·ªßy\n                </Button>\n                <Button\n                  type=\"submit\"\n                  disabled={createSubcategoryMutation.isPending}\n                  data-testid=\"button-subcategory-submit\"\n                >\n                  {createSubcategoryMutation.isPending ? \"ƒêang t·∫°o...\" : \"T·∫°o\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </DialogContent>\n        </Dialog>\n\n        {/* Edit Subcategory Dialog */}\n        <Dialog open={isEditSubcategoryDialogOpen} onOpenChange={setIsEditSubcategoryDialogOpen}>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Ch·ªânh s·ª≠a Danh m·ª•c Con</DialogTitle>\n              <DialogDescription>\n                C·∫≠p nh·∫≠t th√¥ng tin danh m·ª•c con\n              </DialogDescription>\n            </DialogHeader>\n            <form onSubmit={handleUpdateSubcategory}>\n              <div className=\"space-y-4 py-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"edit-subcategory-name\">T√™n danh m·ª•c con</Label>\n                  <Input\n                    id=\"edit-subcategory-name\"\n                    placeholder=\"Nh·∫≠p t√™n danh m·ª•c con...\"\n                    value={editSubcategoryName}\n                    onChange={(e) => setEditSubcategoryName(e.target.value)}\n                    data-testid=\"input-edit-subcategory-name\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"edit-subcategory-order\">Th·ª© t·ª± hi·ªÉn th·ªã</Label>\n                  <Input\n                    id=\"edit-subcategory-order\"\n                    type=\"number\"\n                    placeholder=\"0\"\n                    value={editSubcategoryOrder}\n                    onChange={(e) => setEditSubcategoryOrder(e.target.value)}\n                    data-testid=\"input-edit-subcategory-order\"\n                  />\n                </div>\n              </div>\n              <DialogFooter>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => {\n                    setIsEditSubcategoryDialogOpen(false);\n                    setEditingSubcategory(null);\n                    setEditSubcategoryName(\"\");\n                    setEditSubcategoryOrder(\"\");\n                  }}\n                  data-testid=\"button-edit-subcategory-cancel\"\n                >\n                  H·ªßy\n                </Button>\n                <Button\n                  type=\"submit\"\n                  disabled={updateSubcategoryMutation.isPending}\n                  data-testid=\"button-edit-subcategory-submit\"\n                >\n                  {updateSubcategoryMutation.isPending ? \"ƒêang c·∫≠p nh·∫≠t...\" : \"C·∫≠p nh·∫≠t\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertDescription>\n            Kh√¥ng th·ªÉ t·∫£i danh s√°ch danh m·ª•c. Vui l√≤ng th·ª≠ l·∫°i sau.\n          </AlertDescription>\n        </Alert>\n      )}\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Danh s√°ch Danh m·ª•c</CardTitle>\n          <CardDescription>\n            {categories?.length || 0} danh m·ª•c, {subcategories?.length || 0} danh m·ª•c con\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              ƒêang t·∫£i...\n            </div>\n          ) : categories && categories.length > 0 ? (\n            <div className=\"space-y-2\">\n              {categories.map((category) => {\n                const categorySubcategories = getSubcategoriesForCategory(category.id);\n                const isExpanded = expandedCategories.has(category.id);\n                \n                return (\n                  <Collapsible \n                    key={category.id} \n                    open={isExpanded}\n                    onOpenChange={() => toggleCategoryExpand(category.id)}\n                  >\n                    <div className=\"border rounded-lg\" data-testid={`row-category-${category.id}`}>\n                      <div className=\"flex items-center p-3 gap-3\">\n                        <CollapsibleTrigger asChild>\n                          <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\" data-testid={`button-expand-${category.id}`}>\n                            {isExpanded ? (\n                              <ChevronDown className=\"h-4 w-4\" />\n                            ) : (\n                              <ChevronRight className=\"h-4 w-4\" />\n                            )}\n                          </Button>\n                        </CollapsibleTrigger>\n                        \n                        {category.logoUrl ? (\n                          <img \n                            src={category.logoUrl} \n                            alt={category.name} \n                            className=\"w-10 h-10 object-contain rounded\"\n                          />\n                        ) : (\n                          <div className=\"w-10 h-10 rounded bg-muted flex items-center justify-center\">\n                            <ImageIcon className=\"w-5 h-5 text-muted-foreground\" />\n                          </div>\n                        )}\n                        \n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"font-medium\" data-testid={`text-category-name-${category.id}`}>\n                            {category.name}\n                          </div>\n                          <div className=\"text-sm text-muted-foreground\">\n                            Th·ª© t·ª±: {category.order} | {categorySubcategories.length} danh m·ª•c con\n                          </div>\n                        </div>\n                        \n                        <div className=\"flex items-center gap-1\">\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => handleAddSubcategory(category)}\n                            title=\"Th√™m danh m·ª•c con\"\n                            data-testid={`button-add-subcategory-${category.id}`}\n                          >\n                            <FolderTree className=\"w-4 h-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => handleEditCategory(category)}\n                            data-testid={`button-edit-${category.id}`}\n                          >\n                            <Pencil className=\"w-4 h-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => handleDeleteCategory(category.id, category.name)}\n                            disabled={deleteMutation.isPending}\n                            data-testid={`button-delete-${category.id}`}\n                          >\n                            <Trash2 className=\"w-4 h-4 text-destructive\" />\n                          </Button>\n                        </div>\n                      </div>\n                      \n                      <CollapsibleContent>\n                        <div className=\"border-t bg-muted/30 p-3\">\n                          {categorySubcategories.length > 0 ? (\n                            <Table>\n                              <TableHeader>\n                                <TableRow>\n                                  <TableHead>T√™n danh m·ª•c con</TableHead>\n                                  <TableHead>Th·ª© t·ª±</TableHead>\n                                  <TableHead className=\"text-right\">H√†nh ƒë·ªông</TableHead>\n                                </TableRow>\n                              </TableHeader>\n                              <TableBody>\n                                {categorySubcategories.map((sub) => (\n                                  <TableRow key={sub.id} data-testid={`row-subcategory-${sub.id}`}>\n                                    <TableCell className=\"font-medium\" data-testid={`text-subcategory-name-${sub.id}`}>\n                                      {sub.name}\n                                    </TableCell>\n                                    <TableCell>{sub.order}</TableCell>\n                                    <TableCell className=\"text-right\">\n                                      <div className=\"flex items-center justify-end gap-1\">\n                                        <Button\n                                          variant=\"ghost\"\n                                          size=\"sm\"\n                                          onClick={() => handleEditSubcategory(sub)}\n                                          data-testid={`button-edit-subcategory-${sub.id}`}\n                                        >\n                                          <Pencil className=\"w-4 h-4\" />\n                                        </Button>\n                                        <Button\n                                          variant=\"ghost\"\n                                          size=\"sm\"\n                                          onClick={() => handleDeleteSubcategory(sub.id, sub.name)}\n                                          disabled={deleteSubcategoryMutation.isPending}\n                                          data-testid={`button-delete-subcategory-${sub.id}`}\n                                        >\n                                          <Trash2 className=\"w-4 h-4 text-destructive\" />\n                                        </Button>\n                                      </div>\n                                    </TableCell>\n                                  </TableRow>\n                                ))}\n                              </TableBody>\n                            </Table>\n                          ) : (\n                            <div className=\"text-center py-4 text-muted-foreground text-sm\">\n                              Ch∆∞a c√≥ danh m·ª•c con. Nh·∫•n n√∫t <FolderTree className=\"w-4 h-4 inline mx-1\" /> ƒë·ªÉ th√™m.\n                            </div>\n                          )}\n                        </div>\n                      </CollapsibleContent>\n                    </div>\n                  </Collapsible>\n                );\n              })}\n            </div>\n          ) : (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              Ch∆∞a c√≥ danh m·ª•c n√†o. T·∫°o danh m·ª•c ƒë·∫ßu ti√™n!\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":32734,"size_tokens":null},"client/src/pages/admin/Support.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { io, Socket } from \"socket.io-client\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Card, CardContent, CardFooter, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { \n  MessageCircle, \n  Send, \n  User as UserIcon, \n  Clock, \n  CheckCircle, \n  XCircle,\n  RefreshCw\n} from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { cn } from \"@/lib/utils\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface Message {\n  _id: string;\n  id: string;\n  conversationId: string;\n  senderType: \"user\" | \"admin\" | \"system\";\n  senderId?: string;\n  senderName?: string;\n  content: string;\n  isRead: boolean;\n  createdAt: string;\n}\n\ninterface Conversation {\n  _id: string;\n  id: string;\n  userId?: string;\n  guestId?: string;\n  guestName?: string;\n  guestEmail?: string;\n  userName?: string;\n  userEmail?: string;\n  status: \"active\" | \"closed\";\n  unreadByAdmin: number;\n  unreadByUser: number;\n  lastMessageAt: string;\n  lastMessagePreview?: string;\n  createdAt: string;\n}\n\nexport default function Support() {\n  const [selectedConversation, setSelectedConversation] = useState<Conversation | null>(null);\n  const [messages, setMessages] = useState<Message[]>([]);\n  const [newMessage, setNewMessage] = useState(\"\");\n  const [socket, setSocket] = useState<Socket | null>(null);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const inputRef = useRef<HTMLInputElement>(null);\n  const { toast } = useToast();\n\n  const { data: conversations = [], isLoading: isLoadingConversations, refetch: refetchConversations } = useQuery<Conversation[]>({\n    queryKey: [\"/api/admin/support/conversations\"],\n  });\n\n  const { data: fetchedMessages = [], isLoading: isLoadingMessages } = useQuery<Message[]>({\n    queryKey: [\"/api/admin/support/conversations\", selectedConversation?._id, \"messages\"],\n    enabled: !!selectedConversation,\n  });\n\n  const sendMessageMutation = useMutation({\n    mutationFn: async (content: string) => {\n      const response = await apiRequest(\n        \"POST\",\n        `/api/admin/support/conversations/${selectedConversation?._id}/messages`,\n        { content }\n      );\n      return response.json();\n    },\n    onSuccess: (newMsg) => {\n      setMessages((prev) => [...prev, newMsg]);\n      setNewMessage(\"\");\n      refetchConversations();\n    },\n    onError: () => {\n      toast({\n        title: \"L·ªói\",\n        description: \"Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const markAsReadMutation = useMutation({\n    mutationFn: async (conversationId: string) => {\n      await apiRequest(\"POST\", `/api/admin/support/conversations/${conversationId}/read`);\n    },\n    onSuccess: () => {\n      refetchConversations();\n    },\n  });\n\n  const updateStatusMutation = useMutation({\n    mutationFn: async ({ id, status }: { id: string; status: \"active\" | \"closed\" }) => {\n      const response = await apiRequest(\"PATCH\", `/api/admin/support/conversations/${id}`, { status });\n      return response.json();\n    },\n    onSuccess: (updatedConv) => {\n      setSelectedConversation(updatedConv);\n      refetchConversations();\n      toast({\n        title: \"Th√†nh c√¥ng\",\n        description: `Cu·ªôc tr√≤ chuy·ªán ƒë√£ ƒë∆∞·ª£c ${updatedConv.status === \"closed\" ? \"ƒë√≥ng\" : \"m·ªü l·∫°i\"}`,\n      });\n    },\n  });\n\n  useEffect(() => {\n    if (fetchedMessages.length > 0) {\n      setMessages(fetchedMessages);\n    } else {\n      setMessages([]);\n    }\n  }, [fetchedMessages]);\n\n  useEffect(() => {\n    const newSocket = io({\n      path: \"/socket.io\",\n      transports: [\"websocket\", \"polling\"],\n    });\n\n    newSocket.on(\"connect\", () => {\n      console.log(\"Admin socket connected\");\n      newSocket.emit(\"join:admin\");\n    });\n\n    newSocket.on(\"message:new\", (data: { conversationId?: string; message?: Message } & Message) => {\n      const message = data.message || data;\n      const convId = data.conversationId || message.conversationId;\n\n      if (selectedConversation && (selectedConversation._id === convId || selectedConversation.id === convId)) {\n        if (message.senderType === \"user\") {\n          setMessages((prev) => {\n            const exists = prev.some((m) => m._id === message._id || m.id === message.id);\n            if (exists) return prev;\n            return [...prev, message];\n          });\n        }\n      }\n      \n      refetchConversations();\n    });\n\n    newSocket.on(\"conversation:update\", () => {\n      refetchConversations();\n    });\n\n    setSocket(newSocket);\n\n    return () => {\n      newSocket.disconnect();\n    };\n  }, [selectedConversation]);\n\n  useEffect(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  }, [messages]);\n\n  useEffect(() => {\n    if (selectedConversation && inputRef.current) {\n      inputRef.current.focus();\n      if (selectedConversation.unreadByAdmin > 0) {\n        markAsReadMutation.mutate(selectedConversation._id);\n      }\n    }\n  }, [selectedConversation]);\n\n  const handleSendMessage = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!newMessage.trim() || !selectedConversation) return;\n    sendMessageMutation.mutate(newMessage.trim());\n  };\n\n  const handleSelectConversation = (conv: Conversation) => {\n    setSelectedConversation(conv);\n    setMessages([]);\n  };\n\n  const formatTime = (dateString: string) => {\n    const date = new Date(dateString);\n    const now = new Date();\n    const diff = now.getTime() - date.getTime();\n    const days = Math.floor(diff / (1000 * 60 * 60 * 24));\n\n    if (days === 0) {\n      return date.toLocaleTimeString(\"vi-VN\", { hour: \"2-digit\", minute: \"2-digit\" });\n    } else if (days === 1) {\n      return \"H√¥m qua\";\n    } else if (days < 7) {\n      return `${days} ng√†y tr∆∞·ªõc`;\n    } else {\n      return date.toLocaleDateString(\"vi-VN\");\n    }\n  };\n\n  const activeConversations = conversations.filter((c) => c.status === \"active\");\n  const closedConversations = conversations.filter((c) => c.status === \"closed\");\n\n  return (\n    <div className=\"h-[calc(100vh-64px)] flex\" data-testid=\"admin-support-page\">\n      <div className=\"w-80 border-r flex flex-col\">\n        <div className=\"p-4 border-b\">\n          <div className=\"flex items-center justify-between mb-2\">\n            <h2 className=\"font-semibold text-lg\" data-testid=\"heading-conversations\">Cu·ªôc tr√≤ chuy·ªán</h2>\n            <Button \n              size=\"icon\" \n              variant=\"ghost\" \n              onClick={() => refetchConversations()}\n              data-testid=\"button-refresh-conversations\"\n            >\n              <RefreshCw className=\"w-4 h-4\" />\n            </Button>\n          </div>\n          <p className=\"text-sm text-muted-foreground\">\n            {activeConversations.length} ƒëang ho·∫°t ƒë·ªông\n          </p>\n        </div>\n\n        <ScrollArea className=\"flex-1\">\n          {isLoadingConversations ? (\n            <div className=\"p-4 text-center text-muted-foreground\">ƒêang t·∫£i...</div>\n          ) : conversations.length === 0 ? (\n            <div className=\"p-4 text-center text-muted-foreground\">\n              <MessageCircle className=\"w-12 h-12 mx-auto mb-2 opacity-50\" />\n              <p>Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán n√†o</p>\n            </div>\n          ) : (\n            <div className=\"divide-y\">\n              {activeConversations.length > 0 && (\n                <>\n                  <div className=\"px-4 py-2 bg-muted/50\">\n                    <span className=\"text-xs font-medium text-muted-foreground\">ƒêANG HO·∫†T ƒê·ªòNG</span>\n                  </div>\n                  {activeConversations.map((conv) => (\n                    <ConversationItem\n                      key={conv._id}\n                      conversation={conv}\n                      isSelected={selectedConversation?._id === conv._id}\n                      onClick={() => handleSelectConversation(conv)}\n                      formatTime={formatTime}\n                    />\n                  ))}\n                </>\n              )}\n              \n              {closedConversations.length > 0 && (\n                <>\n                  <div className=\"px-4 py-2 bg-muted/50\">\n                    <span className=\"text-xs font-medium text-muted-foreground\">ƒê√É ƒê√ìNG</span>\n                  </div>\n                  {closedConversations.map((conv) => (\n                    <ConversationItem\n                      key={conv._id}\n                      conversation={conv}\n                      isSelected={selectedConversation?._id === conv._id}\n                      onClick={() => handleSelectConversation(conv)}\n                      formatTime={formatTime}\n                    />\n                  ))}\n                </>\n              )}\n            </div>\n          )}\n        </ScrollArea>\n      </div>\n\n      <div className=\"flex-1 flex flex-col\">\n        {selectedConversation ? (\n          <>\n            <div className=\"p-4 border-b flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"w-10 h-10 rounded-full bg-muted flex items-center justify-center\">\n                  <UserIcon className=\"w-5 h-5 text-muted-foreground\" />\n                </div>\n                <div>\n                  <h3 className=\"font-medium\" data-testid=\"text-user-name\">\n                    {selectedConversation.userName || selectedConversation.guestName || \"Kh√°ch\"}\n                  </h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    {selectedConversation.userEmail || selectedConversation.guestEmail || \"Kh√¥ng c√≥ email\"}\n                  </p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <Badge variant={selectedConversation.status === \"active\" ? \"default\" : \"secondary\"}>\n                  {selectedConversation.status === \"active\" ? \"ƒêang ho·∫°t ƒë·ªông\" : \"ƒê√£ ƒë√≥ng\"}\n                </Badge>\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  onClick={() => updateStatusMutation.mutate({\n                    id: selectedConversation._id,\n                    status: selectedConversation.status === \"active\" ? \"closed\" : \"active\",\n                  })}\n                  data-testid=\"button-toggle-status\"\n                >\n                  {selectedConversation.status === \"active\" ? (\n                    <>\n                      <XCircle className=\"w-4 h-4 mr-1\" />\n                      ƒê√≥ng\n                    </>\n                  ) : (\n                    <>\n                      <CheckCircle className=\"w-4 h-4 mr-1\" />\n                      M·ªü l·∫°i\n                    </>\n                  )}\n                </Button>\n              </div>\n            </div>\n\n            <ScrollArea className=\"flex-1 p-4\">\n              {isLoadingMessages ? (\n                <div className=\"flex items-center justify-center h-full\">\n                  <p className=\"text-muted-foreground\">ƒêang t·∫£i tin nh·∫Øn...</p>\n                </div>\n              ) : messages.length === 0 ? (\n                <div className=\"flex flex-col items-center justify-center h-full text-center\">\n                  <MessageCircle className=\"w-12 h-12 text-muted-foreground mb-2\" />\n                  <p className=\"text-muted-foreground\">Ch∆∞a c√≥ tin nh·∫Øn</p>\n                </div>\n              ) : (\n                <div className=\"space-y-3\">\n                  {messages.map((msg) => (\n                    <div\n                      key={msg._id || msg.id}\n                      className={cn(\n                        \"flex\",\n                        msg.senderType === \"admin\" ? \"justify-end\" : \"justify-start\"\n                      )}\n                    >\n                      <div\n                        className={cn(\n                          \"max-w-[70%] rounded-lg px-3 py-2\",\n                          msg.senderType === \"admin\"\n                            ? \"bg-primary text-primary-foreground\"\n                            : msg.senderType === \"user\"\n                            ? \"bg-muted\"\n                            : \"bg-accent text-accent-foreground text-center text-sm\"\n                        )}\n                      >\n                        {msg.senderType !== \"admin\" && msg.senderName && (\n                          <p className=\"text-xs font-medium mb-1 opacity-70\">\n                            {msg.senderName}\n                          </p>\n                        )}\n                        <p className=\"text-sm whitespace-pre-wrap break-words\">{msg.content}</p>\n                        <p className={cn(\n                          \"text-xs mt-1\",\n                          msg.senderType === \"admin\" ? \"text-primary-foreground/70\" : \"text-muted-foreground\"\n                        )}>\n                          {new Date(msg.createdAt).toLocaleTimeString(\"vi-VN\", {\n                            hour: \"2-digit\",\n                            minute: \"2-digit\",\n                          })}\n                        </p>\n                      </div>\n                    </div>\n                  ))}\n                  <div ref={messagesEndRef} />\n                </div>\n              )}\n            </ScrollArea>\n\n            <div className=\"p-4 border-t\">\n              <form onSubmit={handleSendMessage} className=\"flex gap-2\">\n                <Input\n                  ref={inputRef}\n                  value={newMessage}\n                  onChange={(e) => setNewMessage(e.target.value)}\n                  placeholder=\"Nh·∫≠p tin nh·∫Øn tr·∫£ l·ªùi...\"\n                  disabled={selectedConversation.status === \"closed\" || sendMessageMutation.isPending}\n                  data-testid=\"input-admin-message\"\n                />\n                <Button\n                  type=\"submit\"\n                  disabled={!newMessage.trim() || selectedConversation.status === \"closed\" || sendMessageMutation.isPending}\n                  data-testid=\"button-admin-send\"\n                >\n                  <Send className=\"w-4 h-4 mr-2\" />\n                  G·ª≠i\n                </Button>\n              </form>\n              {selectedConversation.status === \"closed\" && (\n                <p className=\"text-sm text-muted-foreground mt-2 text-center\">\n                  Cu·ªôc tr√≤ chuy·ªán ƒë√£ ƒë√≥ng. M·ªü l·∫°i ƒë·ªÉ ti·∫øp t·ª•c tr·∫£ l·ªùi.\n                </p>\n              )}\n            </div>\n          </>\n        ) : (\n          <div className=\"flex-1 flex flex-col items-center justify-center text-center p-4\">\n            <MessageCircle className=\"w-16 h-16 text-muted-foreground mb-4\" />\n            <h3 className=\"text-lg font-medium mb-2\">Ch·ªçn cu·ªôc tr√≤ chuy·ªán</h3>\n            <p className=\"text-muted-foreground max-w-sm\">\n              Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán t·ª´ danh s√°ch b√™n tr√°i ƒë·ªÉ xem v√† tr·∫£ l·ªùi tin nh·∫Øn\n            </p>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction ConversationItem({\n  conversation,\n  isSelected,\n  onClick,\n  formatTime,\n}: {\n  conversation: Conversation;\n  isSelected: boolean;\n  onClick: () => void;\n  formatTime: (date: string) => string;\n}) {\n  return (\n    <div\n      className={cn(\n        \"p-3 cursor-pointer hover-elevate\",\n        isSelected && \"bg-accent\"\n      )}\n      onClick={onClick}\n      data-testid={`conversation-item-${conversation._id}`}\n    >\n      <div className=\"flex items-start gap-3\">\n        <div className=\"w-10 h-10 rounded-full bg-muted flex items-center justify-center shrink-0\">\n          <UserIcon className=\"w-5 h-5 text-muted-foreground\" />\n        </div>\n        <div className=\"flex-1 min-w-0\">\n          <div className=\"flex items-center justify-between gap-2\">\n            <span className=\"font-medium truncate\">\n              {conversation.userName || conversation.guestName || \"Kh√°ch\"}\n            </span>\n            <span className=\"text-xs text-muted-foreground shrink-0\">\n              {formatTime(conversation.lastMessageAt)}\n            </span>\n          </div>\n          <p className=\"text-sm text-muted-foreground truncate\">\n            {conversation.lastMessagePreview || \"Ch∆∞a c√≥ tin nh·∫Øn\"}\n          </p>\n          <div className=\"flex items-center gap-2 mt-1\">\n            {conversation.unreadByAdmin > 0 && (\n              <Badge variant=\"destructive\" className=\"text-xs px-1.5 py-0\">\n                {conversation.unreadByAdmin}\n              </Badge>\n            )}\n            {conversation.status === \"closed\" && (\n              <Badge variant=\"secondary\" className=\"text-xs px-1.5 py-0\">\n                ƒê√£ ƒë√≥ng\n              </Badge>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":16974,"size_tokens":null},"server/socket.ts":{"content":"import { Server as SocketIOServer } from \"socket.io\";\nimport type { Server } from \"http\";\nimport type { IStorage } from \"./storage\";\n\nlet io: SocketIOServer | null = null;\nlet storageRef: IStorage | null = null;\n\nconst socketAuthorizedConversations = new Map<string, Set<string>>();\n\nexport function setupSocket(httpServer: Server, storage: IStorage) {\n  storageRef = storage;\n  \n  io = new SocketIOServer(httpServer, {\n    cors: {\n      origin: \"*\",\n      methods: [\"GET\", \"POST\"],\n      credentials: true,\n    },\n    path: \"/socket.io\",\n  });\n\n  io.on(\"connection\", (socket) => {\n    console.log(\"Socket connected:\", socket.id);\n    socketAuthorizedConversations.set(socket.id, new Set());\n\n    socket.on(\"join:conversation\", async (conversationId: string) => {\n      if (!conversationId || typeof conversationId !== \"string\") {\n        console.log(`Socket ${socket.id} attempted to join invalid conversation`);\n        return;\n      }\n\n      const conversation = await storageRef?.getConversationById(conversationId);\n      if (!conversation) {\n        console.log(`Socket ${socket.id} attempted to join non-existent conversation: ${conversationId}`);\n        return;\n      }\n\n      const authorized = socketAuthorizedConversations.get(socket.id);\n      if (authorized) {\n        authorized.add(conversationId);\n      }\n      \n      socket.join(`conversation:${conversationId}`);\n      console.log(`Socket ${socket.id} joined conversation:${conversationId}`);\n    });\n\n    socket.on(\"leave:conversation\", (conversationId: string) => {\n      if (!conversationId || typeof conversationId !== \"string\") return;\n      \n      const authorized = socketAuthorizedConversations.get(socket.id);\n      if (authorized) {\n        authorized.delete(conversationId);\n      }\n      \n      socket.leave(`conversation:${conversationId}`);\n      console.log(`Socket ${socket.id} left conversation:${conversationId}`);\n    });\n\n    socket.on(\"join:admin\", () => {\n      socket.join(\"admin:support\");\n      console.log(`Socket ${socket.id} joined admin:support room`);\n    });\n\n    socket.on(\"disconnect\", () => {\n      socketAuthorizedConversations.delete(socket.id);\n      console.log(\"Socket disconnected:\", socket.id);\n    });\n  });\n\n  return io;\n}\n\nexport function getIO(): SocketIOServer | null {\n  return io;\n}\n\nexport function emitNewMessage(conversationId: string, message: any) {\n  if (io) {\n    io.to(`conversation:${conversationId}`).emit(\"message:new\", message);\n    io.to(\"admin:support\").emit(\"message:new\", { conversationId, message });\n  }\n}\n\nexport function emitConversationUpdate(conversation: any) {\n  if (io) {\n    io.to(\"admin:support\").emit(\"conversation:update\", conversation);\n    if (conversation._id) {\n      io.to(`conversation:${conversation._id}`).emit(\"conversation:update\", conversation);\n    }\n  }\n}\n","path":null,"size_bytes":2816,"size_tokens":null},"client/src/components/ChatWidget.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { io, Socket } from \"socket.io-client\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Card, CardContent, CardFooter, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { X, Send, Minimize2, MessageCircle, User } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { cn } from \"@/lib/utils\";\nimport { useAuth } from \"@/hooks/useAuth\";\n\nfunction ChatIcon({ className }: { className?: string }) {\n  return (\n    <svg \n      xmlns=\"http://www.w3.org/2000/svg\" \n      viewBox=\"0 0 417.75 445.5\" \n      className={className}\n      fill=\"currentColor\"\n    >\n      <path d=\"M 352.167969 183.929688 L 354.042969 183.929688 C 361.550781 183.929688 367.789062 189.46875 368.878906 196.675781 C 370.007812 196.449219 371.148438 196.269531 372.296875 196.140625 C 368.550781 183.4375 363.628906 171.1875 357.625 159.628906 C 353.632812 151.9375 349.15625 144.550781 344.238281 137.519531 C 346.808594 131.785156 345.941406 125.253906 341.9375 120.398438 C 340.554688 118.714844 339.125 117.042969 337.699219 115.417969 C 303.382812 76.460938 257.585938 55.011719 208.746094 55.011719 C 159.910156 55.011719 114.117188 76.460938 79.804688 115.417969 C 78.375 117.042969 76.949219 118.714844 75.566406 120.390625 C 71.558594 125.253906 70.695312 131.785156 73.261719 137.519531 C 68.34375 144.550781 63.863281 151.9375 59.867188 159.628906 C 53.863281 171.1875 48.945312 183.433594 45.195312 196.136719 C 46.347656 196.269531 47.488281 196.445312 48.621094 196.675781 C 49.714844 189.46875 55.953125 183.929688 63.457031 183.929688 L 65.332031 183.929688 C 70.613281 170.613281 77.222656 158.222656 84.960938 146.957031 C 86.046875 147.175781 87.164062 147.292969 88.308594 147.292969 C 93.246094 147.292969 97.886719 145.097656 101.042969 141.265625 C 118.691406 119.84375 140.953125 103.972656 165.421875 95.363281 C 179.394531 90.4375 193.972656 87.9375 208.746094 87.9375 C 249.1875 87.9375 288.445312 107.394531 316.445312 141.316406 C 319.582031 145.117188 324.207031 147.292969 329.136719 147.292969 L 329.191406 147.292969 C 330.335938 147.292969 331.453125 147.175781 332.535156 146.957031 C 340.242188 158.179688 346.863281 170.554688 352.167969 183.929688\"/>\n      <path d=\"M 213.269531 421.035156 L 213.265625 421.023438 C 210.476562 416.015625 205.175781 412.90625 199.4375 412.90625 C 194.34375 412.90625 189.53125 415.382812 186.566406 419.527344 L 184.621094 422.246094 L 181.335938 421.625 C 152.601562 416.179688 125.335938 401.695312 102.484375 379.742188 C 88.757812 366.5625 77.058594 351.195312 67.683594 334.023438 L 63.457031 334.023438 C 61.613281 334.023438 59.851562 333.652344 58.246094 332.980469 C 61.753906 339.824219 65.621094 346.4375 69.824219 352.765625 C 77.746094 364.695312 86.902344 375.679688 97.039062 385.414062 C 109.113281 397.007812 122.371094 406.652344 136.441406 414.074219 C 150.382812 421.429688 165.089844 426.589844 180.160156 429.410156 L 183.339844 430.003906 L 184.226562 433.113281 C 186.15625 439.859375 192.410156 444.570312 199.4375 444.570312 C 205.882812 444.570312 211.628906 440.722656 214.074219 434.769531 C 214.871094 432.847656 215.273438 430.820312 215.273438 428.738281 C 215.273438 426.035156 214.582031 423.375 213.273438 421.042969 L 213.269531 421.035156\"/>\n      <path d=\"M 64.46875 328.78125 C 65.574219 328.78125 66.480469 327.875 66.480469 326.769531 L 66.480469 191.101562 C 66.480469 189.992188 65.574219 189.085938 64.464844 189.085938 L 63.34375 189.085938 C 56.4375 189.085938 50.785156 194.738281 50.785156 201.644531 C 47.394531 200.023438 43.625 199.0625 39.640625 198.941406 C 39.261719 198.929688 38.886719 198.921875 38.511719 198.921875 C 37.441406 198.921875 36.378906 198.96875 35.328125 199.0625 C 19.664062 200.421875 6.601562 211.71875 2.777344 226.71875 C 2.125 229.273438 1.738281 231.933594 1.65625 234.667969 L 0.230469 281.21875 C 0.214844 281.695312 0.214844 282.167969 0.214844 282.640625 C 0.367188 302.277344 16.167969 318.59375 35.964844 319.195312 C 36.148438 319.203125 36.339844 319.203125 36.523438 319.203125 C 43.25 319.203125 49.378906 316.574219 53.878906 312.25 C 54.910156 320.574219 62.015625 327.015625 70.617188 327.015625 L 97.53125 327.015625 C 106.984375 327.015625 114.65625 319.34375 114.65625 309.890625 L 114.65625 206.910156 C 114.65625 197.457031 106.984375 189.785156 97.53125 189.785156 L 83.925781 189.785156 L 83.925781 189.085938 L 63.457031 189.085938 C 56.550781 189.085938 50.898438 194.738281 50.898438 201.644531 L 50.898438 303.082031 C 50.898438 305.082031 51.285156 306.988281 51.976562 308.75 C 48.226562 311.640625 43.378906 313.359375 38.125 313.359375 C 25.386719 313.359375 14.964844 303.25 14.640625 290.515625 L 14.640625 227.539062 C 14.726562 214.777344 25.167969 204.398438 37.988281 204.398438 L 50.785156 204.398438 C 53.796875 204.398438 56.234375 206.835938 56.234375 209.847656 L 56.234375 308.089844 C 56.234375 311.101562 58.671875 313.539062 61.683594 313.539062 L 100.078125 313.539062 L 100.078125 206.910156 C 100.078125 205.449219 98.898438 204.269531 97.4375 204.269531 L 81.40625 204.269531 C 79.945312 204.269531 78.765625 205.449219 78.765625 206.910156 L 78.765625 299.144531 L 71.5625 299.144531 L 71.5625 206.910156 C 71.5625 201.464844 75.96875 197.058594 81.40625 197.058594 L 97.4375 197.058594 C 102.882812 197.058594 107.289062 201.464844 107.289062 206.910156 L 107.289062 309.296875 L 108.507812 309.296875 L 108.507812 206.910156 C 108.507812 200.792969 103.550781 195.835938 97.4375 195.835938 L 81.40625 195.835938 C 75.292969 195.835938 70.332031 200.792969 70.332031 206.910156 L 70.332031 300.371094 L 69.410156 300.371094 L 69.441406 206.910156 C 69.441406 200.296875 74.796875 194.9375 81.40625 194.9375 L 97.4375 194.9375 C 104.050781 194.9375 109.40625 200.296875 109.40625 206.910156 L 109.40625 308.296875 L 109.757812 308.296875 C 109.757812 319.328125 100.953125 328.132812 89.921875 328.132812 L 64.46875 328.78125\"/>\n      <path d=\"M 352.03125 328.78125 C 350.925781 328.78125 350.019531 327.875 350.019531 326.769531 L 350.019531 191.101562 C 350.019531 189.992188 350.925781 189.085938 352.035156 189.085938 L 353.15625 189.085938 C 360.0625 189.085938 365.714844 194.738281 365.714844 201.644531 C 369.105469 200.023438 372.875 199.0625 376.859375 198.941406 C 377.238281 198.929688 377.613281 198.921875 377.988281 198.921875 C 379.058594 198.921875 380.121094 198.96875 381.171875 199.0625 C 396.835938 200.421875 409.898438 211.71875 413.722656 226.71875 C 414.375 229.273438 414.761719 231.933594 414.84375 234.667969 L 416.269531 281.21875 C 416.285156 281.695312 416.285156 282.167969 416.285156 282.640625 C 416.132812 302.277344 400.332031 318.59375 380.535156 319.195312 C 380.351562 319.203125 380.160156 319.203125 379.976562 319.203125 C 373.25 319.203125 367.121094 316.574219 362.621094 312.25 C 361.589844 320.574219 354.484375 327.015625 345.882812 327.015625 L 318.96875 327.015625 C 309.515625 327.015625 301.84375 319.34375 301.84375 309.890625 L 301.84375 206.910156 C 301.84375 197.457031 309.515625 189.785156 318.96875 189.785156 L 332.574219 189.785156 L 332.574219 189.085938 L 353.042969 189.085938 C 359.949219 189.085938 365.601562 194.738281 365.601562 201.644531 L 365.601562 303.082031 C 365.601562 305.082031 365.214844 306.988281 364.523438 308.75 C 368.273438 311.640625 373.121094 313.359375 378.375 313.359375 C 391.113281 313.359375 401.535156 303.25 401.859375 290.515625 L 401.859375 227.539062 C 401.773438 214.777344 391.332031 204.398438 378.511719 204.398438 L 365.714844 204.398438 C 362.703125 204.398438 360.265625 206.835938 360.265625 209.847656 L 360.265625 308.089844 C 360.265625 311.101562 357.828125 313.539062 354.816406 313.539062 L 316.421875 313.539062 L 316.421875 206.910156 C 316.421875 205.449219 317.601562 204.269531 319.0625 204.269531 L 335.09375 204.269531 C 336.554688 204.269531 337.734375 205.449219 337.734375 206.910156 L 337.734375 299.144531 L 344.9375 299.144531 L 344.9375 206.910156 C 344.9375 201.464844 340.53125 197.058594 335.09375 197.058594 L 319.0625 197.058594 C 313.617188 197.058594 309.210938 201.464844 309.210938 206.910156 L 309.210938 309.296875 L 307.992188 309.296875 L 307.992188 206.910156 C 307.992188 200.792969 312.949219 195.835938 319.0625 195.835938 L 335.09375 195.835938 C 341.207031 195.835938 346.167969 200.792969 346.167969 206.910156 L 346.167969 300.371094 L 347.089844 300.371094 L 347.058594 206.910156 C 347.058594 200.296875 341.703125 194.9375 335.09375 194.9375 L 319.0625 194.9375 C 312.449219 194.9375 307.09375 200.296875 307.09375 206.910156 L 307.09375 308.296875 L 306.742188 308.296875 C 306.742188 319.328125 315.546875 328.132812 326.578125 328.132812 L 352.03125 328.78125\"/>\n      <path d=\"M 285.402344 197.179688 L 285.402344 335.226562 C 285.402344 345.375 277.164062 353.613281 267.015625 353.613281 L 149.703125 353.613281 C 139.554688 353.613281 131.316406 345.375 131.316406 335.226562 L 131.316406 197.179688 C 131.316406 187.03125 139.554688 178.792969 149.703125 178.792969 L 267.015625 178.792969 C 277.164062 178.792969 285.402344 187.03125 285.402344 197.179688 Z M 285.402344 197.179688\"/>\n      <path fill=\"#ffffff\" d=\"M 278.621094 197.179688 L 278.621094 335.226562 C 278.621094 341.628906 273.417969 346.832031 267.015625 346.832031 L 149.703125 346.832031 C 143.300781 346.832031 138.097656 341.628906 138.097656 335.226562 L 138.097656 197.179688 C 138.097656 190.777344 143.300781 185.574219 149.703125 185.574219 L 267.015625 185.574219 C 273.417969 185.574219 278.621094 190.777344 278.621094 197.179688 Z M 278.621094 197.179688\"/>\n      <path d=\"M 253.179688 217.972656 L 163.542969 217.972656 C 159.730469 217.972656 156.632812 214.875 156.632812 211.0625 C 156.632812 207.25 159.730469 204.152344 163.542969 204.152344 L 253.179688 204.152344 C 256.992188 204.152344 260.089844 207.25 260.089844 211.0625 C 260.089844 214.875 256.992188 217.972656 253.179688 217.972656 Z M 253.179688 217.972656\"/>\n      <path d=\"M 253.179688 247.386719 L 163.542969 247.386719 C 159.730469 247.386719 156.632812 244.289062 156.632812 240.476562 C 156.632812 236.664062 159.730469 233.566406 163.542969 233.566406 L 253.179688 233.566406 C 256.992188 233.566406 260.089844 236.664062 260.089844 240.476562 C 260.089844 244.289062 256.992188 247.386719 253.179688 247.386719 Z M 253.179688 247.386719\"/>\n      <path d=\"M 253.179688 276.796875 L 163.542969 276.796875 C 159.730469 276.796875 156.632812 273.699219 156.632812 269.886719 C 156.632812 266.078125 159.730469 262.980469 163.542969 262.980469 L 253.179688 262.980469 C 256.992188 262.980469 260.089844 266.078125 260.089844 269.886719 C 260.089844 273.699219 256.992188 276.796875 253.179688 276.796875 Z M 253.179688 276.796875\"/>\n      <path d=\"M 222.390625 306.210938 L 163.542969 306.210938 C 159.730469 306.210938 156.632812 303.113281 156.632812 299.300781 C 156.632812 295.488281 159.730469 292.390625 163.542969 292.390625 L 222.390625 292.390625 C 226.203125 292.390625 229.300781 295.488281 229.300781 299.300781 C 229.300781 303.113281 226.203125 306.210938 222.390625 306.210938 Z M 222.390625 306.210938\"/>\n      <path d=\"M 197.074219 82.875 C 201.476562 82.875 205.042969 79.304688 205.042969 74.90625 L 205.042969 30.964844 C 205.042969 26.5625 201.476562 22.996094 197.074219 22.996094 C 192.675781 22.996094 189.105469 26.5625 189.105469 30.964844 L 189.105469 74.90625 C 189.105469 79.304688 192.675781 82.875 197.074219 82.875 Z M 197.074219 82.875\"/>\n      <path d=\"M 139.449219 95.160156 C 142.515625 98.222656 147.542969 98.222656 150.601562 95.160156 C 153.664062 92.097656 153.664062 87.070312 150.601562 84.011719 L 119.464844 52.875 C 116.402344 49.8125 111.375 49.8125 108.316406 52.875 C 105.253906 55.9375 105.253906 60.964844 108.316406 64.023438 Z M 139.449219 95.160156\"/>\n      <path d=\"M 266.179688 95.160156 L 297.320312 64.023438 C 300.378906 60.960938 300.378906 55.933594 297.320312 52.875 C 294.257812 49.8125 289.230469 49.8125 286.171875 52.875 L 255.03125 84.011719 C 251.96875 87.074219 251.96875 92.101562 255.03125 95.160156 C 258.09375 98.21875 263.121094 98.21875 266.179688 95.160156 Z M 266.179688 95.160156\"/>\n      <path d=\"M 333.929688 109.433594 C 341.886719 101.476562 341.886719 88.519531 333.929688 80.5625 L 330.617188 77.246094 C 322.65625 69.289062 309.703125 69.289062 301.746094 77.246094 C 293.785156 85.207031 293.785156 98.160156 301.746094 106.117188 L 305.058594 109.433594 C 313.015625 117.390625 325.972656 117.390625 333.929688 109.433594 Z M 333.929688 109.433594\"/>\n      <path d=\"M 83.746094 109.433594 L 87.0625 106.117188 C 95.019531 98.160156 95.019531 85.207031 87.0625 77.246094 C 79.101562 69.289062 66.148438 69.289062 58.191406 77.246094 L 54.878906 80.5625 C 46.921875 88.519531 46.921875 101.476562 54.878906 109.433594 C 62.835938 117.390625 75.792969 117.390625 83.746094 109.433594 Z M 83.746094 109.433594\"/>\n    </svg>\n  );\n}\n\ninterface Message {\n  _id: string;\n  id: string;\n  conversationId: string;\n  senderType: \"user\" | \"admin\" | \"system\";\n  senderId?: string;\n  senderName?: string;\n  content: string;\n  isRead: boolean;\n  createdAt: string;\n}\n\ninterface Conversation {\n  _id: string;\n  id: string;\n  userId?: string;\n  guestId?: string;\n  status: \"active\" | \"closed\";\n  unreadByUser: number;\n  lastMessageAt: string;\n}\n\ninterface ChatWidgetProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onMinimize: () => void;\n}\n\nexport function ChatWidget({ isOpen, onClose, onMinimize }: ChatWidgetProps) {\n  const [message, setMessage] = useState(\"\");\n  const [socket, setSocket] = useState<Socket | null>(null);\n  const [conversationId, setConversationId] = useState<string | null>(null);\n  const [messages, setMessages] = useState<Message[]>([]);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const inputRef = useRef<HTMLInputElement>(null);\n  const { user, isAuthenticated } = useAuth();\n\n  const { data: conversation, isLoading: isLoadingConversation } = useQuery<Conversation>({\n    queryKey: [\"/api/support/conversation\"],\n    enabled: isOpen,\n    retry: false,\n  });\n\n  const { data: fetchedMessages = [] } = useQuery<Message[]>({\n    queryKey: [\"/api/support/conversation\", conversationId, \"messages\"],\n    enabled: !!conversationId,\n    refetchInterval: isOpen ? 3000 : false,\n  });\n\n  const sendMessageMutation = useMutation({\n    mutationFn: async (content: string) => {\n      const response = await apiRequest(\"POST\", `/api/support/conversation/${conversationId}/messages`, { content });\n      return response.json();\n    },\n    onSuccess: (newMessage) => {\n      setMessages((prev) => [...prev, newMessage]);\n      setMessage(\"\");\n    },\n  });\n\n  const createConversationMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest(\"POST\", \"/api/support/conversation\", {});\n      return response.json();\n    },\n    onSuccess: (conv) => {\n      setConversationId(conv._id || conv.id);\n      queryClient.invalidateQueries({ queryKey: [\"/api/support/conversation\"] });\n    },\n  });\n\n  useEffect(() => {\n    if (conversation) {\n      setConversationId(conversation._id || conversation.id);\n    }\n  }, [conversation]);\n\n  useEffect(() => {\n    if (fetchedMessages.length > 0) {\n      setMessages(fetchedMessages);\n    }\n  }, [fetchedMessages]);\n\n  useEffect(() => {\n    if (isOpen && conversationId) {\n      const newSocket = io({\n        path: \"/socket.io\",\n        transports: [\"websocket\", \"polling\"],\n      });\n\n      newSocket.on(\"connect\", () => {\n        console.log(\"Chat socket connected\");\n        newSocket.emit(\"join:conversation\", conversationId);\n      });\n\n      newSocket.on(\"message:new\", (newMessage: Message) => {\n        if (newMessage.senderType === \"admin\") {\n          setMessages((prev) => {\n            const exists = prev.some((m) => m._id === newMessage._id || m.id === newMessage.id);\n            if (exists) return prev;\n            return [...prev, newMessage];\n          });\n        }\n      });\n\n      setSocket(newSocket);\n\n      return () => {\n        newSocket.emit(\"leave:conversation\", conversationId);\n        newSocket.disconnect();\n      };\n    }\n  }, [isOpen, conversationId]);\n\n  useEffect(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  }, [messages]);\n\n  useEffect(() => {\n    if (isOpen && inputRef.current) {\n      inputRef.current.focus();\n    }\n  }, [isOpen]);\n\n  const handleSendMessage = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!message.trim()) return;\n\n    if (!conversationId) {\n      createConversationMutation.mutate();\n      return;\n    }\n\n    sendMessageMutation.mutate(message.trim());\n  };\n\n  const handleStartChat = () => {\n    createConversationMutation.mutate();\n  };\n\n  if (!isOpen) return null;\n\n  return (\n    <Card className=\"fixed bottom-20 right-4 w-80 sm:w-96 h-[500px] flex flex-col shadow-2xl z-50\" data-testid=\"chat-widget\">\n      <CardHeader className=\"flex flex-col gap-1 py-3 px-4 border-b bg-primary text-primary-foreground rounded-t-lg\">\n        <div className=\"flex items-center justify-between gap-2\">\n          <div className=\"flex items-center gap-2\">\n            <MessageCircle className=\"w-5 h-5\" />\n            <CardTitle className=\"text-base font-medium\">H·ªó tr·ª£ tr·ª±c tuy·∫øn</CardTitle>\n          </div>\n          <div className=\"flex items-center gap-1\">\n            <Button\n              size=\"icon\"\n              variant=\"ghost\"\n              className=\"h-8 w-8 text-primary-foreground hover:bg-primary-foreground/20\"\n              onClick={onMinimize}\n              data-testid=\"button-minimize-chat\"\n            >\n              <Minimize2 className=\"w-4 h-4\" />\n            </Button>\n            <Button\n              size=\"icon\"\n              variant=\"ghost\"\n              className=\"h-8 w-8 text-primary-foreground hover:bg-primary-foreground/20\"\n              onClick={onClose}\n              data-testid=\"button-close-chat\"\n            >\n              <X className=\"w-4 h-4\" />\n            </Button>\n          </div>\n        </div>\n        <div className=\"flex items-center gap-1.5 text-xs text-primary-foreground/80\" data-testid=\"chat-user-info\">\n          <User className=\"w-3 h-3\" />\n          <span>{isAuthenticated && user?.email ? user.email : \"Kh√°ch\"}</span>\n        </div>\n      </CardHeader>\n\n      <CardContent className=\"flex-1 p-0 overflow-hidden\">\n        <ScrollArea className=\"h-full p-4\">\n          {isLoadingConversation ? (\n            <div className=\"flex items-center justify-center h-full\">\n              <p className=\"text-muted-foreground\">ƒêang t·∫£i...</p>\n            </div>\n          ) : !conversationId ? (\n            <div className=\"flex flex-col items-center justify-center h-full gap-4 text-center\">\n              <MessageCircle className=\"w-12 h-12 text-muted-foreground\" />\n              <div>\n                <p className=\"font-medium mb-2\">Ch√†o m·ª´ng b·∫°n!</p>\n                <p className=\"text-sm text-muted-foreground mb-4\">\n                  H√£y b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán v·ªõi b·ªô ph·∫≠n h·ªó tr·ª£ c·ªßa ch√∫ng t√¥i.\n                </p>\n                <Button onClick={handleStartChat} data-testid=\"button-start-chat\">\n                  B·∫Øt ƒë·∫ßu chat\n                </Button>\n              </div>\n            </div>\n          ) : messages.length === 0 ? (\n            <div className=\"flex flex-col items-center justify-center h-full text-center\">\n              <p className=\"text-sm text-muted-foreground\">\n                Ch∆∞a c√≥ tin nh·∫Øn. H√£y g·ª≠i tin nh·∫Øn ƒë·∫ßu ti√™n!\n              </p>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              {messages.map((msg) => (\n                <div\n                  key={msg._id || msg.id}\n                  className={cn(\n                    \"flex\",\n                    msg.senderType === \"user\" ? \"justify-end\" : \"justify-start\"\n                  )}\n                >\n                  <div\n                    className={cn(\n                      \"max-w-[80%] rounded-lg px-3 py-2\",\n                      msg.senderType === \"user\"\n                        ? \"bg-primary text-primary-foreground\"\n                        : msg.senderType === \"admin\"\n                        ? \"bg-muted\"\n                        : \"bg-accent text-accent-foreground text-center text-sm\"\n                    )}\n                  >\n                    {msg.senderType !== \"user\" && msg.senderName && (\n                      <p className=\"text-xs font-medium mb-1 opacity-70\">\n                        {msg.senderName}\n                      </p>\n                    )}\n                    <p className=\"text-sm whitespace-pre-wrap break-words\">{msg.content}</p>\n                    <p className={cn(\n                      \"text-xs mt-1\",\n                      msg.senderType === \"user\" ? \"text-primary-foreground/70\" : \"text-muted-foreground\"\n                    )}>\n                      {new Date(msg.createdAt).toLocaleTimeString(\"vi-VN\", {\n                        hour: \"2-digit\",\n                        minute: \"2-digit\",\n                      })}\n                    </p>\n                  </div>\n                </div>\n              ))}\n              <div ref={messagesEndRef} />\n            </div>\n          )}\n        </ScrollArea>\n      </CardContent>\n\n      {conversationId && (\n        <CardFooter className=\"p-3 border-t\">\n          <form onSubmit={handleSendMessage} className=\"flex w-full gap-2\">\n            <Input\n              ref={inputRef}\n              value={message}\n              onChange={(e) => setMessage(e.target.value)}\n              placeholder=\"Nh·∫≠p tin nh·∫Øn...\"\n              className=\"flex-1\"\n              disabled={sendMessageMutation.isPending}\n              data-testid=\"input-chat-message\"\n            />\n            <Button\n              type=\"submit\"\n              size=\"icon\"\n              disabled={!message.trim() || sendMessageMutation.isPending}\n              data-testid=\"button-send-message\"\n            >\n              <Send className=\"w-4 h-4\" />\n            </Button>\n          </form>\n        </CardFooter>\n      )}\n    </Card>\n  );\n}\n\nconst blinkingStyle = `\n@keyframes blink {\n  0%, 50% { opacity: 1; }\n  51%, 100% { opacity: 0; }\n}\n`;\n\nexport function ChatLauncher() {\n  const [isOpen, setIsOpen] = useState(false);\n  const [isMinimized, setIsMinimized] = useState(false);\n  const [unreadCount, setUnreadCount] = useState(0);\n\n  const { data: conversation } = useQuery<Conversation>({\n    queryKey: [\"/api/support/conversation\"],\n    retry: false,\n    refetchInterval: isOpen ? false : 30000,\n  });\n\n  useEffect(() => {\n    if (conversation && !isOpen) {\n      setUnreadCount(conversation.unreadByUser || 0);\n    }\n  }, [conversation, isOpen]);\n\n  const handleOpen = () => {\n    setIsOpen(true);\n    setIsMinimized(false);\n    setUnreadCount(0);\n  };\n\n  const handleClose = () => {\n    setIsOpen(false);\n    setIsMinimized(false);\n  };\n\n  const handleMinimize = () => {\n    setIsOpen(false);\n    setIsMinimized(true);\n  };\n\n  return (\n    <>\n      <style>{blinkingStyle}</style>\n      <ChatWidget isOpen={isOpen} onClose={handleClose} onMinimize={handleMinimize} />\n      \n      {!isOpen && (\n        <div\n          style={{\n            position: 'fixed',\n            bottom: '80px',\n            right: '16px',\n            zIndex: 9999,\n            display: 'flex',\n            flexDirection: 'column',\n            alignItems: 'center',\n            gap: '4px',\n          }}\n        >\n          <span\n            style={{\n              backgroundColor: '#78d2f0',\n              color: '#ffffff',\n              fontSize: '11px',\n              fontWeight: 600,\n              padding: '4px 8px',\n              borderRadius: '4px',\n              whiteSpace: 'nowrap',\n              animation: 'blink 1.5s infinite',\n              boxShadow: '0 2px 8px rgba(0, 0, 0, 0.15)',\n            }}\n            data-testid=\"text-contact-label\"\n          >\n            Li√™n h·ªá\n          </span>\n          <button\n            onClick={handleOpen}\n            style={{\n              position: 'relative',\n              width: '56px',\n              height: '56px',\n              borderRadius: '50%',\n              backgroundColor: '#78d2f0',\n              color: '#fff400',\n              border: 'none',\n              boxShadow: '0 4px 12px rgba(0, 0, 0, 0.15)',\n              cursor: 'pointer',\n              display: 'flex',\n              alignItems: 'center',\n              justifyContent: 'center',\n            }}\n            data-testid=\"button-chat-launcher\"\n          >\n            <ChatIcon className=\"w-8 h-8\" />\n            {unreadCount > 0 && (\n              <span style={{\n                position: 'absolute',\n                top: '-4px',\n                right: '-4px',\n                backgroundColor: '#ef4444',\n                color: '#ffffff',\n                fontSize: '12px',\n                fontWeight: 'bold',\n                borderRadius: '50%',\n                width: '20px',\n                height: '20px',\n                display: 'flex',\n                alignItems: 'center',\n                justifyContent: 'center',\n              }}>\n                {unreadCount > 9 ? \"9+\" : unreadCount}\n              </span>\n            )}\n          </button>\n        </div>\n      )}\n    </>\n  );\n}\n","path":null,"size_bytes":25527,"size_tokens":null},"attached_assets/excel_to_png_1764611681407.py":{"content":"import os\r\nimport pandas as pd\r\nfrom jinja2 import Environment, FileSystemLoader\r\nfrom playwright.sync_api import sync_playwright\r\nimport math\r\nimport shutil\r\nfrom PIL import Image, ImageFilter, ImageDraw, ImageFont\r\nimport re\r\nimport warnings\r\n\r\n# --- T·∫ÆT C·∫¢NH B√ÅO PANDAS ---\r\nwarnings.simplefilter(action='ignore', category=FutureWarning)\r\n\r\n# --- C·∫§U H√åNH ---\r\nEXCEL_DIR = \"excel_files\"\r\nHTML_DIR = \"output_html\"\r\nIMAGE_DIR = \"output_images\"\r\nDATA_CHECK_DIR = \"data_check\"\r\n\r\nTARGET_WIDTH, TARGET_HEIGHT = 2000, 1300\r\nROW_HEIGHT = 108\r\nROWS_PER_PAGE = 10\r\nDATA_COLS_TO_KEEP = 15\r\nINDEX_COL_WIDTH = 50\r\nTOP_3_COL_WIDTH = 200\r\nOTHER_COL_WIDTH = 105\r\nAVG_CHAR_WIDTH = 8.5\r\nCELL_PADDING_X = 10\r\nLINE_HEIGHT_ESTIMATE = 18\r\n\r\n# --- C·∫§U H√åNH GI·ªöI H·∫†N LEAK ---\r\nMAX_LEAK_TOLERANCE = 5  # Cho ph√©p l·ªçt t·ªëi ƒëa 5 l·ªói/file\r\n\r\n# --- C·∫§U H√åNH WATERMARK ---\r\nWATERMARK_TEXT = \"DATALD.COM\"\r\nWATERMARK_OPACITY = 90  # ƒê·ªô ƒë·∫≠m nh·∫°t (0-255), c√†ng th·∫•p c√†ng m·ªù. 30-50 l√† v·ª´a ƒë·∫πp.\r\nGRID_COLS = 3 # S·ªë l∆∞·ª£ng watermark theo chi·ªÅu ngang\r\nGRID_ROWS = 3 # S·ªë l∆∞·ª£ng watermark theo chi·ªÅu d·ªçc\r\n\r\n# --- H√ÄM M√É H√ìA (MASKING) ---\r\ndef mask_number_group(match):\r\n    digit_str = match.group()\r\n    length = len(digit_str)\r\n    num_to_mask = math.ceil(length / 2)\r\n    return (\"*\" * num_to_mask) + digit_str[num_to_mask:]\r\n\r\ndef mask_email_group(match):\r\n    email = match.group()\r\n    if '@' in email:\r\n        user_part, domain_part = email.split('@', 1)\r\n        masked_user = '*' * len(user_part)\r\n        return f\"{masked_user}@{domain_part}\"\r\n    return email\r\n\r\ndef mask_cell_value(value):\r\n    text = str(value)\r\n    if not text or text.strip().lower() == 'nan':\r\n        return \"\"\r\n    \r\n    # 1. Email\r\n    email_pattern = r'\\b[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}\\b'\r\n    text = re.sub(email_pattern, mask_email_group, text)\r\n\r\n    # 2. S·ªë\r\n    text = re.sub(r'\\d+', mask_number_group, text)\r\n    return text\r\n\r\n# --- H√ÄM KI·ªÇM TRA B·∫¢O M·∫¨T ---\r\ndef check_html_leakage_count(html_path, file_name_check):\r\n    leak_count = 0\r\n    details = []\r\n    try:\r\n        with open(html_path, 'r', encoding='utf-8') as f:\r\n            content = f.read()\r\n        \r\n        # Check Email\r\n        email_pattern = r'\\b[a-zA-Z0-9][a-zA-Z0-9._%+-]*@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}\\b'\r\n        leaked_emails = re.findall(email_pattern, content)\r\n        if leaked_emails:\r\n            leak_count += len(leaked_emails)\r\n            details.extend(leaked_emails)\r\n\r\n        # Check S·ªë\r\n        number_pattern = r'(?<!\\*)\\b\\d{7,}\\b'\r\n        leaked_numbers = re.findall(number_pattern, content)\r\n        if leaked_numbers:\r\n            for num in leaked_numbers:\r\n                if num in file_name_check: continue\r\n                leak_count += 1\r\n                details.append(num)\r\n            \r\n        return leak_count, details\r\n    except Exception as e:\r\n        print(f\"L·ªói check file {html_path}: {e}\")\r\n        return 1, [\"L·ªói ƒë·ªçc file\"]\r\n\r\n# --- C√ÅC H√ÄM H·ªñ TR·ª¢ D·ªÆ LI·ªÜU ---\r\ndef get_column_widths(df_chunk):\r\n    if df_chunk.empty: return []\r\n    try:\r\n        avg_lengths = df_chunk.astype(str).map(lambda x: len(str(x).strip())).mean()\r\n    except AttributeError:\r\n        avg_lengths = df_chunk.astype(str).applymap(lambda x: len(str(x).strip())).mean()\r\n    top_3_indices = avg_lengths.sort_values(ascending=False).head(3).index\r\n    data_widths = []\r\n    for i in range(len(df_chunk.columns)):\r\n        if i in top_3_indices: data_widths.append(TOP_3_COL_WIDTH)\r\n        else: data_widths.append(OTHER_COL_WIDTH)\r\n    return [INDEX_COL_WIDTH] + data_widths\r\n\r\ndef get_cell_class(text, col_width):\r\n    text_space = col_width - CELL_PADDING_X\r\n    if text_space <= 0: return \"no-wrap-text\"\r\n    num_lines = math.ceil(len(str(text).strip()) * AVG_CHAR_WIDTH / text_space)\r\n    estimated_height = num_lines * LINE_HEIGHT_ESTIMATE\r\n    return \"wrap-text\" if estimated_height <= ROW_HEIGHT else \"no-wrap-text\"\r\n\r\n# --- CORE: T·∫†O HTML (ƒê√£ x√≥a ph·∫ßn Cover) ---\r\ndef generate_html_for_sheet(df, file_name, sheet_name, template):\r\n    generated_files = [] \r\n    \r\n    if len(df.columns) > DATA_COLS_TO_KEEP: df = df.iloc[:, :DATA_COLS_TO_KEEP]\r\n    df = df[df.apply(lambda row: any(str(cell).strip() != '' and str(cell).strip().lower() != 'nan' for cell in row), axis=1)]\r\n    if df.empty: return []\r\n\r\n    # --- CH·ªà T·∫†O C√ÅC TRANG N·ªòI DUNG (PAGES) ---\r\n    num_pages = math.ceil(len(df) / ROWS_PER_PAGE)\r\n    for i in range(num_pages):\r\n        page_df = df.iloc[i*ROWS_PER_PAGE : (i+1)*ROWS_PER_PAGE]\r\n        temp_df = page_df.copy()\r\n        while len(temp_df.columns) < DATA_COLS_TO_KEEP: temp_df[f'ph_{len(temp_df.columns)}'] = ''\r\n        col_widths = get_column_widths(temp_df)\r\n\r\n        page_data = []\r\n        for r_idx, row in page_df.iterrows():\r\n            row_cells = []\r\n            for c_idx, cell in enumerate(row):\r\n                val = mask_cell_value('' if str(cell).strip().lower() == 'nan' else cell)\r\n                row_cells.append({\"value\": val, \"class\": get_cell_class(val, col_widths[c_idx+1])})\r\n            while len(row_cells) < DATA_COLS_TO_KEEP: row_cells.append({\"value\": \"\", \"class\": \"wrap-text\"})\r\n            page_data.append({\"excel_row_num\": r_idx + 1, \"cells\": row_cells})\r\n        while len(page_data) < ROWS_PER_PAGE:\r\n            page_data.append({\"excel_row_num\": \" \", \"cells\": [{\"value\": \"\", \"class\": \"wrap-text\"}]*DATA_COLS_TO_KEEP})\r\n\r\n        page_html_path = os.path.join(HTML_DIR, f\"{file_name}_{sheet_name}_page_{i+1}.html\")\r\n        with open(page_html_path, 'w', encoding='utf-8') as f:\r\n            f.write(template.render({\"title\": f\"{file_name} - {sheet_name} - P{i+1}\", \"page_data\": page_data, \"column_widths\": col_widths}))\r\n        generated_files.append((f\"PAGE_{i+1}\", page_html_path, sheet_name))\r\n        \r\n    return generated_files\r\n\r\n# --- H√ÄM X·ª¨ L√ù WATERMARK ---\r\ndef add_watermark_to_image(image_path):\r\n    \"\"\"\r\n    Th√™m watermark 'datald.com' m·ªù v√†o ·∫£nh.\r\n    B·ªë c·ª•c: L∆∞·ªõi 5 c·ªôt x 3 h√†ng.\r\n    \"\"\"\r\n    try:\r\n        # M·ªü ·∫£nh d∆∞·ªõi d·∫°ng RGBA ƒë·ªÉ x·ª≠ l√Ω trong su·ªët\r\n        base_image = Image.open(image_path).convert(\"RGBA\")\r\n        width, height = base_image.size\r\n        \r\n        # T·∫°o m·ªôt layer trong su·ªët ƒë·ªÉ v·∫Ω ch·ªØ\r\n        txt_layer = Image.new(\"RGBA\", base_image.size, (255, 255, 255, 0))\r\n        draw = ImageDraw.Draw(txt_layer)\r\n        \r\n        # C√†i ƒë·∫∑t Font ch·ªØ\r\n        # C·ªë g·∫Øng load font Arial, n·∫øu kh√¥ng c√≥ th√¨ d√πng default (x·∫•u h∆°n)\r\n        font_size = int(width / 25) # K√≠ch th∆∞·ªõc ch·ªØ d·ª±a theo chi·ªÅu r·ªông ·∫£nh cho c√¢n ƒë·ªëi\r\n        try:\r\n            # Tr√™n Windows th∆∞·ªùng c√≥ arial.ttf, Linux/Mac c·∫ßn path kh√°c n·∫øu l·ªói\r\n            font = ImageFont.truetype(\"arial.ttf\", font_size)\r\n        except IOError:\r\n            font = ImageFont.load_default()\r\n        \r\n        # T√≠nh to√°n l∆∞·ªõi\r\n        step_x = width / GRID_COLS\r\n        step_y = height / GRID_ROWS\r\n        \r\n        # M√†u ch·ªØ: X√°m nh·∫°t + Opacity\r\n        text_color = (150, 150, 150, WATERMARK_OPACITY)\r\n        \r\n        for r in range(GRID_ROWS):\r\n            for c in range(GRID_COLS):\r\n                # T√≠nh t·ªça ƒë·ªô t√¢m c·ªßa m·ªói √¥ l∆∞·ªõi\r\n                center_x = (c * step_x) + (step_x / 2)\r\n                center_y = (r * step_y) + (step_y / 2)\r\n                \r\n                # T√≠nh k√≠ch th∆∞·ªõc chu·ªói ƒë·ªÉ cƒÉn gi·ªØa ch√≠nh x√°c\r\n                bbox = draw.textbbox((0, 0), WATERMARK_TEXT, font=font)\r\n                text_w = bbox[2] - bbox[0]\r\n                text_h = bbox[3] - bbox[1]\r\n                \r\n                x = center_x - (text_w / 2)\r\n                y = center_y - (text_h / 2)\r\n                \r\n                # V·∫Ω ch·ªØ l√™n layer trong su·ªët\r\n                draw.text((x, y), WATERMARK_TEXT, font=font, fill=text_color)\r\n        \r\n        # G·ªôp layer ch·ªØ v√†o ·∫£nh g·ªëc\r\n        combined = Image.alpha_composite(base_image, txt_layer)\r\n        \r\n        # Chuy·ªÉn v·ªÅ RGB ƒë·ªÉ l∆∞u file png/jpg chu·∫©n\r\n        combined = combined.convert(\"RGB\")\r\n        combined.save(image_path)\r\n        \r\n    except Exception as e:\r\n        print(f\"     ‚ö†Ô∏è L·ªói th√™m watermark: {e}\")\r\n\r\n# --- H√ÄM T·∫†O ·∫¢NH T·ª™ LIST HTML ---\r\ndef create_images_from_list(html_list, file_name):\r\n    print(f\"     ‚úÖ FILE H·ª¢P L·ªÜ. ƒêang t·∫°o {len(html_list)} ·∫£nh...\")\r\n    with sync_playwright() as p:\r\n        browser = p.chromium.launch()\r\n        page = browser.new_page()\r\n        page.set_viewport_size({\"width\": TARGET_WIDTH, \"height\": TARGET_HEIGHT})\r\n        \r\n        for type_label, html_path, sheet_name in html_list:\r\n            sheet_output_dir = os.path.join(IMAGE_DIR, file_name, sheet_name)\r\n            os.makedirs(sheet_output_dir, exist_ok=True)\r\n\r\n            img_filename = os.path.basename(html_path).replace(\".html\", \".png\")\r\n            img_path = os.path.join(sheet_output_dir, img_filename)\r\n            \r\n            # 1. Ch·ª•p ·∫£nh m√†n h√¨nh\r\n            page.goto(f\"file://{os.path.abspath(html_path)}\")\r\n            page.screenshot(path=img_path, full_page=False)\r\n            \r\n            # 2. Th√™m Watermark\r\n            add_watermark_to_image(img_path)\r\n\r\n        browser.close()\r\n\r\ndef cleanup_htmls(html_list):\r\n    for _, path, _ in html_list:\r\n        if os.path.exists(path):\r\n            os.remove(path)\r\n\r\n# --- WORKFLOW CH√çNH ---\r\ndef process_excel_file_workflow(excel_path, template):\r\n    file_name = os.path.splitext(os.path.basename(excel_path))[0]\r\n    print(f\"\\n--- FILE: {os.path.basename(excel_path)} ---\")\r\n    \r\n    try:\r\n        all_sheets = pd.read_excel(excel_path, sheet_name=None, header=None)\r\n    except Exception as e:\r\n        print(f\"L·ªói ƒë·ªçc file: {e}\")\r\n        return\r\n\r\n    def generate_all_htmls():\r\n        total_htmls = []\r\n        for sheet_name, df in all_sheets.items():\r\n            sheet_htmls = generate_html_for_sheet(df, file_name, sheet_name, template)\r\n            total_htmls.extend(sheet_htmls)\r\n        return total_htmls\r\n\r\n    # 1. T·∫°o HTML\r\n    print(f\"     1Ô∏è‚É£  Giai ƒëo·∫°n 1: T·∫°o HTML to√†n b·ªô c√°c sheet...\")\r\n    all_html_files = generate_all_htmls()\r\n    if not all_html_files:\r\n        print(\"     ‚ö†Ô∏è  File kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá.\")\r\n        return\r\n\r\n    # 2. Check L·∫ßn 1\r\n    print(f\"     2Ô∏è‚É£  Giai ƒëo·∫°n 2: Qu√©t l·ªói b·∫£o m·∫≠t (Ng∆∞·ª°ng cho ph√©p: {MAX_LEAK_TOLERANCE} l·ªói)...\")\r\n    total_leaks = 0\r\n    all_leak_details = []\r\n    \r\n    for _, html_path, _ in all_html_files:\r\n        count, details = check_html_leakage_count(html_path, file_name)\r\n        total_leaks += count\r\n        all_leak_details.extend(details)\r\n    \r\n    should_retry = False\r\n    if total_leaks > MAX_LEAK_TOLERANCE:\r\n        print(f\"     ‚ö†Ô∏è  C·∫£nh b√°o: Ph√°t hi·ªán {total_leaks} l·ªói. V√≠ d·ª•: {all_leak_details[:3]}...\")\r\n        print(\"     üîÑ ƒêang th·ª≠ t·∫°o l·∫°i (Retry to√†n b·ªô file)...\")\r\n        should_retry = True\r\n    elif total_leaks > 0:\r\n        print(f\"     ‚ö†Ô∏è  Th√¥ng b√°o: Ph√°t hi·ªán {total_leaks} l·ªói (Trong ng∆∞·ª°ng cho ph√©p). Ti·∫øp t·ª•c.\")\r\n    else:\r\n        print(f\"     ‚úÖ Tuy·ªát v·ªùi: Kh√¥ng ph√°t hi·ªán l·ªói n√†o.\")\r\n\r\n    # 3. Retry n·∫øu c·∫ßn\r\n    if should_retry:\r\n        cleanup_htmls(all_html_files)\r\n        all_html_files = generate_all_htmls()\r\n        total_leaks = 0\r\n        all_leak_details = []\r\n        for _, html_path, _ in all_html_files:\r\n            count, details = check_html_leakage_count(html_path, file_name)\r\n            total_leaks += count\r\n            all_leak_details.extend(details)\r\n            \r\n    # 4. Quy·∫øt ƒë·ªãnh cu·ªëi c√πng\r\n    if total_leaks > MAX_LEAK_TOLERANCE:\r\n        print(f\"     ‚ùå STOP: V·∫´n c√≤n {total_leaks} l·ªói sau khi retry.\")\r\n        dest_path = os.path.join(DATA_CHECK_DIR, os.path.basename(excel_path))\r\n        if not os.path.exists(dest_path):\r\n            shutil.copy2(excel_path, dest_path)\r\n            print(f\"     -> ƒê√£ copy file Excel v√†o '{DATA_CHECK_DIR}'\")\r\n        else:\r\n            print(f\"     -> File Excel ƒë√£ t·ªìn t·∫°i trong '{DATA_CHECK_DIR}'\")\r\n        cleanup_htmls(all_html_files)\r\n        print(\"     üö´ ƒê√£ h·ªßy b·ªè output cho to√†n b·ªô file n√†y.\")\r\n        return \r\n    \r\n    else:\r\n        try:\r\n            create_images_from_list(all_html_files, file_name)\r\n        except Exception as e:\r\n            print(f\"     ‚ùå L·ªói khi t·∫°o ·∫£nh: {e}\")\r\n        finally:\r\n            cleanup_htmls(all_html_files)\r\n\r\n# --- MAIN ---\r\ndef main():\r\n    print(f\"üöÄ B·∫Øt ƒë·∫ßu... (No Cover + Watermark 5x3)\")\r\n    os.makedirs(HTML_DIR, exist_ok=True)\r\n    os.makedirs(IMAGE_DIR, exist_ok=True)\r\n    os.makedirs(DATA_CHECK_DIR, exist_ok=True)\r\n\r\n    env = Environment(loader=FileSystemLoader('.'))\r\n    template = env.get_template('template.html')\r\n\r\n    excel_files = [f for f in os.listdir(EXCEL_DIR) if f.endswith(('.xlsx', '.xls'))]\r\n    if not excel_files:\r\n        print(\"Kh√¥ng t√¨m th·∫•y file Excel.\")\r\n        return\r\n\r\n    for filename in excel_files:\r\n        excel_path = os.path.join(EXCEL_DIR, filename)\r\n        process_excel_file_workflow(excel_path, template)\r\n\r\n    if os.path.exists(HTML_DIR):\r\n        try: shutil.rmtree(HTML_DIR)\r\n        except: pass\r\n        \r\n    print(\"\\n‚úÖ HO√ÄN T·∫§T. Vui l√≤ng ki·ªÉm tra th∆∞ m·ª•c 'data_check'.\")\r\n\r\nif __name__ == \"__main__\":\r\n    main()","path":null,"size_bytes":13486,"size_tokens":null},"server/services/doSpaces.ts":{"content":"import { S3Client, PutObjectCommand, DeleteObjectCommand } from \"@aws-sdk/client-s3\";\nimport fs from \"fs/promises\";\nimport path from \"path\";\n\nconst REGION = \"sgp1\";\n\nlet s3Client: S3Client | null = null;\n\nfunction getS3Client(): S3Client {\n  if (!s3Client) {\n    const DO_ENDPOINT = process.env.DO_ENDPOINT || \"https://sgp1.digitaloceanspaces.com\";\n    const DO_ACCESS_KEY = process.env.DO_ACCESS_KEY;\n    const DO_SECRET_KEY = process.env.DO_SECRET_KEY;\n    \n    console.log(`[DO Spaces] Initializing client with endpoint: ${DO_ENDPOINT}`);\n    console.log(`[DO Spaces] Access Key present: ${!!DO_ACCESS_KEY}, Secret Key present: ${!!DO_SECRET_KEY}`);\n    \n    if (!DO_ACCESS_KEY || !DO_SECRET_KEY) {\n      throw new Error(\"DO_ACCESS_KEY and DO_SECRET_KEY are required for DigitalOcean Spaces\");\n    }\n    \n    s3Client = new S3Client({\n      endpoint: DO_ENDPOINT,\n      region: REGION,\n      credentials: {\n        accessKeyId: DO_ACCESS_KEY,\n        secretAccessKey: DO_SECRET_KEY,\n      },\n      forcePathStyle: false,\n    });\n    \n    console.log(`[DO Spaces] S3 client initialized successfully`);\n  }\n  return s3Client;\n}\n\nexport function resetS3Client(): void {\n  s3Client = null;\n  console.log(`[DO Spaces] S3 client reset - will reinitialize on next use`);\n}\n\nfunction getBucketName(): string {\n  return process.env.DO_BUCKET_NAME || \"data-ld1\";\n}\n\nexport interface UploadResult {\n  success: boolean;\n  url?: string;\n  key?: string;\n  error?: string;\n}\n\nexport interface UploadOptions {\n  localFilePath: string;\n  remoteKey: string;\n  contentType?: string;\n  isPublic?: boolean;\n}\n\nfunction getContentType(filePath: string): string {\n  const ext = path.extname(filePath).toLowerCase();\n  const mimeTypes: Record<string, string> = {\n    \".png\": \"image/png\",\n    \".jpg\": \"image/jpeg\",\n    \".jpeg\": \"image/jpeg\",\n    \".gif\": \"image/gif\",\n    \".webp\": \"image/webp\",\n    \".pdf\": \"application/pdf\",\n    \".xlsx\": \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n    \".xls\": \"application/vnd.ms-excel\",\n    \".csv\": \"text/csv\",\n  };\n  return mimeTypes[ext] || \"application/octet-stream\";\n}\n\nexport async function uploadToSpaces(options: UploadOptions): Promise<UploadResult> {\n  const { localFilePath, remoteKey, contentType, isPublic = true } = options;\n  \n  try {\n    const client = getS3Client();\n    \n    const fileContent = await fs.readFile(localFilePath);\n    const mimeType = contentType || getContentType(localFilePath);\n    const bucketName = getBucketName();\n    \n    console.log(`[DO Spaces] Uploading to bucket: ${bucketName}, key: ${remoteKey}, size: ${fileContent.length} bytes`);\n    \n    const command = new PutObjectCommand({\n      Bucket: bucketName,\n      Key: remoteKey,\n      Body: fileContent,\n      ContentType: mimeType,\n      ACL: isPublic ? \"public-read\" : \"private\",\n    });\n    \n    await client.send(command);\n    \n    const cdnUrl = `https://${bucketName}.${REGION}.cdn.digitaloceanspaces.com/${remoteKey}`;\n    \n    console.log(`[DO Spaces] Uploaded: ${remoteKey} -> ${cdnUrl}`);\n    \n    return {\n      success: true,\n      url: cdnUrl,\n      key: remoteKey,\n    };\n  } catch (error: any) {\n    const errorName = error.name || 'Unknown';\n    const errorCode = error.$metadata?.httpStatusCode || 'N/A';\n    const errorMessage = error.message || 'No message';\n    console.error(`[DO Spaces] Upload failed for ${remoteKey}:`);\n    console.error(`  - Error Name: ${errorName}`);\n    console.error(`  - HTTP Status: ${errorCode}`);\n    console.error(`  - Message: ${errorMessage}`);\n    if (error.$metadata) {\n      console.error(`  - Metadata:`, JSON.stringify(error.$metadata, null, 2));\n    }\n    return {\n      success: false,\n      error: `${errorName}: ${errorMessage} (HTTP ${errorCode})`,\n    };\n  }\n}\n\nexport async function uploadMultipleToSpaces(\n  files: { localPath: string; remotePath: string }[],\n  folderName: string\n): Promise<{ success: boolean; urls: string[]; errors: string[] }> {\n  const urls: string[] = [];\n  const errors: string[] = [];\n  \n  for (const file of files) {\n    const remoteKey = `${folderName}/${file.remotePath}`;\n    const result = await uploadToSpaces({\n      localFilePath: file.localPath,\n      remoteKey,\n    });\n    \n    if (result.success && result.url) {\n      urls.push(result.url);\n    } else {\n      errors.push(result.error || `Failed to upload ${file.localPath}`);\n    }\n  }\n  \n  return {\n    success: errors.length === 0,\n    urls,\n    errors,\n  };\n}\n\nexport async function deleteFromSpaces(remoteKey: string): Promise<boolean> {\n  try {\n    const client = getS3Client();\n    \n    const command = new DeleteObjectCommand({\n      Bucket: getBucketName(),\n      Key: remoteKey,\n    });\n    \n    await client.send(command);\n    console.log(`[DO Spaces] Deleted: ${remoteKey}`);\n    return true;\n  } catch (error: any) {\n    console.error(`[DO Spaces] Delete failed for ${remoteKey}:`, error.message);\n    return false;\n  }\n}\n\nexport function generateFolderName(postId: string, originalFileName: string): string {\n  const baseName = path.basename(originalFileName, path.extname(originalFileName));\n  const sanitizedName = baseName.replace(/[^a-zA-Z0-9_\\-\\u00C0-\\u024F\\u1E00-\\u1EFF]/g, \"_\").substring(0, 50);\n  return `${postId}-${sanitizedName}`;\n}\n\n// ============================================\n// ARCHIVE BUCKET (datashop) - for original files\n// ============================================\n\nlet archiveS3Client: S3Client | null = null;\n\nfunction getArchiveS3Client(): S3Client {\n  if (!archiveS3Client) {\n    const DO_ENDPOINT = process.env.DO_ENDPOINT_1 || \"https://sgp1.digitaloceanspaces.com\";\n    const DO_ACCESS_KEY = process.env.DO_ACCESS_KEY_1;\n    const DO_SECRET_KEY = process.env.DO_SECRET_KEY_1;\n    \n    console.log(`[DO Archive] Initializing archive client with endpoint: ${DO_ENDPOINT}`);\n    console.log(`[DO Archive] Access Key present: ${!!DO_ACCESS_KEY}, Secret Key present: ${!!DO_SECRET_KEY}`);\n    \n    if (!DO_ACCESS_KEY || !DO_SECRET_KEY) {\n      throw new Error(\"DO_ACCESS_KEY_1 and DO_SECRET_KEY_1 are required for archive bucket\");\n    }\n    \n    archiveS3Client = new S3Client({\n      endpoint: DO_ENDPOINT,\n      region: REGION,\n      credentials: {\n        accessKeyId: DO_ACCESS_KEY,\n        secretAccessKey: DO_SECRET_KEY,\n      },\n      forcePathStyle: false,\n    });\n    \n    console.log(`[DO Archive] Archive S3 client initialized successfully`);\n  }\n  return archiveS3Client;\n}\n\nfunction getArchiveBucketName(): string {\n  return process.env.DO_BUCKET_NAME_1 || \"datashop\";\n}\n\nexport async function uploadOriginalToArchive(localFilePath: string, remoteKey: string): Promise<UploadResult> {\n  try {\n    const client = getArchiveS3Client();\n    const fileContent = await fs.readFile(localFilePath);\n    const mimeType = getContentType(localFilePath);\n    const bucketName = getArchiveBucketName();\n    \n    console.log(`[DO Archive] Uploading original to bucket: ${bucketName}, key: ${remoteKey}, size: ${fileContent.length} bytes`);\n    \n    const command = new PutObjectCommand({\n      Bucket: bucketName,\n      Key: remoteKey,\n      Body: fileContent,\n      ContentType: mimeType,\n      ACL: \"private\",\n    });\n    \n    await client.send(command);\n    \n    const url = `https://${bucketName}.${REGION}.digitaloceanspaces.com/${remoteKey}`;\n    \n    console.log(`[DO Archive] Original file uploaded: ${remoteKey}`);\n    \n    return {\n      success: true,\n      url,\n      key: remoteKey,\n    };\n  } catch (error: any) {\n    const errorName = error.name || 'Unknown';\n    const errorCode = error.$metadata?.httpStatusCode || 'N/A';\n    const errorMessage = error.message || 'No message';\n    console.error(`[DO Archive] Upload failed for ${remoteKey}:`);\n    console.error(`  - Error Name: ${errorName}`);\n    console.error(`  - HTTP Status: ${errorCode}`);\n    console.error(`  - Message: ${errorMessage}`);\n    if (error.$metadata) {\n      console.error(`  - Metadata:`, JSON.stringify(error.$metadata, null, 2));\n    }\n    return {\n      success: false,\n      error: `${errorName}: ${errorMessage} (HTTP ${errorCode})`,\n    };\n  }\n}\n","path":null,"size_bytes":8073,"size_tokens":null},"client/src/components/NotificationBell.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Bell, Check, CheckCheck } from \"lucide-react\";\n\ninterface Notification {\n  id: string;\n  title: string;\n  content: string;\n  type: \"all\" | \"single\";\n  senderId: string;\n  senderName?: string;\n  isRead: boolean;\n  createdAt: string;\n}\n\nexport function NotificationBell() {\n  const [open, setOpen] = useState(false);\n\n  const { data: notifications = [] } = useQuery<Notification[]>({\n    queryKey: [\"/api/notifications\"],\n    refetchInterval: 30000,\n  });\n\n  const { data: unreadData } = useQuery<{ count: number }>({\n    queryKey: [\"/api/notifications/unread-count\"],\n    refetchInterval: 30000,\n  });\n\n  const markReadMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"POST\", `/api/notifications/${id}/read`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/notifications\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/notifications/unread-count\"] });\n    },\n  });\n\n  const markAllReadMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"POST\", \"/api/notifications/read-all\");\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/notifications\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/notifications/unread-count\"] });\n    },\n  });\n\n  const unreadCount = unreadData?.count || 0;\n\n  const formatDate = (dateString: string) => {\n    const date = new Date(dateString);\n    const now = new Date();\n    const diffMs = now.getTime() - date.getTime();\n    const diffMins = Math.floor(diffMs / 60000);\n    const diffHours = Math.floor(diffMs / 3600000);\n    const diffDays = Math.floor(diffMs / 86400000);\n\n    if (diffMins < 1) return \"V·ª´a xong\";\n    if (diffMins < 60) return `${diffMins} ph√∫t tr∆∞·ªõc`;\n    if (diffHours < 24) return `${diffHours} gi·ªù tr∆∞·ªõc`;\n    if (diffDays < 7) return `${diffDays} ng√†y tr∆∞·ªõc`;\n    return date.toLocaleDateString(\"vi-VN\");\n  };\n\n  return (\n    <Popover open={open} onOpenChange={setOpen}>\n      <PopoverTrigger asChild>\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          className=\"relative\"\n          data-testid=\"button-notifications\"\n        >\n          <Bell className=\"h-5 w-5\" />\n          {unreadCount > 0 && (\n            <Badge\n              variant=\"destructive\"\n              className=\"absolute -top-1 -right-1 h-5 w-5 flex items-center justify-center p-0 text-xs\"\n            >\n              {unreadCount > 99 ? \"99+\" : unreadCount}\n            </Badge>\n          )}\n        </Button>\n      </PopoverTrigger>\n      <PopoverContent className=\"w-96 p-0\" align=\"end\">\n        <div className=\"flex items-center justify-between p-4 border-b\">\n          <h4 className=\"font-semibold\">Th√¥ng b√°o</h4>\n          {unreadCount > 0 && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => markAllReadMutation.mutate()}\n              disabled={markAllReadMutation.isPending}\n              className=\"text-xs\"\n              data-testid=\"button-mark-all-read\"\n            >\n              <CheckCheck className=\"h-4 w-4 mr-1\" />\n              ƒê·ªçc t·∫•t c·∫£\n            </Button>\n          )}\n        </div>\n        <ScrollArea className=\"max-h-[400px]\">\n          {notifications.length === 0 ? (\n            <div className=\"p-8 text-center text-muted-foreground\">\n              <Bell className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\n              <p>Ch∆∞a c√≥ th√¥ng b√°o</p>\n            </div>\n          ) : (\n            <div className=\"divide-y\">\n              {notifications.map((notification) => (\n                <div\n                  key={notification.id}\n                  className={`p-4 hover-elevate cursor-pointer transition-colors ${\n                    !notification.isRead ? \"bg-primary/5\" : \"\"\n                  }`}\n                  onClick={() => {\n                    if (!notification.isRead) {\n                      markReadMutation.mutate(notification.id);\n                    }\n                  }}\n                  data-testid={`notification-item-${notification.id}`}\n                >\n                  <div className=\"flex items-start gap-3\">\n                    <div className={`mt-1 h-2 w-2 rounded-full flex-shrink-0 ${\n                      notification.isRead ? \"bg-transparent\" : \"bg-primary\"\n                    }`} />\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-start gap-2\">\n                        <p className=\"font-medium text-sm break-words\">\n                          {notification.title}\n                        </p>\n                        {notification.isRead && (\n                          <Check className=\"h-3 w-3 text-muted-foreground flex-shrink-0 mt-0.5\" />\n                        )}\n                      </div>\n                      <p className=\"text-sm text-muted-foreground mt-1 whitespace-pre-wrap break-words\">\n                        {notification.content}\n                      </p>\n                      <p className=\"text-xs text-muted-foreground mt-2\">\n                        {formatDate(notification.createdAt)}\n                      </p>\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </ScrollArea>\n      </PopoverContent>\n    </Popover>\n  );\n}\n","path":null,"size_bytes":5755,"size_tokens":null},"client/src/pages/admin/Notifications.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Label } from \"@/components/ui/label\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Bell, Send, Trash2, Users, User, Loader2 } from \"lucide-react\";\nimport AdminLayout from \"./Layout\";\n\ninterface NotificationType {\n  id: string;\n  title: string;\n  content: string;\n  type: \"all\" | \"single\";\n  targetUserId?: string;\n  senderId: string;\n  senderName?: string;\n  isRead: boolean;\n  createdAt: string;\n}\n\ninterface UserType {\n  id: string;\n  email: string;\n  firstName?: string;\n  lastName?: string;\n  role: string;\n}\n\nexport default function Notifications() {\n  const { toast } = useToast();\n  const [title, setTitle] = useState(\"\");\n  const [content, setContent] = useState(\"\");\n  const [notificationType, setNotificationType] = useState<\"all\" | \"single\">(\"all\");\n  const [targetUserId, setTargetUserId] = useState(\"\");\n\n  const { data: notifications = [], isLoading: loadingNotifications } = useQuery<NotificationType[]>({\n    queryKey: [\"/api/admin/notifications\"],\n  });\n\n  const { data: users = [], isLoading: loadingUsers } = useQuery<UserType[]>({\n    queryKey: [\"/api/admin/users\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: { title: string; content: string; type: \"all\" | \"single\"; targetUserId?: string }) => {\n      return apiRequest(\"/api/admin/notifications\", {\n        method: \"POST\",\n        body: JSON.stringify(data),\n      });\n    },\n    onSuccess: () => {\n      toast({ title: \"ƒê√£ g·ª≠i th√¥ng b√°o th√†nh c√¥ng\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/notifications\"] });\n      setTitle(\"\");\n      setContent(\"\");\n      setNotificationType(\"all\");\n      setTargetUserId(\"\");\n    },\n    onError: (error: any) => {\n      toast({ title: \"L·ªói\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(`/api/admin/notifications/${id}`, { method: \"DELETE\" });\n    },\n    onSuccess: () => {\n      toast({ title: \"ƒê√£ x√≥a th√¥ng b√°o\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/notifications\"] });\n    },\n    onError: (error: any) => {\n      toast({ title: \"L·ªói\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!title.trim() || !content.trim()) {\n      toast({ title: \"Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß ti√™u ƒë·ªÅ v√† n·ªôi dung\", variant: \"destructive\" });\n      return;\n    }\n    if (notificationType === \"single\" && !targetUserId) {\n      toast({ title: \"Vui l√≤ng ch·ªçn ng∆∞·ªùi nh·∫≠n\", variant: \"destructive\" });\n      return;\n    }\n    createMutation.mutate({\n      title: title.trim(),\n      content: content.trim(),\n      type: notificationType,\n      targetUserId: notificationType === \"single\" ? targetUserId : undefined,\n    });\n  };\n\n  const getUserName = (userId: string) => {\n    const user = users.find((u) => u.id === userId);\n    if (!user) return userId;\n    const name = `${user.firstName || \"\"} ${user.lastName || \"\"}`.trim();\n    return name || user.email;\n  };\n\n  return (\n    <AdminLayout>\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center gap-3\">\n          <Bell className=\"h-8 w-8 text-primary\" />\n          <div>\n            <h1 className=\"text-3xl font-bold\">Qu·∫£n l√Ω Th√¥ng b√°o</h1>\n            <p className=\"text-muted-foreground\">G·ª≠i th√¥ng b√°o t·ªõi ng∆∞·ªùi d√πng</p>\n          </div>\n        </div>\n\n        <div className=\"grid gap-6 lg:grid-cols-2\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Send className=\"h-5 w-5\" />\n                T·∫°o th√¥ng b√°o m·ªõi\n              </CardTitle>\n              <CardDescription>\n                G·ª≠i th√¥ng b√°o t·ªõi t·∫•t c·∫£ ng∆∞·ªùi d√πng ho·∫∑c m·ªôt ng∆∞·ªùi d√πng c·ª• th·ªÉ\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <form onSubmit={handleSubmit} className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"title\">Ti√™u ƒë·ªÅ</Label>\n                  <Input\n                    id=\"title\"\n                    placeholder=\"Nh·∫≠p ti√™u ƒë·ªÅ th√¥ng b√°o...\"\n                    value={title}\n                    onChange={(e) => setTitle(e.target.value)}\n                    data-testid=\"input-notification-title\"\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"content\">N·ªôi dung</Label>\n                  <Textarea\n                    id=\"content\"\n                    placeholder=\"Nh·∫≠p n·ªôi dung th√¥ng b√°o...\"\n                    value={content}\n                    onChange={(e) => setContent(e.target.value)}\n                    rows={4}\n                    data-testid=\"input-notification-content\"\n                  />\n                </div>\n\n                <div className=\"space-y-3\">\n                  <Label>G·ª≠i ƒë·∫øn</Label>\n                  <RadioGroup\n                    value={notificationType}\n                    onValueChange={(value: \"all\" | \"single\") => {\n                      setNotificationType(value);\n                      if (value === \"all\") setTargetUserId(\"\");\n                    }}\n                    className=\"flex gap-4\"\n                  >\n                    <div className=\"flex items-center space-x-2\">\n                      <RadioGroupItem value=\"all\" id=\"type-all\" data-testid=\"radio-notification-all\" />\n                      <Label htmlFor=\"type-all\" className=\"flex items-center gap-1 cursor-pointer\">\n                        <Users className=\"h-4 w-4\" />\n                        T·∫•t c·∫£ ng∆∞·ªùi d√πng\n                      </Label>\n                    </div>\n                    <div className=\"flex items-center space-x-2\">\n                      <RadioGroupItem value=\"single\" id=\"type-single\" data-testid=\"radio-notification-single\" />\n                      <Label htmlFor=\"type-single\" className=\"flex items-center gap-1 cursor-pointer\">\n                        <User className=\"h-4 w-4\" />\n                        M·ªôt ng∆∞·ªùi d√πng\n                      </Label>\n                    </div>\n                  </RadioGroup>\n                </div>\n\n                {notificationType === \"single\" && (\n                  <div className=\"space-y-2\">\n                    <Label>Ch·ªçn ng∆∞·ªùi nh·∫≠n</Label>\n                    <Select value={targetUserId} onValueChange={setTargetUserId}>\n                      <SelectTrigger data-testid=\"select-notification-user\">\n                        <SelectValue placeholder=\"Ch·ªçn ng∆∞·ªùi d√πng...\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {users.map((user) => (\n                          <SelectItem key={user.id} value={user.id}>\n                            {user.firstName || user.lastName\n                              ? `${user.firstName || \"\"} ${user.lastName || \"\"}`.trim()\n                              : user.email}\n                            {user.role === \"admin\" && \" (Admin)\"}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n                )}\n\n                <Button\n                  type=\"submit\"\n                  className=\"w-full\"\n                  disabled={createMutation.isPending}\n                  data-testid=\"button-send-notification\"\n                >\n                  {createMutation.isPending ? (\n                    <>\n                      <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                      ƒêang g·ª≠i...\n                    </>\n                  ) : (\n                    <>\n                      <Send className=\"mr-2 h-4 w-4\" />\n                      G·ª≠i th√¥ng b√°o\n                    </>\n                  )}\n                </Button>\n              </form>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle>Th·ªëng k√™</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between p-4 rounded-lg bg-muted\">\n                <div className=\"flex items-center gap-3\">\n                  <Bell className=\"h-8 w-8 text-primary\" />\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">T·ªïng th√¥ng b√°o</p>\n                    <p className=\"text-2xl font-bold\">{notifications.length}</p>\n                  </div>\n                </div>\n              </div>\n              <div className=\"flex items-center justify-between p-4 rounded-lg bg-muted\">\n                <div className=\"flex items-center gap-3\">\n                  <Users className=\"h-8 w-8 text-blue-500\" />\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">G·ª≠i t·ªõi t·∫•t c·∫£</p>\n                    <p className=\"text-2xl font-bold\">{notifications.filter((n) => n.type === \"all\").length}</p>\n                  </div>\n                </div>\n              </div>\n              <div className=\"flex items-center justify-between p-4 rounded-lg bg-muted\">\n                <div className=\"flex items-center gap-3\">\n                  <User className=\"h-8 w-8 text-green-500\" />\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">G·ª≠i ri√™ng</p>\n                    <p className=\"text-2xl font-bold\">{notifications.filter((n) => n.type === \"single\").length}</p>\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>L·ªãch s·ª≠ th√¥ng b√°o</CardTitle>\n            <CardDescription>Danh s√°ch t·∫•t c·∫£ th√¥ng b√°o ƒë√£ g·ª≠i</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {loadingNotifications ? (\n              <div className=\"flex items-center justify-center py-8\">\n                <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n              </div>\n            ) : notifications.length === 0 ? (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                Ch∆∞a c√≥ th√¥ng b√°o n√†o\n              </div>\n            ) : (\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Ti√™u ƒë·ªÅ</TableHead>\n                    <TableHead>N·ªôi dung</TableHead>\n                    <TableHead>Lo·∫°i</TableHead>\n                    <TableHead>Ng∆∞·ªùi nh·∫≠n</TableHead>\n                    <TableHead>Ng√†y g·ª≠i</TableHead>\n                    <TableHead className=\"text-right\">Thao t√°c</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {notifications.map((notification) => (\n                    <TableRow key={notification.id}>\n                      <TableCell className=\"font-medium max-w-[200px] truncate\">\n                        {notification.title}\n                      </TableCell>\n                      <TableCell className=\"max-w-[300px] truncate\">\n                        {notification.content}\n                      </TableCell>\n                      <TableCell>\n                        {notification.type === \"all\" ? (\n                          <Badge variant=\"secondary\" className=\"flex items-center gap-1 w-fit\">\n                            <Users className=\"h-3 w-3\" />\n                            T·∫•t c·∫£\n                          </Badge>\n                        ) : (\n                          <Badge variant=\"outline\" className=\"flex items-center gap-1 w-fit\">\n                            <User className=\"h-3 w-3\" />\n                            C√° nh√¢n\n                          </Badge>\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        {notification.type === \"single\" && notification.targetUserId\n                          ? getUserName(notification.targetUserId)\n                          : \"-\"}\n                      </TableCell>\n                      <TableCell>\n                        {new Date(notification.createdAt).toLocaleString(\"vi-VN\")}\n                      </TableCell>\n                      <TableCell className=\"text-right\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={() => deleteMutation.mutate(notification.id)}\n                          disabled={deleteMutation.isPending}\n                          title=\"X√≥a\"\n                          data-testid={`button-delete-notification-${notification.id}`}\n                        >\n                          <Trash2 className=\"h-4 w-4 text-destructive\" />\n                        </Button>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </AdminLayout>\n  );\n}\n","path":null,"size_bytes":13917,"size_tokens":null},"server/googleAuth.ts":{"content":"import passport from \"passport\";\nimport { Strategy as GoogleStrategy } from \"passport-google-oauth20\";\nimport session from \"express-session\";\nimport type { Express, RequestHandler } from \"express\";\nimport { createSessionStore } from \"./mongodb\";\n\nlet storage: any;\n\nexport function setStorage(s: any) {\n  storage = s;\n}\n\nexport function getSession(mongoConnected: boolean) {\n  const sessionTtl = 7 * 24 * 60 * 60 * 1000; // 1 week\n  const sessionStore = createSessionStore(mongoConnected);\n  \n  return session({\n    secret: process.env.SESSION_SECRET!,\n    store: sessionStore,\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      httpOnly: true,\n      secure: true,\n      maxAge: sessionTtl,\n    },\n  });\n}\n\nexport async function setupGoogleAuth(app: Express, mongoConnected: boolean) {\n  app.set(\"trust proxy\", 1);\n  app.use(getSession(mongoConnected));\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  const clientID = process.env.GOOGLE_CLIENT_ID;\n  const clientSecret = process.env.GOOGLE_CLIENT_SECRET;\n\n  if (!clientID || !clientSecret) {\n    console.error(\"[GoogleAuth] Missing GOOGLE_CLIENT_ID or GOOGLE_CLIENT_SECRET\");\n    throw new Error(\"Google OAuth credentials not configured\");\n  }\n\n  passport.use(\n    new GoogleStrategy(\n      {\n        clientID,\n        clientSecret,\n        callbackURL: \"/api/auth/google/callback\",\n        proxy: true,\n      },\n      async (accessToken, refreshToken, profile, done) => {\n        try {\n          const email = profile.emails?.[0]?.value || null;\n          const firstName = profile.name?.givenName || null;\n          const lastName = profile.name?.familyName || null;\n          const profileImageUrl = profile.photos?.[0]?.value || null;\n\n          console.log(\"[GoogleAuth] User logged in:\", {\n            id: profile.id,\n            email,\n            firstName,\n            lastName,\n          });\n\n          const user = await storage.upsertUser({\n            id: profile.id,\n            email,\n            firstName,\n            lastName,\n            profileImageUrl,\n          });\n\n          const sessionUser = {\n            claims: {\n              sub: profile.id,\n              email,\n              first_name: firstName,\n              last_name: lastName,\n              profile_image_url: profileImageUrl,\n            },\n            access_token: accessToken,\n            refresh_token: refreshToken,\n            expires_at: Math.floor(Date.now() / 1000) + 3600,\n          };\n\n          done(null, sessionUser);\n        } catch (error) {\n          console.error(\"[GoogleAuth] Error during authentication:\", error);\n          done(error as Error);\n        }\n      }\n    )\n  );\n\n  passport.serializeUser((user: Express.User, cb) => cb(null, user));\n  passport.deserializeUser((user: Express.User, cb) => cb(null, user));\n\n  app.get(\n    \"/api/auth/google\",\n    passport.authenticate(\"google\", {\n      scope: [\"profile\", \"email\"],\n      prompt: \"select_account\",\n    })\n  );\n\n  app.get(\n    \"/api/auth/google/callback\",\n    passport.authenticate(\"google\", {\n      failureRedirect: \"/?error=auth_failed\",\n    }),\n    (req, res) => {\n      res.redirect(\"/\");\n    }\n  );\n\n  app.get(\"/api/logout\", (req, res) => {\n    req.logout(() => {\n      req.session.destroy(() => {\n        res.redirect(\"/\");\n      });\n    });\n  });\n\n  // Redirect /api/login to Google auth for backwards compatibility\n  app.get(\"/api/login\", (_req, res) => {\n    res.redirect(\"/api/auth/google\");\n  });\n}\n\nexport const isAuthenticated: RequestHandler = async (req, res, next) => {\n  const user = req.user as any;\n\n  if (!req.isAuthenticated() || !user) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n\n  return next();\n};\n","path":null,"size_bytes":3708,"size_tokens":null},"client/src/hooks/useDevToolsDetection.ts":{"content":"import { useEffect } from 'react';\nimport { useLocation } from 'wouter';\n\nfunction isDevToolsOpen(): boolean {\n  const threshold = 160;\n  const widthThreshold = window.outerWidth - window.innerWidth > threshold;\n  const heightThreshold = window.outerHeight - window.innerHeight > threshold;\n  return widthThreshold || heightThreshold;\n}\n\nexport function useDevToolsDetection() {\n  const [location, setLocation] = useLocation();\n\n  useEffect(() => {\n    if (location !== '/' && isDevToolsOpen()) {\n      setLocation('/');\n      return;\n    }\n\n    let devtoolsOpen = isDevToolsOpen();\n\n    const checkDevTools = () => {\n      if (isDevToolsOpen()) {\n        if (!devtoolsOpen || location !== '/') {\n          devtoolsOpen = true;\n          setLocation('/');\n        }\n      } else {\n        devtoolsOpen = false;\n      }\n    };\n\n    const detectDevToolsViaDebugger = () => {\n      const element = new Image();\n      Object.defineProperty(element, 'id', {\n        get: function() {\n          if (location !== '/') {\n            setLocation('/');\n          }\n          return '';\n        }\n      });\n      console.log('%c', element);\n    };\n\n    checkDevTools();\n\n    const interval = setInterval(() => {\n      checkDevTools();\n      detectDevToolsViaDebugger();\n    }, 500);\n\n    window.addEventListener('resize', checkDevTools);\n\n    // Disable right-click context menu\n    const disableContextMenu = (e: MouseEvent) => {\n      e.preventDefault();\n      return false;\n    };\n\n    // Disable keyboard shortcuts for DevTools, view-source, save, copy, print, select all\n    const disableKeyShortcuts = (e: KeyboardEvent) => {\n      const key = e.key.toUpperCase();\n      \n      // F12 - DevTools\n      if (e.key === 'F12') {\n        e.preventDefault();\n        setLocation('/');\n        return false;\n      }\n      \n      // Ctrl+Shift combinations (DevTools shortcuts)\n      if (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(key)) {\n        e.preventDefault();\n        setLocation('/');\n        return false;\n      }\n      \n      // Ctrl combinations\n      if (e.ctrlKey && !e.shiftKey) {\n        // Ctrl+U - View Source\n        if (key === 'U') {\n          e.preventDefault();\n          setLocation('/');\n          return false;\n        }\n        \n        // Ctrl+S - Save Page\n        if (key === 'S') {\n          e.preventDefault();\n          return false;\n        }\n        \n        // Ctrl+P - Print\n        if (key === 'P') {\n          e.preventDefault();\n          return false;\n        }\n        \n        // Ctrl+A - Select All (only outside input fields)\n        if (key === 'A') {\n          const target = e.target as HTMLElement;\n          const isInputField = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable;\n          if (!isInputField) {\n            e.preventDefault();\n            return false;\n          }\n        }\n        \n        // Ctrl+C - Copy (only outside input fields)\n        if (key === 'C') {\n          const target = e.target as HTMLElement;\n          const isInputField = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable;\n          if (!isInputField) {\n            e.preventDefault();\n            return false;\n          }\n        }\n        \n        // Ctrl+X - Cut (only outside input fields)\n        if (key === 'X') {\n          const target = e.target as HTMLElement;\n          const isInputField = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable;\n          if (!isInputField) {\n            e.preventDefault();\n            return false;\n          }\n        }\n      }\n    };\n\n    // Disable text selection (except in input fields)\n    const disableSelectStart = (e: Event) => {\n      const target = e.target as HTMLElement;\n      const isInputField = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable;\n      if (!isInputField) {\n        e.preventDefault();\n        return false;\n      }\n    };\n\n    // Disable copy event (except in input fields)\n    const disableCopy = (e: ClipboardEvent) => {\n      const target = e.target as HTMLElement;\n      const isInputField = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable;\n      if (!isInputField) {\n        e.preventDefault();\n        return false;\n      }\n    };\n\n    // Disable cut event (except in input fields)\n    const disableCut = (e: ClipboardEvent) => {\n      const target = e.target as HTMLElement;\n      const isInputField = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable;\n      if (!isInputField) {\n        e.preventDefault();\n        return false;\n      }\n    };\n\n    // Disable drag start (prevent dragging images/content)\n    const disableDragStart = (e: DragEvent) => {\n      e.preventDefault();\n      return false;\n    };\n\n    document.addEventListener('contextmenu', disableContextMenu);\n    document.addEventListener('keydown', disableKeyShortcuts);\n    document.addEventListener('selectstart', disableSelectStart);\n    document.addEventListener('copy', disableCopy);\n    document.addEventListener('cut', disableCut);\n    document.addEventListener('dragstart', disableDragStart);\n\n    return () => {\n      clearInterval(interval);\n      window.removeEventListener('resize', checkDevTools);\n      document.removeEventListener('contextmenu', disableContextMenu);\n      document.removeEventListener('keydown', disableKeyShortcuts);\n      document.removeEventListener('selectstart', disableSelectStart);\n      document.removeEventListener('copy', disableCopy);\n      document.removeEventListener('cut', disableCut);\n      document.removeEventListener('dragstart', disableDragStart);\n    };\n  }, [location, setLocation]);\n}\n","path":null,"size_bytes":5755,"size_tokens":null},"client/src/pages/admin/UserPoints.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport AdminLayout from \"./Layout\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Coins, User as UserIcon } from \"lucide-react\";\nimport type { User } from \"@shared/schema\";\n\nexport default function AdminUserPoints() {\n  const { data: users = [], isLoading } = useQuery<User[]>({\n    queryKey: [\"/api/admin/users\"],\n  });\n\n  const usersWithPoints = users\n    .filter(user => (user.points || 0) >= 1)\n    .sort((a, b) => (b.points || 0) - (a.points || 0));\n\n  const totalPoints = usersWithPoints.reduce((sum, user) => sum + (user.points || 0), 0);\n\n  return (\n    <AdminLayout>\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">Check ƒêi·ªÉm User</h1>\n            <p className=\"text-muted-foreground\">\n              Danh s√°ch ng∆∞·ªùi d√πng c√≥ ƒëi·ªÉm quy ƒë·ªïi t·ª´ 1 ƒëi·ªÉm tr·ªü l√™n\n            </p>\n          </div>\n        </div>\n\n        <div className=\"grid gap-4 md:grid-cols-3\">\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">T·ªïng s·ªë User c√≥ ƒëi·ªÉm</CardTitle>\n              <UserIcon className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\" data-testid=\"text-users-with-points\">\n                {usersWithPoints.length}\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">T·ªïng ƒëi·ªÉm trong h·ªá th·ªëng</CardTitle>\n              <Coins className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold text-primary\" data-testid=\"text-total-points\">\n                {totalPoints.toLocaleString()}\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">ƒêi·ªÉm trung b√¨nh</CardTitle>\n              <Coins className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\" data-testid=\"text-avg-points\">\n                {usersWithPoints.length > 0 \n                  ? Math.round(totalPoints / usersWithPoints.length).toLocaleString() \n                  : 0}\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Coins className=\"h-5 w-5\" />\n              Danh s√°ch User c√≥ ƒëi·ªÉm\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <div className=\"space-y-2\">\n                {[1, 2, 3, 4, 5].map((i) => (\n                  <div key={i} className=\"h-12 bg-muted animate-pulse rounded-md\" />\n                ))}\n              </div>\n            ) : usersWithPoints.length === 0 ? (\n              <div className=\"text-center py-12 text-muted-foreground\" data-testid=\"text-no-users\">\n                <Coins className=\"w-12 h-12 mx-auto mb-4 opacity-50\" />\n                <p>Ch∆∞a c√≥ user n√†o c√≥ ƒëi·ªÉm</p>\n              </div>\n            ) : (\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead className=\"w-12\">#</TableHead>\n                    <TableHead>Username</TableHead>\n                    <TableHead>Email</TableHead>\n                    <TableHead className=\"text-right\">ƒêi·ªÉm</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {usersWithPoints.map((user, index) => (\n                    <TableRow key={user.id} data-testid={`row-user-${user.id}`}>\n                      <TableCell className=\"font-medium\">\n                        {index + 1}\n                      </TableCell>\n                      <TableCell>\n                        <div className=\"flex items-center gap-2\">\n                          <div className=\"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center\">\n                            {user.profileImageUrl ? (\n                              <img \n                                src={user.profileImageUrl} \n                                alt={user.username || \"User\"} \n                                className=\"w-8 h-8 rounded-full object-cover\"\n                              />\n                            ) : (\n                              <UserIcon className=\"w-4 h-4 text-primary\" />\n                            )}\n                          </div>\n                          <span className=\"font-medium\" data-testid={`text-username-${user.id}`}>\n                            {user.username || \"Ch∆∞a ƒë·∫∑t t√™n\"}\n                          </span>\n                        </div>\n                      </TableCell>\n                      <TableCell className=\"text-muted-foreground\">\n                        {user.email || \"‚Äî\"}\n                      </TableCell>\n                      <TableCell className=\"text-right\">\n                        <Badge \n                          variant=\"default\" \n                          className=\"bg-primary text-primary-foreground\"\n                          data-testid={`badge-points-${user.id}`}\n                        >\n                          <Coins className=\"w-3 h-3 mr-1\" />\n                          {(user.points || 0).toLocaleString()}\n                        </Badge>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </AdminLayout>\n  );\n}\n","path":null,"size_bytes":6315,"size_tokens":null}},"version":2}